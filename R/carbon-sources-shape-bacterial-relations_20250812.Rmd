---
title: "Ono_interaction_202508127"
author: "HirokiOno"
date: "2025-08-12"
output: html_document
---

# Settings
## Library loading
```{r}
library(flowCore)
library(openxlsx)
library(data.table)
library(pbapply)
library(ggplot2)
library(dplyr)
library(plyr)
library(ggpubr)
library(coin)
library(magrittr)
library(stringr)
library(vegan)
library(pairwiseAdonis)
library(tidyverse)
library(clusterProfiler)
library(qvalue)
library(yaml)
```

## Output yaml file
```{r}
pkg_versions <- sessionInfo()$otherPkgs
pkg_list <- lapply(pkg_versions, function(x) x$Version)
writeLines(as.yaml(pkg_list), "R_environment.yml")
```

## Color settings
```{r}
# Function to create RGB colors
create_rgb <- function(r, g, b) {
  rgb(red = r, green = g, blue = b, maxColorValue = 255)
}

# Colors for 8 bacterial species
color_bacteria <- c(
  create_rgb(230, 0, 0),
  create_rgb(255, 0, 170),
  create_rgb(153, 0, 230),
  create_rgb(0, 60, 179),
  create_rgb(0, 170, 204),
  create_rgb(0, 179, 89),
  create_rgb(204, 204, 0),
  create_rgb(255, 128, 0)
)

# Colors for 6 types of interactions
color_interaction <- list(
  mutualism = create_rgb(10, 118, 198),
  commensalism = create_rgb(115, 180, 230),
  parasitism = create_rgb(155, 114, 176),
  amensalism = create_rgb(230, 138, 138),
  competition = create_rgb(222, 80, 80),
  neutral = create_rgb(188, 188, 206)
)

# Colors for fluorescent proteins
color_fluorescent <- list(
  GFP = create_rgb(89, 178, 101),
  mScarlet = create_rgb(230, 115, 202)
)

# Colors for 16 carbon sources (using HSV)
color_carbon <- sapply(0:15, function(i) hsv(h = 21 * i / 360, s = 0.5, v = 0.9, alpha = 1))
```


# Preparation of datasets
## Load files
```{r}
# Load .xlsx files regarding experimental design
all_sample_df <- data.table(read.xlsx("experimental_design.xlsx", sheet = 1))
info <- data.table(read.xlsx("experimental_design.xlsx", sheet = 2))

# Load .csv files regarding phylogenetic distance
phylo_distance <- data.frame(read.csv("phylogenetic_distance.csv"))
```

## Get the count information for each particle from the fcs file
```{r}
# Start time tracking
start_time <- Sys.time()

# Initialize results storage
density_data <- list()

# Process each FCS file
density_data <- pblapply(all_sample_df$fcs_file, function(file) {
  sample <- read.FCS(file)
  tempDataframe <- as.data.table(sample@exprs)
  tempDataframe[, Gate.count := 0]
  total_count <- as.integer(sample@description$`$TOT`)

  # Replace values less than 1 with 1
  cols <- c("FITC-A", "PE-A", "PE-Cy5-A")
  for (col in cols) {
    tempDataframe[, (col) := pmax(get(col), 1)]
  }

  # Classify events using conditional logic
  tempDataframe[, Gate.count := fifelse(`FITC-A` > 500 | `PE-A` > 100, 5, Gate.count)]
  tempDataframe[, Gate.count := fifelse((`FITC-A` > 500 & `PE-A` < 100) | 
                                        (`PE-A` > 100 & `PE-A` < 500 & `PE-A` < `FITC-A` / 10), 4, Gate.count)]
  tempDataframe[, Gate.count := fifelse((`FITC-A` < 500 & `PE-A` > 100) | 
                                        (`FITC-A` > 500 & `FITC-A` < 2000 & `PE-A` > (`FITC-A` * 3 - 1000)) | 
                                        (`FITC-A` > 2000 & `FITC-A` < 7000 & `PE-A` > (`FITC-A` * 59 - 113000)), 3, Gate.count)]
  tempDataframe[, Gate.count := fifelse(`SSC-H` > 25000, 2, Gate.count)]
  tempDataframe[, Gate.count := fifelse((`SSC-H` > 240000 & `PE-Cy5-A` > 20000 & `FITC-A` > 20000 & `PE-A` > 800 & 
                                         (`PE-A` > 170000 | `PE-A` < `FITC-A` * 110 / 69 + 60000 - 31000 * 110 / 69)) |
                                        (`SSC-H` > 19000 & `SSC-H` < (15 * `PE-Cy5-A` - 60000) & `SSC-H` > (10 * `PE-Cy5-A` - 360000) & 
                                         `FITC-A` > 20000 & `PE-A` > 800 & (`PE-A` > 170000 | `PE-A` < `FITC-A` * 110 / 69 + 60000 - 31000 * 110 / 69)), 1, Gate.count)]

  # Count event types
  beads <- sum(tempDataframe$Gate.count == 1)
  red <- sum(tempDataframe$Gate.count == 3)
  green <- sum(tempDataframe$Gate.count == 4)
  bicolor <- sum(tempDataframe$Gate.count == 5)

  # Return the result as a list to be merged with all_sample_df
  return(list(green = green, red = red, bicolor = bicolor, beads = beads))
})

# Convert the list of results to a data.table
density_data_dt <- rbindlist(density_data)

# Add new columns to all_sample_df by matching the row order
all_sample_df[, c("green", "red", "bicolor", "beads") := .(density_data_dt$green, density_data_dt$red, density_data_dt$bicolor, density_data_dt$beads)]

all_sample_df <- as.data.frame(all_sample_df)

# End time tracking and print duration
end_time <- Sys.time()
duration <- end_time - start_time
print(paste("Execution time:", duration, "min"))
```

## TEMP
```{r}
all_sample_df_2<-all_sample_df
# all_sample_df<-all_sample_df_2
```

## Convert particle counts to cell density.
```{r}
# Calculate target fluorescent cell density based on fluorescence type and protocol
all_sample_df$target_fluorescent_cells_density <- ifelse(
  all_sample_df$bacterial_species_count == 1,
  ifelse(
    all_sample_df$monoculture_fluorescence == "GFP",
    ifelse(
      all_sample_df$dispensation_protcol == 1,
      1.83 * 1e7 * 80 / 4000 * all_sample_df$green / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
      ifelse(
        all_sample_df$dispensation_protcol %in% c(2, 3, 4),
        1.83 * 1e7 * 64 / 4000 * all_sample_df$green / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
        "ERROR"
      )
    ),
    ifelse(
      all_sample_df$monoculture_fluorescence == "mScarlet",
      ifelse(
        all_sample_df$dispensation_protcol == 1,
        1.83 * 1e7 * 80 / 4000 * all_sample_df$red / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
        ifelse(
          all_sample_df$dispensation_protcol %in% c(2, 3, 4),
          1.83 * 1e7 * 64 / 4000 * all_sample_df$red / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
          "ERROR"
        )
      ),
      "ERROR"
    )
  ),
  ifelse(
    all_sample_df$bacterial_species_count == 2,
    ifelse(
      all_sample_df$dispensation_protcol == 1,
      1.83 * 1e7 * 80 / 4000 * (all_sample_df$green + all_sample_df$red) / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
      ifelse(
        all_sample_df$dispensation_protcol %in% c(2, 3, 4),
        1.83 * 1e7 * 64 / 4000 * (all_sample_df$green + all_sample_df$red) / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
        "ERROR"
      )
    ),
    "ERROR"
  )
)

# Calculate total fluorescent events density
all_sample_df$fluorescent_events_density <- ifelse(
  all_sample_df$dispensation_protcol == 1,
  1.83 * 1e7 * 80 / 4000 * (all_sample_df$green + all_sample_df$red + all_sample_df$bicolor) / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
  ifelse(
    all_sample_df$dispensation_protcol %in% c(2, 3, 4),
    1.83 * 1e7 * 64 / 4000 * (all_sample_df$green + all_sample_df$red + all_sample_df$bicolor) / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
    "ERROR"
  )
)

# Calculate green fluorescent events density
all_sample_df$green_events_density <- ifelse(
  all_sample_df$dispensation_protcol == 1,
  1.83 * 1e7 * 80 / 4000 * all_sample_df$green / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
  ifelse(
    all_sample_df$dispensation_protcol %in% c(2, 3, 4),
    1.83 * 1e7 * 64 / 4000 * all_sample_df$green / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
    "ERROR"
  )
)

# Calculate red fluorescent events density
all_sample_df$red_events_density <- ifelse(
  all_sample_df$dispensation_protcol == 1,
  1.83 * 1e7 * 80 / 4000 * all_sample_df$red / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
  ifelse(
    all_sample_df$dispensation_protcol %in% c(2, 3, 4),
    1.83 * 1e7 * 64 / 4000 * all_sample_df$red / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
    "ERROR"
  )
)

# Replace NaN values in relevant columns with 1
cols_to_check <- c("target_fluorescent_cells_density", "fluorescent_events_density", "green_events_density", "red_events_density")
all_sample_df[cols_to_check] <- lapply(all_sample_df[cols_to_check], function(x) ifelse(is.nan(x), 1, x))

# Convert relevant columns to numeric
all_sample_df$target_fluorescent_cells_density <- as.numeric(all_sample_df$target_fluorescent_cells_density)
all_sample_df$fluorescent_events_density <- as.numeric(all_sample_df$fluorescent_events_density)
all_sample_df$green_events_density <- as.numeric(all_sample_df$green_events_density)
all_sample_df$red_events_density <- as.numeric(all_sample_df$red_events_density)

# Calculate total green + red fluorescent cell density
all_sample_df$green_red_cells_density <- all_sample_df$green_events_density + all_sample_df$red_events_density

# Final NaN check and replacement
cols_to_check <- c("target_fluorescent_cells_density", "fluorescent_events_density", "green_events_density", "red_events_density", "green_red_cells_density")
all_sample_df[cols_to_check] <- lapply(all_sample_df[cols_to_check], function(x) ifelse(is.nan(x), 1, x))
```

## Determine detection limits
```{r}
# Pick up cells density (water environment)
water_df <- all_sample_df[all_sample_df$environment == "water", ]
water_cell_density <- water_df$green_red_cells_density

proportion <- seq(0,1, by=0.1)
water_q <- quantile(water_cell_density, proportion, type=1)

# We considered the 90th percentile as the detection limit.
detection_limit <- signif(water_q[10], 3)
detection_limit
```

## Perform background processing
```{r}
# Replaces values smaller than detection_limit
all_sample_df$background_processing_target_fluorescent_cells_density <- pmax(all_sample_df$target_fluorescent_cells_density, detection_limit)
all_sample_df$background_processing_fluorescent_events_density <- pmax(all_sample_df$fluorescent_events_density, detection_limit)
all_sample_df$background_processing_green_events_density <- pmax(all_sample_df$green_events_density, detection_limit)
all_sample_df$background_processing_red_events_density <- pmax(all_sample_df$red_events_density, detection_limit)
```

## Pick up monocultured cell density
```{r}
# Get unique values for experiments and environments
experiment_vals <- unique(all_sample_df$experiment)
environment_vals <- unique(all_sample_df$environment)

# Initialize empty vectors for storing min/med/max fluorescence values
green_min_vec <- numeric(nrow(all_sample_df))
green_med_vec <- numeric(nrow(all_sample_df))
green_max_vec <- numeric(nrow(all_sample_df))
red_min_vec <- numeric(nrow(all_sample_df))
red_med_vec <- numeric(nrow(all_sample_df))
red_max_vec <- numeric(nrow(all_sample_df))
check_vec <- numeric(nrow(all_sample_df))

# Loop over all rows to extract background fluorescence statistics
for (i in 1:nrow(all_sample_df)) {

  # Monoculture case
  if (all_sample_df$bacterial_species_count[i] == 1) {
    temp_experiment <- all_sample_df[
      all_sample_df$experiment == all_sample_df$experiment[i] &
      all_sample_df$environment == all_sample_df$environment[i], 
    ]
    
    temp_mono <- temp_experiment[
      temp_experiment$bacteria == all_sample_df$bacteria[i], 
    ]
    
    green_min_vec[i] <- min(as.numeric(temp_mono$background_processing_green_events_density))
    green_med_vec[i] <- median(as.numeric(temp_mono$background_processing_green_events_density))
    green_max_vec[i] <- max(as.numeric(temp_mono$background_processing_green_events_density))
    
    red_min_vec[i] <- min(as.numeric(temp_mono$background_processing_red_events_density))
    red_med_vec[i] <- median(as.numeric(temp_mono$background_processing_red_events_density))
    red_max_vec[i] <- max(as.numeric(temp_mono$background_processing_red_events_density))
    
    # Check that 3 fcs files exist for monoculture
    check_vec[i] <- ifelse(length(temp_mono$fcs_file) == 3, 0, 1)
  }

  # Coculture case
  if (all_sample_df$bacterial_species_count[i] == 2) {
    temp_experiment <- all_sample_df[
      all_sample_df$experiment == all_sample_df$experiment[i] &
      all_sample_df$environment == all_sample_df$environment[i], 
    ]
    
    temp_mono_GFP <- temp_experiment[
      temp_experiment$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i], 
    ]
    
    temp_mono_mScarlet <- temp_experiment[
      temp_experiment$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i], 
    ]
    
    green_min_vec[i] <- min(as.numeric(temp_mono_GFP$background_processing_green_events_density))
    green_med_vec[i] <- median(as.numeric(temp_mono_GFP$background_processing_green_events_density))
    green_max_vec[i] <- max(as.numeric(temp_mono_GFP$background_processing_green_events_density))
    
    red_min_vec[i] <- min(as.numeric(temp_mono_mScarlet$background_processing_red_events_density))
    red_med_vec[i] <- median(as.numeric(temp_mono_mScarlet$background_processing_red_events_density))
    red_max_vec[i] <- max(as.numeric(temp_mono_mScarlet$background_processing_red_events_density))
    
    # Check that 3 + 3 = 6 fcs files exist for coculture monocultures
    check_vec[i] <- ifelse(length(c(temp_mono_GFP$fcs_file, temp_mono_mScarlet$fcs_file)) == 6, 0, 1)
  }
}

# Assign min/med/max values to main data frame if all fcs files are present
if (all(check_vec == 0)) {
  all_sample_df$green_min <- green_min_vec
  all_sample_df$green_med <- green_med_vec
  all_sample_df$green_max <- green_max_vec
  all_sample_df$red_min <- red_min_vec
  all_sample_df$red_med <- red_med_vec
  all_sample_df$red_max <- red_max_vec
}
```

## Pick up cocultured cell density
```{r}
# Initialize empty data frame to store selected values
pick <- data.frame()

# Loop through each row in the dataset
for (i in 1:nrow(all_sample_df)) {
  if (all_sample_df$experiment[i] == "main" && all_sample_df$bacterial_species_count[i] == 2) {
    
    # Filter rows from the same experiment, environment, and bacterial pair
    temp <- all_sample_df[all_sample_df$experiment == "main", ]
    temp <- temp[temp$bacterial_species_count == 2, ]
    temp <- temp[temp$bacteria == all_sample_df$bacteria[i], ]
    temp <- temp[temp$environment == all_sample_df$environment[i], ]
    
    # Append calculated background stats to 'pick'
    pick <- rbind(
      pick,
      data.frame(
        file = all_sample_df$fcs_file[i],
        co_mingreen = min(temp$background_processing_green_events_density),
        co_medgreen = median(temp$background_processing_green_events_density),
        co_maxgreen = max(temp$background_processing_green_events_density),
        co_minred = min(temp$background_processing_red_events_density),
        co_medred = median(temp$background_processing_red_events_density),
        co_maxred = max(temp$background_processing_red_events_density),
        # Check if the number of matching files is exactly 3
        check = if (nrow(temp) == 3) { 0 } else { 1 }
      )
    )
  } else {
    # If not coculture from 'main', fill with "none"
    pick <- rbind(
      pick,
      data.frame(
        file = all_sample_df$fcs_file[i],
        co_mingreen = "none",
        co_medgreen = "none",
        co_maxgreen = "none",
        co_minred = "none",
        co_medred = "none",
        co_maxred = "none",
        check = 0
      )
    )
  }
}

# If all checks passed, assign extracted values back to the main data frame
if (all(pick$check == 0)) {
  all_sample_df$co_mingreen <- pick$co_mingreen
  all_sample_df$co_medgreen <- pick$co_medgreen
  all_sample_df$co_maxgreen <- pick$co_maxgreen
  all_sample_df$co_minred <- pick$co_minred
  all_sample_df$co_medred <- pick$co_medred
  all_sample_df$co_maxred <- pick$co_maxred
}
```

## Test the significance of the effect
```{r}
# Filter to main experiment and cocultures only
temp <- all_sample_df[all_sample_df$experiment == "main", ]
temp <- temp[temp$bacterial_species_count == 2, ]

# Initialize result storage
test_df <- data.frame()
greenpvalue <- numeric(nrow(temp))
redpvalue <- numeric(nrow(temp))
check <- numeric(nrow(temp))

# Loop over each coculture sample
for (i in 1:nrow(temp)) {
  cg <- c()
  cr <- c()
  
  # Extract samples with same bacteria pair and environment
  temp_df <- temp[
    (temp$bacteria == temp$bacteria[i]) &
    (temp$environment == temp$environment[i]), ]
  
  # Normalize fluorescence signals by average mono-culture values
  cg <- c(as.numeric(temp_df$background_processing_green_events_density) /
          mean(c(as.numeric(temp_df$green_min),
                 as.numeric(temp_df$green_med),
                 as.numeric(temp_df$green_max))))
  
  cr <- c(as.numeric(temp_df$background_processing_red_events_density) /
          mean(c(as.numeric(temp_df$red_min),
                 as.numeric(temp_df$red_med),
                 as.numeric(temp_df$red_max))))
  
  # Perform one-sample t-test for GFP channel (null hypothesis: mean = 1)
  if (var(cg) == 0) {
    tgtemp <- ifelse(cg[1] == 1, 1, 0)
  } else {
    tgtemp <- t.test(
      x = cg, y = NULL, alternative = c("two.sided", "less", "greater"),
      mu = 1, paired = FALSE, var.equal = FALSE, conf.level = 0.95
    )$p.value
  }
  
  # Perform one-sample t-test for mScarlet channel (null hypothesis: mean = 1)
  if (var(cr) == 0) {
    trtemp <- ifelse(cr[1] == 1, 1, 0)
  } else {
    trtemp <- t.test(
      x = cr, y = NULL, alternative = c("two.sided", "less", "greater"),
      mu = 1, paired = FALSE, var.equal = FALSE, conf.level = 0.95
    )$p.value
  }
  
  # Check if both channels have exactly 3 data points
  check[i] <- ifelse(length(cg) == 3 & length(cr) == 3, 0, 1)
  
  # Store p-values and check status
  test_df <- rbind(test_df, data.frame(
    filelatest = temp$fcs_file[i],
    greenpvalue = tgtemp,
    redpvalue = trtemp,
    check = check[i]
  ))
}

# Adjust p-values using Benjamini-Hochberg method
greenqvalue <- p.adjust(test_df$greenpvalue, method = "BH")
redqvalue <- p.adjust(test_df$redpvalue, method = "BH")

# If all tests are valid, assign p/q-values to the original dataframe
if (all(test_df$check == 0)) {
  all_sample_df$greenpvalue <- "mono-culture"
  all_sample_df$redpvalue <- "mono-culture"
  
  for (i in 1:nrow(test_df)) {
    idx <- which(all_sample_df$fcs_file == test_df$filelatest[i])
    
    if (length(idx) > 0) {
      all_sample_df$greenpvalue[idx] <- test_df$greenpvalue[i]
      all_sample_df$redpvalue[idx] <- test_df$redpvalue[i]
    }
  }
  
  all_sample_df$greenqvalue <- "mono-culture"
  all_sample_df$redqvalue <- "mono-culture"
  
  all_sample_df$greenqvalue[!all_sample_df$greenpvalue == "mono-culture"] <- greenqvalue
  all_sample_df$redqvalue[!all_sample_df$redpvalue == "mono-culture"] <- redqvalue
}
```

## Calculate interaction classes & interaction types
```{r}
# Function to calculate population standard deviation
pop_sd <- function(x) {
  if (all(is.na(x))) return(NA)
  sqrt(mean((x - mean(x, na.rm = TRUE))^2, na.rm = TRUE))
}

# Function to safely convert to numeric, returns NULL if conversion fails
safe_numeric1 <- function(x) {
  vals <- suppressWarnings(as.numeric(x))
  if (any(is.na(vals))) return(NULL) else return(vals)
}

# Function to safely convert specific columns in a row to numeric
safe_numeric2 <- function(row, cols) {
  vals <- as.numeric(row[cols])
  if (any(is.na(vals))) return(NULL) else return(vals)
}

# Function to compute interaction type based on red_to_green and green_to_red relationships
compute_type <- function(red_to_green, green_to_red) {
  if (red_to_green == "+" && green_to_red == "+") {
    return("Mutualism")
  } else if ((red_to_green == "0" && green_to_red == "+") || (red_to_green == "+" && green_to_red == "0")) {
    return("Commensalism")
  } else if ((red_to_green == "-" && green_to_red == "+") || (red_to_green == "+" && green_to_red == "-")) {
    return("Parasitism")
  } else if ((red_to_green == "0" && green_to_red == "-") || (red_to_green == "-" && green_to_red == "0")) {
    return("Amensalism")
  } else if (red_to_green == "-" && green_to_red == "-") {
    return("Competition")
  } else if (red_to_green == "0" && green_to_red == "0") {
    return("Neutral")
  } else {
    return("ERROR")
  }
}

# Function to compute hierarchy level based on interaction type
compute_plot_hierarchy <- function(type) {
  if (type == "Neutral") {
    return(0)
  } else if (type %in% c("Commensalism", "Amensalism")) {
    return(1)
  } else if (type %in% c("Mutualism", "Parasitism", "Competition")) {
    return(2)
  } else {
    return("ERROR")
  }
}

# Function to compute various aspects for a given row
compute_row <- function(row) {
  # Calculate green aspect value (log ratio of green values)
  vals_green_num <- safe_numeric1(row[c("co_mingreen", "co_medgreen", "co_maxgreen")])
  vals_green_den <- safe_numeric1(row[c("green_min", "green_med", "green_max")])
  if (is.null(vals_green_num) || is.null(vals_green_den)) {
    greenaspect_value <- "OTHER"
  } else {
    avg_num <- mean(vals_green_num)
    avg_den <- mean(vals_green_den)
    greenaspect_value <- ifelse(avg_den == 0 || (avg_num/avg_den) <= 0, "OTHER", log(avg_num/avg_den, base = 2))
  }
  
  # Calculate red aspect value (log ratio of red values)
  vals_red_num <- safe_numeric1(row[c("co_minred", "co_medred", "co_maxred")])
  vals_red_den <- safe_numeric1(row[c("red_min", "red_med", "red_max")])
  if (is.null(vals_red_num) || is.null(vals_red_den)) {
    redaspect_value <- "OTHER"
  } else {
    avg_num_red <- mean(vals_red_num)
    avg_den_red <- mean(vals_red_den)
    redaspect_value <- ifelse(avg_den_red == 0 || (avg_num_red/avg_den_red) <= 0, "OTHER", log(avg_num_red/avg_den_red, base = 2))
  }
  
  # Compute theta value based on green and red aspects
  if (!is.numeric(greenaspect_value) || !is.numeric(redaspect_value)) {
    theta_value <- "OTHER"
  } else {
    CU <- greenaspect_value
    CW <- redaspect_value
    if (CU == 0 && CW == 0) {
      theta_value <- 0
    } else if (CU == 0) {
      theta_value <- ifelse(CW > 0, 45, -45)
    } else if (CW == 0) {
      theta_value <- ifelse(CU > 0, 45, -45)
    } else if (CU == CW) {
      theta_value <- ifelse(CW > 0, 90, -90)
    } else {
      ratio <- if (CU > CW) CU/CW else CW/CU
      t_val <- atan(ratio)
      adjusted <- if (t_val < (pi * 0.25)) t_val + pi else t_val
      theta_value <- (pi * 3/4 - adjusted) / pi * 180
    }
  }
  
  # Compute x value (smaller of green and red aspect values)
  if (!is.numeric(greenaspect_value) || !is.numeric(redaspect_value)) {
    x_value <- "OTHER"
  } else {
    x_value <- if (greenaspect_value > redaspect_value) redaspect_value else greenaspect_value
  }
  
  # Compute x standard deviation
  if (!is.numeric(greenaspect_value) || !is.numeric(redaspect_value)) {
    x_sd <- "OTHER"
  } else {
    if (greenaspect_value > redaspect_value) {
      A_vals <- safe_numeric2(row, c("co_minred", "co_medred", "co_maxred"))
      B_vals <- safe_numeric2(row, c("red_min", "red_med", "red_max"))
      if (is.null(A_vals) || is.null(B_vals)) {
        x_sd <- "OTHER"
      } else {
        A <- mean(A_vals)
        B <- mean(B_vals)
        if (A == 0 || B == 0) {
          x_sd <- "OTHER"
        } else {
          sd_A <- pop_sd(A_vals)
          sd_B <- pop_sd(B_vals)
          x_sd <- sqrt((A^2 * sd_B^2) + (B^2 * sd_A^2)) / (log(2) * A * B)
        }
      }
    } else {
      A_vals <- safe_numeric2(row, c("co_mingreen", "co_medgreen", "co_maxgreen"))
      B_vals <- safe_numeric2(row, c("green_min", "green_med", "green_max"))
      if (is.null(A_vals) || is.null(B_vals)) {
        x_sd <- "OTHER"
      } else {
        A <- mean(A_vals)
        B <- mean(B_vals)
        if (A == 0 || B == 0) {
          x_sd <- "OTHER"
        } else {
          sd_A <- pop_sd(A_vals)
          sd_B <- pop_sd(B_vals)
          x_sd <- sqrt((A^2 * sd_B^2) + (B^2 * sd_A^2)) / (log(2) * A * B)
        }
      }
    }
  }
  
  # Compute y value (larger of green and red aspect values)
  if (!is.numeric(greenaspect_value) || !is.numeric(redaspect_value)) {
    y_value <- "OTHER"
  } else {
    y_value <- if (greenaspect_value > redaspect_value) greenaspect_value else redaspect_value
  }
  
  # Compute y standard deviation
  if (!is.numeric(greenaspect_value) || !is.numeric(redaspect_value)) {
    y_sd <- "OTHER"
  } else {
    if (greenaspect_value > redaspect_value) {
      A_vals <- safe_numeric2(row, c("co_mingreen", "co_medgreen", "co_maxgreen"))
      B_vals <- safe_numeric2(row, c("green_min", "green_med", "green_max"))
      if (is.null(A_vals) || is.null(B_vals)) {
        y_sd <- "OTHER"
      } else {
        A <- mean(A_vals)
        B <- mean(B_vals)
        if (A == 0 || B == 0) {
          y_sd <- "OTHER"
        } else {
          sd_A <- pop_sd(A_vals)
          sd_B <- pop_sd(B_vals)
          y_sd <- sqrt((A^2 * sd_B^2) + (B^2 * sd_A^2)) / (log(2) * A * B)
        }
      }
    } else {
      A_vals <- safe_numeric2(row, c("co_minred", "co_medred", "co_maxred"))
      B_vals <- safe_numeric2(row, c("red_min", "red_med", "red_max"))
      if (is.null(A_vals) || is.null(B_vals)) {
        y_sd <- "OTHER"
      } else {
        A <- mean(A_vals)
        B <- mean(B_vals)
        if (A == 0 || B == 0) {
          y_sd <- "OTHER"
        } else {
          sd_A <- pop_sd(A_vals)
          sd_B <- pop_sd(B_vals)
          y_sd <- sqrt((A^2 * sd_B^2) + (B^2 * sd_A^2)) / (log(2) * A * B)
        }
      }
    }
  }
  
  # Determine red-to-green and green-to-red interactions based on q-values and aspect values
  greenq <- safe_numeric1(row["greenqvalue"])
  greenaspect <- greenaspect_value
  if (is.null(greenq) || is.null(greenaspect)) {
    red_to_green <- "OTHER"
  } else if (greenq > 0.05 || greenaspect == 0) {
    red_to_green <- "0"
  } else if (greenq <= 0.05 && greenaspect > 0) {
    red_to_green <- "+"
  } else if (greenq <= 0.05 && greenaspect < 0) {
    red_to_green <- "-"
  } else {
    red_to_green <- "ERROR"
  }
  
  redq <- safe_numeric1(row["redqvalue"])
  redaspect <- redaspect_value
  if (is.null(redq) || is.null(redaspect)) {
    green_to_red <- "OTHER"
  } else if (redq > 0.05 || redaspect == 0) {
    green_to_red <- "0"
  } else if (redq <= 0.05 && redaspect > 0) {
    green_to_red <- "+"
  } else if (redq <= 0.05 && redaspect < 0) {
    green_to_red <- "-"
  } else {
    green_to_red <- "ERROR"
  }
  
  # Determine interaction type and plot hierarchy
  Type <- compute_type(red_to_green, green_to_red)
  plot_hierarchy <- compute_plot_hierarchy(Type)
  
  # Return computed values as a vector
  return(c(
    greenaspect_value = greenaspect_value,
    redaspect_value = redaspect_value,
    theta_value = theta_value,
    x_value = x_value,
    x_sd = x_sd,
    y_value = y_value,
    y_sd = y_sd,
    red_to_green = red_to_green,
    green_to_red = green_to_red,
    Type = Type,
    plot_hierarchy = plot_hierarchy
  ))
}

# Apply compute_row function to each row in the dataframe
new_cols <- lapply(1:nrow(all_sample_df), function(i) compute_row(all_sample_df[i, ]))

# Combine results into a new data frame
new_cols <- do.call(rbind, new_cols)
new_cols <- as.data.frame(new_cols, stringsAsFactors = FALSE)

# Combine new columns with the original dataframe
all_sample_df <- cbind(all_sample_df, new_cols)
```

## Pick up OD data
```{r}
# Function to extract OD values from 96-well plate data
FilterMaxOD96read <- function(plate_basic_name, plate_id, hour, env1, env2, strain, carbon1, carbon2, test, monoculture_fluorescence, monoculture_strain) {
  od <- c()
  id <- c()
  plate_name <- paste(plate_basic_name, plate_id, "_", hour, "h.csv", sep = "")
  d <- data.frame(read.csv(plate_name))
  
  # Extract OD values from the 96-well format (8 rows × 12 columns)
  for (i in 1:12) {
    for (j in 1:8) {
      od <- c(od, as.numeric(d[j, i + 1]))
    }
  }
  
  h96 <- rep(hour, 96)
  environment96 <- c(rep(env1, 48), rep(env2, 48))
  carbon96 <- c(rep(carbon1, 48), rep(carbon2, 48))
  index <- 1:96
  
  # Construct data frame for OD measurements
  ODdf <- data.frame(
    "OD" = as.numeric(od),
    "hour" = as.numeric(h96),
    "strain" = strain,
    "env" = environment96,
    "well_index" = index,
    "platehour" = paste(plate_basic_name, plate_id, "-hour", hour, "_", index),
    "plateindex" = paste(plate_basic_name, plate_id, index),
    "carbon" = carbon96,
    "test" = test,
    "monoculture_fluorescence" = monoculture_fluorescence,
    "monoculture_strain" = monoculture_strain,
    stringsAsFactors = FALSE
  )
  
  return(ODdf)
}

# Initialize result data frame
ODdf <- data.frame()
env_list <- info$environment_list

# Co-culture: uniform strain and fluorescence labels
strain <- info$coculture_platedesign[1:96]
monoculture_fluorescence <- rep("coculture", 96)
monoculture_strain <- rep("coculture", 96)

# Read 0–72 hour data for co-culture plates 1–32
for (i in 0:24) {
  for (j in 1:32) {
    temp_i <- if (i * 3 < 10) { paste("0", i * 3, sep = "") } else { i * 3 }
    temp_j <- if (j < 10) { paste("0", j, sep = "") } else { j }

    env1 <- env_list[j]
    env2 <- env_list[j]
    carbon1 <- env1
    carbon2 <- env2

    ODdf <- rbind(ODdf, FilterMaxOD96read("Ono_plate", temp_j, temp_i, env1, env2, strain, carbon1, carbon2, "coculture", monoculture_fluorescence, monoculture_strain))
  }
}

# Monoculture plates 33–48
strain <- info$monoculture_platedesign
monoculture_fluorescence <- info$monoculture_fluorescence_list
monoculture_strain <- info$monoculture_platedesign

for (i in 0:24) {
  for (j in 33:48) {
    temp_i <- if (i * 3 < 10) { paste("0", i * 3, sep = "") } else { i * 3 }
    temp_j <- if (j < 10) { paste("0", j, sep = "") } else { j }

    env1 <- env_list[((j - 32) * 2)]
    env2 <- env_list[((j - 32) * 2 - 1)]
    carbon1 <- env1
    carbon2 <- env2

    ODdf <- rbind(ODdf, FilterMaxOD96read("Ono_plate", temp_j, temp_i, env1, env2, strain, carbon1, carbon2, "coculture", monoculture_fluorescence, monoculture_strain))
  }
}

# Monoculture test plates 49–72
env_list <- info$monoculture_test_environment_list
carbon_list <- info$monoculture_test_carbon_list

for (i in 0:24) {
  for (j in 49:72) {
    temp_i <- if (i * 3 < 10) { paste("0", i * 3, sep = "") } else { i * 3 }
    temp_j <- if (j < 10) { paste("0", j, sep = "") } else { j }

    env1 <- env_list[((j - 48) * 2 - 1)]
    env2 <- env_list[((j - 48) * 2)]
    carbon1 <- carbon_list[((j - 48) * 2 - 1)]
    carbon2 <- carbon_list[((j - 48) * 2)]

    ODdf <- rbind(ODdf, FilterMaxOD96read("Ono_plate", temp_j, temp_i, env1, env2, strain, carbon1, carbon2, "monoculture", monoculture_fluorescence, monoculture_strain))
  }
}

# Assign final OD values to each FCS sample
all_sample_df$final_OD <- "Not Available"

for (i in 1:nrow(all_sample_df)) {
  if (all_sample_df$concentration[i] == 0.5) {
    env_temp <- paste(all_sample_df$environment[i], "0.5 mg/mL")
  } else if (all_sample_df$concentration[i] == 1.0) {
    env_temp <- all_sample_df$environment[i]
  }

  tempOD <- ODdf[
    ODdf$env == env_temp &
    ODdf$strain == all_sample_df$bacteria[i] &
    ODdf$well_index == all_sample_df$well_index[i] &
    ODdf$hour == 72, ]

  if (length(tempOD$OD) == 1) {
    all_sample_df$final_OD[i] <- tempOD$OD[1]
  }
}
```

## temp
```{r}
all_sample_df_3 <- all_sample_df
```

# Analysis
## Fig.1
### Fig.1C
```{r}
# Create data frames for GFP and mScarlet conditions
tempDFG <- data.frame(
  tempx = c("1mono", "1mono", "1mono", "2co", "2co", "2co"),
  tempy = c(4 - 0.6, 4 + 0.2, 4 + 0.4, 6 + 0.8, 6 - 0.2, 6 - 0.6)
)

tempDFR <- data.frame(
  tempx = c("1mono", "1mono", "1mono", "2co", "2co", "2co"),
  tempy = c(8 - 0.9, 8 + 0.2, 8 + 0.7, 2 + 0.4, 2 - 0.3, 2 - 0.1)
)

# Create a bar plot for GFP condition
g <- ggplot(data = tempDFG, mapping = aes(x = tempx, y = tempy)) +
  geom_bar(stat = "summary", fun = "mean", width = 0.6, fill = color_fluorescent$GFP) + 
  geom_point(size = 5, color = "grey20") +
  scale_y_continuous(
    limits = c(0, 20),
    expand = c(0, 0),
    breaks = c(0, 4, 8, 12, 16, 20)
  ) +
  theme_classic() +
  theme(
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    plot.margin = margin(t = 10, r = 150, b = 0, l = 150, unit = "pt"),
    legend.position = "none"
  )

ggsave(file = "Fig1C_GFP_cell_density_barplot.pdf", plot = g)
g

# Create a bar plot for mScarlet condition
g <- ggplot(data = tempDFR, mapping = aes(x = tempx, y = tempy)) +
  geom_bar(stat = "summary", fun = "mean", width = 0.6, fill = color_fluorescent$mScarlet) +
  geom_point(size = 5, color = "grey20") +
  scale_y_continuous(
    limits = c(0, 20),
    expand = c(0, 0),
    breaks = c(0, 4, 8, 12, 16, 20)
  ) +
  theme_classic() +
  theme(
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    plot.margin = margin(t = 10, r = 150, b = 0, l = 150, unit = "pt"),
    legend.position = "none",
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA)
  )

ggsave(file = "Fig1C_mScarlet_cell_density_barplot.pdf", plot = g)
g
```

### Fig.1D
```{r}
# Define example data frames
sample <- data.frame(x1 = -8, y1 = log(3/2, base = 2) * 4, col = "point_data", fil = "point_data")
sample2 <- data.frame(x1 = c(0, -8), y1 = c(0, log(3/2, base = 2) * 4), col = "line_data")

# Define boundary lines for interaction visualization
df1 <- data.frame(x1 = -15, y1 = -15, x2 = 15, y2 = 15)
df2 <- data.frame(x1 = -14, y1 = 14, x2 = 0, y2 = 0)
df3 <- data.frame(x1 = -14.5, y1 = 0, x2 = 15, y2 = 0)
df4 <- data.frame(x1 = 0, y1 = 14.5, x2 = 0, y2 = -15)

# Define different interaction types with their respective colors
dfMutualism <- data.frame(x1 = 15, y1 = 14.5, x2 = 1, y2 = 14.5, col = "Mutualism")
dfCommensalism <- data.frame(x1 = 1, y1 = 14.5, x2 = -1, y2 = 14.5, col = "Commensalism")
dfParasitism1 <- data.frame(x1 = -1, y1 = 14.5, x2 = -15, y2 = 14.5, col = "Parasitism")
dfParasitism2 <- data.frame(x1 = -14.5, y1 = 15, x2 = -14.5, y2 = 1, col = "Parasitism")
dfAmensalism <- data.frame(x1 = -14.5, y1 = 1, x2 = -14.5, y2 = -1, col = "Amensalism")
dfCompetition <- data.frame(x1 = -14.5, y1 = -1, x2 = -14.5, y2 = -15, col = "Competition")
dfW1 <- data.frame(x1 = -14.5, y1 = -15.5, x2 = -12, y2 = -13, col = "White_data")
dfW2 <- data.frame(x1 = 15.5, y1 = 14.5, x2 = 13, y2 = 12, col = "White_data")

# Data for plotting x and y labels
dfx <- data.frame(x1 = c(4, 8, 12), y1 = c(0, 0, 0), lab = c("1", "2", "3"))
dfy <- data.frame(x1 = c(0, 0, 0), y1 = c(-12, -8, -4), lab = c("-3", "-2", "-1"))

# Define tick marks for the x and y axes
dfxtick <- data.frame(x1 = c(-12, -12, -8, -8, -4, -4, 0, 0, 4, 4, 8, 8, 12, 12),
                      y1 = c(0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2),
                      lab = c("-12", "-12", "-8", "-8", "-4", "-4", "0", "0", "4", "4", "8", "8", "12", "12"),
                      col = "Y")
dfytick <- data.frame(x1 = c(0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2),
                      y1 = c(-12, -12, -8, -8, -4, -4, 0, 0, 4, 4, 8, 8, 12, 12),
                      lab = c("-12", "-12", "-8", "-8", "-4", "-4", "0", "0", "4", "4", "8", "8", "12", "12"),
                      col = "Y")

# Function to create a circle shape for plotting
circleFun <- function(center = c(0, 0), diameter = 1, npoints = 1000) {
  r <- diameter / 2
  tt <- seq(3/4 * pi, (atan(2/log(3/2, base = 2)) + 1/2 * pi), length.out = npoints)
  xx <- center[1] + r * cos(tt)
  yy <- center[2] + r * sin(tt)
  data.frame(x = xx, y = yy)
}

# Generate circle data for plot
dat <- circleFun(c(0, 0), 4, npoints = 1000)

# Create the base plot with various interaction types represented by segments
g1 <- ggplot() +
  # Draw interaction lines for various categories
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey80", data = df3, linewidth = 0.5, linetype = "solid", show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey80", data = df4, linewidth = 0.5, linetype = "solid", show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfMutualism, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfCommensalism, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfParasitism1, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfParasitism2, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfAmensalism, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfCompetition, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfW1, linewidth = 5 * sqrt(2), show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfW2, linewidth = 5 * sqrt(2), show.legend = NA) +
  # Draw lines
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey20", data = df1, linewidth = 0.75, show.legend = NA) +
  geom_segment(aes(x = x2, y = y2, xend = x1, yend = y1),
               color = "grey20", data = df2, linewidth = 0.5, linetype = "dashed", show.legend = NA) +
  # Add labels for x and y axis
  geom_text(data = dfx, aes(x = x1, y = y1 + 1, label = lab), show.legend = NA) +
  geom_line(data = dfxtick, aes(x = x1, y = y1, group = lab, color = col), show.legend = NA) +
  geom_text(data = dfy, aes(x = x1 + 1, y = y1, label = lab), show.legend = NA) +
  geom_line(data = dfytick, aes(x = x1, y = y1, group = lab, color = col), show.legend = NA) +
  # Add sample data
  geom_line(data = sample2, aes(x = x1, y = y1), color = "grey20", show.legend = NA) +
  geom_point(data = sample, aes(x = as.numeric(x1), y = as.numeric(y1)),
             color = color_interaction$parasitism, fill = "white", shape = 21, stroke = 1, size = 2, alpha = 1,
             stat = "identity", position = "identity", na.rm = FALSE, show.legend = NA, inherit.aes = TRUE)

# Define error data frames
errorDFx <- data.frame(x1 = (-2 - 0.24417729) * 4, y1 = log(3/2, base = 2) * 4, x2 = (-2 + 0.24417729) * 4, y2 = log(3/2, base = 2) * 4)
errorDFy <- data.frame(x1 = -2 * 4, y1 = (log(3/2, base = 2) - 0.216404256) * 4, x2 = -2 * 4, y2 = (log(3/2, base = 2) + 0.216404256) * 4)

# Add error segments
g1 <- g1 + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "grey20", alpha = 0.4, data = errorDFx, linewidth = 0.4, linetype = "solid")
g1 <- g1 + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "grey20", alpha = 0.4, data = errorDFy, linewidth = 0.4, linetype = "solid")

# Final plot customization
g1 <- g1 +
  geom_point(data = sample, aes(x = as.numeric(x1), y = as.numeric(y1)),
             color = color_interaction$parasitism, shape = 21, stroke = 1, size = 2, alpha = 1,
             stat = "identity", position = "identity", na.rm = FALSE, show.legend = NA, inherit.aes = TRUE) +
  geom_path(data = dat, aes(x = x, y = y), color = "grey20") +
  scale_x_continuous(limits = c(-15.5, 15.5), expand = c(0, 0)) +
  scale_y_continuous(limits = c(-15.5, 15.5), expand = c(0, 0)) +
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE) +
  scale_color_manual(values=c(color_interaction$amensalism,color_interaction$commensalism,color_interaction$competition,color_interaction$mutualism,color_interaction$parasitism,"White","grey80",color_interaction$mutualism))+
  theme_void() +
  theme(legend.position = "none")

# Display and save the plot
plot(g1)
ggsave(file = "Fig1E.pdf", plot = g1)
```


## Fig.2
### Fig.2A, Fig.2B
```{r}
# Fig.2A
# Construct theta plot dataframe for each coculture bacteria and environment (single carbon source)
thetaplot_df <- data.frame()
for (i in 1:28) {
  for (j in 1:16) {
    temp <- all_sample_df[all_sample_df$experiment == "main", ]
    temp <- temp[temp$bacterial_species_count == 2, ]
    temp <- temp[temp$bacteria == info$coculture_bacteria_list[i], ]
    temp <- temp[temp$environment == info$environment_list[j], ]
    
    thetaplot_df <- rbind(thetaplot_df, data.frame(
      bacteria = info$coculture_bacteria_list[i],
      environment = info$environment_list[j],
      nc = as.numeric(temp$carbonsource_species_count)[1],
      x_value = as.numeric(temp$x_value)[1],
      x_sd = as.numeric(temp$x_sd)[1],
      y_value = as.numeric(temp$y_value)[1],
      y_sd = as.numeric(temp$y_sd)[1],
      theta_value = as.numeric(temp$theta_value)[1],
      Type = temp$Type[1],
      plot_hierarchy = temp$plot_hierarchy[1]
    ))
  }
}

thetaplot_df0 <- thetaplot_df[thetaplot_df$plot_hierarchy == 0, ]
thetaplot_df1 <- thetaplot_df[thetaplot_df$plot_hierarchy == 1, ]
thetaplot_df2 <- thetaplot_df[thetaplot_df$plot_hierarchy == 2, ]

# Axes and guides for the plot
df1 <- data.frame(x1 = -12, y1 = -12, x2 = 12, y2 = 12)
df2 <- data.frame(x1 = -12, y1 = 12, x2 = 0, y2 = 0)
df3 <- data.frame(x1 = -12, y1 = 0, x2 = 12, y2 = 0)
df4 <- data.frame(x1 = 0, y1 = 12, x2 = 0, y2 = -12)

# Ticks and labels
dfx <- data.frame(x1 = c(-8, -4, 0, 4, 8), y1 = rep(0, 5), lab = c("-8", "-4", "0", "4", "8"))
dfy <- data.frame(x1 = rep(0, 5), y1 = c(-8, -4, 0, 4, 8), lab = c("-8", "-4", "0", "4", "8"))
dfxtick <- data.frame(
  x1 = c(-8, -8, -4, -4, 0, 0, 4, 4, 8, 8),
  y1 = c(0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2),
  lab = rep(c("-8", "-4", "0", "4", "8"), each = 2),
  col = "Y"
)
dfxtick_2 <- data.frame(
  x1 = c(-8, -8, -4, -4, 4, 4, 8, 8),
  y1 = c(0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2),
  lab = rep(c("-8", "-4", "4", "8"), each = 2),
  col = "Y"
)
dfytick <- data.frame(
  x1 = c(0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2),
  y1 = c(-8, -8, -4, -4, 0, 0, 4, 4, 8, 8),
  lab = rep(c("-8", "-4", "0", "4", "8"), each = 2),
  col = "Y"
)
dfytick_2 <- data.frame(
  x1 = c(0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2),
  y1 = c(-8, -8, -4, -4, 4, 4, 8, 8),
  lab = rep(c("-8", "-4", "4", "8"), each = 2),
  col = "Y"
)

# Create base
g <- ggplot() +
  geom_segment(aes(x = x1, y = y1 - 12, xend = x2, yend = y2 - 12), color = "grey80", data = df3, linewidth = 0.8) +
  geom_segment(aes(x = x1 - 12, y = y1, xend = x2 - 12, yend = y2), color = "grey80", data = df4, linewidth = 0.8) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2), color = "grey80", data = df3, linewidth = 0.8) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2), color = "grey80", data = df4, linewidth = 0.8) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2), color = "black", data = df1, linewidth = 1) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2), color = "black", data = df2, linewidth = 0.8, linetype = "dashed") +
  geom_text(data = dfx, aes(x = x1, y = y1 - 13.2, label = lab), size = 9) +
  geom_line(data = dfxtick_2, aes(x = x1, y = y1, group = lab), linewidth = 0.8, color = "grey80") +
  geom_line(data = dfxtick, aes(x = x1, y = y1 - 12, group = lab), linewidth = 0.8, color = "grey80") +
  geom_text(data = dfy, aes(x = x1 - 13.5, y = y1, label = lab), size = 9) +
  geom_line(data = dfytick_2, aes(x = x1, y = y1, group = lab), linewidth = 0.8, color = "grey80") +
  geom_line(data = dfytick, aes(x = x1 - 12, y = y1, group = lab), linewidth = 0.8, color = "grey80")

# Add error bars for each point
for (i in 1:nrow(thetaplot_df)) {
  temp <- thetaplot_df[i, ]
  errorDFx <- data.frame(x1 = temp$x_value - temp$x_sd, y1 = temp$y_value,
                         x2 = temp$x_value + temp$x_sd, y2 = temp$y_value)
  errorDFy <- data.frame(x1 = temp$x_value, y1 = temp$y_value - temp$y_sd,
                         x2 = temp$x_value, y2 = temp$y_value + temp$y_sd)
  g <- g +
    geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2), data = errorDFx, color = "black", alpha = 0.2, linewidth = 0.3) +
    geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2), data = errorDFy, color = "black", alpha = 0.2, linewidth = 0.3)
}

# Add points
g <- g +
  geom_point(data = thetaplot_df0, aes(x = x_value, y = y_value, color = as.factor(Type)), shape = 21, stroke = 0.75, size = 1.5) +
  geom_point(data = thetaplot_df1, aes(x = x_value, y = y_value, color = as.factor(Type)), shape = 21, stroke = 0.75, size = 1.5) +
  geom_point(data = thetaplot_df2, aes(x = x_value, y = y_value, color = as.factor(Type)), shape = 21, stroke = 0.75, size = 1.5) +
  scale_x_continuous(limits = c(-14.5, 12), expand = c(0, 0)) +
  scale_y_continuous(limits = c(-14.5, 12), expand = c(0, 0)) +
  coord_fixed(ratio = 1) +
  scale_color_manual(values = c(
    color_interaction$amensalism,
    color_interaction$commensalism,
    color_interaction$competition,
    color_interaction$mutualism,
    color_interaction$neutral,
    color_interaction$parasitism
  )) +
  theme_void() +
  theme(legend.position = "none")

ggsave(file = "Fig2A.pdf", plot = g)
plot(g)

# Fig.2B
# Reorder the factor levels of interaction types
thetaplot_df <- transform(thetaplot_df, Type = factor(Type, levels = info$interaction_types_list))

# Count the number of occurrences for each interaction type
count <- data.frame()
for (i in 6:1) {
  count <- rbind(count, data.frame(
    x1 = 1,
    count1 = length(thetaplot_df[thetaplot_df$Type == info$interaction_types_list[i], ]$Type),
    Type = info$interaction_types_list[i]
  ))
}

# Create percentage labels and normalized ratios
c_vec <- c()
c1_vec <- c()
for (i in 1:6) {
  ratio <- count$count1[i] / sum(count$count1)
  label <- if (ratio < 0.1) {
    paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
  } else {
    paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
  }
  c_vec <- c(c_vec, label)
  c1_vec <- c(c1_vec, ratio)
}

# Add new columns for label and normalized count
count <- cbind(count, c = c_vec, c1 = c1_vec)

# Ensure factor level order is preserved
count <- transform(count, Type = factor(Type, levels = info$interaction_types_list))

# Calculate label positions for stacked bar
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

# Plot stacked bar with percentages
g <- ggplot(data = count, aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 6, hjust = -1) +
  theme_void() +
  scale_fill_manual(values = c(
    color_interaction$mutualism,
    color_interaction$commensalism,
    color_interaction$parasitism,
    color_interaction$amensalism,
    color_interaction$competition,
    color_interaction$neutral
  ))

# Save and display the plot
ggsave(file = "Fig2B.pdf", plot = g)
plot(g)
```

### Fig.2C, Fig.2D
```{r}
# Define strain order for plotting
my_strain <- info$bacteria_list_Phylogenetic[8:1]

# Define interaction types and their corresponding colors
my_type <- c("Mutualism", "Commensalism", "Parasitism", "Amensalism", "Competition", "Neutral")
my_cmap <- c(color_interaction$mutualism, color_interaction$commensalism, color_interaction$parasitism, 
             color_interaction$amensalism, color_interaction$competition, color_interaction$neutral)

# Create color dataframe for interactions
my_color_df <- data.frame(interaction_type = my_type, color = my_cmap)
my_color_df$interaction_type <- factor(my_color_df$interaction_type, levels = my_type)
my_color_df <- my_color_df[order(my_color_df$interaction_type), ]
my_color_df$level <- rep(1, nrow(my_color_df))

# Collect theta values
thetaplot_df <- data.frame()

for (i in 1:28) {
  for (j in 1:32) {
    temp <- all_sample_df[all_sample_df$experiment == "main", ]
    temp <- temp[temp$bacterial_species_count == 2, ]
    temp <- temp[temp$bacteria == info$coculture_bacteria_list[i], ]
    temp <- temp[temp$environment == info$environment_list[j], ]
    
    # Append relevant values to thetaplot_df
    thetaplot_df <- rbind(thetaplot_df, data.frame(
      bacteria = info$coculture_bacteria_list[i],
      coculture_species_GFP = temp$coculture_species_GFP[1],
      coculture_species_mScarlet = temp$coculture_species_mScarlet[1],
      environment = info$environment_list[j],
      nc = as.numeric(temp$carbonsource_species_count)[1],
      x_value = as.numeric(temp$x_value)[1],
      x_sd = as.numeric(temp$x_sd)[1],
      y_value = as.numeric(temp$y_value)[1],
      y_sd = as.numeric(temp$y_sd)[1],
      theta_value = as.numeric(temp$theta_value)[1],
      interaction_type = temp$Type[1],
      plot_hierarchy = temp$plot_hierarchy[1]
    ))
  }
}

# Function to generate interaction map for a specific carbon source
pairintmap <- function(carbon) {
  fnc_intmap <- thetaplot_df[thetaplot_df$environment == carbon, ]
  
  # Set factor levels
  fnc_intmap$coculture_species_GFP <- factor(fnc_intmap$coculture_species_GFP, levels = my_strain)
  fnc_intmap$coculture_species_mScarlet <- factor(fnc_intmap$coculture_species_mScarlet, levels = my_strain)
  fnc_intmap$interaction_type <- factor(fnc_intmap$interaction_type, levels = my_type)
  
  # Create concat identifiers for each pair
  fnc_intmap$ConcatGR <- paste(fnc_intmap$coculture_species_GFP, fnc_intmap$coculture_species_mScarlet, sep = "_")
  fnc_fillcolor <- my_color_df[my_color_df$interaction_type %in% fnc_intmap$interaction_type, ]$color
  
  # Generate all possible strain combinations
  fnc_df <- as.data.frame(t(combn(my_strain, m = 2)))
  colnames(fnc_df) <- c("Strain_A", "Strain_B")
  fnc_df$Strain_A <- factor(fnc_df$Strain_A, levels = my_strain)
  fnc_df$Strain_B <- factor(fnc_df$Strain_B, levels = my_strain)
  fnc_df$ConcatAB <- paste(fnc_df$Strain_A, fnc_df$Strain_B, sep = "_")
  fnc_df$ConcatBA <- paste(fnc_df$Strain_B, fnc_df$Strain_A, sep = "_")
  
  # Join interaction types for both AB and BA directions
  fnc_temp <- fnc_intmap %>% select(ConcatGR, interaction_type)
  colnames(fnc_temp) <- c("ConcatAB", "TypeAB")
  fnc_temp$TypeAB <- as.character(fnc_temp$TypeAB)
  fnc_df <- left_join(fnc_df, fnc_temp)
  
  fnc_temp <- fnc_intmap %>% select(ConcatGR, interaction_type)
  colnames(fnc_temp) <- c("ConcatBA", "TypeBA")
  fnc_temp$TypeBA <- as.character(fnc_temp$TypeBA)
  fnc_df <- left_join(fnc_df, fnc_temp)
  
  # Choose whichever direction (AB or BA) has non-NA type
  fnc_df$Type <- NA
  for (i in 1:nrow(fnc_df)) {
    if (!is.na(fnc_df$TypeAB[i])) {
      fnc_df$Type[i] <- fnc_df$TypeAB[i]
    } else {
      fnc_df$Type[i] <- fnc_df$TypeBA[i]
    }
  }
  
  # Filter and factorize for plotting
  fnc_df <- fnc_df[!is.na(fnc_df$Type), ]
  fnc_df$Type <- factor(fnc_df$Type, levels = my_type)
  
  # Generate the heatmap
  p <- ggplot(fnc_df, aes(x = Strain_A, y = Strain_B, fill = Type)) +
    geom_tile(colour = "white", size = 0.2) +
    scale_fill_manual(values = fnc_fillcolor) +
    guides(fill = guide_legend(title = "")) +
    coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE) +
    scale_x_discrete(expand = expansion(mult = c(0.1, 0)), guide = guide_axis(angle = 90), position = "top") +
    theme_pubr(legend = "right") +
    theme(
      legend.position = "none",
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.line = element_line(size = 2, lineend = "square", color = "grey20"),
      axis.ticks.length = unit(3, "mm"),
      axis.ticks = element_line(size = 2, lineend = "square", color = "grey20")
    )
  
  return(p)
}

# Save plots
ggsave(file = "Fig2C.pdf", plot = pairintmap("Raffinose"))
ggsave(file = "Fig2D.pdf", plot = pairintmap("Succinate"))

# Print plots to device
pairintmap("Raffinose")
pairintmap("Succinate")
```

### Fig.2E, Fig.2F
```{r}
# Filtering data based on conditions
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 2 &
                                    all_sample_df$carbonsource_species_count == 1 &
                                    all_sample_df$experiment == "main",]

# Bacteria processing
tempB <- data.frame()
for (i in 1:28) {
  tempB <- rbind(tempB, data.frame(bacteria = info$coculture_bacteria_list[i],
                                   mean = mean(as.numeric(all_sample_df_temp[all_sample_df_temp$bacteria == info$coculture_bacteria_list[i],]$theta_value))))
}
tempB <- tempB$bacteria[order(tempB$mean)]

# Clean up bacteria names
tempB <- str_remove_all(tempB, "_GFP|_mScarlet| Tn5")

# Environment processing
tempE <- data.frame()
for (i in 1:16) {
  tempE <- rbind(tempE, data.frame(environment = info$environment_list[i],
                                   mean = mean(as.numeric(all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i],]$theta_value))))
}
tempE <- tempE$environment[order(tempE$mean)]

# Count data
count <- data.frame()
for (i in 6:1) {
  for (j in 1:28) {
    temp <- all_sample_df_temp[all_sample_df_temp$bacteria == info$coculture_bacteria_list[j],]
    count <- rbind(count, data.frame(bac = info$coculture_bacteria_list[j],
                                     count1 = length(temp[temp$Type == info$interaction_types_list[i],]$Type),
                                     Type = info$interaction_types_list[i]))
  }
}

# Prepare count data
countDF <- data.frame()
for (j in 1:28) {
  tempcount <- data.frame(dammy = c(1:6))
  c1 <- c()
  for (i in 1:6) {
    temp <- count[count$bac == info$coculture_bacteria_list[j],]
    c1 <- c(c1, temp$count1[i] / sum(temp$count1))
  }
  env1 <- rep(info$coculture_bacteria_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}

# Clean up environment names
countDF$env1 <- str_remove_all(countDF$env1, "_GFP|_mScarlet| Tn5")
countDF <- countDF[countDF$c1 != 0,]

# Plot for bacteria
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = tempB)) 

g <- ggplot(data = countDF, mapping = aes(x = as.factor(env1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.75) +
  theme_pubr(legend = "none") +
  scale_y_continuous(labels = scales::percent, breaks = c(0, 0.5, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_interaction$mutualism, color_interaction$commensalism,
                               color_interaction$parasitism, color_interaction$amensalism,
                               color_interaction$competition, color_interaction$neutral)) +
  theme(title = element_blank(), axis.text.x = element_text(size = 11), axis.text.y = element_text(size = 12),
        axis.title.x = element_blank(), axis.title.y = element_blank(), plot.margin = margin(t = 180, r = 0, b = 0, l = 0, unit = "pt"),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20")) +
  scale_x_discrete(guide = guide_axis(angle = 90))

ggsave(file = "Fig2F.pdf", plot = g)
plot(g)

# Repeat for environment
count <- data.frame()
for (i in 6:1) {
  for (j in 1:16) {
    temp <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[j],]
    count <- rbind(count, data.frame(env = info$environment_list[j],
                                     count1 = length(temp[temp$Type == info$interaction_types_list[i],]$Type),
                                     Type = info$interaction_types_list[i]))
  }
}

countDF <- data.frame()
for (j in 1:16) {
  tempcount <- data.frame(dammy = c(1:6))
  c1 <- c()
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j],]
    c1 <- c(c1, temp$count1[i] / sum(temp$count1))
  }
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}

countDF <- countDF[countDF$c1 != 0,]
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = tempE)) 

g <- ggplot(data = countDF, mapping = aes(x = as.factor(env1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.75) +
  theme_pubr(legend = "none") +
  scale_y_continuous(labels = scales::percent, breaks = c(0, 0.5, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_interaction$mutualism, color_interaction$commensalism,
                               color_interaction$parasitism, color_interaction$amensalism,
                               color_interaction$competition, color_interaction$neutral)) +
  theme(title = element_blank(), axis.text = element_text(size = 12), axis.title.x = element_blank(),
        axis.title.y = element_blank(), plot.margin = margin(t = 180, r = 209, b = 0, l = 0, unit = "pt"),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20")) +
  scale_x_discrete(guide = guide_axis(angle = 90))

ggsave(file = "Fig2E.pdf", plot = g)
plot(g)
```

## Fig.3
### Fig.3A
```{r}
# Subset for 2 species communities in the main experiment
all_sample_df_temp <- all_sample_df[
  all_sample_df$bacterial_species_count == 2 & 
  all_sample_df$experiment == "main", 
]

# Count interaction types for each environment in main set (1 carbon source environments)
infoc <- transform(all_sample_df_temp, Type = factor(Type, levels = info$interaction_types_list))
count <- data.frame()

for (i in 6:1) {
  for (j in 1:16) {
    temp <- infoc[infoc$environment == info$environment_list[j], ]
    temp <- subset(temp, !is.na(temp$fcs_file))
    
    count <- rbind(count, data.frame(
      env = info$environment_list[j],
      count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
      Type = info$interaction_types_list[i]
    ))
  }
}

# Calculate proportions and text labels for plotting
countDF <- data.frame()

for (j in 1:16) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    
    c <- c(c, if (ratio < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    
    c1 <- c(c1, ratio)
  }
  
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}

# Format for plotting
countDF <- subset(countDF, c1 != 0)
countDF <- transform(countDF, 
                     Type = factor(Type, levels = info$interaction_types_list),
                     env1 = factor(env1, levels = info$environment_list[16:1]))

# Plot for main environments (1 carbon source environments)
g1 <- ggplot() +
  geom_bar(data = countDF,
           mapping = aes(x = as.factor(env1), y = c1, fill = Type),
           stat = "identity", position = "fill", width = 0.75) +
  theme_minimal() +
  scale_y_continuous(position = "right", labels = scales::percent,
                     breaks = c(0, 0.5, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(
    color_interaction$mutualism,
    color_interaction$commensalism,
    color_interaction$parasitism,
    color_interaction$amensalism,
    color_interaction$competition,
    color_interaction$neutral
  )) +
  coord_flip()

# Count interaction types for additional environments (2 carbon source environments)
infoc <- transform(all_sample_df_temp, Type = factor(Type, levels = info$interaction_types_list))
count <- data.frame()

for (i in 6:1) {
  for (j in 17:24) {
    temp <- infoc[infoc$environment == info$environment_list[j], ]
    temp <- subset(temp, !is.na(temp$fcs_file))
    
    count <- rbind(count, data.frame(
      env = info$environment_list[j],
      count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
      Type = info$interaction_types_list[i]
    ))
  }
}

# Calculate proportions and labels for additional environments
countDF <- data.frame()

for (j in 17:24) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    
    c <- c(c, if (ratio < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    
    c1 <- c(c1, ratio)
  }
  
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}

# Format for plotting
countDF <- subset(countDF, c1 != 0)
countDF <- transform(countDF, 
                     Type = factor(Type, levels = info$interaction_types_list),
                     env1 = factor(env1, levels = info$environment_list[24:17]))

# Plot for environments (2 carbon source environments)
g2 <- ggplot() +
  geom_bar(data = countDF,
           mapping = aes(x = as.factor(env1), y = c1, fill = Type),
           stat = "identity", position = "fill", width = 0.875) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(
    color_interaction$mutualism,
    color_interaction$commensalism,
    color_interaction$parasitism,
    color_interaction$amensalism,
    color_interaction$competition,
    color_interaction$neutral
  )) +
  coord_flip()

# Count interaction types for additional environments (4 carbon source environments)
infoc <- transform(all_sample_df_temp, Type = factor(Type, levels = info$interaction_types_list))
count <- data.frame()

for (i in 6:1) {
  for (j in 25:28) {
    temp <- infoc[infoc$environment == info$environment_list[j], ]
    temp <- subset(temp, !is.na(temp$fcs_file))
    count <- rbind(count, data.frame(
      env = info$environment_list[j],
      count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
      Type = info$interaction_types_list[i]
    ))
  }
}

countDF <- data.frame()

# Calculate proportions
for (j in 25:28) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    c <- c(c, if (ratio < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    c1 <- c(c1, ratio)
  }
  
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}

# Filter out rows with zero proportions and adjust the factor levels
countDF <- subset(countDF, c1 != 0)
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = info$environment_list[28:25]))

# Plot the bar chart for environments (4 carbon source environments)
g4 <- ggplot() +
  geom_bar(data = countDF,
           mapping = aes(x = as.factor(env1), y = c1, fill = Type),
           stat = "identity", position = "fill", width = 0.94) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(
    color_interaction$mutualism,
    color_interaction$commensalism,
    color_interaction$parasitism,
    color_interaction$amensalism,
    color_interaction$competition,
    color_interaction$neutral
  )) +
  coord_flip()

# Count interaction types for additional environments (8 carbon source environments)
infoc <- transform(all_sample_df_temp, Type = factor(Type, levels = info$interaction_types_list))
count <- data.frame()

for (i in 6:1) {
  for (j in 29:30) {
    temp <- infoc[infoc$environment == info$environment_list[j], ]
    temp <- subset(temp, !is.na(temp$fcs_file))
    count <- rbind(count, data.frame(
      env = info$environment_list[j],
      count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
      Type = info$interaction_types_list[i]
    ))
  }
}

countDF <- data.frame()

for (j in 29:30) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    c <- c(c, if (ratio < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    c1 <- c(c1, ratio)
  }
  
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}

countDF <- subset(countDF, c1 != 0)
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = info$environment_list[30:29]))

# Plot the bar chart for environments (8 carbon source environments)
g8 <- ggplot() +
  geom_bar(data = countDF,
           mapping = aes(x = as.factor(env1), y = c1, fill = Type),
           stat = "identity", position = "fill", width = 0.97) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(
    color_interaction$parasitism,
    color_interaction$amensalism,
    color_interaction$competition,
    color_interaction$neutral
  )) +
  coord_flip()

# Count interaction types for additional environments (16 carbon source environments)
infoc <- transform(all_sample_df_temp, Type = factor(Type, levels = info$interaction_types_list))
count <- data.frame()

for (i in 6:1) {
  for (j in 31:31) {
    temp <- infoc[infoc$environment == info$environment_list[j], ]
    temp <- subset(temp, !is.na(temp$fcs_file))
    count <- rbind(count, data.frame(
      env = info$environment_list[j],
      count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
      Type = info$interaction_types_list[i]
    ))
  }
}

countDF <- data.frame()

for (j in 31:31) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    c <- c(c, if (ratio < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    c1 <- c(c1, ratio)
  }
  
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}

countDF <- subset(countDF, c1 != 0)
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = info$environment_list[31:31]))

# Plot the bar chart for environment (16 carbon source environments)
g16 <- ggplot() +
  geom_bar(data = countDF,
           mapping = aes(x = as.factor(env1), y = c1, fill = Type),
           stat = "identity", position = "fill", width = 1) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(
    color_interaction$amensalism,
    color_interaction$competition
  )) +
  coord_flip()

# Data frames for theta values and types in different carbon source conditions
c1 <- data.frame(
  env = "1",
  theta = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 1 & all_sample_df_temp$bacterial_species_count == 2, ]$theta,
  strain = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 1 & all_sample_df_temp$bacterial_species_count == 2, ]$bacteria,
  Type = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 1 & all_sample_df_temp$bacterial_species_count == 2, ]$Type
)

c2 <- data.frame(
  env = "2",
  theta = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 2 & all_sample_df_temp$bacterial_species_count == 2, ]$theta,
  strain = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 2 & all_sample_df_temp$bacterial_species_count == 2, ]$bacteria,
  Type = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 2 & all_sample_df_temp$bacterial_species_count == 2, ]$Type
)

c4 <- data.frame(
  env = "4",
  theta = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 4 & all_sample_df_temp$bacterial_species_count == 2, ]$theta,
  strain = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 4 & all_sample_df_temp$bacterial_species_count == 2, ]$bacteria,
  Type = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 4 & all_sample_df_temp$bacterial_species_count == 2, ]$Type
)

c8 <- data.frame(
  env = "8",
  theta = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 8 & all_sample_df_temp$bacterial_species_count == 2, ]$theta,
  strain = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 8 & all_sample_df_temp$bacterial_species_count == 2, ]$bacteria,
  Type = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 8 & all_sample_df_temp$bacterial_species_count == 2, ]$Type
)

c16 <- data.frame(
  env = "16",
  theta = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 16 & all_sample_df_temp$bacterial_species_count == 2, ]$theta,
  strain = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 16 & all_sample_df_temp$bacterial_species_count == 2, ]$bacteria,
  Type = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 16 & all_sample_df_temp$bacterial_species_count == 2, ]$Type
)

# Combine all data frames and remove rows with NA in the Type column
infoc <- rbind(c1, c2, c4, c8, c16)
infoc <- subset(infoc, !is.na(infoc$Type))
infoc <- transform(infoc, env = factor(env, levels = c("1", "2", "4", "8", "16")))

envc <- c("1", "2", "4", "8", "16")

# Transform Type column to be a factor with predefined levels
infoc <- transform(infoc, Type = factor(Type, levels = info$interaction_types_list))

# Initialize an empty data frame for counts
count <- data.frame()

# Count interaction types in each environment
for (i in 6:1) {
  for (j in 1:5) {
    temp <- infoc[infoc$env == envc[j], ]
    count <- rbind(count, data.frame(env = envc[j],
                                     count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
                                     Type = info$interaction_types_list[i]))
  }
}

# Initialize an empty data frame for the result
countDF <- data.frame()

# Calculate proportions and format as percentages
for (j in 1:5) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  
  for (i in 1:6) {
    temp <- count[count$env == envc[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    c <- c(c, if (round(ratio) < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    c1 <- c(c1, ratio)
  }
  
  # Add environment and interaction type to the data
  env1 <- rep(envc[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  
  countDF <- rbind(countDF, tempcount)
}

countDF <- subset(countDF, c1 != 0)

countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = c("1", "2", "4", "8", "16")))

# Create a stacked bar plot using ggplot
gbar <- ggplot(data = countDF, mapping = aes(x = as.factor(env1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.8) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0.05, 0.05)) +
  scale_fill_manual(values = c(color_interaction$mutualism,
                               color_interaction$commensalism,
                               color_interaction$parasitism,
                               color_interaction$amensalism,
                               color_interaction$competition,
                               color_interaction$neutral)) +
  theme(title = element_blank(),
        axis.text = element_text(size = 10),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())

# Create a blank panel for the layout
panel.blank <- ggplot() +
  geom_point(aes(1, 1), colour = "white") +
  theme(plot.background = element_rect(colour = "white"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

# Define the layout for arranging the plots
layout1 <- rbind(c(1, 1, 2, 3, 4, 5, 7),
                 c(8, 6, 6, 6, 6, 6, 7))

# Arrange and plot all figures
g <- gridExtra::grid.arrange(
  g1 + theme_pubr() + theme(axis.title.x = element_blank(),
                            axis.title.y = element_blank(),
                            legend.position = "none",
                            title = element_blank(),
                            axis.text = element_blank(),
                            plot.margin = margin(t = 11.1, r = 9.1, b = 14, l = 42, unit = "pt"),
                            axis.line = element_line(size = 0.5, lineend = "square", color = "grey20"),
                            axis.ticks = element_line(size = 0.5, lineend = "square", color = "grey20"),
                            axis.line.y = element_blank(),
                            axis.ticks.y = element_blank()),
  g2 + theme_void() + theme(axis.title.x = element_blank(),
                             axis.title.y = element_blank(),
                             legend.position = "none",
                             title = element_blank(),
                             plot.margin = margin(t = 13, r = 9, b = 13, l = 0, unit = "pt")),
  g4 + theme_void() + theme(axis.title.x = element_blank(),
                             axis.title.y = element_blank(),
                             legend.position = "none",
                             title = element_blank(),
                             plot.margin = margin(t = 11.03, r = 9, b = 11.03, l = 0, unit = "pt")),
  g8 + theme_void() + theme(axis.title.x = element_blank(),
                             axis.title.y = element_blank(),
                             legend.position = "none",
                             title = element_blank(),
                             plot.margin = margin(t = 6.83, r = 9, b = 6.83, l = 0, unit = "pt")),
  g16 + theme_void() + theme(axis.title.x = element_blank(),
                              axis.title.y = element_blank(),
                              legend.position = "none",
                              title = element_blank(),
                              plot.margin = margin(t = 0, r = 9, b = 0, l = 0, unit = "pt")),
  gbar + theme_pubr() + scale_y_continuous(labels = scales::percent,
                                           breaks = c(0, 0.5, 1), expand = c(0, 0)) +
    theme(axis.text.x = element_text(size = 8),
          axis.title.x = element_blank(),
          axis.text.y = element_text(size = 8),
          axis.title.y = element_blank(),
          legend.position = "none",
          title = element_blank(),
          plot.margin = margin(t = 0, r = 0, b = 50, l = 0, unit = "pt"),
          axis.line = element_line(size = 0.5, lineend = "square", color = "grey20"),
          axis.ticks = element_line(size = 0.5, lineend = "square", color = "grey20")),
  panel.blank, panel.blank,
  layout_matrix = layout1,
  widths = c(0.59, 4.65, 2.6, 2.6, 2.6, 2.6, 15),
  heights = c(3, 2)
)

# Save the plot as a PDF
ggsave("Fig3A.pdf", plot = g)
```

### Fig.3B
```{r}
# Create theta-value dataframe for each co-culture-environment pair
thetaplot_df <- data.frame()
for (i in 1:28) {
  for (j in 1:32) {
    temp <- all_sample_df[
      all_sample_df$experiment == "main" &
        all_sample_df$bacterial_species_count == 2 &
        all_sample_df$bacteria == info$coculture_bacteria_list[i] &
        all_sample_df$environment == info$environment_list[j],
    ]
    thetaplot_df <- rbind(
      thetaplot_df,
      data.frame(
        bacteria = info$coculture_bacteria_list[i],
        environment = info$environment_list[j],
        carbonsource_species_count = as.numeric(temp$carbonsource_species_count)[1],
        bacterial_species_count = as.numeric(temp$bacterial_species_count)[1],
        x_value = as.numeric(temp$x_value)[1],
        x_sd = as.numeric(temp$x_sd)[1],
        y_value = as.numeric(temp$y_value)[1],
        y_sd = as.numeric(temp$y_sd)[1],
        theta_value = as.numeric(temp$theta_value)[1],
        Type = temp$Type[1],
        plot_hierarchy = temp$plot_hierarchy[1]
      )
    )
  }
}

# Create temporary dataframe
all_sample_df_temp <- thetaplot_df

# Subset theta values by carbon source species count
c1 <- data.frame(
  env = "1",
  theta = as.numeric(all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 1 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$theta_value),
  strain = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 1 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$bacteria,
  Type = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 1 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$Type
)

c2 <- data.frame(
  env = "2",
  theta = as.numeric(all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 2 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$theta_value),
  strain = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 2 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$bacteria,
  Type = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 2 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$Type
)

c4 <- data.frame(
  env = "4",
  theta = as.numeric(all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 4 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$theta_value),
  strain = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 4 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$bacteria,
  Type = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 4 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$Type
)

c8 <- data.frame(
  env = "8",
  theta = as.numeric(all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 8 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$theta_value),
  strain = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 8 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$bacteria,
  Type = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 8 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$Type
)

c16 <- data.frame(
  env = "16",
  theta = as.numeric(all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 16 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$theta_value),
  strain = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 16 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$bacteria,
  Type = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 16 &
      all_sample_df_temp$bacterial_species_count == 2,
  ]$Type
)

# Merge data for plotting
infoc <- rbind(c1, c2, c4, c8, c16)
infoc <- transform(infoc, env = factor(env, levels = c("1", "2", "4", "8", "16")))

# Violin plot of theta values across carbon diversity levels
g <- ggplot(data = infoc, aes(x = as.factor(env), y = theta)) +
  scale_y_continuous(limits = c(-90, 90), breaks = c(-90, -45, 0, 45, 90), expand = c(0, 0)) +
  geom_point(shape = 21, size = 0.4, stroke = 0.2, alpha = 0.3, position = position_jitter(0.4)) +
  geom_violin(fill = NA, color = "grey10") +
  stat_summary(fun = mean, geom = "point", shape = 3, size = 1.8, color = "red") +
  theme_minimal() +
  theme(
    plot.margin = margin(t = 230, r = 290, b = 0, l = 0, unit = "pt"),
    axis.text.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    axis.title = element_blank(),
    axis.line = element_line(size = 0.5, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.5, lineend = "square", color = "grey20")
  )

plot(g)
ggsave("Fig3B.pdf", g)

# Spearman correlation between carbon diversity and theta
infoc2 <- infoc
infoc2$env <- as.numeric(infoc2$env)

n <- data.frame(n = as.numeric(rank(infoc2$env, ties.method = "average")))
infoc2 <- cbind(infoc2, n)

nt <- data.frame(nt = as.numeric(rank(infoc2$theta, ties.method = "average")))
infoc2 <- cbind(infoc2, nt)

coin_corr <- spearman_test(nt ~ n, data = infoc2)
print(pvalue(coin_corr))


log10_p <- log10(pvalue(coin_corr))
cat("log10(p):", log10_p, "\n")
a <- (10^(log10_p + round(abs(log10_p))))
print(paste("pvalue: ", a, "*10^", round(log10_p), sep=""))
```

## Fig.4
### Fig.4A
```{r}
# Filter monoculture samples from main experiment
all_sample_df_temp <- all_sample_df[
  all_sample_df$bacterial_species_count == 1 & 
    all_sample_df$experiment == "main", ]

# Set up strain list
strain_list <- c(info$monoculture_bacteria_list[1],
                 info$monoculture_bacteria_list[3:14],
                 info$monoculture_bacteria_list[16])

logDensityDF <- data.frame()

# Calculate log10 mean density for each environment-strain pair
for (i in 1:32) {
  for (j in 1:14) {
    temp <- all_sample_df_temp[
      all_sample_df_temp$environment == info$environment_list[i] &
        all_sample_df_temp$bacteria == strain_list[j], ]

    logDensityDF <- rbind(logDensityDF, data.frame(
      env     = temp$environment[1],
      nc      = temp$carbonsource_species_count[1],
      species = temp$monoculture_bacteria[1],
      strain  = temp$bacteria[1],
      mean     = log(mean(as.numeric(temp$target_fluorescent_cells_density)), 10)
    ))
  }
}

# Perform hierarchical clustering for each species
KResult <- data.frame()

for (i in 1:8) {
  rows <- logDensityDF[logDensityDF$species == info$bacteria_list[i], ]
  part1 <- data.frame(target_fluorescent_cells_density = rows$mean)
  distance <- dist(part1)
  hc <- hclust(distance, method = "ward.D2")
  plot(hc)
  hcresult <- cutree(hc, k = 2)

  result <- data.frame(
    target_fluorescent_cells_density = part1$target_fluorescent_cells_density,
    monoculture_bacteria = rows$strain,
    species = rows$species,
    hc = hcresult,
    env = rows$env,
    nc = rows$nc
  )

  KResult <- rbind(KResult, result)
}

# Reassign cluster labels for some strains
relabel_clusters <- function(df, strain_name) {
  df[df$monoculture_bacteria == strain_name & df$hc == 1, "hc"] <- 3
  df[df$monoculture_bacteria == strain_name & df$hc == 2, "hc"] <- 1
  df[df$monoculture_bacteria == strain_name & df$hc == 3, "hc"] <- 2
  return(df)
}

KResult <- relabel_clusters(KResult, "AgT_GFP")
KResult <- relabel_clusters(KResult, "SpP_GFP Tn5")
KResult <- relabel_clusters(KResult, "SpP_mScarlet")

# Assign hard/easy classification for coculture pairs
EasyHard <- data.frame()

for (i in 1:nrow(all_sample_df)) {
  if (all_sample_df$coculture_species_GFP[i] != "monoculture") {
    greenHD <- KResult[
      KResult$env == all_sample_df$environment[i] &
        (KResult$monoculture_bacteria == paste0(all_sample_df$coculture_species_GFP[i], "_GFP") |
           KResult$monoculture_bacteria == paste0(all_sample_df$coculture_species_GFP[i], "_GFP Tn5")), 
    ]$hc[1]
  } else {
    greenHD <- "mono"
  }

  if (all_sample_df$coculture_species_mScarlet[i] != "monoculture") {
    redHD <- KResult[
      KResult$env == all_sample_df$environment[i] &
        (KResult$monoculture_bacteria == paste0(all_sample_df$coculture_species_mScarlet[i], "_mScarlet") |
           KResult$monoculture_bacteria == paste0(all_sample_df$coculture_species_mScarlet[i], "_mScarlet Tn5")), 
    ]$hc[1]
  } else {
    redHD <- "mono"
  }

  EasyHard <- rbind(EasyHard, data.frame(greenHD = greenHD, redHD = redHD))
}

all_sample_df$greenHD <- EasyHard$greenHD
all_sample_df$redHD <- EasyHard$redHD

# Create heatmap panels for different environment groups
growth_spe1 <- data.frame()
plot_env_group <- function(env_indices, group_id) {
  growth_spe <- data.frame()
  for (j in env_indices) {
    tempBE <- KResult[KResult$env == info$environment_list[j], ]
    growth_spe <- rbind(growth_spe, tempBE)
    tempBE <- cbind(tempBE, data.frame(c = group_id))
    growth_spe1 <<- rbind(growth_spe1, tempBE)
  }
  growth_spe <- transform(growth_spe,
                          monoculture_bacteria = factor(monoculture_bacteria,
                                                        levels = info$strain_list_phylogenetic[1:14]),
                          env = factor(env, levels = rev(info$environment_list[env_indices])))

  ggplot() +
    geom_tile(data = growth_spe,
              mapping = aes(x = env, y = monoculture_bacteria, fill = as.factor(hc)),
              width = 0.75) +
    scale_fill_manual(values = c("#c450a0", "#4fc474")) +
    scale_x_discrete(guide = guide_axis(angle = 90), position = "top") +
    coord_flip() +
    theme_minimal()
}

g1 <- plot_env_group(1:16, 1)
g2 <- plot_env_group(17:24, 2)
g4 <- plot_env_group(25:28, 4)
g8 <- plot_env_group(29:30, 8)
g16 <- plot_env_group(31:31, 16)

# Create bar plot showing percentage of hc==1 or hc==2 per environment group
par <- data.frame()
for (i in c(1, 2, 4, 8, 16)) {
  temp <- growth_spe1[growth_spe1$c == i, ]
  for (k in 1:2) {
    par <- rbind(par,
                 data.frame(num = i,
                            percentage = sum(temp$hc == k) / nrow(temp),
                            den = k))
  }
}

# Dual-axis scaling functions
variable_scaler <- function(y2, yaxis1, yaxis2) {
  a <- (yaxis1[2] - yaxis1[1]) / (yaxis2[2] - yaxis2[1])
  b <- (yaxis1[1] * yaxis2[2] - yaxis1[2] * yaxis2[1]) / (yaxis2[2] - yaxis2[1])
  a * y2 + b
}

axis_scaler <- function(y1, yaxis1, yaxis2) {
  c_val <- (yaxis2[2] - yaxis2[1]) / (yaxis1[2] - yaxis1[1])
  d <- (yaxis2[1] * yaxis1[2] - yaxis2[2] * yaxis1[1]) / (yaxis1[2] - yaxis1[1])
  c_val * y1 + d
}

# Format barplot data
par <- transform(par,
                 den = factor(den, levels = c(2, 1)),
                 num = factor(num, levels = c(1, 2, 4, 8, 16)))

gbar <- ggplot() +
  geom_bar(data = par,
           mapping = aes(x = as.factor(num), y = percentage, fill = as.factor(den)),
           stat = "identity", position = "fill", width = 0.8) +
  scale_fill_manual(values = c("#F6995C", "#51829B")) +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.5, 1),
                     expand = c(0, 0))

gbar <- gbar + theme_pubr() + theme(
    axis.text.x = element_text(size = 10, colour = "black"),
    axis.text.y = element_text(size = 10, colour = "black"),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "none",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.ticks = element_blank()
  )
# Save the figure as PDF
ggsave(file = "Fig4A.pdf", plot = gbar)
plot(gbar)
```

### Fig.4B
```{r}
# Filter samples with exactly two bacterial species and exclude control conditions
all_sample_df_temp <- all_sample_df[
  all_sample_df$bacterial_species_count == 2 &
    all_sample_df$experiment == "main" &
    all_sample_df$environment != "water", ]

# Subset: both redHD and greenHD are "2" (Easy and Easy condition)
EE <- all_sample_df_temp[
  all_sample_df_temp$greenHD == "2" & all_sample_df_temp$redHD == "2", ]

temp <- data.frame()

# Count interaction types across carbon source diversity
for (i in 1:6) {
  tempEH <- EE[EE$Type == info$interaction_types_list[i], ]
  for (j in c(1, 2, 4, 8, 16)) {
    tempEHc <- tempEH[tempEH$carbonsource_species_count == j, ]
    temp <- rbind(
      temp,
      data.frame(
        carbonsource_species_count = j,
        Type = info$interaction_types_list[i],
        count = length(tempEHc$fcs_file)
      )
    )
  }
}

# Format data for plotting
EE <- temp
EE$Type <- factor(EE$Type, levels = info$interaction_types_list)
EE$carbonsource_species_count <- factor(EE$carbonsource_species_count, levels = c("1", "2", "4", "8", "16"))

# Generate stacked bar plot (Easy and Easy condition)
g <- ggplot(data = EE) +
  geom_histogram(aes(x = carbonsource_species_count, y = count / 3, fill = Type),
                 position = "stack", stat = "identity", width = 0.8) +
  scale_y_continuous(limits = c(0, 350), breaks = c(0, 100, 200, 300), expand = c(0, 0)) +
  theme_minimal() +
  theme(
    axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_text(size = 15),
    plot.margin = margin(t = 150, r = 330, b = 0, l = 0, unit = "pt")
  ) +
  scale_fill_manual(values = c(
    color_interaction$mutualism,
    color_interaction$commensalism,
    color_interaction$parasitism,
    color_interaction$amensalism,
    color_interaction$competition,
    color_interaction$neutral
  ))

g
ggsave(file = "Fig4B_Easy.pdf", plot = g)

# Subset: at least one of redHD or greenHD is "1" (Easy and Hard or Hard and Hard condition)
EH_HH <- all_sample_df_temp[
  (all_sample_df_temp$greenHD == "1" & all_sample_df_temp$redHD == "1") |
    (all_sample_df_temp$greenHD == "2" & all_sample_df_temp$redHD == "1") |
    (all_sample_df_temp$greenHD == "1" & all_sample_df_temp$redHD == "2"), ]

temp <- data.frame()

# Count interaction types across carbon source diversity
for (i in 1:6) {
  tempEH <- EH_HH[EH_HH$Type == info$interaction_types_list[i], ]
  for (j in c(1, 2, 4, 8, 16)) {
    tempEHc <- tempEH[tempEH$carbonsource_species_count == j, ]
    temp <- rbind(
      temp,
      data.frame(
        carbonsource_species_count = j,
        Type = info$interaction_types_list[i],
        count = length(tempEHc$fcs_file)
      )
    )
  }
}

# Format data for plotting
EH_HH <- temp
EH_HH$Type <- factor(EH_HH$Type, levels = info$interaction_types_list)
EH_HH$carbonsource_species_count <- factor(EH_HH$carbonsource_species_count, levels = c("1", "2", "4", "8", "16"))

# Generate stacked bar plot (Easy and Hard or Hard and Hard condition)
g <- ggplot(data = EH_HH) +
  geom_histogram(aes(x = carbonsource_species_count, y = count / 3, fill = Type),
                 position = "stack", stat = "identity", width = 0.8) +
  scale_y_continuous(limits = c(0, 350), breaks = c(0, 100, 200, 300), expand = c(0, 0)) +
  theme_minimal() +
  theme(
    axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_text(size = 15),
    plot.margin = margin(t = 150, r = 330, b = 0, l = 0, unit = "pt")
  ) +
  scale_fill_manual(values = c(
    color_interaction$mutualism,
    color_interaction$commensalism,
    color_interaction$parasitism,
    color_interaction$amensalism,
    color_interaction$competition,
    color_interaction$neutral
  ))

g
ggsave(file = "Fig4B_Hard.pdf", plot = g)
```

## Fig.5, FigS12
```{r}
# Filter single-species samples in the main experiment
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 1, ]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$experiment == "main", ]
all_sample_df_temp$background_processing_target_fluorescent_cells_density <- log(x = all_sample_df_temp$background_processing_target_fluorescent_cells_density, base = 10)

# Select strain list (excluding element 2 and 15)
strain_list <- c(info$monoculture_bacteria_list[1],
                 info$monoculture_bacteria_list[3:14],
                 info$monoculture_bacteria_list[16])

# 1->2 mixing environments
# Initialize data frame for observed vs predicted values
mix2ave2 <- data.frame()

for (i in 17:24) {
  tempE2 <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1  <- all_sample_df_temp[all_sample_df_temp$environment == tempE2$carbonsource_mixed_pair1[1], ]
  temp2  <- all_sample_df_temp[all_sample_df_temp$environment == tempE2$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    temp1B <- temp1[temp1$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2B <- temp2[temp2$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    
    cmono  <- c(temp1B, temp2B)
    ave12  <- mean(cmono)
    sdmean <- sqrt(mean(c(var(temp1B), var(temp2B))))
    tempY  <- c(ave12 - sdmean, ave12, ave12 + sdmean)
    
    tempEBc <- tempE2[tempE2$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    
    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2ave2 <- rbind(mix2ave2, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = ptemp
        ))
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY, alternative = "two.sided",
                  paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for (k in 1:length(tempEBc)) {
        mix2ave2 <- rbind(mix2ave2, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = t$p.value
        ))
      }
    }
  }
}

mix2ave2$qvalue <- p.adjust(mix2ave2$pvalue, method = "BH")

meanDF2 <- data.frame()
for (i in 17:24) {
  for (j in 1:14) {
    temp <- mix2ave2[(mix2ave2$env == info$environment_list[i]) &
                     (mix2ave2$bacteria == strain_list[j]), ]
    
    meanDF2 <- rbind(meanDF2, data.frame(
      envbac = paste(info$environment_list[i], strain_list[j]),
      ave12  = temp$ave12[1],
      mean   = mean(temp$value),
      sdx    = temp$sdx[1],
      sdy    = temp$sdy[1],
      p      = if (temp$qvalue[1] < 0.05) 1 else 0,
      pp     = if ((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1])) {
                 "high"
               } else if ((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1])) {
                 "low"
               } else {
                 "same"
               }
    ))
  }
}

# Count outcome types
temphigh <- 0
tempsame <- 0
templow  <- 0

for (i in 1:length(meanDF2$envbac)) {
  if (meanDF2$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (meanDF2$ave12[i] > meanDF2$mean[i]) {
      templow <- templow + 1
    } else {
      temphigh <- temphigh + 1
    }
  }
}

# Prepare stacked bar plot data
judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)

c  <- c()
c1 <- c()

for (k in 1:3) {
  ratio <- count$count1[k] / sum(count$count1)
  c[k]  <- if (ratio < 0.1) {
             paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
           } else {
             paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
           }
  c1[k] <- ratio
}

count <- cbind(count, c, c1)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

# Plot stacked bar
g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(184, 153, 58, maxColorValue = 255),
                               "grey70",
                               rgb(58, 184, 153, maxColorValue = 255)))
g
ggsave(file = "Fig5A_bar.pdf", plot = g)

# Summary scatter plot with error bars
meanDF2$pp <- factor(meanDF2$pp, levels = c("high", "same", "low"))
# df1 <- data.frame(x1 = 1e5, y1 = 1e5, x2 = 1e10, y2 = 1e10)
df1 <- data.frame(x1 = 5, y1 = 5, x2 = 10, y2 = 10)
df2 <- data.frame(x1 = log(x = (4.57*10^5), base = 10), y1 = 5, x2 = log(x = (4.57*10^5), base = 10), y2 = 10)
df3 <- data.frame(x1 = 5, y1 = log(x = (4.57*10^5), base = 10), x2 = 10, y2 = log(x = (4.57*10^5), base = 10))

g <- ggplot(meanDF2, aes(x = ave12, y = mean, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df1, color = "grey20", linewidth = 0.75, linetype = "dotted") +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df2, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df3, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(5, 10), expand = c(0, 0)) +
  scale_y_continuous(limits = c(5, 10), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(184, 153, 58, maxColorValue = 255),
                                "grey70",
                                rgb(58, 184, 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1)

for (i in 1:nrow(meanDF2)) {
  temp <- meanDF2[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                         x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                         x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g +
    geom_segment(data = errorDFx, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2) +
    geom_segment(data = errorDFy, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2)
}
g
ggsave(file = "Fig5A_scatter.pdf", plot = g)

# Fig.S12
g <- ggplot(meanDF2, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 1, alpha = 0.5, fill = NA,
               binwidth = 0.02, stackdir = "center", color = "black") +
  scale_y_continuous(limits = c(0.75, 1.75), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = "FigS12A.pdf", plot = g)

# Repeat for 2->4 mixing environments
mix2Ave <- data.frame()

for (i in 25:28) {
  tempE <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1 <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2 <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]

  temp11 <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1], ]
  temp12 <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1], ]
  temp21 <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1], ]
  temp22 <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1], ]

  for (j in 1:14) {
    temp11B <- temp11[temp11$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp12B <- temp12[temp12$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp21B <- temp21[temp21$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp22B <- temp22[temp22$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density

    cvals <- c(temp11B, temp12B, temp21B, temp22B)
    ave12 <- mean(cvals)
    sdmean <- sqrt(mean(c(var(temp11B), var(temp12B), var(temp21B), var(temp22B))))
    tempY <- c(ave12 - sdmean, ave12, ave12 + sdmean)

    tempEBc <- tempE[tempE$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density

    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = ptemp
        ))
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY)
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = t$p.value
        ))
      }
    }
  }
}

mix2Ave$qvalue <- p.adjust(mix2Ave$pvalue, method = "BH")

meanDF <- data.frame()
for (i in 25:28) {
  for (j in 1:14) {
    temp <- subset(mix2Ave, env == info$environment_list[i] & bacteria == strain_list[j])
    meanDF <- rbind(meanDF, data.frame(
      envbac = paste(info$environment_list[i], strain_list[j]),
      ave12  = temp$ave12[1],
      mean   = mean(temp$value),
      sdx    = temp$sdx[1],
      sdy    = temp$sdy[1],
      p      = ifelse(temp$qvalue[1] < 0.05, 1, 0),
      pp     = ifelse(temp$qvalue[1] < 0.05,
                      ifelse(mean(temp$value) > temp$ave12[1], "high", "low"),
                      "same")
    ))
  }
}

temphigh <- sum(meanDF$p == 1 & meanDF$mean > meanDF$ave12)
tempsame <- sum(meanDF$p == 0)
templow  <- sum(meanDF$p == 1 & meanDF$mean < meanDF$ave12)

judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)
count$c  <- ifelse(count$count1 / sum(count$count1) < 0.1,
                   paste(" ", format(round(count$count1 / sum(count$count1) * 100, 1), nsmall = 1), "%"),
                   paste(format(round(count$count1 / sum(count$count1) * 100, 1), nsmall = 1), "%"))
count$c1 <- count$count1 / sum(count$count1)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - 0.5 * c1)

g <- ggplot(count, aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(184,153,58, maxColorValue = 255),
                                "grey70",
                                rgb(58,184,153, maxColorValue = 255)))
g
ggsave("Fig5B_bar.pdf", plot = g)

meanDF$pp <- factor(meanDF$pp, levels = c("high", "same", "low"))
df1 <- data.frame(x1 = 5, y1 = 5, x2 = 10, y2 = 10)
df2 <- data.frame(x1 = log(x = (4.57*10^5), base = 10), y1 = 5, x2 = log(x = (4.57*10^5), base = 10), y2 = 10)
df3 <- data.frame(x1 = 5, y1 = log(x = (4.57*10^5), base = 10), x2 = 10, y2 = log(x = (4.57*10^5), base = 10))

g <- ggplot(meanDF, aes(x = ave12, y = mean, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df1, color = "grey20", linewidth = 0.75, linetype = "dotted") +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df2, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df3, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(5, 10), expand = c(0, 0)) +
  scale_y_continuous(limits = c(5, 10), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(184, 153, 58, maxColorValue = 255),
                                "grey70",
                                rgb(58, 184, 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1)
for (i in 1:nrow(meanDF)) {
  temp <- meanDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                         x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                         x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g +
    geom_segment(data = errorDFx, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2) +
    geom_segment(data = errorDFy, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2)
}
g
ggsave("Fig5B_scatter.pdf", plot = g)

g <- ggplot(meanDF, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 1, alpha = 0.5, fill = NA,
               binwidth = 0.02, stackdir = "center", color = "black") +
  scale_y_continuous(limits = c(0.75, 1.75), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave("FigS12B.pdf", plot = g)

# Repeat for 4->8 mixing environments
mix2Ave <- data.frame()

for (i in 29:30) {
  tempE   <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]
  temp11  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1], ]
  temp12  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1], ]
  temp21  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1], ]
  temp22  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1], ]
  temp111 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair1[1], ]
  temp112 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair2[1], ]
  temp121 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair1[1], ]
  temp122 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair2[1], ]
  temp211 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair1[1], ]
  temp212 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair2[1], ]
  temp221 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair1[1], ]
  temp222 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    temp111B <- temp111[temp111$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp112B <- temp112[temp112$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp121B <- temp121[temp121$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp122B <- temp122[temp122$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp211B <- temp211[temp211$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp212B <- temp212[temp212$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp221B <- temp221[temp221$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp222B <- temp222[temp222$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    
    cvals  <- c(temp111B, temp112B, temp121B, temp122B, temp211B, temp212B, temp221B, temp222B)
    ave12  <- mean(cvals)
    sdmean <- mean(c(var(temp111B), var(temp112B), var(temp121B), var(temp122B), 
                     var(temp211B), var(temp212B), var(temp221B), var(temp222B)))^0.5
    tempY  <- c(ave12 - sdmean, ave12, ave12 + sdmean)
    
    tempEBc <- tempE[tempE$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    
    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = ptemp
        ))
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),
                  paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = t$p.value
        ))
      }
    }
  }
}

qvalue  <- p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave <- cbind(mix2Ave, qvalue)

meanDF <- data.frame()

for (i in 29:30) {
  for (j in 1:14) {
    temp <- mix2Ave[(mix2Ave$env == info$environment_list[i]) &
                    (mix2Ave$bacteria == strain_list[j]), ]
    meanDF <- rbind(meanDF, data.frame(
      envbac = paste(info$environment_list[i], strain_list[j]),
      ave12  = temp$ave12[1],
      mean   = mean(temp$value),
      sdx    = temp$sdx[1],
      sdy    = temp$sdy[1],
      p      = if (temp$qvalue[1] < 0.05) 1 else 0,
      pp     = if ((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1])) {
                  "high"
                } else if ((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1])) {
                  "low"
                } else {
                  "same"
                }
    ))
  }
}

temphigh <- 0
tempsame <- 0
templow  <- 0
for (i in 1:length(meanDF$envbac)) {
  if (meanDF$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (meanDF$ave12[i] > meanDF$mean[i]) {
      templow <- templow + 1
    } else if (meanDF$ave12[i] < meanDF$mean[i]) {
      temphigh <- temphigh + 1
    }
  }
}

judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)

c_vals <- c()
c1_vals <- c()
for (k in 1:3) {
  c_vals[k]  <- if (count$count1[k] / sum(count$count1) < 0.1) {
                  paste(" ", format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                } else {
                  paste(format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                }
  c1_vals[k] <- count$count1[k] / sum(count$count1)
}
count <- cbind(count, c = c_vals, c1 = c1_vals)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                 "grey70",
                                 rgb(red = 58, green = 184, blue = 153, maxColorValue = 255)))
g
ggsave(file = "Fig5C_bar.pdf", plot = g)

meanDF <- transform(meanDF, pp = factor(pp, levels = c("high", "same", "low")))
df1 <- data.frame(x1 = 5, y1 = 5, x2 = 10, y2 = 10)
df2 <- data.frame(x1 = log(x = (4.57*10^5), base = 10), y1 = 5, x2 = log(x = (4.57*10^5), base = 10), y2 = 10)
df3 <- data.frame(x1 = 5, y1 = log(x = (4.57*10^5), base = 10), x2 = 10, y2 = log(x = (4.57*10^5), base = 10))

g <- ggplot(meanDF, aes(x = ave12, y = mean, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df1, color = "grey20", linewidth = 0.75, linetype = "dotted") +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df2, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df3, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(5, 10), expand = c(0, 0)) +
  scale_y_continuous(limits = c(5, 10), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(184, 153, 58, maxColorValue = 255),
                                "grey70",
                                rgb(58, 184, 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1)

for (i in 1:length(meanDF$envbac)) {
  temp     <- meanDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                         x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                         x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                         color = "black", alpha = 0.3, data = errorDFx,
                         linewidth = 0.2, linetype = "solid")
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                         color = "black", alpha = 0.3, data = errorDFy,
                         linewidth = 0.2, linetype = "solid")
}

g
ggsave(file = "Fig5C_scatter.pdf", plot = g)


g <- ggplot(meanDF, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 1, alpha = 0.5, fill = NA,
               binwidth = 0.02, stackdir = "center", color = "black") +
  scale_y_continuous(limits = c(0.75, 1.75), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = "FigS12C.pdf", plot = g)

# Repeat for 8->16 mixing environments
mix2Ave <- data.frame()

for (i in 31:31) {
  tempE   <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]
  
  temp11  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1], ]
  temp12  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1], ]
  temp21  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1], ]
  temp22  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1], ]
  
  temp111 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair1[1], ]
  temp112 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair2[1], ]
  temp121 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair1[1], ]
  temp122 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair2[1], ]
  temp211 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair1[1], ]
  temp212 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair2[1], ]
  temp221 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair1[1], ]
  temp222 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair2[1], ]
  
  temp1111 <- all_sample_df_temp[all_sample_df_temp$environment == temp111$carbonsource_mixed_pair1[1], ]
  temp1112 <- all_sample_df_temp[all_sample_df_temp$environment == temp111$carbonsource_mixed_pair2[1], ]
  temp1121 <- all_sample_df_temp[all_sample_df_temp$environment == temp112$carbonsource_mixed_pair1[1], ]
  temp1122 <- all_sample_df_temp[all_sample_df_temp$environment == temp112$carbonsource_mixed_pair2[1], ]
  temp1211 <- all_sample_df_temp[all_sample_df_temp$environment == temp121$carbonsource_mixed_pair1[1], ]
  temp1212 <- all_sample_df_temp[all_sample_df_temp$environment == temp121$carbonsource_mixed_pair2[1], ]
  temp1221 <- all_sample_df_temp[all_sample_df_temp$environment == temp122$carbonsource_mixed_pair1[1], ]
  temp1222 <- all_sample_df_temp[all_sample_df_temp$environment == temp122$carbonsource_mixed_pair2[1], ]
  temp2111 <- all_sample_df_temp[all_sample_df_temp$environment == temp211$carbonsource_mixed_pair1[1], ]
  temp2112 <- all_sample_df_temp[all_sample_df_temp$environment == temp211$carbonsource_mixed_pair2[1], ]
  temp2121 <- all_sample_df_temp[all_sample_df_temp$environment == temp212$carbonsource_mixed_pair1[1], ]
  temp2122 <- all_sample_df_temp[all_sample_df_temp$environment == temp212$carbonsource_mixed_pair2[1], ]
  temp2211 <- all_sample_df_temp[all_sample_df_temp$environment == temp221$carbonsource_mixed_pair1[1], ]
  temp2212 <- all_sample_df_temp[all_sample_df_temp$environment == temp221$carbonsource_mixed_pair2[1], ]
  temp2221 <- all_sample_df_temp[all_sample_df_temp$environment == temp222$carbonsource_mixed_pair1[1], ]
  temp2222 <- all_sample_df_temp[all_sample_df_temp$environment == temp222$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    temp1111B <- temp1111[temp1111$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1112B <- temp1112[temp1112$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1121B <- temp1121[temp1121$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1122B <- temp1122[temp1122$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1211B <- temp1211[temp1211$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1212B <- temp1212[temp1212$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1221B <- temp1221[temp1221$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1222B <- temp1222[temp1222$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2111B <- temp2111[temp2111$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2112B <- temp2112[temp2112$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2121B <- temp2121[temp2121$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2122B <- temp2122[temp2122$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2211B <- temp2211[temp2211$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2212B <- temp2212[temp2212$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2221B <- temp2221[temp2221$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2222B <- temp2222[temp2222$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    
    cvals  <- c(temp1111B, temp1112B, temp1121B, temp1122B,
                temp1211B, temp1212B, temp1221B, temp1222B,
                temp2111B, temp2112B, temp2121B, temp2122B,
                temp2211B, temp2212B, temp2221B, temp2222B)
    
    ave12  <- mean(cvals)
    sdmean <- mean(c(var(temp1111B), var(temp1112B), var(temp1121B), var(temp1122B),
                     var(temp1211B), var(temp1212B), var(temp1221B), var(temp1222B),
                     var(temp2111B), var(temp2112B), var(temp2121B), var(temp2122B),
                     var(temp2211B), var(temp2212B), var(temp2221B), var(temp2222B)))^0.5
    tempY <- c(ave12 - sdmean, ave12, ave12 + sdmean)

    tempEBc <- tempE[tempE$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density

    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = ptemp
        ))
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY, alternative = "two.sided",
                  paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = t$p.value
        ))
      }
    }
  }
}

qvalue <- p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave <- cbind(mix2Ave, qvalue)

meanDF <- data.frame()
for (i in 31:31) {
  for (j in 1:14) {
    temp <- mix2Ave[(mix2Ave$env == info$environment_list[i]) &
                    (mix2Ave$bacteria == strain_list[j]), ]
    meanDF <- rbind(meanDF, data.frame(
      envbac = paste(info$environment_list[i], strain_list[j]),
      ave12  = temp$ave12[1],
      mean   = mean(temp$value),
      sdx    = temp$sdx[1],
      sdy    = temp$sdy[1],
      p      = if (temp$qvalue[1] < 0.05) 1 else 0,
      pp     = if ((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1])) {
                 "high"
               } else if ((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1])) {
                 "low"
               } else {
                 "same"
               }
    ))
  }
}

temphigh <- 0
tempsame <- 0
templow  <- 0

for (i in 1:length(meanDF$envbac)) {
  if (meanDF$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (meanDF$ave12[i] > meanDF$mean[i]) {
      templow <- templow + 1
    } else if (meanDF$ave12[i] < meanDF$mean[i]) {
      temphigh <- temphigh + 1
    }
  }
}

judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)

count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)
c_vals <- c()
c1_vals <- c()

for (k in 1:3) {
  c_vals[k]  <- if (count$count1[k] / sum(count$count1) < 0.1) {
                  paste(" ", format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                } else {
                  paste(format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                }
  c1_vals[k] <- count$count1[k] / sum(count$count1)
}

count <- cbind(count, c = c_vals, c1 = c1_vals)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))

count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                               "grey70",
                               rgb(red = 58, green = 184, blue = 153, maxColorValue = 255)))
g
ggsave(file = "Fig5D_bar.pdf", plot = g)

meanDF <- transform(meanDF, pp = factor(pp, levels = c("high", "same", "low")))
df1 <- data.frame(x1 = 5, y1 = 5, x2 = 10, y2 = 10)
df2 <- data.frame(x1 = log(x = (4.57*10^5), base = 10), y1 = 5, x2 = log(x = (4.57*10^5), base = 10), y2 = 10)
df3 <- data.frame(x1 = 5, y1 = log(x = (4.57*10^5), base = 10), x2 = 10, y2 = log(x = (4.57*10^5), base = 10))

g <- ggplot(meanDF, aes(x = ave12, y = mean, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df1, color = "grey20", linewidth = 0.75, linetype = "dotted") +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df2, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df3, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(5, 10), expand = c(0, 0)) +
  scale_y_continuous(limits = c(5, 10), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(184, 153, 58, maxColorValue = 255),
                                "grey70",
                                rgb(58, 184, 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1)

for (i in 1:length(meanDF$envbac)) {
  temp <- meanDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                          x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                          x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFx,
                        linewidth = 0.2, linetype = "solid")
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFy,
                        linewidth = 0.2, linetype = "solid")
}

g
ggsave(file = "Fig5D_scatter.pdf", plot = g)

g <- ggplot(meanDF, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 1, alpha = 0.5, fill = NA,
               binwidth = 0.02, stackdir = "center", color = "black") +
  scale_y_continuous(limits = c(0.75, 1.75), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g

ggsave(file = "FigS12D.pdf", plot = g)
```

## TableS4, TableS6
```{r}
# Create an empty data frame
thetaplot_df <- data.frame()

# Loop through all coculture bacteria and environments
for (i in 1:28) {
  for (j in 1:32) {
    
    temp <- all_sample_df[all_sample_df$experiment == "main", ]
    temp <- temp[temp$bacterial_species_count == 2, ]
    temp <- temp[temp$bacteria == info$coculture_bacteria_list[i], ]
    temp <- temp[temp$environment == info$environment_list[j], ]
    
    thetaplot_df <- rbind(thetaplot_df, data.frame(
      bacteria = info$coculture_bacteria_list[i],
      environment = info$environment_list[j],
      nc = as.numeric(temp$carbonsource_species_count)[1],
      x_value = as.numeric(temp$x_value)[1],
      x_sd = as.numeric(temp$x_sd)[1],
      y_value = as.numeric(temp$y_value)[1],
      y_sd = as.numeric(temp$y_sd)[1],
      theta_value = as.numeric(temp$theta_value)[1],
      Type = temp$Type[1],
      plot_hierarchy = temp$plot_hierarchy[1]
    ))
  }
}

# Subset for environments with 1 carbon source
thetaplot_df1 <- thetaplot_df[thetaplot_df$nc == 1, ]

thetaplot_df1 <- transform(thetaplot_df1,
                           environment = factor(environment, levels = info$environment_list[1:16]))
thetaplot_df1 <- transform(thetaplot_df1,
                           bacteria = factor(bacteria, levels = info$coculture_bacteria_list))

set.seed(1)

# Chi-squared test: environment vs. interaction type
env <- table(thetaplot_df1$environment, thetaplot_df1$Type)
print(env)
chisq.test(env, simulate.p.value = TRUE, B = 100000)

# Chi-squared test: bacteria vs. interaction type
bac <- table(thetaplot_df1$bacteria, thetaplot_df1$Type)
print(bac)
chisq.test(bac, simulate.p.value = TRUE, B = 100000)
```

## TableS5
```{r}
set.seed(1)

# Filter main experiment samples
all_sample_df_temp <- all_sample_df[all_sample_df$experiment == "main", ]

# Define strain list
strain_list <- c(info$monoculture_bacteria_list[1],
                 info$monoculture_bacteria_list[3:14],
                 info$monoculture_bacteria_list[16])

# Count interaction types per environment
intDF <- data.frame()
for (i in 1:16) {
  temp <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  intDF <- rbind(intDF, data.frame(
    Mutualism = sum(temp$Type == "Mutualism"),
    Commensalism = sum(temp$Type == "Commensalism"),
    Parasitism = sum(temp$Type == "Parasitism"),
    Amensalism = sum(temp$Type == "Amensalism"),
    Competition = sum(temp$Type == "Competition"),
    Neutral = sum(temp$Type == "Neutral")
  ))
}
rownames(intDF) <- info$environment_list[1:16]

# Run pairwise PERMANOVA on interaction counts
X1 <- as.factor(info$carbon_source_categories_level1[1:16])
X2 <- as.factor(info$carbon_source_categories_level2[1:16])

pvalue_c <- c()

for (i in 1:7) {
  tempDF <- data.frame()
  for (j in 1:16) {
    if (as.numeric(X2[j]) == i) {
      tempDF <- rbind(tempDF, intDF[j, ])
    }
  }
  X3 <- c(rep(i, nrow(tempDF)), rep(8, 16))
  tempDF <- rbind(tempDF, intDF)
  result <- pairwise.adonis(as.matrix(tempDF), X3)
  pvalue_c <- c(pvalue_c, result["p.value"])
}

tempDF <- data.frame()
for (j in 1:16) {
  if (as.numeric(X2[j]) %in% c(1, 2, 3)) {
    tempDF <- rbind(tempDF, intDF[j, ])
  }
}
X3 <- c(rep(9, nrow(tempDF)), rep(8, 16))
tempDF <- rbind(tempDF, intDF)
result <- pairwise.adonis(as.matrix(tempDF), X3)
pvalue_c <- c(pvalue_c, result["p.value"])

# Adjust p-values
qvalue <- p.adjust(as.numeric(pvalue_c), method = "BH")
print(as.numeric(pvalue_c))
print(qvalue)
```

## TableS7
```{r}
set.seed(1)

# Filter for main experiment with 2-species co-culture
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 2 & all_sample_df$experiment == "main", ]

# Create theta dataframe
theta_df <- data.frame()
for (i in 1:28) {
  for (j in 1:16) {
    temp <- all_sample_df_temp[
      all_sample_df_temp$bacteria == info$coculture_bacteria_list[i] &
      all_sample_df_temp$environment == info$environment_list[j], ]
    
    theta_df <- rbind(theta_df, data.frame(
      theta = temp$theta_value[1],
      bacteria = info$coculture_bacteria_list[i],
      environment = info$environment_list[j]
    ))
  }
}

# Calculate mean theta per bacterial pair
df <- data.frame()
for (i in 1:28) {
  df <- rbind(df, data.frame(
    bacteria = info$coculture_bacteria_list[i],
    ave = mean(as.numeric(theta_df[theta_df$bacteria == info$coculture_bacteria_list[i], ]$theta))
  ))
}

# Sort and assign theta rank
df <- df %>%
  arrange(ave) %>%
  mutate(Theta = row_number())

# Create pair ID and extract strain names
df$ID <- paste("P_", df$Theta, sep = "")
df$Strain_A <- str_extract(df$bacteria, "^[^_]+")
df$Strain_B <- str_extract(df$bacteria, "(?<= - ).*(?=_mScarlet)")

# Initialize strain-pair mapping
strain <- data.frame(Strain = info$bacteria_list_Phylogenetic[1:8])
strain$pairs <- NA

# Map strains to their co-culture pair IDs
for (i in 1:nrow(strain)) {
  strain$pairs[i] <- c(
    df[df$Strain_A == strain$Strain[i], ]$ID,
    df[df$Strain_B == strain$Strain[i], ]$ID
  ) %>%
    unique() %>%
    paste(collapse = ",")
}

# Expand strain-pair associations to long format
for (i in 1:nrow(strain)) {
  my_tmp <- strain$pairs[i] %>% str_split(pattern = ",") %>% unlist()
  my_df <- data.frame(Strain = strain$Strain[i], ID = my_tmp)
  
  if (i == 1) {
    strain_pair_each <- my_df
  } else {
    strain_pair_each <- bind_rows(strain_pair_each, my_df)
  }
}

# Prepare gene list for GSEA (Theta values named by pair ID, descending order)
my_list <- df$Theta
names(my_list) <- df$ID
my_list <- my_list[order(my_list, decreasing = TRUE)]

# Run GSEA
res_gsea <- GSEA(
  geneList = my_list,
  TERM2GENE = strain_pair_each,
  nPerm = 1000000,
  minGSSize = 3,
  maxGSSize = 1000,
  pvalueCutoff = 1,
  pAdjustMethod = "BH"
)


print(res_gsea$ID)
print(res_gsea$pvalue)
print(res_gsea$p.adjust)
```

## TableS8
```{r}
# Filter for co-culture (2-species) data
all_sample_df_temp <- all_sample_df
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$bacterial_species_count == 2, ]

# Initialize empty dataframe to store results
analysed_df <- data.frame()

# Loop over all environment-bacteria combinations
for (j in 1:32) {
  for (i in 1:28) {
    
    # Subset data for specific coculture pair and environment
    temp <- all_sample_df_temp[all_sample_df_temp$bacteria == info$coculture_bacteria_list[i], ]
    temp <- temp[temp$environment == info$environment_list[j], ]
    
    # Append first row of relevant data to the output dataframe
    analysed_df <- rbind(
      analysed_df,
      data.frame(
        bacteria = temp$bacteria[1],
        coculture_species_GFP = temp$coculture_species_GFP[1],
        coculture_species_mScarlet = temp$coculture_species_mScarlet[1],
        environment = temp$environment[1],
        carbonsource_mixed_pair1 = temp$carbonsource_mixed_pair1[1],
        carbonsource_mixed_pair2 = temp$carbonsource_mixed_pair2[1],
        carbonsource_species_count = temp$carbonsource_species_count[1],
        green_Log2FoldChange = temp$greenaspect_value[1],
        red_Log2FoldChange = temp$redaspect_value[1],
        interaction_type = temp$theta_value[1],
        interaction_class = temp$Type[1]
      )
    )
  }
}

# Export result as CSV
write_csv(x = analysed_df, file = "TableS8.csv")
```

## TableS9, TableS10
```{r}
# Define the interaction types
interaction_types <- c("Mutualism", "Commensalism", "Parasitism", "Amensalism", "Competition", "Neutral")

# Filter main experiment and coculture with two bacterial species
all_sample_df_temp <- all_sample_df[all_sample_df$experiment == "main", ]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$bacterial_species_count == 2, ]

# Initialize the dataframe for storing interactions
interaction_map <- data.frame()
id <- 0

# Loop over environments and cocultures to populate interaction map
for (i in 1:32) {
  environment_data <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  
  for (j in 1:28) {
    id <- id + 1
    coculture_data <- environment_data[environment_data$bacteria == info$coculture_bacteria_list[j], ]
    interaction_map <- rbind(interaction_map, data.frame(ID = id, interaction_type = coculture_data$Type[1], 
                                                        Nb_cs = coculture_data$carbonsource_species_count[1], 
                                                        level_G = coculture_data$greenHD[1], 
                                                        level_R = coculture_data$redHD[1]))
  }
}

my_df <- interaction_map
my_df$UorL <- "Upper & Lower"
my_df[my_df$level_G == 1 & my_df$level_R == 1, ]$UorL <- "Lower & Lower"
my_df[my_df$level_G == 2 & my_df$level_R == 2, ]$UorL <- "Upper & Upper"
my_df$UorL <- factor(my_df$UorL, levels = c("Lower & Lower", "Upper & Lower", "Upper & Upper"))
my_df$frac <- 1

my_df$interaction_type <- factor(my_df$interaction_type, levels = interaction_types)
my_df$Nb_cs <- factor(my_df$Nb_cs, levels = c(0, 1, 2, 4, 8, 16))

carbon_sources <- c(0, 1, 2, 4, 8, 16)

k <- 1
for (i in 1:length(carbon_sources)) {
  my_univ <- my_df[my_df$Nb_cs == carbon_sources[i], ] %>% select(interaction_type, ID)
  my_subset <- my_df[(my_df$UorL %in% c("Upper & Lower", "Lower & Lower")) & (my_df$Nb_cs == carbon_sources[i]), ]$ID
  
  if (length(my_subset) > 0) {
    my_res <- enricher(gene = my_subset, TERM2GENE = my_univ, pvalueCutoff = 1, minGSSize = 1)
    my_res <- my_res@result
    my_res$Nb_cs <- carbon_sources[i]
    my_res$UorL <- "Upr-Lwr or Lwr-Lwr"
    
    if (k == 1) {
      my_res_df <- my_res
      k <- k + 1
    } else {
      my_res_df <- bind_rows(my_res_df, my_res)
    }
  }
}

# Perform the analysis for the "Upper & Upper" category
for (i in 1:length(carbon_sources)) {
  my_univ <- my_df[my_df$Nb_cs == carbon_sources[i], ] %>% select(interaction_type, ID)
  my_subset <- my_df[(my_df$UorL %in% c("Upper & Upper")) & (my_df$Nb_cs == carbon_sources[i]), ]$ID
  
  if (length(my_subset) > 0) {
    my_res <- enricher(gene = my_subset, TERM2GENE = my_univ, pvalueCutoff = 1, minGSSize = 1)
    my_res <- my_res@result
    my_res$Nb_cs <- carbon_sources[i]
    my_res$UorL <- "Upr-Upr"
    my_res_df <- bind_rows(my_res_df, my_res)
  }
}

print(my_res_df)
```

## Fig.S1 
```{r}
# Select samples for the 'main' experiment
all_sample_df_temp <- all_sample_df[all_sample_df$experiment == "main", ]
growth_spe <- data.frame("dammy" = c(1:16))
bacteria_list <- c(info$monoculture_bacteria_list[1], info$monoculture_bacteria_list[3:14], info$monoculture_bacteria_list[16])

# Loop through each bacterial strain
for (i in 1:14) {
  temp <- all_sample_df_temp[all_sample_df_temp$bacteria == bacteria_list[i], ]
  tempc <- data.frame()

  for (j in 1:16) {
    tempBE <- temp[temp$environment == info$environment_list[j], ]
    tempc <- rbind(tempc, "a" = log10(mean(as.numeric(tempBE$background_processing_target_fluorescent_cells_density))) - log10(457000))
  }
  
  growth_spe <- cbind(growth_spe, tempc)
}

# Normalize growth data to maximum value for each strain
normalizedG <- data.frame("dammy" = c(1:32))
for (i in 2:15) {
  tempmax <- max(growth_spe[, i])
  tempc <- data.frame()
  
  for (j in 1:16) {
    tempc <- rbind(tempc, "a" = growth_spe[j, i] / tempmax)
  }
  
  normalizedG <- cbind(normalizedG, tempc)
}

# Transpose the normalized data and set column/row names
normalizedGt <- t(normalizedG)[2:15, 1:16]
a <- set_colnames(normalizedGt, info$environment_list[1:16])
MetabolicMatrix <- set_rownames(a, bacteria_list)

# Reshape the data for heatmap plotting
MetabolicMelt <- melt(MetabolicMatrix)
colnames(MetabolicMelt) <- c("Strain", "Carbon", "Value")

# Create heatmap and save to PDF
dev.new()
pdf("FigS1_dendrogram.pdf")
heatmap(MetabolicMatrix, scale = "none")
dev.off()

# Create clr
dev.new()
clr <- heatmap(MetabolicMatrix, scale = "none")
dev.off()

# Get row and column indices for reordered heatmap
gene.idx <- rownames(MetabolicMatrix)[clr$rowInd]
group.idx <- colnames(MetabolicMatrix)[clr$colInd]

# Reorder factors for ggplot
MetabolicMelt$Strain <- factor(MetabolicMelt$Strain, levels = gene.idx)
MetabolicMelt$Carbon <- factor(MetabolicMelt$Carbon, levels = group.idx)

# Create and save ggplot heatmap
ghm <- ggplot(MetabolicMelt, aes(x = Carbon, y = Strain, fill = Value)) +
  geom_tile() +
  theme_pubr() +
  theme(axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        strip.background = element_rect(fill = "white", colour = "white"),
        axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1),
        axis.text.y = element_text(size = 10),
        axis.title = element_blank()) +
  scale_fill_gradientn("value", colours = c("grey95", "grey5"), na.value = "red") +
  coord_fixed(ratio = 1.14, xlim = NULL, ylim = NULL, expand = TRUE)

ggsave(file = "FigS1_heatmap.pdf", plot = ghm)
ghm
```

## Fig.S3
```{r}
FilterMaxOD96read <- function(plate_basic_name, plate_id, hour, env1, env2, strain, carbon1, carbon2, test, monoculture_fluorescence, monoculture_strain) {
  od <- c()
  id <- c()
  plate_name <- paste(plate_basic_name, plate_id, "_", hour, "h.csv", sep = "")
  d <- data.frame(read.csv(plate_name))
  
  for (i in 1:12) {
    for (j in 1:8) {
      od <- c(od, as.numeric(d[j, i + 1]))
    }
  }
  
  h96 <- rep(hour, 96)
  environment96 <- c(rep(env1, 48), rep(env2, 48))
  carbon96 <- c(rep(carbon1, 48), rep(carbon2, 48))
  index <- c(1:96)
  
  ODdf <- data.frame(
    "OD" = as.numeric(od),
    "hour" = as.numeric(h96),
    "strain" = strain,
    "env" = environment96,
    "index" = index,
    "platehour" = paste(plate_basic_name, plate_id, "-hour", hour, "_", index),
    "plateindex" = paste(plate_basic_name, plate_id, index),
    "carbon" = carbon96,
    "test" = test,
    "monoculture_fluorescence" = monoculture_fluorescence,
    "monoculture_strain" = monoculture_strain,
    stringsAsFactors = FALSE
  )
  return(ODdf)
}

env_list <- info$environment_list
strain <- info$coculture_platedesign
monoculture_fluorescence <- info$monoculture_fluorescence_list
monoculture_strain <- info$monoculture_platedesign

ODdfConc <- data.frame()
env_list <- info$monoculture_test_environment_list
carbon_list <- info$monoculture_test_carbon_list

for (i in 24:24) {
  for (j in 49:72) {
    temp_i <- if (i * 3 < 10) { paste("0", i * 3, sep = "") } else { i * 3 }
    temp_j <- if (j < 10) { paste("0", j, sep = "") } else { j }
    
    env1 <- env_list[((j - 48) * 2 - 1)]
    env2 <- env_list[((j - 48) * 2)]
    
    carbon1 <- carbon_list[((j - 48) * 2 - 1)]
    carbon2 <- carbon_list[((j - 48) * 2)]
    
    if (mod(j, 3) == 1) {
      conc <- data.frame(concentration = c(rep(0.5, 48), rep(1, 48)))
    } else if (mod(j, 3) == 2) {
      conc <- data.frame(concentration = c(rep(1.5, 48), rep(0.5, 48)))
    } else {
      conc <- data.frame(concentration = c(rep(1.0, 48), rep(1.5, 48)))
    }
    
    ODdfConctemp <- cbind(
      FilterMaxOD96read("Ono_plate", temp_j, temp_i, env1, env2, strain, carbon1, carbon2, "monoculture", monoculture_fluorescence, monoculture_strain),
      conc
    )
    ODdfConc <- rbind(ODdfConc, ODdfConctemp)
  }
}

concDF <- data.frame()
concentration_list <- c(0.5, 1, 1.5)

for (i in 1:16) {
  tempE <- ODdfConc[ODdfConc$carbon == info$environment_list[i],]
  
  for (j in 1:8) {
    tempB <- tempE[substr(tempE$monoculture_strain, 1, 3) == info$bacteria_list[j],]
    concDFt <- data.frame()
    
    for (k in 1:3) {
      temp <- tempB[tempB$concentration == concentration_list[k],]
      concDFt <- rbind(concDFt, data.frame(
        monoculture_strain = substr(temp$monoculture_strain[1], 1, 3),
        carbon = temp$carbon[1],
        concentration = as.numeric(temp$concentration[1]),
        mean = mean(temp$OD)
      ))
    }
    
    if ((concDFt[concDFt$concentration == 0.5,]$mean[1] < concDFt[concDFt$concentration == 1,]$mean[1]) & 
        (concDFt[concDFt$concentration == 1.0,]$mean[1] < concDFt[concDFt$concentration == 1.5,]$mean[1])) {
      c <- rep(1, 3)
    } else {
      c <- rep(0, 3)
    }
    
    concDFt <- cbind(concDFt, c)
    concDF <- rbind(concDF, concDFt)
  }
}

concDF <- transform(concDF, monoculture_strain = factor(monoculture_strain, levels = info$bacteria_list_Phylogenetic))
concDF <- transform(concDF, carbon = factor(carbon, levels = info$environment_list))

# Plot and save figures
g <- ggplot() +
  geom_violin(data = concDF, mapping = aes(x = as.factor(concentration), y = mean), alpha = 0.3, color = "grey") +
  geom_line(data = concDF, aes(x = as.factor(concentration), y = mean, color = carbon, group = interaction(carbon, monoculture_strain)), alpha = 0.5) +
  geom_point(data = concDF, mapping = aes(x = as.factor(concentration), y = mean, fill = monoculture_strain), alpha = 0.5, shape = 21, size = 2) +
  scale_y_continuous(limits = c(0, 0.75), breaks = c(0, 0.25, 0.5, 0.75), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_bacteria[1], color_bacteria[2], color_bacteria[3], color_bacteria[4], color_bacteria[5], color_bacteria[6], color_bacteria[7], color_bacteria[8])) +
  scale_color_manual(values = c(color_carbon[1], color_carbon[5], color_carbon[9], color_carbon[13], color_carbon[2], color_carbon[6], color_carbon[10], color_carbon[14], color_carbon[3], color_carbon[7], color_carbon[11], color_carbon[15], color_carbon[4], color_carbon[8], color_carbon[12], color_carbon[16])) +
  theme_bw() +
  theme(legend.position = "none", axis.title = element_blank(), axis.text = element_blank())
g
ggsave(file = "FigS2A.pdf", plot = g)

temp <- data.frame()

# Loop over 16 environments and 8 strains
for (i in 1:16) {
  for (j in 1:8) {
    
    temp1 <- concDF[concDF$carbon == info$environment_list[i], ]
    temp1 <- temp1[temp1$monoculture_strain == info$bacteria_list[j], ]
    
    # Filter data based on specific conditions (e.g., mean OD > threshold, flag column 'c' is 0)
    if (((temp1[temp1$concentration == 0.5, ]$mean > 0.05) |
         (temp1[temp1$concentration == 1.0, ]$mean > 0.05) |
         (temp1[temp1$concentration == 1.5, ]$mean > 0.05)) &&
        (temp1[temp1$concentration == 0.5, ]$c == 0)) {
      
      # Append filtered data to the result
      temp <- rbind(temp, temp1)
    }
  }
}

g <- ggplot() +
  geom_line(data = temp, aes(x = as.factor(concentration), y = mean, color = carbon, group = interaction(carbon, monoculture_strain)), alpha = 0.5) +
  geom_point(data = temp, aes(x = as.factor(concentration), y = mean, fill = monoculture_strain), alpha = 0.5, shape = 21, size = 2) +
  scale_y_continuous(limits = c(0, 0.75), breaks = c(0, 0.25, 0.5, 0.75), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_bacteria[1], color_bacteria[3], color_bacteria[4], color_bacteria[5], color_bacteria[6], color_bacteria[7], color_bacteria[8])) +
  scale_color_manual(values = c(color_carbon[1], color_carbon[10], color_carbon[14], color_carbon[3], color_carbon[15], color_carbon[4], color_carbon[12], color_carbon[16])) +
  theme_bw() +
  theme(legend.position = "none", axis.title = element_blank(), axis.text = element_blank())

ggsave(file = "FigS2B.pdf", plot = g)
g


# Filter data for the 'main' and 'conc' experiments
all_sample_df_temp <- all_sample_df[all_sample_df$experiment == "main" | all_sample_df$experiment == "conc", ]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 1, ]
ODdfConc <- all_sample_df_temp[all_sample_df_temp$bacterial_species_count == 1, ]

concDF <- data.frame()
concentration_list <- c(0.5, 1)

# Loop over 16 environments
for (i in 1:16) {
  tempE <- ODdfConc[ODdfConc$environment == info$environment_list[i], ]
  
  for (j in 1:8) {
    tempB <- tempE[tempE$monoculture_bacteria == info$bacteria_list[j], ]
    concDFt <- data.frame()
    
    for (k in 1:2) {
      
      # Subset data for the current concentration
      temp <- tempB[tempB$concentration == concentration_list[k], ]
      
      # Calculate the ratio of background fluorescence between concentrations
      concDFt <- rbind(concDFt, data.frame(
        monoculture_strain = temp$monoculture_bacteria[1],
        carbon = temp$environment[1],
        concentration = as.numeric(temp$concentration[1]),
        mean = mean(temp$background_processing_target_fluorescent_cells_density),
        k = k,
        a = mean(tempB[tempB$concentration == concentration_list[2], ]$background_processing_target_fluorescent_cells_density) /
          mean(tempB[tempB$concentration == concentration_list[1], ]$background_processing_target_fluorescent_cells_density),
        b = if (mean(tempB[tempB$concentration == concentration_list[2], ]$background_processing_target_fluorescent_cells_density) != 457000 &&
          mean(tempB[tempB$concentration == concentration_list[1], ]$background_processing_target_fluorescent_cells_density) != 457000) {
          mean(tempB[tempB$concentration == concentration_list[2], ]$background_processing_target_fluorescent_cells_density) /
            mean(tempB[tempB$concentration == concentration_list[1], ]$background_processing_target_fluorescent_cells_density)
        } else {
          "ERROR"
        }
      ))
    }
    
    # Flag if the mean concentration at 0.5 is greater than that at 1
    if (concDFt[concDFt$concentration == 0.5, ]$mean[1] <= concDFt[concDFt$concentration == 1, ]$mean[1]) {
      c <- rep(1, 2)
    } else {
      c <- rep(0, 2)
    }
    
    # Add the flag column to the dataframe
    concDFt <- cbind(concDFt, c)
    
    # Combine with the overall concentration dataframe
    concDF <- rbind(concDF, concDFt)
  }
}

# Transform factors for plotting
concDF <- transform(concDF, carbon = factor(carbon, levels = info$environment_list))
concDF <- transform(concDF, monoculture_strain = factor(monoculture_strain, levels = info$bacteria_list_Phylogenetic))

g <- ggplot() +
  geom_hline(yintercept = 4.57*10^5, linetype = "solid", alpha = 0.5, linewidth = 0.5, color = 'red') +
  geom_violin(data = concDF, mapping = aes(x = as.factor(concentration), y = mean), alpha = 0.3, color = "grey") +
  geom_line(data = concDF, aes(x = as.factor(concentration), y = mean, color = carbon, group = interaction(carbon, monoculture_strain)), alpha = 0.5) +
  geom_point(data = concDF, mapping = aes(x = as.factor(concentration), y = mean, fill = monoculture_strain), alpha = 0.5, shape = 21, size = 2) +
  scale_y_continuous(trans = "log10", limits = c(10^5, 3 * 10^9), breaks = c(10^6, 10^7, 10^8, 10^9), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_bacteria[1], color_bacteria[2], color_bacteria[3], color_bacteria[4], color_bacteria[5], color_bacteria[6], color_bacteria[7], color_bacteria[8])) +
  scale_color_manual(values = c(color_carbon[1], color_carbon[5], color_carbon[9], color_carbon[13], color_carbon[2], color_carbon[6], color_carbon[10], color_carbon[14], color_carbon[3], color_carbon[7], color_carbon[11], color_carbon[15], color_carbon[4], color_carbon[8], color_carbon[12], color_carbon[16])) +
  theme_bw() +
  theme(legend.position = "none", axis.title = element_blank(), axis.text = element_blank())

ggsave(file = "FigS2C.pdf", plot = g)
g

# Filter out rows with "ERROR" in column 'b'
concDF1 <- concDF[concDF$c == 0, ]

g <- ggplot() +
  geom_hline(yintercept = 4.57*10^5, linetype = "solid", alpha = 0.5, linewidth = 0.5, color = 'red') +
  geom_line(data = concDF1, aes(x = as.factor(concentration), y = mean, color = carbon, group = interaction(carbon, monoculture_strain)), alpha = 0.5) +
  geom_point(data = concDF1, mapping = aes(x = as.factor(concentration), y = mean, fill = monoculture_strain), alpha = 0.5, shape = 21, size = 2) +
  scale_y_continuous(trans = "log10", limits = c(10^5, 3 * 10^9), breaks = c(10^6, 10^7, 10^8, 10^9), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_bacteria[4], color_bacteria[6], color_bacteria[7], color_bacteria[8])) +
  scale_color_manual(values = c(color_carbon[1], color_carbon[5], color_carbon[13], color_carbon[6], color_carbon[10], color_carbon[14], color_carbon[11], color_carbon[4], color_carbon[12], color_carbon[16])) +
  theme_bw() +
  theme(axis.title = element_blank(), legend.text = element_text(size = 10), legend.position = "none", axis.text = element_blank())

ggsave(file = "FigS2D.pdf", plot = g)
g

# Filter out rows with "ERROR" in column 'b'
concNew <- concDF[concDF$b != "ERROR", ]

# Create histogram plot
g <- ggplot() +
  geom_histogram(data = concNew[concNew$k == k, ], mapping = aes(x = 1 / as.numeric(b)), alpha = 0.3, color = "grey", bins = 14) +
  scale_x_continuous(trans = "log10", limits = c(0.01, 3), breaks = c(0.01, 0.1, 1, 10)) +
  theme_bw()

ggsave(file = "FigS2E.pdf", plot = g)
g
```

## Fig.S4
```{r}
# Create GFP gating segments
df1 <- data.frame(x1 = 500, y1 = 100, x2 = 500, y2 = 1)
df2 <- data.frame(x1 = 500, y1 = 1, x2 = 299999, y2 = 1)
df3 <- data.frame(x1 = 299999, y1 = 1, x2 = 299999, y2 = 500)
df4 <- data.frame(x1 = 299999, y1 = 500, x2 = 5000, y2 = 500)
df5 <- data.frame()
for (i in seq(1000, 5000, by = 10)) {
  df5 <- rbind(df5, data.frame(x = i, y = i / 10))
}
df6 <- data.frame(x1 = 1000, y1 = 100, x2 = 500, y2 = 100)

# Create mScarlet gating segments
df7 <- data.frame(x1 = 1, y1 = 299999, x2 = 1, y2 = 100)
df8 <- data.frame(x1 = 1, y1 = 100, x2 = 500, y2 = 100)
df9 <- data.frame(x1 = 500, y1 = 100, x2 = 500, y2 = 500)
df10 <- data.frame()
for (i in seq(500, 2000, by = 1)) {
  df10 <- rbind(df10, data.frame(x = i, y = (i * 3 - 1000)))
}
df11 <- data.frame()
for (i in seq(2000, 7000, by = 10)) {
  df11 <- rbind(df11, data.frame(x = i, y = (i * 59 - 113000)))
}
df12 <- data.frame(x1 = 7000, y1 = 299999, x2 = 1, y2 = 299999)

# Create PCRed gating segments
df13 <- data.frame(x1 = 20000, y1 = 299999, x2 = 20000, y2 = 240000)
df14 <- data.frame()
for (i in seq(79000 / 15, 20000, by = 10)) {
  df14 <- rbind(df14, data.frame(x = i, y = (i * 15 - 60000)))
}
df15 <- data.frame(x1 = 79000 / 15, y1 = 19000, x2 = 37900, y2 = 19000)
df16 <- data.frame()
for (i in seq(37900, 60000, by = 10)) {
  df16 <- rbind(df16, data.frame(x = i, y = (i * 10 - 360000)))
}
df17 <- data.frame(x1 = 60000, y1 = 240000, x2 = 299999, y2 = 240000)
df18 <- data.frame(x1 = 299999, y1 = 240000, x2 = 299999, y2 = 299999)
df19 <- data.frame(x1 = 299999, y1 = 299999, x2 = 20000, y2 = 299999)
df20 <- data.frame(x1 = 1, y1 = 170000, x2 = 299999, y2 = 170000)
df21 <- data.frame()
for (i in seq(0, 100000, by = 10)) {
  df21 <- rbind(df21, data.frame(x = i, y = (i * 110000 / 69000 + 60000 - 31000 * 110000 / 69000)))
}

# Load FCS file
sample <- read.FCS("Ono_plate23_19.fcs")

# Extract required channels and initialize Gate.count
tempDataframe <- data.frame(
  SSC.H = data.frame(sample@exprs)["SSC.H"],
  FITC.A = data.frame(sample@exprs)["FITC.A"],
  PE.A = data.frame(sample@exprs)["PE.A"],
  PE.Cy5.A = data.frame(sample@exprs)["PE.Cy5.A"],
  Gate.count = 0
)
total_count <- sample@description$`$TOT`

# Replace values <1 with 1 (log scale compatibility)
tempDataframe$FITC.A[tempDataframe$FITC.A < 1] <- 1
tempDataframe$PE.A[tempDataframe$PE.A < 1] <- 1
tempDataframe$PE.Cy5.A[tempDataframe$PE.Cy5.A < 1] <- 1

# Gate definitions
tempDataframe[tempDataframe$FITC.A > 500 | tempDataframe$PE.A > 100, "Gate.count"] <- 5  # bicolor
tempDataframe[
  (tempDataframe$FITC.A > 500 & tempDataframe$PE.A < 100) |
  (tempDataframe$PE.A > 100 & tempDataframe$PE.A < 500 & tempDataframe$PE.A < tempDataframe$FITC.A / 10),
  "Gate.count"
] <- 4  # GFP
tempDataframe[
  (tempDataframe$FITC.A < 500 & tempDataframe$PE.A > 100) |
  (tempDataframe$FITC.A > 500 & tempDataframe$FITC.A < 2000 & tempDataframe$PE.A > (tempDataframe$FITC.A * 3 - 1000)) |
  (tempDataframe$FITC.A > 2000 & tempDataframe$FITC.A < 7000 & tempDataframe$PE.A > (tempDataframe$FITC.A * 59 - 113000)),
  "Gate.count"
] <- 3  # mScarlet
tempDataframe[tempDataframe$SSC.H > 25000, "Gate.count"] <- 2  # beads debris
tempDataframe[
  (tempDataframe$SSC.H > 240000 & tempDataframe$PE.Cy5.A > 20000 & tempDataframe$FITC.A > 20000 &
   tempDataframe$PE.A > 800 &
   (tempDataframe$PE.A > 170000 | tempDataframe$PE.A < tempDataframe$FITC.A * 110 / 69 + 60000 - 31000 * 110 / 69)) |
  (tempDataframe$SSC.H > 19000 & tempDataframe$SSC.H < (15 * tempDataframe$PE.Cy5.A - 60000) &
   tempDataframe$SSC.H > (10 * tempDataframe$PE.Cy5.A - 360000) &
   tempDataframe$FITC.A > 20000 & tempDataframe$PE.A > 800 &
   (tempDataframe$PE.A > 170000 | tempDataframe$PE.A < tempDataframe$FITC.A * 110 / 69 + 60000 - 31000 * 110 / 69)),
  "Gate.count"
] <- 1  # beads

# Define colors
colorT <- rgb(255, 255, 255, maxColorValue = 255, alpha = 0)
colorG1 <- rgb(89 + (255 - 89) * 2 / 3, 178 + (255 - 178) * 2 / 3, 101 + (255 - 101) * 2 / 3, maxColorValue = 255)
colorG2 <- rgb(89 + (255 - 89) * 1 / 3, 178 + (255 - 178) * 1 / 3, 101 + (255 - 101) * 1 / 3, maxColorValue = 255)
colorG3 <- rgb(89, 178, 101, maxColorValue = 255)
colorR1 <- rgb(230 + (255 - 230) * 2 / 3, 115 + (255 - 115) * 2 / 3, 202 + (255 - 202) * 2 / 3, maxColorValue = 255)
colorR2 <- rgb(230 + (255 - 230) * 1 / 3, 115 + (255 - 115) * 1 / 3, 202 + (255 - 202) * 1 / 3, maxColorValue = 255)
colorR3 <- rgb(230, 115, 202, maxColorValue = 255)

# Subset gated cells
temp <- tempDataframe[tempDataframe$Gate.count %in% c(3, 4), ]
tempG <- temp[temp$Gate.count == 4, ]
tempR <- temp[temp$Gate.count == 3, ]

# Plot GFP
g1 <- ggplot() +
  geom_point(data = tempG, aes(x = FITC.A, y = PE.A), size = 0.1, shape = 20, color = colorG3, alpha = 0.2) +
  geom_density_2d_filled(data = tempG, aes(x = FITC.A, y = PE.A), breaks = c(0, 0.01, 0.1, 1, 10, 100)) +
  scale_fill_discrete(type = c(colorT, colorG1, colorG2, colorG3, "black")) +
  geom_density_2d(data = tempG, aes(x = FITC.A, y = PE.A), breaks = c(0, 0.01, 0.1, 1, 10, 100), color = "black") +
  scale_x_continuous(trans = "log10", limits = c(1, 300000), breaks = 10^(0:5), guide = guide_axis(angle = 90), expand = c(0.004, 0.004)) +
  scale_y_continuous(trans = "log10", limits = c(1, 300000), breaks = 10^(0:5), expand = c(0.004, 0.004)) +
  coord_fixed() +
  theme_minimal() +
  theme(panel.background = element_rect(fill = colorT), axis.line = element_blank())
plot(g1)
ggsave("Fig.S4_GFP.pdf", plot = g1)

# Plot mScarlet + gates
g2 <- ggplot() +
  geom_point(data = tempR, aes(x = FITC.A, y = PE.A), size = 0.1, shape = 20, color = colorR3, alpha = 0.2) +
  geom_density_2d_filled(data = tempR, aes(x = FITC.A, y = PE.A), breaks = c(0, 0.01, 0.1, 1, 10, 100)) +
  scale_fill_discrete(type = c(colorT, colorR1, colorR2, colorR3, "black")) +
  geom_density_2d(data = tempR, aes(x = FITC.A, y = PE.A), breaks = c(0, 0.01, 0.1, 1, 10, 100), color = "black") +
  scale_x_continuous(trans = "log10", limits = c(1, 300000), breaks = 10^(0:5), guide = guide_axis(angle = 90), expand = c(0.004, 0.004)) +
  scale_y_continuous(trans = "log10", limits = c(1, 300000), breaks = 10^(0:5), expand = c(0.004, 0.004)) +
  coord_fixed() +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2), color = colorG3, data = df1) +
  geom_segment(data = df2, aes(x = x1, y = y1, xend = x2, yend = y2), color = colorG3) +
  geom_segment(data = df3, aes(x = x1, y = y1, xend = x2, yend = y2), color = colorG3) +
  geom_segment(data = df4, aes(x = x1, y = y1, xend = x2, yend = y2), color = colorG3) +
  geom_segment(data = df6, aes(x = x1, y = y1, xend = x2, yend = y2), color = colorG3) +
  geom_segment(data = df7, aes(x = x1, y = y1, xend = x2, yend = y2), color = colorR3) +
  geom_segment(data = df8, aes(x = x1, y = y1, xend = x2, yend = y2), color = colorR3) +
  geom_segment(data = df9, aes(x = x1, y = y1, xend = x2, yend = y2), color = colorR3) +
  geom_segment(data = df12, aes(x = x1, y = y1, xend = x2, yend = y2), color = colorR3) +
  geom_line(data = df5, aes(x = x, y = y), color = colorG3) +
  geom_line(data = df10, aes(x = x, y = y), color = colorR3) +
  geom_line(data = df11, aes(x = x, y = y), color = colorR3) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = colorT), panel.grid = element_blank())
plot(g2)
ggsave("Fig.S4_RFP.pdf", plot = g2)
```

## FigS6
```{r}
# Create data frame
thetaplot_df <- data.frame()

for (i in 1:28) {
  for (j in 1:16) {
    temp <- all_sample_df[all_sample_df$experiment == "main", ]
    temp <- temp[temp$bacterial_species_count == 2, ]
    temp <- temp[temp$bacteria == info$coculture_bacteria_list[i], ]
    temp <- temp[temp$environment == info$environment_list[j], ]
    
    thetaplot_df <- rbind(thetaplot_df, data.frame(
      bacteria = info$coculture_bacteria_list[i],
      environment = info$environment_list[j],
      nc = as.numeric(temp$carbonsource_species_count[1]),
      x_value = as.numeric(temp$x_value)[1],
      x_sd = as.numeric(temp$x_sd)[1],
      y_value = as.numeric(temp$y_value)[1],
      y_sd = as.numeric(temp$y_sd)[1],
      theta_value = as.numeric(temp$theta_value)[1],
      Type = temp$Type[1],
      plot_hierarchy = temp$plot_hierarchy[1]
    ))
  }
}

# Filter for single-carbon environments
thetaplot_df1 <- thetaplot_df[thetaplot_df$nc == 1, ]

# Create interaction matrix (strain × environment)
int_matrix16 <- data.frame()

for (i in 1:28) {
  temp_row <- data.frame(dummy = c(1))
  
  for (j in 1:16) {
    temp <- all_sample_df[all_sample_df$experiment == "main", ]
    temp <- temp[temp$bacterial_species_count == 2, ]
    temp <- temp[temp$bacteria == info$coculture_bacteria_list[i], ]
    temp <- temp[temp$environment == info$environment_list[j], ]
    
    temp_row <- cbind(temp_row, data.frame(environment = temp$Type[1]))
  }
  
  int_matrix16 <- rbind(int_matrix16, temp_row)
}

# Clean up interaction matrix
int_matrix16 <- int_matrix16[1:28, 2:17]
int_matrix16 <- set_colnames(x = int_matrix16, value = info$environment_list[1:16])
int_matrix16 <- set_rownames(x = int_matrix16, value = info$coculture_bacteria_list[1:28])
int_matrix16[] <- lapply(int_matrix16, as.factor)

# Compute distance and cluster strains
distance_matrix <- daisy(int_matrix16, metric = "dice")
hc <- hclust(as.dist(distance_matrix), method = "average")

par(mar = c(10, 0, 10, 0), pin = c(4, 1))

bac.idx <- info$coculture_bacteria_list[hc$order]

# Save dendrogram for strains
# dev.new()
# pdf("FigS6_for_bacteria_dendrogram.pdf")
# par(mar = c(10, 0, 10, 0), pin = c(4, 1))
# plot(hc, main = "", xlab = "", sub = "", cex = 0.8, labels = FALSE, hang = -1)
# dev.off()

# dev.new()
# pdf("FigS6_for_bacteria_dendrogram_for_species_ref.pdf")
# plot(hc, main = "", xlab = "", sub = "", cex = 0.8)
# dev.off()

# Cluster environments instead of strains
int_matrix16 <- as.data.frame(t(as.matrix(int_matrix16)))
int_matrix16[] <- lapply(int_matrix16, as.factor)

distance_matrix <- daisy(int_matrix16, metric = "dice")
hc <- hclust(as.dist(distance_matrix), method = "average")

# Save dendrogram for environments
# dev.new()
# pdf("FigS6_for_env_dendrogram.pdf")
# par(mar = c(10, 0, 10, 0), pin = c(4, 1))
# plot(hc, main = "", xlab = "", sub = "", cex = 0.8, labels = FALSE, hang = -1)
# dev.off()

# dev.new()
# pdf("FigS6_for_env_dendrogram_for_species_ref.pdf")
# plot(hc, main = "", xlab = "", sub = "", cex = 0.8)
# dev.off()

env.idx <- info$environment_list[hc$order]

# Reorder factors for plotting
thetaplot_df1$environment <- factor(thetaplot_df1$environment, levels = env.idx)
thetaplot_df1$bacteria <- factor(thetaplot_df1$bacteria, levels = bac.idx)

# Create heatmap of interaction types
g <- ggplot(thetaplot_df1, aes(x = environment, y = bacteria, fill = Type)) +
  geom_tile() +
  scale_fill_manual(values = c(
    color_interaction$mutualism,
    color_interaction$commensalism,
    color_interaction$parasitism,
    color_interaction$amensalism,
    color_interaction$competition,
    color_interaction$neutral
  )) +
  theme_pubr() +
  coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
    strip.background = element_rect(fill = "white", colour = "white"),
    axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 10),
    axis.title = element_blank()
  )

g
ggsave(file = "FigS6_tile.pdf", plot = g)
```

## FigS7
```{r}
# Create binary presence matrix: rows = strains, cols = co-culture pairs
df1 <- data.frame(rep(0, 8))
for (i in 1:27) {
  df1 <- cbind(df1, rep(0, 8))
}
colnames(df1) <- df$bacteria
rownames(df1) <- info$bacteria_list_Phylogenetic[1:8]

# Fill matrix: 1 if strain name is included in the co-culture pair name
for (i in 1:nrow(df1)) {
  for (j in 1:ncol(df1)) {
    row <- rownames(df1)[i]
    col <- colnames(df1)[j]
    df1[i, j] <- ifelse(grepl(row, col, fixed = TRUE), 1, 0)
  }
}

# Convert to long format for plotting
SpeDF <- data.frame()
for (i in 1:8) {
  for (j in 1:28) {
    SpeDF <- rbind(SpeDF, data.frame(
      y = info$bacteria_list_Phylogenetic[i],
      x = j,
      value = df1[i, j]
    ))
  }
}
SpeDF$y <- factor(SpeDF$y, levels = info$bacteria_list_Phylogenetic[8:1])

# Plot tile heatmap
g <- ggplot(SpeDF, aes(x = as.factor(x), y = y, fill = as.factor(value))) +
  geom_tile() +
  scale_fill_manual(values = c("grey90", "grey20")) +
  theme_pubr() +
  coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
    strip.background = element_rect(fill = "white", colour = "white"),
    axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_text(size = 10),
    axis.title = element_blank()
  )

g
ggsave(file = "FigS7.pdf", plot = g)
```

## FigS8
```{r}
# Create data frame
thetaplot_df <- data.frame()

for (i in 1:28) {
  for (j in 1:32) {
    temp <- all_sample_df[all_sample_df$experiment == "main", ]
    temp <- temp[temp$bacterial_species_count == 2, ]
    temp <- temp[temp$bacteria == info$coculture_bacteria_list[i], ]
    temp <- temp[temp$environment == info$environment_list[j], ]
    
    thetaplot_df <- rbind(
      thetaplot_df,
      data.frame(
        bacteria = info$coculture_bacteria_list[i],
        environment = info$environment_list[j],
        nc = as.numeric(temp$carbonsource_species_count[1]),
        x_value = as.numeric(temp$x_value)[1],
        x_sd = as.numeric(temp$x_sd)[1],
        y_value = as.numeric(temp$y_value)[1],
        y_sd = as.numeric(temp$y_sd)[1],
        theta_value = as.numeric(temp$theta_value)[1],
        Type = temp$Type[1],
        plot_hierarchy = temp$plot_hierarchy[1]
      )
    )
  }
}

# Set factor levels
thetaplot_df$environment <- factor(thetaplot_df$environment, levels = info$environment_list)
thetaplot_df$bacteria <- factor(thetaplot_df$bacteria, levels = info$coculture_bacteria_list)

# Plot heatmaps by carbon source count (nc)
plot_by_nc <- function(nc_val, legend = TRUE, save_name = "") {
  df_subset <- thetaplot_df[thetaplot_df$nc == nc_val, ]
  
  p <- ggplot(df_subset, aes(x = environment, y = bacteria, fill = Type)) +
    geom_tile() +
    coord_fixed(ratio = 1 / nc_val) +
    theme_pubr() +
    scale_fill_manual(values = switch(
      as.character(nc_val),
      "1" = c(color_interaction$mutualism, color_interaction$commensalism,
             color_interaction$parasitism, color_interaction$amensalism,
             color_interaction$competition, color_interaction$neutral),
      "2" = c(color_interaction$mutualism, color_interaction$commensalism,
             color_interaction$parasitism, color_interaction$amensalism,
             color_interaction$competition, color_interaction$neutral),
      "4" = c(color_interaction$mutualism, color_interaction$commensalism,
             color_interaction$parasitism, color_interaction$amensalism,
             color_interaction$competition, color_interaction$neutral),
      "8" = c(color_interaction$parasitism, color_interaction$amensalism,
             color_interaction$competition, color_interaction$neutral),
      "16" = c(color_interaction$amensalism, color_interaction$competition)
    )) +
    theme(
      axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
      axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
      strip.background = element_rect(fill = "white", colour = "white"),
      axis.text.x = if (nc_val == 1 && legend) element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1) else element_blank(),
      axis.text.y = if (nc_val == 1 && legend) element_text(size = 10) else element_blank(),
      axis.title = element_blank(),
      legend.position = if (legend) "right" else "none"
    )
  
  ggsave(file = save_name, plot = p)
  plot(p)
}

# Generate and save plots
plot_by_nc(1, legend = FALSE, save_name = "FigS8_C1_tile.pdf")
plot_by_nc(2, legend = FALSE, save_name = "FigS8_C2_tile.pdf")
plot_by_nc(4, legend = FALSE, save_name = "FigS8_C4_tile.pdf")
plot_by_nc(8, legend = FALSE, save_name = "FigS8_C8_tile.pdf")
plot_by_nc(16, legend = FALSE, save_name = "FigS8_C16_tile.pdf")
```

## FigS9
```{r}
# Filter to monoculture samples in the main experiment
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 1, ]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$experiment == "main", ]

# Define target strains
strain_list <- c(info$monoculture_bacteria_list[1], info$monoculture_bacteria_list[3:14], info$monoculture_bacteria_list[16])

meanDF <- data.frame()
for (i in 1:32) {
  for (j in 1:14) {
    temp <- all_sample_df_temp[
      all_sample_df_temp$environment == info$environment_list[i] &
      all_sample_df_temp$bacteria == strain_list[j], ]

    meanDF <- rbind(meanDF, data.frame(
      env = temp$environment[1],
      nc = temp$carbonsource_species_count[1],
      species = temp$monoculture_bacteria[1],
      strain = temp$bacteria[1],
      mean = log(mean(temp$target_fluorescent_cells_density), 10)
    ))
  }
}

# Hierarchical clustering and dendrogram plotting (Ward method)
KResult <- data.frame()
for (i in 1:8) {
  c1 <- meanDF[meanDF$species == info$bacteria_list[i], ]$species
  c2 <- meanDF[meanDF$species == info$bacteria_list[i], ]$mean
  part1 <- data.frame(target_fluorescent_cells_density = c2)

  distance <- dist(part1)
  hc <- hclust(distance, method = "ward.D2")

  # dev.new()
  # par(mar = c(10, 0, 10, 0), pin = c(4, 1))
  # plot(hc, main = "", xlab = "", sub = "", cex = 0.8, labels = FALSE, hang = -1)
  # dev.off()

  hcresult <- cutree(hc, k = 2)
  result <- data.frame(
    target_fluorescent_cells_density = part1$target_fluorescent_cells_density,
    monoculture_bacteria = c1,
    hc = hcresult
  )
  KResult <- rbind(KResult, result)
}

# Additional metadata for clustering results
KResult <- data.frame()
for (i in 1:8) {
  strain <- meanDF[meanDF$species == info$bacteria_list[i], ]$strain
  species <- meanDF[meanDF$species == info$bacteria_list[i], ]$species
  mean_val <- meanDF[meanDF$species == info$bacteria_list[i], ]$mean
  env <- meanDF[meanDF$species == info$bacteria_list[i], ]$env
  nc <- meanDF[meanDF$species == info$bacteria_list[i], ]$nc
  part1 <- data.frame(target_fluorescent_cells_density = mean_val)

  distance <- dist(part1)
  hc <- hclust(distance, method = "ward.D2")
  # plot(hc)
  hcresult <- cutree(hc, k = 2)

  result <- data.frame(
    target_fluorescent_cells_density = part1$target_fluorescent_cells_density,
    monoculture_bacteria = strain,
    species = species,
    hc = hcresult,
    env = env,
    nc = nc
  )
  KResult <- rbind(KResult, result)
}

# Manually reassign cluster labels for specific strains
KResult[KResult$monoculture_bacteria == "AgT_GFP" & KResult$hc == 1, ]$hc <- 3
KResult[KResult$monoculture_bacteria == "AgT_GFP" & KResult$hc == 2, ]$hc <- 1
KResult[KResult$monoculture_bacteria == "AgT_GFP" & KResult$hc == 3, ]$hc <- 2

KResult[KResult$monoculture_bacteria == "SpP_GFP Tn5" & KResult$hc == 1, ]$hc <- 3
KResult[KResult$monoculture_bacteria == "SpP_GFP Tn5" & KResult$hc == 2, ]$hc <- 1
KResult[KResult$monoculture_bacteria == "SpP_GFP Tn5" & KResult$hc == 3, ]$hc <- 2

KResult[KResult$monoculture_bacteria == "SpP_mScarlet" & KResult$hc == 1, ]$hc <- 3
KResult[KResult$monoculture_bacteria == "SpP_mScarlet" & KResult$hc == 2, ]$hc <- 1
KResult[KResult$monoculture_bacteria == "SpP_mScarlet" & KResult$hc == 3, ]$hc <- 2

KResult$species <- factor(KResult$species, levels = info$bacteria_list_Phylogenetic[1:8])

# Plot violin/jitter plot of cell density
g <- ggplot() +
  geom_hline(yintercept = log(457000, 10), linetype = "solid", alpha = 0.5, size = 1, color = 'red') +
  geom_violin(data = KResult, aes(x = species, y = target_fluorescent_cells_density), fill = "white", color = "black") +
  geom_jitter(data = KResult, aes(x = species, y = target_fluorescent_cells_density, color = as.factor(hc)), 
              width = 0.35, height = 0, shape = 21, stroke = 0.8, size = 0.8) +
  geom_violin(data = KResult, aes(x = species, y = target_fluorescent_cells_density), fill = NA, color = "black") +
  scale_y_continuous(limits = c(3, 10), expand = c(0, 0), breaks = c(3, 5, 7, 9)) +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  scale_color_manual(values = c("#51829B", "#F6995C")) +
  theme_pubr() +
  theme(
    axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
    legend.position = "none",
    axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.margin = margin(t = 150, r = 230, b = 0, l = 0, unit = "pt")
  )
g
ggsave(file = "FigS9.pdf", plot = g)
```

## FigS10
```{r}
# Filter only "main" experiment
all_sample_df_temp <- all_sample_df[all_sample_df$experiment == "main", ]

# Function to generate growth tile plot
generate_growth_tile_plot <- function(env_range, width_value) {
  growth_spe <- data.frame()
  
  for (i in 1:8) {
    temp <- all_sample_df_temp[all_sample_df_temp$monoculture_bacteria == info$bacteria_list[i], ]
    tempc <- data.frame()
    
    for (j in env_range) {
      tempBE <- temp[temp$environment == info$environment_list[j], ]
      
      mean_val <- log10(mean(as.numeric(tempBE$background_processing_target_fluorescent_cells_density)))
      tempc <- rbind(tempc, data.frame(
        bacteria = info$bacteria_list[i],
        env = info$environment_list[j],
        mean = mean_val
      ))
    }
    
    growth_spe <- rbind(growth_spe, tempc)
  }

  growth_spe <- transform(growth_spe, bacteria = factor(bacteria, levels = info$bacteria_list_Phylogenetic[1:8]))
  growth_spe <- transform(growth_spe, env = factor(env, levels = rev(info$environment_list[env_range])))

  plot <- ggplot() +
    geom_tile(data = growth_spe, mapping = aes(x = env, y = bacteria, fill = as.numeric(mean)), width = width_value) +
    scale_fill_gradientn("Median", colours = c("grey95", "grey5"), na.value = "blue", limit = c(log10(457000), 10)) +
    scale_x_discrete(guide = guide_axis(angle = 90)) +
    coord_flip() +
    theme_minimal()

  return(plot)
}

# Generate tile plots for each environment group
g1  <- generate_growth_tile_plot(1:16, 0.75)
g2  <- generate_growth_tile_plot(17:24, 0.875)
g4  <- generate_growth_tile_plot(25:28, 0.94)
g8  <- generate_growth_tile_plot(29:30, 0.97)
g16 <- generate_growth_tile_plot(31:31, 1)

# Blank panel (for layout spacing)
panel.blank <- ggplot() +
  geom_point(aes(1, 1), colour = "white") +
  theme(
    plot.background = element_rect(colour = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank()
  )

# Layout matrix and plot arrangement
layout1 <- rbind(
  c(8, 1, 2, 3, 4, 5, 9, 7),
  c(6, 6, 6, 6, 6, 6, 6, 7)
)

g <- gridExtra::grid.arrange(
  g1 + theme_void() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = "none", title = element_blank(), plot.margin = margin(t = 14.3, r = 15, b = 14.02, l = 0, unit = "pt")),
  g2 + theme_void() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = "none", title = element_blank(), plot.margin = margin(t = 13, r = 15, b = 13, l = 0, unit = "pt")),
  g4 + theme_void() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = "none", title = element_blank(), plot.margin = margin(t = 11.03, r = 15, b = 11.03, l = 0, unit = "pt")),
  g8 + theme_void() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = "none", title = element_blank(), plot.margin = margin(t = 6.83, r = 15, b = 6.83, l = 0, unit = "pt")),
  g16 + theme_void() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = "none", title = element_blank(), plot.margin = margin(t = 0, r = 15, b = 0, l = 0, unit = "pt")),
  panel.blank,panel.blank, panel.blank, panel.blank,
  layout_matrix = layout1,
  widths = c(0, 1, 1, 1, 1, 1, 0, 1.305),
  heights = c(1.90, 1)
)

plot(g)

ggsave(file = "FigS10.pdf", plot = g)
```

## FigS11
```{r}
# Filter data for bacterial species count of 2, 'main' experiment, and exclude 'water' environment
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 2,]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$experiment == "main",]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$environment != "water",]

temp <- data.frame()
for(i in 1:length(all_sample_df_temp$fcs_file)){
  if ((mean(as.numeric(all_sample_df_temp$green_max[i]), as.numeric(all_sample_df_temp$green_med[i]), as.numeric(all_sample_df_temp$green_min[i])) != 457000) && 
      (mean(as.numeric(all_sample_df_temp$red_max[i]), as.numeric(all_sample_df_temp$red_med[i]), as.numeric(all_sample_df_temp$red_min[i])) != 457000)) {
    temp <- rbind(temp, all_sample_df_temp[i,])
  }
}

all_sample_df_temp <- temp

# Filter data for 'EE' condition
EE <- all_sample_df_temp[all_sample_df_temp$greenHD == "2" & all_sample_df_temp$redHD == "2",]

temp <- data.frame()
for(i in 1:6){
  tempEH <- EE[EE$Type == info$interaction_types_list[i],]
  for(j in c(1, 2, 4, 8, 16)){
    tempEHc <- tempEH[tempEH$carbonsource_species_count == j,]
    temp <- rbind(temp, data.frame(carbonsource_species_count = j, Type = info$interaction_types_list[i], count = length(tempEHc$fcs_file)))
  }
}

# Assign the results to 'EE' and transform factor levels
EE <- temp
EE <- transform(EE, Type = factor(Type, levels = info$interaction_types_list))
EE <- transform(EE, carbonsource_species_count = factor(carbonsource_species_count, levels = c("1", "2", "4", "8", "16")))

# Create and save the plot for EE condition
g <- ggplot(data = EE) +
  geom_histogram(mapping = aes(x = carbonsource_species_count, y = count / 3, fill = Type), position = "stack", stat = "identity", width = 0.8) +
  scale_y_continuous(limits = c(0, 150), breaks = c(0, 50, 100, 150), expand = c(0, 0)) +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"), axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        legend.position = "none", axis.title = element_blank(), axis.text = element_text(size = 15), plot.margin = margin(t = 150, r = 330, b = 0, l = 0, unit = "pt")) +
  scale_fill_manual(values = c(color_interaction$mutualism, color_interaction$commensalism, color_interaction$parasitism, color_interaction$amensalism, color_interaction$competition, color_interaction$neutral))

ggsave(file = "FigS11_EE.pdf", plot = g)

# Filter data for 'EH/HH' conditions based on greenHD and redHD values
EH_HH <- all_sample_df_temp[(all_sample_df_temp$greenHD == "1" & all_sample_df_temp$redHD == "1") | 
                             (all_sample_df_temp$greenHD == "2" & all_sample_df_temp$redHD == "1") |
                             (all_sample_df_temp$greenHD == "1" & all_sample_df_temp$redHD == "2"),]

temp <- data.frame()
for(i in 1:6){
  tempEH <- EH_HH[EH_HH$Type == info$interaction_types_list[i],]
  for(j in c(1, 2, 4, 8, 16)){
    tempEHc <- tempEH[tempEH$carbonsource_species_count == j,]
    temp <- rbind(temp, data.frame(carbonsource_species_count = j, Type = info$interaction_types_list[i], count = length(tempEHc$fcs_file)))
  }
}

# Assign the results to 'EH_HH' and transform factor levels
EH_HH <- temp
EH_HH <- transform(EH_HH, Type = factor(Type, levels = info$interaction_types_list))
EH_HH <- transform(EH_HH, carbonsource_species_count = factor(carbonsource_species_count, levels = c("1", "2", "4", "8", "16")))

# Create and save the plot for EH_HH condition
g <- ggplot(data = EH_HH) +
  geom_histogram(mapping = aes(x = carbonsource_species_count, y = count / 3, fill = Type), position = "stack", stat = "identity", width = 0.8) +
  scale_y_continuous(limits = c(0, 150), breaks = c(0, 50, 100, 150), expand = c(0, 0)) +
  theme_minimal() +
  theme(axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"), axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        legend.position = "none", axis.title = element_blank(), axis.text = element_text(size = 15), plot.margin = margin(t = 150, r = 330, b = 0, l = 0, unit = "pt")) +
  scale_fill_manual(values = c(color_interaction$mutualism, color_interaction$commensalism, color_interaction$parasitism, color_interaction$amensalism, color_interaction$competition, color_interaction$neutral))

ggsave(file = "FigS11_EH_HH.pdf", plot = g)
```

## FigS13
```{r}
# Filter single-species samples in the main experiment
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 1, ]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$experiment == "main", ]

# Select strain list (excluding element 2 and 15)
strain_list <- c(info$monoculture_bacteria_list[1],
                 info$monoculture_bacteria_list[3:14],
                 info$monoculture_bacteria_list[16])

# 1->2 mixing environments
# Initialize data frame for observed vs predicted values
mix2ave2 <- data.frame()

for (i in 17:24) {
  tempE2 <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1  <- all_sample_df_temp[all_sample_df_temp$environment == tempE2$carbonsource_mixed_pair1[1], ]
  temp2  <- all_sample_df_temp[all_sample_df_temp$environment == tempE2$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    temp1B <- as.numeric(temp1[temp1$bacteria == strain_list[j], ]$final_OD)
    temp2B <- as.numeric(temp2[temp2$bacteria == strain_list[j], ]$final_OD)
    
    cmono  <- c(temp1B, temp2B)
    ave12  <- mean(cmono)
    sdmean <- sqrt(mean(c(var(temp1B), var(temp2B))))
    tempY  <- c(ave12 - sdmean, ave12, ave12 + sdmean)
    
    tempEBc <- as.numeric(tempE2[tempE2$bacteria == strain_list[j], ]$final_OD)
    
    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2ave2 <- rbind(mix2ave2, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = ptemp
        ))
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY, alternative = "two.sided",
                  paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for (k in 1:length(tempEBc)) {
        mix2ave2 <- rbind(mix2ave2, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = t$p.value
        ))
      }
    }
  }
}

mix2ave2$qvalue <- p.adjust(mix2ave2$pvalue, method = "BH")

meanDF2 <- data.frame()
for (i in 17:24) {
  for (j in 1:14) {
    temp <- mix2ave2[(mix2ave2$env == info$environment_list[i]) &
                     (mix2ave2$bacteria == strain_list[j]), ]
    
    meanDF2 <- rbind(meanDF2, data.frame(
      envbac = paste(info$environment_list[i], strain_list[j]),
      ave12  = temp$ave12[1],
      mean   = mean(temp$value),
      sdx    = temp$sdx[1],
      sdy    = temp$sdy[1],
      p      = if (temp$qvalue[1] < 0.05) 1 else 0,
      pp     = if ((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1])) {
                 "high"
               } else if ((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1])) {
                 "low"
               } else {
                 "same"
               }
    ))
  }
}

# Count outcome types
temphigh <- 0
tempsame <- 0
templow  <- 0

for (i in 1:length(meanDF2$envbac)) {
  if (meanDF2$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (meanDF2$ave12[i] > meanDF2$mean[i]) {
      templow <- templow + 1
    } else {
      temphigh <- temphigh + 1
    }
  }
}

# Prepare stacked bar plot data
judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)

c  <- c()
c1 <- c()

for (k in 1:3) {
  ratio <- count$count1[k] / sum(count$count1)
  c[k]  <- if (ratio < 0.1) {
             paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
           } else {
             paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
           }
  c1[k] <- ratio
}

count <- cbind(count, c, c1)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

# Plot stacked bar
g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(184, 153, 58, maxColorValue = 255),
                               "grey70",
                               rgb(58, 184, 153, maxColorValue = 255)))
g
ggsave(file = "FigS13A_bar.pdf", plot = g)

# Summary scatter plot with error bars
meanDF2$pp <- factor(meanDF2$pp, levels = c("high", "same", "low"))
df1 <- data.frame(x1 = 0, y1 = 0, x2 = 0.8, y2 = 0.8)

g <- ggplot(meanDF2, aes(x = ave12, y = mean, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df1, color = "grey20", linewidth = 0.75, linetype = "dotted") +
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(0, 0.8), expand = c(0, 0))+
  scale_y_continuous(limits = c(0, 0.8), expand = c(0, 0))+
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(184, 153, 58, maxColorValue = 255),
                                "grey70",
                                rgb(58, 184, 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1)

for (i in 1:nrow(meanDF2)) {
  temp <- meanDF2[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                         x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                         x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g +
    geom_segment(data = errorDFx, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2) +
    geom_segment(data = errorDFy, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2)
}
g
ggsave(file = "FigS13A_scatter.pdf", plot = g)

g <- ggplot(meanDF2, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 0.75, alpha = 0.5, fill = NA,
               binwidth = 0.15, stackdir = "center", color = "black") +
  scale_y_continuous(trans = "log10", limits = c(0.01, 100), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = "FigS13E.pdf", plot = g)

# Repeat for 2->4 mixing environments
mix2Ave <- data.frame()

for (i in 25:28) {
  tempE <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1 <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2 <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]

  temp11 <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1], ]
  temp12 <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1], ]
  temp21 <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1], ]
  temp22 <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1], ]

  for (j in 1:14) {
    temp11B <- as.numeric(temp11[temp11$bacteria == strain_list[j], ]$final_OD)
    temp12B <- as.numeric(temp12[temp12$bacteria == strain_list[j], ]$final_OD)
    temp21B <- as.numeric(temp21[temp21$bacteria == strain_list[j], ]$final_OD)
    temp22B <- as.numeric(temp22[temp22$bacteria == strain_list[j], ]$final_OD)

    cvals <- c(temp11B, temp12B, temp21B, temp22B)
    ave12 <- mean(cvals)
    sdmean <- sqrt(mean(c(var(temp11B), var(temp12B), var(temp21B), var(temp22B))))
    tempY <- c(ave12 - sdmean, ave12, ave12 + sdmean)

    tempEBc <- as.numeric(tempE[tempE$bacteria == strain_list[j], ]$final_OD)

    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = ptemp
        ))
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY)
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = t$p.value
        ))
      }
    }
  }
}

mix2Ave$qvalue <- p.adjust(mix2Ave$pvalue, method = "BH")

meanDF <- data.frame()
for (i in 25:28) {
  for (j in 1:14) {
    temp <- subset(mix2Ave, env == info$environment_list[i] & bacteria == strain_list[j])
    meanDF <- rbind(meanDF, data.frame(
      envbac = paste(info$environment_list[i], strain_list[j]),
      ave12  = temp$ave12[1],
      mean   = mean(temp$value),
      sdx    = temp$sdx[1],
      sdy    = temp$sdy[1],
      p      = ifelse(temp$qvalue[1] < 0.05, 1, 0),
      pp     = ifelse(temp$qvalue[1] < 0.05,
                      ifelse(mean(temp$value) > temp$ave12[1], "high", "low"),
                      "same")
    ))
  }
}

temphigh <- sum(meanDF$p == 1 & meanDF$mean > meanDF$ave12)
tempsame <- sum(meanDF$p == 0)
templow  <- sum(meanDF$p == 1 & meanDF$mean < meanDF$ave12)

judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)
count$c  <- ifelse(count$count1 / sum(count$count1) < 0.1,
                   paste(" ", format(round(count$count1 / sum(count$count1) * 100, 1), nsmall = 1), "%"),
                   paste(format(round(count$count1 / sum(count$count1) * 100, 1), nsmall = 1), "%"))
count$c1 <- count$count1 / sum(count$count1)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - 0.5 * c1)

g <- ggplot(count, aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(184,153,58, maxColorValue = 255),
                                "grey70",
                                rgb(58,184,153, maxColorValue = 255)))
g
ggsave("FigS13B_bar.pdf", plot = g)

meanDF$pp <- factor(meanDF$pp, levels = c("high", "same", "low"))
df1 <- data.frame(x1 = 0, y1 = 0, x2 = 0.8, y2 = 0.8)
g <- ggplot(meanDF, aes(x = ave12, y = mean, color = pp)) +
  geom_segment(data = df1, aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey20", linewidth = 0.75, linetype = "dotted") +
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(0, 0.8), expand = c(0, 0))+
  scale_y_continuous(limits = c(0, 0.8), expand = c(0, 0))+
  theme_minimal() +
  theme(legend.position = "none",
        axis.line = element_line(size = 0.8, color = "grey20"),
        axis.ticks = element_line(size = 0.8, color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0)) +
  scale_color_manual(values = c(rgb(184,153,58, maxColorValue = 255),
                                "grey70",
                                rgb(58,184,153, maxColorValue = 255))) +
  coord_fixed()
for (i in 1:nrow(meanDF)) {
  temp <- meanDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                         x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                         x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g +
    geom_segment(data = errorDFx, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2) +
    geom_segment(data = errorDFy, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2)
}
g
ggsave("FigS13B_scatter.pdf", plot = g)

g <- ggplot(meanDF, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 0.75, alpha = 0.5, fill = NA,
               binwidth = 0.15, stackdir = "center", color = "black") +
  scale_y_log10(limits = c(0.01, 100), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70))
g
ggsave("FigS13F.pdf", plot = g)

# Repeat for 4->8 mixing environments
mix2Ave <- data.frame()

for (i in 29:30) {
  tempE   <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]
  temp11  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1], ]
  temp12  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1], ]
  temp21  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1], ]
  temp22  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1], ]
  temp111 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair1[1], ]
  temp112 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair2[1], ]
  temp121 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair1[1], ]
  temp122 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair2[1], ]
  temp211 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair1[1], ]
  temp212 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair2[1], ]
  temp221 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair1[1], ]
  temp222 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    temp111B <- as.numeric(temp111[temp111$bacteria == strain_list[j], ]$final_OD)
    temp112B <- as.numeric(temp112[temp112$bacteria == strain_list[j], ]$final_OD)
    temp121B <- as.numeric(temp121[temp121$bacteria == strain_list[j], ]$final_OD)
    temp122B <- as.numeric(temp122[temp122$bacteria == strain_list[j], ]$final_OD)
    temp211B <- as.numeric(temp211[temp211$bacteria == strain_list[j], ]$final_OD)
    temp212B <- as.numeric(temp212[temp212$bacteria == strain_list[j], ]$final_OD)
    temp221B <- as.numeric(temp221[temp221$bacteria == strain_list[j], ]$final_OD)
    temp222B <- as.numeric(temp222[temp222$bacteria == strain_list[j], ]$final_OD)
    
    cvals  <- c(temp111B, temp112B, temp121B, temp122B, temp211B, temp212B, temp221B, temp222B)
    ave12  <- mean(cvals)
    sdmean <- mean(c(var(temp111B), var(temp112B), var(temp121B), var(temp122B), 
                     var(temp211B), var(temp212B), var(temp221B), var(temp222B)))^0.5
    tempY  <- c(ave12 - sdmean, ave12, ave12 + sdmean)
    
    tempEBc <- as.numeric(tempE[tempE$bacteria == strain_list[j], ]$final_OD)
    
    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = ptemp
        ))
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),
                  paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = t$p.value
        ))
      }
    }
  }
}

qvalue  <- p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave <- cbind(mix2Ave, qvalue)

meanDF <- data.frame()

for (i in 29:30) {
  for (j in 1:14) {
    temp <- mix2Ave[(mix2Ave$env == info$environment_list[i]) &
                    (mix2Ave$bacteria == strain_list[j]), ]
    meanDF <- rbind(meanDF, data.frame(
      envbac = paste(info$environment_list[i], strain_list[j]),
      ave12  = temp$ave12[1],
      mean   = mean(temp$value),
      sdx    = temp$sdx[1],
      sdy    = temp$sdy[1],
      p      = if (temp$qvalue[1] < 0.05) 1 else 0,
      pp     = if ((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1])) {
                  "high"
                } else if ((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1])) {
                  "low"
                } else {
                  "same"
                }
    ))
  }
}

temphigh <- 0
tempsame <- 0
templow  <- 0
for (i in 1:length(meanDF$envbac)) {
  if (meanDF$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (meanDF$ave12[i] > meanDF$mean[i]) {
      templow <- templow + 1
    } else if (meanDF$ave12[i] < meanDF$mean[i]) {
      temphigh <- temphigh + 1
    }
  }
}

judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)

c_vals <- c()
c1_vals <- c()
for (k in 1:3) {
  c_vals[k]  <- if (count$count1[k] / sum(count$count1) < 0.1) {
                  paste(" ", format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                } else {
                  paste(format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                }
  c1_vals[k] <- count$count1[k] / sum(count$count1)
}
count <- cbind(count, c = c_vals, c1 = c1_vals)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                 "grey70",
                                 rgb(red = 58, green = 184, blue = 153, maxColorValue = 255)))
g
ggsave(file = "FigS13C_bar.pdf", plot = g)

meanDF <- transform(meanDF, pp = factor(pp, levels = c("high", "same", "low")))
df1 <- data.frame(x1 = 0, y1 = 0, x2 = 0.8, y2 = 0.8)
g <- ggplot(meanDF, aes(x = ave12, y = mean, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey20", data = df1, linewidth = 0.75, linetype = "dotted") +
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(0, 0.8), expand = c(0, 0))+
  scale_y_continuous(limits = c(0, 0.8), expand = c(0, 0))+
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                  "grey70",
                                  rgb(red = 58, green = 184, blue = 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)

for (i in 1:length(meanDF$envbac)) {
  temp     <- meanDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                         x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                         x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                         color = "black", alpha = 0.3, data = errorDFx,
                         linewidth = 0.2, linetype = "solid")
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                         color = "black", alpha = 0.3, data = errorDFy,
                         linewidth = 0.2, linetype = "solid")
}

g
ggsave(file = "FigS13C_scatter.pdf", plot = g)


g <- ggplot(meanDF, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 0.75, alpha = 0.5, fill = NA,
               binwidth = 0.15, stackdir = "center", color = "black") +
  scale_y_log10(limits = c(0.01, 100), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = "FigS13G.pdf", plot = g)

# Repeat for 8->16 mixing environments
mix2Ave <- data.frame()

for (i in 31:31) {
  tempE   <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]
  
  temp11  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1], ]
  temp12  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1], ]
  temp21  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1], ]
  temp22  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1], ]
  
  temp111 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair1[1], ]
  temp112 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair2[1], ]
  temp121 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair1[1], ]
  temp122 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair2[1], ]
  temp211 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair1[1], ]
  temp212 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair2[1], ]
  temp221 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair1[1], ]
  temp222 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair2[1], ]
  
  temp1111 <- all_sample_df_temp[all_sample_df_temp$environment == temp111$carbonsource_mixed_pair1[1], ]
  temp1112 <- all_sample_df_temp[all_sample_df_temp$environment == temp111$carbonsource_mixed_pair2[1], ]
  temp1121 <- all_sample_df_temp[all_sample_df_temp$environment == temp112$carbonsource_mixed_pair1[1], ]
  temp1122 <- all_sample_df_temp[all_sample_df_temp$environment == temp112$carbonsource_mixed_pair2[1], ]
  temp1211 <- all_sample_df_temp[all_sample_df_temp$environment == temp121$carbonsource_mixed_pair1[1], ]
  temp1212 <- all_sample_df_temp[all_sample_df_temp$environment == temp121$carbonsource_mixed_pair2[1], ]
  temp1221 <- all_sample_df_temp[all_sample_df_temp$environment == temp122$carbonsource_mixed_pair1[1], ]
  temp1222 <- all_sample_df_temp[all_sample_df_temp$environment == temp122$carbonsource_mixed_pair2[1], ]
  temp2111 <- all_sample_df_temp[all_sample_df_temp$environment == temp211$carbonsource_mixed_pair1[1], ]
  temp2112 <- all_sample_df_temp[all_sample_df_temp$environment == temp211$carbonsource_mixed_pair2[1], ]
  temp2121 <- all_sample_df_temp[all_sample_df_temp$environment == temp212$carbonsource_mixed_pair1[1], ]
  temp2122 <- all_sample_df_temp[all_sample_df_temp$environment == temp212$carbonsource_mixed_pair2[1], ]
  temp2211 <- all_sample_df_temp[all_sample_df_temp$environment == temp221$carbonsource_mixed_pair1[1], ]
  temp2212 <- all_sample_df_temp[all_sample_df_temp$environment == temp221$carbonsource_mixed_pair2[1], ]
  temp2221 <- all_sample_df_temp[all_sample_df_temp$environment == temp222$carbonsource_mixed_pair1[1], ]
  temp2222 <- all_sample_df_temp[all_sample_df_temp$environment == temp222$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    temp1111B <- as.numeric(temp1111[temp1111$bacteria == strain_list[j], ]$final_OD)
    temp1112B <- as.numeric(temp1112[temp1112$bacteria == strain_list[j], ]$final_OD)
    temp1121B <- as.numeric(temp1121[temp1121$bacteria == strain_list[j], ]$final_OD)
    temp1122B <- as.numeric(temp1122[temp1122$bacteria == strain_list[j], ]$final_OD)
    temp1211B <- as.numeric(temp1211[temp1211$bacteria == strain_list[j], ]$final_OD)
    temp1212B <- as.numeric(temp1212[temp1212$bacteria == strain_list[j], ]$final_OD)
    temp1221B <- as.numeric(temp1221[temp1221$bacteria == strain_list[j], ]$final_OD)
    temp1222B <- as.numeric(temp1222[temp1222$bacteria == strain_list[j], ]$final_OD)
    temp2111B <- as.numeric(temp2111[temp2111$bacteria == strain_list[j], ]$final_OD)
    temp2112B <- as.numeric(temp2112[temp2112$bacteria == strain_list[j], ]$final_OD)
    temp2121B <- as.numeric(temp2121[temp2121$bacteria == strain_list[j], ]$final_OD)
    temp2122B <- as.numeric(temp2122[temp2122$bacteria == strain_list[j], ]$final_OD)
    temp2211B <- as.numeric(temp2211[temp2211$bacteria == strain_list[j], ]$final_OD)
    temp2212B <- as.numeric(temp2212[temp2212$bacteria == strain_list[j], ]$final_OD)
    temp2221B <- as.numeric(temp2221[temp2221$bacteria == strain_list[j], ]$final_OD)
    temp2222B <- as.numeric(temp2222[temp2222$bacteria == strain_list[j], ]$final_OD)
    
    cvals  <- c(temp1111B, temp1112B, temp1121B, temp1122B,
                temp1211B, temp1212B, temp1221B, temp1222B,
                temp2111B, temp2112B, temp2121B, temp2122B,
                temp2211B, temp2212B, temp2221B, temp2222B)
    
    ave12  <- mean(cvals)
    sdmean <- mean(c(var(temp1111B), var(temp1112B), var(temp1121B), var(temp1122B),
                     var(temp1211B), var(temp1212B), var(temp1221B), var(temp1222B),
                     var(temp2111B), var(temp2112B), var(temp2121B), var(temp2122B),
                     var(temp2211B), var(temp2212B), var(temp2221B), var(temp2222B)))^0.5
    tempY <- c(ave12 - sdmean, ave12, ave12 + sdmean)

    tempEBc <- as.numeric(tempE[tempE$bacteria == strain_list[j], ]$final_OD)

    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = ptemp
        ))
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY, alternative = "two.sided",
                  paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = t$p.value
        ))
      }
    }
  }
}

qvalue <- p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave <- cbind(mix2Ave, qvalue)

meanDF <- data.frame()
for (i in 31:31) {
  for (j in 1:14) {
    temp <- mix2Ave[(mix2Ave$env == info$environment_list[i]) &
                    (mix2Ave$bacteria == strain_list[j]), ]
    meanDF <- rbind(meanDF, data.frame(
      envbac = paste(info$environment_list[i], strain_list[j]),
      ave12  = temp$ave12[1],
      mean   = mean(temp$value),
      sdx    = temp$sdx[1],
      sdy    = temp$sdy[1],
      p      = if (temp$qvalue[1] < 0.05) 1 else 0,
      pp     = if ((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1])) {
                 "high"
               } else if ((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1])) {
                 "low"
               } else {
                 "same"
               }
    ))
  }
}

temphigh <- 0
tempsame <- 0
templow  <- 0

for (i in 1:length(meanDF$envbac)) {
  if (meanDF$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (meanDF$ave12[i] > meanDF$mean[i]) {
      templow <- templow + 1
    } else if (meanDF$ave12[i] < meanDF$mean[i]) {
      temphigh <- temphigh + 1
    }
  }
}

judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)

count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)
c_vals <- c()
c1_vals <- c()

for (k in 1:3) {
  c_vals[k]  <- if (count$count1[k] / sum(count$count1) < 0.1) {
                  paste(" ", format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                } else {
                  paste(format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                }
  c1_vals[k] <- count$count1[k] / sum(count$count1)
}

count <- cbind(count, c = c_vals, c1 = c1_vals)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))

count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                               "grey70",
                               rgb(red = 58, green = 184, blue = 153, maxColorValue = 255)))
g
ggsave(file = "FigS13D_bar.pdf", plot = g)

meanDF <- transform(meanDF, pp = factor(pp, levels = c("high", "same", "low")))
df1 <- data.frame(x1 = 0, y1 = 0, x2 = 0.8, y2 = 0.8)

g <- ggplot(meanDF, aes(x = ave12, y = mean, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey20", data = df1, linewidth = 0.75, linetype = "dotted") +
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(0, 0.8), expand = c(0, 0))+
  scale_y_continuous(limits = c(0, 0.8), expand = c(0, 0))+
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                 "grey70",
                                 rgb(red = 58, green = 184, blue = 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)

for (i in 1:length(meanDF$envbac)) {
  temp <- meanDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                          x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                          x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFx,
                        linewidth = 0.2, linetype = "solid")
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFy,
                        linewidth = 0.2, linetype = "solid")
}

g
ggsave(file = "FigS13D_scatter.pdf", plot = g)

g <- ggplot(meanDF, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 0.75, alpha = 0.5, fill = NA,
               binwidth = 0.15, stackdir = "center", color = "black") +
  scale_y_continuous(trans = "log10", limits = c(0.01, 100), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))

g
ggsave(file = "FigS13H.pdf", plot = g)
```

## FigS14
```{r}
# Initialize new columns
all_sample_df$mono_target_med <- 0
all_sample_df$conc_ratio <- 0

# Assign monoculture median fluorescence based on fluorophore
for (i in 1:nrow(all_sample_df)) {
  if (all_sample_df$bacterial_species_count[i] == 1 &&
      all_sample_df$monoculture_fluorescence[i] == "GFP") {
    
    all_sample_df$mono_target_med[i] <- all_sample_df$green_med[i]
    
  } else if (all_sample_df$bacterial_species_count[i] == 1 &&
             all_sample_df$monoculture_fluorescence[i] == "mScarlet") {
    
    all_sample_df$mono_target_med[i] <- all_sample_df$red_med[i]
  }
}

all_sample_df$mono_target_med <- as.numeric(all_sample_df$mono_target_med)

# Calculate concentration ratio between full and half concentrations
for (i in 1:nrow(all_sample_df)) {
  if (all_sample_df$bacterial_species_count[i] == 1 &&
      all_sample_df$carbonsource_species_count[i] == 1 &&
      (all_sample_df$experiment[i] == "main" || all_sample_df$experiment[i] == "conc")) {
    
    temp1 <- all_sample_df[all_sample_df$environment == all_sample_df$environment[i] &
                           all_sample_df$bacteria == all_sample_df$bacteria[i], ]
    
    temp_main <- temp1[temp1$experiment == "main", ]
    temp_half <- temp1[temp1$experiment == "conc", ]
    
    # Calculate average fluorescence (main vs. conc)
    if (all_sample_df$monoculture_fluorescence[i] == "GFP") {
      main_ave <- mean(as.numeric(temp_main$green_min[1]),
                       as.numeric(temp_main$green_med[1]),
                       as.numeric(temp_main$green_max[1]))
      
      half_ave <- mean(as.numeric(temp_half$green_min[1]),
                       as.numeric(temp_half$green_med[1]),
                       as.numeric(temp_half$green_max[1]))
      
    } else if (all_sample_df$monoculture_fluorescence[i] == "mScarlet") {
      main_ave <- mean(as.numeric(temp_main$red_min[1]),
                       as.numeric(temp_main$red_med[1]),
                       as.numeric(temp_main$red_max[1]))
      
      half_ave <- mean(as.numeric(temp_half$red_min[1]),
                       as.numeric(temp_half$red_med[1]),
                       as.numeric(temp_half$red_max[1]))
      
    } else {
      main_ave <- "ERROR"
      half_ave <- "ERROR"
    }
    
    if (var(as.numeric(temp_main$mono_target_med)) == 0 &&
        var(as.numeric(temp_half$mono_target_med)) == 0) {
      
      all_sample_df$conc_ratio[i] <- half_ave / main_ave
      
    } else {
      all_sample_df$conc_ratio[i] <- "ERROR"
    }
  }
}


# Initialize the 'starve' column
all_sample_df$starve <- "ERROR"

# Function to check starvation condition for different carbon source counts
check_starve <- function(i, all_sample_df) {
  experiment_condition <- all_sample_df$experiment[i] == "main" && all_sample_df$bacterial_species_count[i] == 2
  if (!experiment_condition) return(NULL)
  
  environment <- all_sample_df$environment[i]
  coculture_GFP <- all_sample_df$coculture_species_GFP[i]
  coculture_mScarlet <- all_sample_df$coculture_species_mScarlet[i]
  
  tempE <- all_sample_df[all_sample_df$environment == environment,]
  
  # Return NULL if no matching environment
  if (nrow(tempE) == 0) return(NULL)
  
  return(tempE)
}

determine_starvation <- function(i, all_sample_df, tempE, num_carbonsources) {
  # Get the corresponding data
  temp1 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair1[1],]
  temp2 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair2[1],]
  
  temp1G <- temp1[(temp1$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp1$experiment == "main"),]
  temp1R <- temp1[(temp1$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp1$experiment == "main"),]
  
  temp2G <- temp2[(temp2$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp2$experiment == "main"),]
  temp2R <- temp2[(temp2$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp2$experiment == "main"),]
  
  # Check if 'conc_ratio' length is valid for all groups
  valid_lengths <- all(length(temp1G$conc_ratio) == 3, length(temp1R$conc_ratio) == 3, 
                       length(temp2G$conc_ratio) == 3, length(temp2R$conc_ratio) == 3)
  if (!valid_lengths) return("ERROR")
  
  # Check starvation condition for the carbon sources
  if (all(temp1G$conc_ratio[1] <= 1, temp1R$conc_ratio[1] <= 1, temp2G$conc_ratio[1] <= 1, temp2R$conc_ratio[1] <= 1)) {
    return(1)
  } else {
    return(0)
  }
}

# Loop through rows for each carbon source condition
for (i in 1:nrow(all_sample_df)) {
  
  # Check starvation condition for C1
  if (all_sample_df$carbonsource_species_count[i] == 1) {
    tempE <- check_starve(i, all_sample_df)
    if (!is.null(tempE)) {
      result <- determine_starvation(i, all_sample_df, tempE, 1)
      all_sample_df$starve[i] <- result
    }
  }
  
  # Check starvation condition for C2
  if (all_sample_df$carbonsource_species_count[i] == 2) {
    tempE <- check_starve(i, all_sample_df)
    if (!is.null(tempE)) {
      result <- determine_starvation(i, all_sample_df, tempE, 2)
      all_sample_df$starve[i] <- result
    }
  }
  
  # Check starvation condition for C4
  if (all_sample_df$carbonsource_species_count[i] == 4) {
    tempE <- check_starve(i, all_sample_df)
    if (!is.null(tempE)) {
      result <- determine_starvation(i, all_sample_df, tempE, 4)
      all_sample_df$starve[i] <- result
    }
  }
  
  # Check starvation condition for C8
  if (all_sample_df$carbonsource_species_count[i] == 8) {
    tempE <- check_starve(i, all_sample_df)
    if (!is.null(tempE)) {
      result <- determine_starvation(i, all_sample_df, tempE, 8)
      all_sample_df$starve[i] <- result
    }
  }
}

# Loop through all samples in the dataframe
for(i in 1:nrow(all_sample_df)) {
  
  # Check if the conditions match for main experiment with two bacterial species and 16 carbon sources
  if(all_sample_df$experiment[i] == "main" && all_sample_df$bacterial_species_count[i] == 2 && all_sample_df$carbonsource_species_count[i] == 16) {
    
    # Subset the data for the current environment
    tempE <- all_sample_df[all_sample_df$environment == all_sample_df$environment[i],]
    
    # Subset for mixed pairs of carbon sources
    temp1 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair1[1],]
    temp2 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair2[1],]
    
    # Further subsets for subsequent mixed carbon source pairs
    temp11 <- all_sample_df[all_sample_df$environment == temp1$carbonsource_mixed_pair1[1],]
    temp12 <- all_sample_df[all_sample_df$environment == temp1$carbonsource_mixed_pair2[1],]
    temp21 <- all_sample_df[all_sample_df$environment == temp2$carbonsource_mixed_pair1[1],]
    temp22 <- all_sample_df[all_sample_df$environment == temp2$carbonsource_mixed_pair2[1],]
    
    # More subsets for deeper levels of mixed carbon source pairs
    temp111 <- all_sample_df[all_sample_df$environment == temp11$carbonsource_mixed_pair1[1],]
    temp112 <- all_sample_df[all_sample_df$environment == temp11$carbonsource_mixed_pair2[1],]
    temp121 <- all_sample_df[all_sample_df$environment == temp12$carbonsource_mixed_pair1[1],]
    temp122 <- all_sample_df[all_sample_df$environment == temp12$carbonsource_mixed_pair2[1],]
    temp211 <- all_sample_df[all_sample_df$environment == temp21$carbonsource_mixed_pair1[1],]
    temp212 <- all_sample_df[all_sample_df$environment == temp21$carbonsource_mixed_pair2[1],]
    temp221 <- all_sample_df[all_sample_df$environment == temp22$carbonsource_mixed_pair1[1],]
    temp222 <- all_sample_df[all_sample_df$environment == temp22$carbonsource_mixed_pair2[1],]
    
    # Further subset for the next hierarchical levels of mixed pairs
    temp1111 <- all_sample_df[all_sample_df$environment == temp111$carbonsource_mixed_pair1[1],]
    temp1112 <- all_sample_df[all_sample_df$environment == temp111$carbonsource_mixed_pair2[1],]
    temp1121 <- all_sample_df[all_sample_df$environment == temp112$carbonsource_mixed_pair1[1],]
    temp1122 <- all_sample_df[all_sample_df$environment == temp112$carbonsource_mixed_pair2[1],]
    temp1211 <- all_sample_df[all_sample_df$environment == temp121$carbonsource_mixed_pair1[1],]
    temp1212 <- all_sample_df[all_sample_df$environment == temp121$carbonsource_mixed_pair2[1],]
    temp1221 <- all_sample_df[all_sample_df$environment == temp122$carbonsource_mixed_pair1[1],]
    temp1222 <- all_sample_df[all_sample_df$environment == temp122$carbonsource_mixed_pair2[1],]
    temp2111 <- all_sample_df[all_sample_df$environment == temp211$carbonsource_mixed_pair1[1],]
    temp2112 <- all_sample_df[all_sample_df$environment == temp211$carbonsource_mixed_pair2[1],]
    temp2121 <- all_sample_df[all_sample_df$environment == temp212$carbonsource_mixed_pair1[1],]
    temp2122 <- all_sample_df[all_sample_df$environment == temp212$carbonsource_mixed_pair2[1],]
    temp2211 <- all_sample_df[all_sample_df$environment == temp221$carbonsource_mixed_pair1[1],]
    temp2212 <- all_sample_df[all_sample_df$environment == temp221$carbonsource_mixed_pair2[1],]
    temp2221 <- all_sample_df[all_sample_df$environment == temp222$carbonsource_mixed_pair1[1],]
    temp2222 <- all_sample_df[all_sample_df$environment == temp222$carbonsource_mixed_pair2[1],]

    # Filter data for different combinations of environments and carbon sources
    temp1111G <- temp1111[(temp1111$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp1111$experiment == "main"), ]
    temp1111R <- temp1111[(temp1111$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp1111$experiment == "main"), ]
    temp1112G <- temp1112[(temp1112$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp1112$experiment == "main"), ]
    temp1112R <- temp1112[(temp1112$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp1112$experiment == "main"), ]
    temp1121G <- temp1121[(temp1121$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp1121$experiment == "main"), ]
    temp1121R <- temp1121[(temp1121$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp1121$experiment == "main"), ]
    temp1122G <- temp1122[(temp1122$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp1122$experiment == "main"), ]
    temp1122R <- temp1122[(temp1122$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp1122$experiment == "main"), ]
    temp1211G <- temp1211[(temp1211$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp1211$experiment == "main"), ]
    temp1211R <- temp1211[(temp1211$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp1211$experiment == "main"), ]
    temp1212G <- temp1212[(temp1212$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp1212$experiment == "main"), ]
    temp1212R <- temp1212[(temp1212$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp1212$experiment == "main"), ]
    temp1221G <- temp1221[(temp1221$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp1221$experiment == "main"), ]
    temp1221R <- temp1221[(temp1221$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp1221$experiment == "main"), ]
    temp1222G <- temp1222[(temp1222$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp1222$experiment == "main"), ]
    temp1222R <- temp1222[(temp1222$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp1222$experiment == "main"), ]
    temp2111G <- temp2111[(temp2111$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp2111$experiment == "main"), ]
    temp2111R <- temp2111[(temp2111$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp2111$experiment == "main"), ]
    temp2112G <- temp2112[(temp2112$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp2112$experiment == "main"), ]
    temp2112R <- temp2112[(temp2112$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp2112$experiment == "main"), ]
    temp2121G <- temp2121[(temp2121$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp2121$experiment == "main"), ]
    temp2121R <- temp2121[(temp2121$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp2121$experiment == "main"), ]
    temp2122G <- temp2122[(temp2122$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp2122$experiment == "main"), ]
    temp2122R <- temp2122[(temp2122$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp2122$experiment == "main"), ]
    temp2211G <- temp2211[(temp2211$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp2211$experiment == "main"), ]
    temp2211R <- temp2211[(temp2211$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp2211$experiment == "main"), ]
    temp2212G <- temp2212[(temp2212$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp2212$experiment == "main"), ]
    temp2212R <- temp2212[(temp2212$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp2212$experiment == "main"), ]
    temp2221G <- temp2221[(temp2221$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp2221$experiment == "main"), ]
    temp2221R <- temp2221[(temp2221$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp2221$experiment == "main"), ]
    temp2222G <- temp2222[(temp2222$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i]) & (temp2222$experiment == "main"), ]
    temp2222R <- temp2222[(temp2222$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i]) & (temp2222$experiment == "main"), ]
    
    # Check if the length of conc_ratio is 3 for all the filtered datasets
    if(all(sapply(list(temp1111G, temp1111R, temp1112G, temp1112R, temp1121G, temp1121R, 
                      temp1122G, temp1122R, temp1211G, temp1211R, temp1212G, temp1212R, 
                      temp1221G, temp1221R, temp1222G, temp1222R, temp2111G, temp2111R, 
                      temp2112G, temp2112R, temp2121G, temp2121R, temp2122G, temp2122R, 
                      temp2211G, temp2211R, temp2212G, temp2212R, temp2221G, temp2221R, 
                      temp2222G, temp2222R), function(x) length(x$conc_ratio) == 3))) {
      
      # Check if all conc_ratio values are less than or equal to 1
      if(all(sapply(list(temp1111G, temp1111R, temp1112G, temp1112R, temp1121G, temp1121R, 
                        temp1122G, temp1122R, temp1211G, temp1211R, temp1212G, temp1212R, 
                        temp1221G, temp1221R, temp1222G, temp1222R, temp2111G, temp2111R, 
                        temp2112G, temp2112R, temp2121G, temp2121R, temp2122G, temp2122R, 
                        temp2211G, temp2211R, temp2212G, temp2212R, temp2221G, temp2221R, 
                        temp2222G, temp2222R), function(x) x$conc_ratio[1] <= 1))) {
        
        # Set the starvation flag to 1 if all conditions are met
        all_sample_df$starve[i] <- 1
      } else {
        # Set the starvation flag to 0 if conditions are not met
        all_sample_df$starve[i] <- 0
      }
    } else {
      # Flag as an error if conc_ratio is not 3 for all
      all_sample_df$starve[i] <- "ERROR"
    }
  }
}

# Monoculture: Handling for different carbon sources (1, 2, 4, 8)

# Handle 1 carbon source (C1)
for(i in 1:length(all_sample_df$fcs_file)) {
  if(all_sample_df$experiment[i] == "main" &&
     all_sample_df$bacterial_species_count[i] == 1 &&
     all_sample_df$carbonsource_species_count[i] == 1) {
    
    # Filter data based on the environment and bacteria
    tempE <- all_sample_df[all_sample_df$environment == all_sample_df$environment[i],]
    tempEB <- tempE[(tempE$bacteria == all_sample_df$bacteria[i]) & (tempE$experiment == "main"),]
    
    # Check concentration ratio and determine starvation
    if(length(tempEB$conc_ratio) == 3) {
      if(tempEB$conc_ratio[1] < 1/2 | tempEB$conc_ratio[1] == 1) {
        all_sample_df$starve[i] <- 1
      } else {
        all_sample_df$starve[i] <- 0
      }
    } else {
      all_sample_df$starve[i] <- "ERROR"
    }
  }
}

# Handle 2 carbon sources (C2)
for(i in 1:length(all_sample_df$fcs_file)) {
  if(all_sample_df$experiment[i] == "main" &&
     all_sample_df$bacterial_species_count[i] == 1 &&
     all_sample_df$carbonsource_species_count[i] == 2) {
    
    # Filter data based on mixed carbon source pairs
    tempE <- all_sample_df[all_sample_df$environment == all_sample_df$environment[i],]
    temp1 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair1[1],]
    temp2 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair2[1],]
    
    # Filter based on bacterial species and experiment
    temp1B <- temp1[(temp1$bacteria == all_sample_df$bacteria[i]) & (temp1$experiment == "main"),]
    temp2B <- temp2[(temp2$bacteria == all_sample_df$bacteria[i]) & (temp2$experiment == "main"),]
    
    # Check concentration ratios and determine starvation
    if(length(temp1B$conc_ratio) == 3 && length(temp2B$conc_ratio) == 3) {
      if(temp1B$conc_ratio[1] <= 1 && temp2B$conc_ratio[1] <= 1) {
        all_sample_df$starve[i] <- 1
      } else {
        all_sample_df$starve[i] <- 0
      }
    } else {
      all_sample_df$starve[i] <- "ERROR"
    }
  }
}

# Handle 4 carbon sources (C4)
for(i in 1:length(all_sample_df$fcs_file)) {
  if(all_sample_df$experiment[i] == "main" &&
     all_sample_df$bacterial_species_count[i] == 1 &&
     all_sample_df$carbonsource_species_count[i] == 4) {
    
    # Filter data for multiple carbon source pairs
    tempE <- all_sample_df[all_sample_df$environment == all_sample_df$environment[i],]
    temp1 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair1[1],]
    temp2 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair2[1],]
    temp11 <- all_sample_df[all_sample_df$environment == temp1$carbonsource_mixed_pair1[1],]
    temp12 <- all_sample_df[all_sample_df$environment == temp1$carbonsource_mixed_pair2[1],]
    temp21 <- all_sample_df[all_sample_df$environment == temp2$carbonsource_mixed_pair1[1],]
    temp22 <- all_sample_df[all_sample_df$environment == temp2$carbonsource_mixed_pair2[1],]
    
    # Filter based on bacterial species and experiment
    temp11B <- temp11[(temp11$bacteria == all_sample_df$bacteria[i]) & (temp11$experiment == "main"),]
    temp12B <- temp12[(temp12$bacteria == all_sample_df$bacteria[i]) & (temp12$experiment == "main"),]
    temp21B <- temp21[(temp21$bacteria == all_sample_df$bacteria[i]) & (temp21$experiment == "main"),]
    temp22B <- temp22[(temp22$bacteria == all_sample_df$bacteria[i]) & (temp22$experiment == "main"),]
    
    # Check concentration ratios and determine starvation
    if(length(temp11B$conc_ratio) == 3 &&
       length(temp12B$conc_ratio) == 3 &&
       length(temp21B$conc_ratio) == 3 &&
       length(temp22B$conc_ratio) == 3) {
      if(temp11B$conc_ratio[1] <= 1 &&
         temp12B$conc_ratio[1] <= 1 &&
         temp21B$conc_ratio[1] <= 1 &&
         temp22B$conc_ratio[1] <= 1) {
        all_sample_df$starve[i] <- 1
      } else {
        all_sample_df$starve[i] <- 0
      }
    } else {
      all_sample_df$starve[i] <- "ERROR"
    }
  }
}

# Handle 8 carbon sources (C8)
for(i in 1:length(all_sample_df$fcs_file)) {
  if(all_sample_df$experiment[i] == "main" &&
     all_sample_df$bacterial_species_count[i] == 1 &&
     all_sample_df$carbonsource_species_count[i] == 8) {
    
    # Filter data for more carbon source pairs
    tempE <- all_sample_df[all_sample_df$environment == all_sample_df$environment[i],]
    temp1 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair1[1],]
    temp2 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair2[1],]
    temp11 <- all_sample_df[all_sample_df$environment == temp1$carbonsource_mixed_pair1[1],]
    temp12 <- all_sample_df[all_sample_df$environment == temp1$carbonsource_mixed_pair2[1],]
    temp21 <- all_sample_df[all_sample_df$environment == temp2$carbonsource_mixed_pair1[1],]
    temp22 <- all_sample_df[all_sample_df$environment == temp2$carbonsource_mixed_pair2[1],]
    temp111 <- all_sample_df[all_sample_df$environment == temp11$carbonsource_mixed_pair1[1],]
    temp112 <- all_sample_df[all_sample_df$environment == temp11$carbonsource_mixed_pair2[1],]
    temp121 <- all_sample_df[all_sample_df$environment == temp12$carbonsource_mixed_pair1[1],]
    temp122 <- all_sample_df[all_sample_df$environment == temp12$carbonsource_mixed_pair2[1],]
    temp211 <- all_sample_df[all_sample_df$environment == temp21$carbonsource_mixed_pair1[1],]
    temp212 <- all_sample_df[all_sample_df$environment == temp21$carbonsource_mixed_pair2[1],]
    temp221 <- all_sample_df[all_sample_df$environment == temp22$carbonsource_mixed_pair1[1],]
    temp222 <- all_sample_df[all_sample_df$environment == temp22$carbonsource_mixed_pair2[1],]
    
    # Filter based on bacterial species and experiment
    temp111B <- temp111[(temp111$bacteria == all_sample_df$bacteria[i]) & (temp111$experiment == "main"),]
    temp112B <- temp112[(temp112$bacteria == all_sample_df$bacteria[i]) & (temp112$experiment == "main"),]
    temp121B <- temp121[(temp121$bacteria == all_sample_df$bacteria[i]) & (temp121$experiment == "main"),]
    temp122B <- temp122[(temp122$bacteria == all_sample_df$bacteria[i]) & (temp122$experiment == "main"),]
    temp211B <- temp211[(temp211$bacteria == all_sample_df$bacteria[i]) & (temp211$experiment == "main"),]
    temp212B <- temp212[(temp212$bacteria == all_sample_df$bacteria[i]) & (temp212$experiment == "main"),]
    temp221B <- temp221[(temp221$bacteria == all_sample_df$bacteria[i]) & (temp221$experiment == "main"),]
    temp222B <- temp222[(temp222$bacteria == all_sample_df$bacteria[i]) & (temp222$experiment == "main"),]
    
    # Check concentration ratios and determine starvation
    if(length(temp111B$conc_ratio) == 3 &&
       length(temp112B$conc_ratio) == 3 &&
       length(temp121B$conc_ratio) == 3 &&
       length(temp122B$conc_ratio) == 3 &&
       length(temp211B$conc_ratio) == 3 &&
       length(temp212B$conc_ratio) == 3 &&
       length(temp221B$conc_ratio) == 3 &&
       length(temp222B$conc_ratio) == 3) {
      if(temp111B$conc_ratio[1] <= 1 &&
         temp112B$conc_ratio[1] <= 1 &&
         temp121B$conc_ratio[1] <= 1 &&
         temp122B$conc_ratio[1] <= 1 &&
         temp211B$conc_ratio[1] <= 1 &&
         temp212B$conc_ratio[1] <= 1 &&
         temp221B$conc_ratio[1] <= 1 &&
         temp222B$conc_ratio[1] <= 1) {
        all_sample_df$starve[i] <- 1
      } else {
        all_sample_df$starve[i] <- 0
      }
    } else {
      all_sample_df$starve[i] <- "ERROR"
    }
  }
}

# Handle 16 carbon sources (C16)
for (i in 1:length(all_sample_df$fcs_file)) {
  
  # Check conditions for the experiment (main, single bacterial species, 16 carbon sources)
  if (all_sample_df$experiment[i] == "main" && 
      all_sample_df$bacterial_species_count[i] == 1 && 
      all_sample_df$carbonsource_species_count[i] == 16) {
    
    # Subset data for the current environment
    tempE <- all_sample_df[all_sample_df$environment == all_sample_df$environment[i], ]
    
    # Subset data for the mixed carbon source pairs
    temp1 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair1[1], ]
    temp2 <- all_sample_df[all_sample_df$environment == tempE$carbonsource_mixed_pair2[1], ]
    
    # Further subsets for each pair of carbon sources
    temp11 <- all_sample_df[all_sample_df$environment == temp1$carbonsource_mixed_pair1[1], ]
    temp12 <- all_sample_df[all_sample_df$environment == temp1$carbonsource_mixed_pair2[1], ]
    temp21 <- all_sample_df[all_sample_df$environment == temp2$carbonsource_mixed_pair1[1], ]
    temp22 <- all_sample_df[all_sample_df$environment == temp2$carbonsource_mixed_pair2[1], ]
    
    # Subset for additional carbon source pairs
    temp111 <- all_sample_df[all_sample_df$environment == temp11$carbonsource_mixed_pair1[1], ]
    temp112 <- all_sample_df[all_sample_df$environment == temp11$carbonsource_mixed_pair2[1], ]
    temp121 <- all_sample_df[all_sample_df$environment == temp12$carbonsource_mixed_pair1[1], ]
    temp122 <- all_sample_df[all_sample_df$environment == temp12$carbonsource_mixed_pair2[1], ]
    temp211 <- all_sample_df[all_sample_df$environment == temp21$carbonsource_mixed_pair1[1], ]
    temp212 <- all_sample_df[all_sample_df$environment == temp21$carbonsource_mixed_pair2[1], ]
    temp221 <- all_sample_df[all_sample_df$environment == temp22$carbonsource_mixed_pair1[1], ]
    temp222 <- all_sample_df[all_sample_df$environment == temp22$carbonsource_mixed_pair2[1], ]
    
    # Subset for deeper carbon source layers
    temp1111 <- all_sample_df[all_sample_df$environment == temp111$carbonsource_mixed_pair1[1], ]
    temp1112 <- all_sample_df[all_sample_df$environment == temp111$carbonsource_mixed_pair2[1], ]
    temp1121 <- all_sample_df[all_sample_df$environment == temp112$carbonsource_mixed_pair1[1], ]
    temp1122 <- all_sample_df[all_sample_df$environment == temp112$carbonsource_mixed_pair2[1], ]
    temp1211 <- all_sample_df[all_sample_df$environment == temp121$carbonsource_mixed_pair1[1], ]
    temp1212 <- all_sample_df[all_sample_df$environment == temp121$carbonsource_mixed_pair2[1], ]
    temp1221 <- all_sample_df[all_sample_df$environment == temp122$carbonsource_mixed_pair1[1], ]
    temp1222 <- all_sample_df[all_sample_df$environment == temp122$carbonsource_mixed_pair2[1], ]
    temp2111 <- all_sample_df[all_sample_df$environment == temp211$carbonsource_mixed_pair1[1], ]
    temp2112 <- all_sample_df[all_sample_df$environment == temp211$carbonsource_mixed_pair2[1], ]
    temp2121 <- all_sample_df[all_sample_df$environment == temp212$carbonsource_mixed_pair1[1], ]
    temp2122 <- all_sample_df[all_sample_df$environment == temp212$carbonsource_mixed_pair2[1], ]
    temp2211 <- all_sample_df[all_sample_df$environment == temp221$carbonsource_mixed_pair1[1], ]
    temp2212 <- all_sample_df[all_sample_df$environment == temp221$carbonsource_mixed_pair2[1], ]
    temp2221 <- all_sample_df[all_sample_df$environment == temp222$carbonsource_mixed_pair1[1], ]
    temp2222 <- all_sample_df[all_sample_df$environment == temp222$carbonsource_mixed_pair2[1], ]
    
    # Filter data based on bacterial species and experiment type
    temp1111B <- temp1111[(temp1111$bacteria == all_sample_df$bacteria[i]) & (temp1111$experiment == "main"), ]
    temp1112B <- temp1112[(temp1112$bacteria == all_sample_df$bacteria[i]) & (temp1112$experiment == "main"), ]
    temp1121B <- temp1121[(temp1121$bacteria == all_sample_df$bacteria[i]) & (temp1121$experiment == "main"), ]
    temp1122B <- temp1122[(temp1122$bacteria == all_sample_df$bacteria[i]) & (temp1122$experiment == "main"), ]
    temp1211B <- temp1211[(temp1211$bacteria == all_sample_df$bacteria[i]) & (temp1211$experiment == "main"), ]
    temp1212B <- temp1212[(temp1212$bacteria == all_sample_df$bacteria[i]) & (temp1212$experiment == "main"), ]
    temp1221B <- temp1221[(temp1221$bacteria == all_sample_df$bacteria[i]) & (temp1221$experiment == "main"), ]
    temp1222B <- temp1222[(temp1222$bacteria == all_sample_df$bacteria[i]) & (temp1222$experiment == "main"), ]
    temp2111B <- temp2111[(temp2111$bacteria == all_sample_df$bacteria[i]) & (temp2111$experiment == "main"), ]
    temp2112B <- temp2112[(temp2112$bacteria == all_sample_df$bacteria[i]) & (temp2112$experiment == "main"), ]
    temp2121B <- temp2121[(temp2121$bacteria == all_sample_df$bacteria[i]) & (temp2121$experiment == "main"), ]
    temp2122B <- temp2122[(temp2122$bacteria == all_sample_df$bacteria[i]) & (temp2122$experiment == "main"), ]
    temp2211B <- temp2211[(temp2211$bacteria == all_sample_df$bacteria[i]) & (temp2211$experiment == "main"), ]
    temp2212B <- temp2212[(temp2212$bacteria == all_sample_df$bacteria[i]) & (temp2212$experiment == "main"), ]
    temp2221B <- temp2221[(temp2221$bacteria == all_sample_df$bacteria[i]) & (temp2221$experiment == "main"), ]
    temp2222B <- temp2222[(temp2222$bacteria == all_sample_df$bacteria[i]) & (temp2222$experiment == "main"), ]
    
    # Check if each subset has exactly three concentration ratios and apply starvation condition
    if (all(sapply(list(temp1111B, temp1112B, temp1121B, temp1122B, temp1211B, temp1212B, temp1221B, temp1222B, 
                       temp2111B, temp2112B, temp2121B, temp2122B, temp2211B, temp2212B, temp2221B, temp2222B), 
                   function(x) length(x$conc_ratio) == 3))) {
      
      # Check if all concentration ratios are less than or equal to 1
      if (all(sapply(list(temp1111B, temp1112B, temp1121B, temp1122B, temp1211B, temp1212B, temp1221B, temp1222B, 
                         temp2111B, temp2112B, temp2121B, temp2122B, temp2211B, temp2212B, temp2221B, temp2222B), 
                     function(x) x$conc_ratio[1] <= 1))) {
        
        # Mark starvation if conditions are met
        all_sample_df$starve[i] <- 1
      } else {
        all_sample_df$starve[i] <- 0
      }
      
    } else {
      all_sample_df$starve[i] <- "ERROR"
    }
  }
}


all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 1 & all_sample_df$experiment == "main", ]

strain_list <- c(info$monoculture_bacteria_list[1], info$monoculture_bacteria_list[3:14], info$monoculture_bacteria_list[16])

# Initialize a data frame to store the results
DF <- data.frame(c(1:31))

for (i in 1:14) {
  tempr <- data.frame()
  
  for (j in 1:31) {
    temp <- all_sample_df_temp[all_sample_df_temp$bacteria == strain_list[i] & 
                               all_sample_df_temp$environment == info$environment_list[j], ]
    
    tempr <- rbind(tempr, data.frame(a = temp$starve[1]))
  }
  
  DF <- cbind(DF, tempr)
}

# Set row and column names for the final data frame
rownames(DF) <- info$environment_list[1:31]
colnames(DF) <- c("id", strain_list[1:14])


# Filter data for monoculture bacterial species and specific conditions
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 1, ]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$experiment == "main", ]

all_sample_df_temp2 <- all_sample_df_temp[(as.numeric(all_sample_df_temp$carbonsource_species_count) >= 2) &
                                             (all_sample_df_temp$starve == 1), ]

all_sample_df_temp1 <- all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 1, ]

all_sample_df_temp <- rbind(all_sample_df_temp1, all_sample_df_temp2)

all_sample_df_temp$background_processing_target_fluorescent_cells_density <- log(x = all_sample_df_temp$background_processing_target_fluorescent_cells_density, base = 10)

# List of bacterial strains for analysis
strain_list <- c(info$monoculture_bacteria_list[1], info$monoculture_bacteria_list[3:14], info$monoculture_bacteria_list[16])

# Initialize an empty data frame to store results for mixed carbon sources
mix2Ave <- data.frame()

# Loop through each environment to calculate average cell densities and perform t-tests
for (i in 17:24) {
  tempE <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1 <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2 <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    # Retrieve background fluorescent cell densities for both paired environments
    temp1B <- as.numeric(temp1[temp1$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp2B <- as.numeric(temp2[temp2$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    cmono <- c(temp1B, temp2B)
    ave12 <- mean(cmono)
    sdmean <- sqrt(mean(c(var(temp1B), var(temp2B))))

    tempY <- c(ave12 - sdmean, ave12, ave12 + sdmean)

    tempEBc <- as.numeric(tempE[tempE$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    
    # Skip if any value is NA or if no growth is observed
    if (is.na(ave12) | is.na(sdmean) | sum(tempEBc) == 0) {
      next
    } else {
      # If variance of EBc is 0, assign a p-value of 1 or 0 based on the comparison
      if (var(tempEBc) == 0) {
        ptemp <- ifelse(tempEBc[1] == ave12, 1, 0)
        for (k in 1:length(tempEBc)) {
          mix2Ave <- rbind(mix2Ave, data.frame(
            envbac = paste(info$environment_list[i], strain_list[j]),
            env = info$environment_list[i],
            bacteria = strain_list[j],
            ave12 = ave12,
            sdx = sdmean,
            sdy = sd(tempEBc),
            value = tempEBc[k],
            pvalue = ptemp
          ))
        }
      } else {
        # Perform t-test and store p-value
        t <- t.test(x = tempEBc, y = tempY, alternative = "two.sided", paired = FALSE, var.equal = FALSE, conf.level = 0.95)
        for (k in 1:length(tempEBc)) {
          mix2Ave <- rbind(mix2Ave, data.frame(
            envbac = paste(info$environment_list[i], strain_list[j]),
            env = info$environment_list[i],
            bacteria = strain_list[j],
            ave12 = ave12,
            sdx = sdmean,
            sdy = sd(tempEBc),
            value = tempEBc[k],
            pvalue = t$p.value
          ))
        }
      }
    }
  }
}

# Adjust p-values for multiple comparisons using the Benjamini-Hochberg method
qvalue <- p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave <- cbind(mix2Ave, qvalue)

# Calculate mean values and categorize results based on q-value and mean comparison
meanDF <- data.frame()
for (i in 17:24) {
  for (j in 1:14) {
    temp <- mix2Ave[(mix2Ave$env == info$environment_list[i]) & (mix2Ave$bacteria == strain_list[j]), ]
    if (length(temp$envbac) != 0) {
      meanDF <- rbind(meanDF, data.frame(
        envbac = paste(info$environment_list[i], strain_list[j]),
        ave12 = temp$ave12[1],
        mean = mean(temp$value),
        sdx = temp$sdx[1],
        sdy = temp$sdy[1],
        p = ifelse(temp$qvalue[1] < 0.05, 1, 0),
        pp = ifelse(temp$qvalue[1] < 0.05 & mean(temp$value) > temp$ave12[1], "high",
                    ifelse(temp$qvalue[1] < 0.05 & mean(temp$value) < temp$ave12[1], "low", "same"))
      ))
    }
  }
}

# Count the number of occurrences for each category
temphigh <- 0
tempsame <- 0
templow <- 0
for (i in 1:length(meanDF$envbac)) {
  if (meanDF$p[i] == 0) {
    tempsame <- tempsame + 1
  } else if (meanDF$p[i] == 1) {
    if (meanDF$ave12[i] > meanDF$mean[i]) {
      templow <- templow + 1
    } else {
      temphigh <- temphigh + 1
    }
  }
}

judge <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count <- data.frame(x1 = 1, Type = judge, count1 = judge2)

# Format and calculate proportions for the bar chart
c <- c()
c1 <- c()
for (k in 1:3) {
  c <- c(c, ifelse(count$count1[k] / sum(count$count1) < 0.1, 
                   paste(" ", format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = ""),
                   paste(format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")))
  c1 <- c(c1, count$count1[k] / sum(count$count1))
}

count <- cbind(count, c, c1)

# Set factor levels for the bar chart categories
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

# Plotting the stacked bar chart
g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                               "grey70", rgb(red = 58, green = 184, blue = 153, maxColorValue = 255)))
g
ggsave(file = "FigS14A_bar.pdf", plot = g)

# Update 'pp' column to factor for plotting
meanDF <- transform(meanDF, pp = factor(pp, levels = c("high", "same", "low")))

# Create dummy data for error bars
df1 <- data.frame(x1 = 5, y1 = 5, x2 = 10, y2 = 10)
df2 <- data.frame(x1 = log(x = (4.57*10^5), base = 10), y1 = 5, x2 = log(x = (4.57*10^5), base = 10), y2 = 10)
df3 <- data.frame(x1 = 5, y1 = log(x = (4.57*10^5), base = 10), x2 = 10, y2 = log(x = (4.57*10^5), base = 10))

g <- ggplot(meanDF, aes(x = ave12, y = mean, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df1, color = "grey20", linewidth = 0.75, linetype = "dotted") +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df2, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df3, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(5, 10), expand = c(0, 0)) +
  scale_y_continuous(limits = c(5, 10), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(184, 153, 58, maxColorValue = 255),
                                "grey70",
                                rgb(58, 184, 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1)
for (i in 1:nrow(meanDF)) {
  temp <- meanDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                         x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                         x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g +
    geom_segment(data = errorDFx, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2) +
    geom_segment(data = errorDFy, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2)
}
g

ggsave(file = "FigS14A_scatter.pdf", plot = g)

g <- ggplot(meanDF, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 1, alpha = 0.5, fill = NA,
               binwidth = 0.02, stackdir = "center", color = "black") +
  scale_y_continuous(limits = c(0.75, 1.75), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = "FigS14E.pdf", plot = g)


# Repeat for mixing 2 carbon source environment
mix2Ave <- data.frame()

for (i in 25:28) {
  
  tempE <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1 <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2 <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]
  
  temp11 <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1], ]
  temp12 <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1], ]
  temp21 <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1], ]
  temp22 <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    
    temp11B <- as.numeric(temp11[temp11$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp12B <- as.numeric(temp12[temp12$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp21B <- as.numeric(temp21[temp21$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp22B <- as.numeric(temp22[temp22$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    
    c <- c(temp11B, temp12B, temp21B, temp22B)
    ave12 <- mean(c)
    sdmean <- sqrt(mean(c(var(temp11B), var(temp12B), var(temp21B), var(temp22B)))) # Compute standard deviation
    
    tempY <- c(ave12 - sdmean, ave12, ave12 + sdmean)
    
    tempEBc <- as.numeric(tempE[tempE$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    
    if (is.na(ave12) | is.na(sdmean) | sum(tempEBc) == 0) {
      next
    }
    
    if (var(tempEBc) == 0) {
      if (tempEBc[1] == ave12) {
        ptemp <- 1
      } else {
        ptemp <- 0
      }
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac = paste(info$environment_list[i], strain_list[j]),
          env = info$environment_list[i],
          bacteria = strain_list[j],
          ave12 = ave12,
          sdx = sdmean,
          sdy = sd(tempEBc),
          value = tempEBc[k],
          pvalue = ptemp
        ))
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"), paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac = paste(info$environment_list[i], strain_list[j]),
          env = info$environment_list[i],
          bacteria = strain_list[j],
          ave12 = ave12,
          sdx = sdmean,
          sdy = sd(tempEBc),
          value = tempEBc[k],
          pvalue = t$p.value
        ))
      }
    }
  }
}

qvalue <- p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave <- cbind(mix2Ave, qvalue)

meanDF <- data.frame()

for (i in 25:28) {
  for (j in 1:14) {
    temp <- mix2Ave[(mix2Ave$env == info$environment_list[i]) & (mix2Ave$bacteria == strain_list[j]), ]
    if (length(temp$envbac) != 0) {
      meanDF <- rbind(meanDF, data.frame(
        envbac = paste(info$environment_list[i], strain_list[j]),
        ave12 = temp$ave12[1],
        mean = mean(temp$value),
        sdx = temp$sdx[1],
        sdy = temp$sdy[1],
        p = ifelse(temp$qvalue[1] < 0.05, 1, 0),
        pp = ifelse((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1]), "high", 
                    ifelse((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1]), "low", "same"))
      ))
    }
  }
}

temphigh <- 0
tempsame <- 0
templow <- 0
for (i in 1:length(meanDF$envbac)) {
  if (meanDF$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (meanDF$p[i] == 1) {
      if (meanDF$ave12[i] > meanDF$mean[i]) {
        templow <- templow + 1
      } else {
        if (meanDF$ave12[i] < meanDF$mean[i]) {
          temphigh <- temphigh + 1
        }
      }
    }
  }
}

judge <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count <- data.frame(x1 = 1, Type = judge, count1 = judge2)

c <- c()
c1 <- c()

for (k in 1:3) {
  c <- c(c, if (count$count1[k] / sum(count$count1) < 0.1) {
    paste(" ", format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
  } else {
    paste(format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
  })
  c1 <- c(c1, count$count1[k] / sum(count$count1))
}

count <- cbind(count, c, c1)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                               "grey70", rgb(red = 58, green = 184, blue = 153, maxColorValue = 255)))

ggsave(file = "FigS14B_bar.pdf", plot = g)

meanDF <- transform(meanDF, pp = factor(pp, levels = c("high", "same", "low")))
df1 <- data.frame(x1 = 5, y1 = 5, x2 = 10, y2 = 10)
df2 <- data.frame(x1 = log(x = (4.57*10^5), base = 10), y1 = 5, x2 = log(x = (4.57*10^5), base = 10), y2 = 10)
df3 <- data.frame(x1 = 5, y1 = log(x = (4.57*10^5), base = 10), x2 = 10, y2 = log(x = (4.57*10^5), base = 10))

g <- ggplot(meanDF, aes(x = ave12, y = mean, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df1, color = "grey20", linewidth = 0.75, linetype = "dotted") +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df2, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df3, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(5, 10), expand = c(0, 0)) +
  scale_y_continuous(limits = c(5, 10), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(184, 153, 58, maxColorValue = 255),
                                "grey70",
                                rgb(58, 184, 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1)
for (i in 1:nrow(meanDF)) {
  temp <- meanDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                         x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                         x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g +
    geom_segment(data = errorDFx, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2) +
    geom_segment(data = errorDFy, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2)
}
g

ggsave(file = "FigS14B_scatter.pdf", plot = g)

g <- ggplot(meanDF, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 1, alpha = 0.5, fill = NA,
               binwidth = 0.02, stackdir = "center", color = "black") +
  scale_y_continuous(limits = c(0.75, 1.75), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = "FigS14F.pdf", plot = g)

# Repeat for mixing 4 carbon source environment
mix2Ave <- data.frame()

for (i in 29:30) {
  tempE   <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]
  temp11  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1], ]
  temp12  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1], ]
  temp21  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1], ]
  temp22  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1], ]
  temp111 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair1[1], ]
  temp112 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair2[1], ]
  temp121 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair1[1], ]
  temp122 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair2[1], ]
  temp211 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair1[1], ]
  temp212 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair2[1], ]
  temp221 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair1[1], ]
  temp222 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair2[1], ]

  for (j in 1:14) {
    
    temp111B <- as.numeric(temp111[temp111$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp112B <- as.numeric(temp112[temp112$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp121B <- as.numeric(temp121[temp121$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp122B <- as.numeric(temp122[temp122$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp211B <- as.numeric(temp211[temp211$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp212B <- as.numeric(temp212[temp212$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp221B <- as.numeric(temp221[temp221$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp222B <- as.numeric(temp222[temp222$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    
    monoculture_values <- c(temp111B, temp112B, temp121B, temp122B, temp211B, temp212B, temp221B, temp222B)
    ave12 <- mean(monoculture_values)
    
    sdmean <- mean(c(
      var(temp111B), var(temp112B), var(temp121B), var(temp122B),
      var(temp211B), var(temp212B), var(temp221B), var(temp222B)
    ), na.rm = TRUE)^0.5
    
    tempY <- c(ave12 - sdmean, ave12, ave12 + sdmean)
    
    tempEBc <- as.numeric(tempE[tempE$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    
    if (is.na(ave12) | is.na(sdmean) | sum(tempEBc) == 0) {
      next
    }
    
    if (var(tempEBc) == 0) {
      ptemp <- ifelse(tempEBc[1] == ave12, 1, 0)
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac = paste(info$environment_list[i], strain_list[j]),
          env    = info$environment_list[i],
          bacteria = strain_list[j],
          ave12  = ave12,
          sdx    = sdmean,
          sdy    = sd(tempEBc),
          value  = tempEBc[k],
          pvalue = ptemp
        ))
      }
    } else {
      t <- t.test(
        x = tempEBc,
        y = tempY,
        alternative = "two.sided",
        paired = FALSE,
        var.equal = FALSE,
        conf.level = 0.95
      )
      
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac = paste(info$environment_list[i], strain_list[j]),
          env    = info$environment_list[i],
          bacteria = strain_list[j],
          ave12  = ave12,
          sdx    = sdmean,
          sdy    = sd(tempEBc),
          value  = tempEBc[k],
          pvalue = t$p.value
        ))
      }
    }
  }
}

qvalue <- p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave <- cbind(mix2Ave, qvalue)

meanDF <- data.frame()
for (i in 29:30) {
  for (j in 1:14) {
    temp <- mix2Ave[(mix2Ave$env == info$environment_list[i]) & (mix2Ave$bacteria == strain_list[j]), ]
    
    if (length(temp$envbac) != 0) {
      p_sig <- if (temp$qvalue[1] < 0.05) 1 else 0
      trend <- if ((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1])) {
        "high"
      } else if ((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1])) {
        "low"
      } else {
        "same"
      }
      
      meanDF <- rbind(meanDF, data.frame(
        envbac = paste(info$environment_list[i], strain_list[j]),
        ave12 = temp$ave12[1],
        mean = mean(temp$value),
        sdx = temp$sdx[1],
        sdy = temp$sdy[1],
        p = p_sig,
        pp = trend
      ))
    }
  }
}

temphigh <- 0
tempsame <- 0
templow <- 0

for (i in 1:length(meanDF$envbac)) {
  if (meanDF$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (meanDF$ave12[i] > meanDF$mean[i]) {
      templow <- templow + 1
    } else if (meanDF$ave12[i] < meanDF$mean[i]) {
      temphigh <- temphigh + 1
    }
  }
}

judge <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count <- data.frame(x1 = 1, Type = judge, count1 = judge2)

c <- c()
c1 <- c()
for (k in 1:3) {
  pct <- round(count$count1[k] / sum(count$count1) * 100, 1)
  label <- if (count$count1[k] / sum(count$count1) < 0.1) {
    paste(" ", format(pct, nsmall = 1), "%", sep = "")
  } else {
    paste(format(pct, nsmall = 1), "%", sep = "")
  }
  c <- c(c, label)
  c1 <- c(c1, count$count1[k] / sum(count$count1))
}
count <- cbind(count, c, c1)

count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(
    rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
    "grey70",
    rgb(red = 58, green = 184, blue = 153, maxColorValue = 255)
  ))
g
ggsave(file = "FigS14C_bar.pdf", plot = g)

meanDF <- transform(meanDF, pp = factor(pp, levels = c("high", "same", "low")))
df1 <- data.frame(x1 = 5, y1 = 5, x2 = 10, y2 = 10)
df2 <- data.frame(x1 = log(x = (4.57*10^5), base = 10), y1 = 5, x2 = log(x = (4.57*10^5), base = 10), y2 = 10)
df3 <- data.frame(x1 = 5, y1 = log(x = (4.57*10^5), base = 10), x2 = 10, y2 = log(x = (4.57*10^5), base = 10))

g <- ggplot(meanDF, aes(x = ave12, y = mean, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df1, color = "grey20", linewidth = 0.75, linetype = "dotted") +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df2, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df3, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(5, 10), expand = c(0, 0)) +
  scale_y_continuous(limits = c(5, 10), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(184, 153, 58, maxColorValue = 255),
                                "grey70",
                                rgb(58, 184, 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1)
for (i in 1:nrow(meanDF)) {
  temp <- meanDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                         x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                         x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g +
    geom_segment(data = errorDFx, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2) +
    geom_segment(data = errorDFy, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2)
}
g

ggsave(file = "FigS14C_scatter.pdf", plot = g)

g <- ggplot(meanDF, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 1, alpha = 0.5, fill = NA,
               binwidth = 0.02, stackdir = "center", color = "black") +
  scale_y_continuous(limits = c(0.75, 1.75), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = "FigS14G.pdf", plot = g)

# Repeat for mixing 8 carbon source environment
mix2Ave <- data.frame()

for (i in 31:31) {

  tempE <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i],]

  temp1 <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1],]
  temp2 <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1],]

  temp11 <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1],]
  temp12 <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1],]
  temp21 <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1],]
  temp22 <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1],]

  temp111 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair1[1],]
  temp112 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair2[1],]
  temp121 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair1[1],]
  temp122 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair2[1],]
  temp211 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair1[1],]
  temp212 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair2[1],]
  temp221 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair1[1],]
  temp222 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair2[1],]

  temp1111 <- all_sample_df_temp[all_sample_df_temp$environment == temp111$carbonsource_mixed_pair1[1],]
  temp1112 <- all_sample_df_temp[all_sample_df_temp$environment == temp111$carbonsource_mixed_pair2[1],]
  temp1121 <- all_sample_df_temp[all_sample_df_temp$environment == temp112$carbonsource_mixed_pair1[1],]
  temp1122 <- all_sample_df_temp[all_sample_df_temp$environment == temp112$carbonsource_mixed_pair2[1],]
  temp1211 <- all_sample_df_temp[all_sample_df_temp$environment == temp121$carbonsource_mixed_pair1[1],]
  temp1212 <- all_sample_df_temp[all_sample_df_temp$environment == temp121$carbonsource_mixed_pair2[1],]
  temp1221 <- all_sample_df_temp[all_sample_df_temp$environment == temp122$carbonsource_mixed_pair1[1],]
  temp1222 <- all_sample_df_temp[all_sample_df_temp$environment == temp122$carbonsource_mixed_pair2[1],]
  temp2111 <- all_sample_df_temp[all_sample_df_temp$environment == temp211$carbonsource_mixed_pair1[1],]
  temp2112 <- all_sample_df_temp[all_sample_df_temp$environment == temp211$carbonsource_mixed_pair2[1],]
  temp2121 <- all_sample_df_temp[all_sample_df_temp$environment == temp212$carbonsource_mixed_pair1[1],]
  temp2122 <- all_sample_df_temp[all_sample_df_temp$environment == temp212$carbonsource_mixed_pair2[1],]
  temp2211 <- all_sample_df_temp[all_sample_df_temp$environment == temp221$carbonsource_mixed_pair1[1],]
  temp2212 <- all_sample_df_temp[all_sample_df_temp$environment == temp221$carbonsource_mixed_pair2[1],]
  temp2221 <- all_sample_df_temp[all_sample_df_temp$environment == temp222$carbonsource_mixed_pair1[1],]
  temp2222 <- all_sample_df_temp[all_sample_df_temp$environment == temp222$carbonsource_mixed_pair2[1],]

  for (j in 1:14) {
    temp1111B <- as.numeric(temp1111[temp1111$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp1112B <- as.numeric(temp1112[temp1112$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp1121B <- as.numeric(temp1121[temp1121$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp1122B <- as.numeric(temp1122[temp1122$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp1211B <- as.numeric(temp1211[temp1211$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp1212B <- as.numeric(temp1212[temp1212$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp1221B <- as.numeric(temp1221[temp1221$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp1222B <- as.numeric(temp1222[temp1222$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp2111B <- as.numeric(temp2111[temp2111$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp2112B <- as.numeric(temp2112[temp2112$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp2121B <- as.numeric(temp2121[temp2121$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp2122B <- as.numeric(temp2122[temp2122$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp2211B <- as.numeric(temp2211[temp2211$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp2212B <- as.numeric(temp2212[temp2212$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp2221B <- as.numeric(temp2221[temp2221$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    temp2222B <- as.numeric(temp2222[temp2222$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density)
    
    c <- c(
      temp1111B, temp1112B, temp1121B, temp1122B,
      temp1211B, temp1212B, temp1221B, temp1222B,
      temp2111B, temp2112B, temp2121B, temp2122B,
      temp2211B, temp2212B, temp2221B, temp2222B
    )
    
    ave12 <- mean(c)
    
    sdmean <- mean(c(
      var(temp1111B), var(temp1112B), var(temp1121B), var(temp1122B),
      var(temp1211B), var(temp1212B), var(temp1221B), var(temp1222B),
      var(temp2111B), var(temp2112B), var(temp2121B), var(temp2122B),
      var(temp2211B), var(temp2212B), var(temp2221B), var(temp2222B)
    )) ^ 0.5

    tempY <- c(ave12 - sdmean, ave12, ave12 + sdmean)

    tempEBc <- as.numeric(tempE[tempE$bacteria == strain_list[j],]$background_processing_target_fluorescent_cells_density)

    if (!is.na(ave12) && !is.na(sdmean) && sum(tempEBc) != 0) {
      if (var(tempEBc) == 0) {
        pval <- ifelse(tempEBc[1] == ave12, 1, 0)
      } else {
        t <- t.test(x = tempEBc, y = tempY, paired = FALSE, var.equal = FALSE)
        pval <- t$p.value
      }

      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(
          mix2Ave,
          data.frame(
            envbac = paste(info$environment_list[i], strain_list[j]),
            env = info$environment_list[i],
            bacteria = strain_list[j],
            ave12 = ave12,
            sdx = sdmean,
            sdy = sd(tempEBc),
            value = tempEBc[k],
            pvalue = pval
          )
        )
      }
    }
  }
}

qvalue <- p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave <- cbind(mix2Ave, qvalue)

meanDF <- data.frame()
for (i in 31:31) {
  for (j in 1:14) {
    temp <- mix2Ave[(mix2Ave$env == info$environment_list[i]) & (mix2Ave$bacteria == strain_list[j]), ]
    
    if (sum(temp$ave12) != 0) {
      meanDF <- rbind(meanDF, data.frame(
        envbac = paste(info$environment_list[i], strain_list[j]),
        ave12 = temp$ave12[1],
        mean = mean(temp$value),
        sdx = temp$sdx[1],
        sdy = temp$sdy[1],
        p = if (temp$qvalue[1] < 0.05) 1 else 0,
        pp = if (temp$qvalue[1] < 0.05 & mean(temp$value) > temp$ave12[1]) {
          "high"
        } else if (temp$qvalue[1] < 0.05 & mean(temp$value) < temp$ave12[1]) {
          "low"
        } else {
          "same"
        }
      ))
    }
  }
}

temphigh <- 0
tempsame <- 0
templow <- 0

for (i in 1:length(meanDF$envbac)) {
  if (meanDF$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (meanDF$ave12[i] > meanDF$mean[i]) {
      templow <- templow + 1
    } else if (meanDF$ave12[i] < meanDF$mean[i]) {
      temphigh <- temphigh + 1
    }
  }
}

judge <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count <- data.frame(x1 = 1, Type = judge, count1 = judge2)

c <- c()
c1 <- c()
for (k in 1:3) {
  ratio <- count$count1[k] / sum(count$count1)
  label <- if (ratio < 0.1) {
    paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
  } else {
    paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
  }
  c <- c(c, label)
  c1 <- c(c1, ratio)
}

count <- cbind(count, c, c1)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data = count, aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(
    rgb(184, 153, 58, maxColorValue = 255),
    "grey70",
    rgb(58, 184, 153, maxColorValue = 255)
  ))
g
ggsave(file = "FigS14D_bar.pdf", plot = g)

meanDF <- transform(meanDF, pp = factor(pp, levels = c("high", "same", "low")))

df1 <- data.frame(x1 = 5, y1 = 5, x2 = 10, y2 = 10)
df2 <- data.frame(x1 = log(x = (4.57*10^5), base = 10), y1 = 5, x2 = log(x = (4.57*10^5), base = 10), y2 = 10)
df3 <- data.frame(x1 = 5, y1 = log(x = (4.57*10^5), base = 10), x2 = 10, y2 = log(x = (4.57*10^5), base = 10))

g <- ggplot(meanDF, aes(x = ave12, y = mean, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df1, color = "grey20", linewidth = 0.75, linetype = "dotted") +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df2, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               data = df3, color = "red", linewidth = 0.25, linetype = "solid", alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_x_continuous(limits = c(5, 10), expand = c(0, 0)) +
  scale_y_continuous(limits = c(5, 10), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(184, 153, 58, maxColorValue = 255),
                                "grey70",
                                rgb(58, 184, 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1)
for (i in 1:nrow(meanDF)) {
  temp <- meanDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$mean,
                         x2 = temp$ave12 + temp$sdx, y2 = temp$mean)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$mean - temp$sdy,
                         x2 = temp$ave12, y2 = temp$mean + temp$sdy)
  g <- g +
    geom_segment(data = errorDFx, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2) +
    geom_segment(data = errorDFy, aes(x = x1, y = y1, xend = x2, yend = y2),
                 color = "black", alpha = 0.3, linewidth = 0.2)
}
g

ggsave(file = "FigS14D_scatter.pdf", plot = g)

g <- ggplot(meanDF, aes(x = "1", y = mean / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 1, alpha = 0.5, fill = NA,
               binwidth = 0.02, stackdir = "center", color = "black") +
  scale_y_continuous(limits = c(0.75, 1.75), expand = c(0, 0)) +
  labs(y = "") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = "FigS14H.pdf", plot = g)
```

## FigS16
```{r}
# Subset data for the 'main' experiment
all_sample_df_temp <- all_sample_df[all_sample_df$experiment == "main", ]

# Initialize growth dataframe and define bacteria list
growth_spe <- data.frame("dummy" = 1:32)
bacteria_list <- c(info$monoculture_bacteria_list[1], info$monoculture_bacteria_list[3:14], info$monoculture_bacteria_list[16])

# Calculate log-transformed cell densities per strain per environment
for (i in 1:14) {
  temp <- all_sample_df_temp[all_sample_df_temp$bacteria == bacteria_list[i], ]
  tempc <- data.frame()
  for (j in 1:32) {
    tempBE <- temp[temp$environment == info$environment_list[j], ]
    tempc <- rbind(tempc, "a" = log10(mean(as.numeric(tempBE$background_processing_target_fluorescent_cells_density))) - log10(457000))
  }
  growth_spe <- cbind(growth_spe, tempc)
}

# Normalize growth data per strain by its maximum
normalizedG <- data.frame("dummy" = 1:32)
for (i in 2:15) {
  tempmax <- max(growth_spe[, i])
  tempc <- data.frame()
  for (j in 1:32) {
    tempc <- rbind(tempc, "a" = growth_spe[j, i] / tempmax)
  }
  normalizedG <- cbind(normalizedG, tempc)
}
normalizedGt <- t(normalizedG)[2:15, 1:32]

# Compute Euclidean distances between strains
a <- dist(normalizedGt)
data.matrix <- as.matrix(a)

# Convert distance matrix to long format for plotting
data.matrix2 <- as.data.frame(data.matrix)
data.matrix2 <- cbind(data.frame(a = info$strain_list[1:14]), data.matrix2)
mat <- rbind(c("a", info$strain_list), data.matrix2)

matD <- data.frame()
for (i in 1:14) {
  tempc <- c()
  for (j in 1:14) {
    tempc <- c(tempc, mat[j + 1, i + 1])
  }
  tempmatD <- data.frame(
    GFP = mat$a[2:15],
    mScarlet = rep(mat[1, i + 1], 14),
    a = tempc[1:14]
  )
  matD <- rbind(matD, tempmatD)
}

# Format factor levels for plotting
matD <- transform(matD,
  GFP = factor(GFP, levels = info$strain_list_phylogenetic[14:1]),
  mScarlet = factor(mScarlet, levels = info$strain_list_phylogenetic[1:14])
)

# Plot metabolic distance heatmap
g <- ggplot(matD, aes(y = GFP, x = mScarlet, fill = as.numeric(a))) +
  geom_tile() +
  scale_fill_gradientn("MetabolicDistance", colours = c("white", "grey5"), na.value = "white") +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  theme_pubr() +
  coord_fixed(ratio = 1) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20")
  )

ggsave(filename = "FigS16_tile.pdf", plot = g)
plot(g)

# Rename strain names to numeric indices for lookup
colnames(data.matrix) <- info$strain_list_phylogenetic[1:14]
rownames(data.matrix) <- info$strain_list_phylogenetic[1:14]
data.matrix <- as.data.frame(data.matrix)

# Prepare species name mapping for coculture
all_sample_df_temp <- all_sample_df
gfp_map <- c("AgT" = 1, "SpP" = 2, "AlF" = 4, "DeA" = 6, "PaV" = 8, "PaA" = 10, "PsA" = 12)
mScarlet_map <- c("PsD" = 14, "SpP" = 3, "AlF" = 5, "DeA" = 7, "PaV" = 9, "PaA" = 11, "PsA" = 13)

all_sample_df_temp$coculture_species_GFP <- as.numeric(gfp_map[all_sample_df_temp$coculture_species_GFP])
all_sample_df_temp$coculture_species_mScarlet <- as.numeric(mScarlet_map[all_sample_df_temp$coculture_species_mScarlet])

# Assign metabolic distance values to main coculture samples
for (i in 1:length(all_sample_df_temp$fcs_file)) {
  if (all_sample_df_temp$bacterial_species_count[i] == 2 && all_sample_df_temp$experiment[i] == "main") {
    all_sample_df$MetaDist[i] <- data.matrix[
      all_sample_df_temp$coculture_species_GFP[i],
      all_sample_df_temp$coculture_species_mScarlet[i]
    ]
  } else {
    all_sample_df$MetaDist[i] <- "ERROR"
  }
}

# Filter data for cocultures in the main experiment
all_sample_df_temp <- all_sample_df[
  all_sample_df$bacterial_species_count == 2 & all_sample_df$experiment == "main", 
]

# Create data frame with metabolic distance and theta values for each coculture pair in each environment
Dist_theta <- data.frame()
for (i in 1:28) {
  for (j in 1:16) {
    temp <- all_sample_df_temp[
      all_sample_df_temp$bacteria == info$coculture_bacteria_list[i] &
      all_sample_df_temp$environment == info$environment_list[j], 
    ]
    Dist_theta <- rbind(
      Dist_theta, 
      data.frame(
        Dist = as.numeric(temp$MetaDist[1]),
        theta = temp$theta_value,
        bacteria = info$coculture_bacteria_list[i]
      )
    )
  }
}

# Calculate average distance and average theta for each coculture pair
Dist_theta_ave <- data.frame()
for (i in 1:28) {
  subset_data <- Dist_theta[Dist_theta$bacteria == info$coculture_bacteria_list[i], ]
  Dist_theta_ave <- rbind(
    Dist_theta_ave, 
    data.frame(
      Dist = mean(as.numeric(subset_data$Dist)),
      ave = mean(as.numeric(subset_data$theta))
    )
  )
}

# Plot scatter of individual points and average points
g <- ggplot() +
  geom_point(
    data = Dist_theta, 
    mapping = aes(x = as.numeric(Dist), y = as.numeric(theta)), 
    alpha = 0.3, color = "black", shape = 21
  ) +
  geom_point(
    data = Dist_theta_ave, 
    mapping = aes(x = as.numeric(Dist), y = as.numeric(ave)), 
    alpha = 1, color = "red", shape = 3, size = 3
  ) +
  theme_bw() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20")
  ) +
  scale_y_continuous(
    limits = c(-90, 90),
    breaks = c(-90, -45, 0, 45, 90),
    expand = c(0, 0)
  ) +
  scale_x_continuous(
    limits = c(0, 4),
    breaks = c(0, 1, 2, 3, 4),
    expand = c(0, 0)
  )

# Show and save plot
g
ggsave(filename = "FigS16_scatter.pdf", plot = g)

# Correlation tests between metabolic distance and theta values
cor.test(as.numeric(Dist_theta$Dist), as.numeric(Dist_theta$theta), method = "spearman")$estimate
cor.test(as.numeric(Dist_theta$Dist), as.numeric(Dist_theta$theta), method = "spearman")$p.value

cor.test(as.numeric(Dist_theta_ave$Dist), as.numeric(Dist_theta_ave$ave), method = "spearman")$estimate
cor.test(as.numeric(Dist_theta_ave$Dist), as.numeric(Dist_theta_ave$ave), method = "spearman")$p.value
```

## FigS17
```{r}
# Subset only main experiment samples
all_sample_df_temp <- all_sample_df[all_sample_df$experiment == "main", ]

# Load phylogenetic distance matrix
matD <- data.frame(read.csv("phylogenetic_distance.csv"))

# Create an empty square matrix for phylogenetic distances
data.matrix <- data.frame()
for (i in 1:8) {
  data.matrix <- rbind(data.matrix, c(info$bacteria_list_Phylogenetic[1:8]))
}
colnames(data.matrix) <- info$bacteria_list_Phylogenetic[1:8]
rownames(data.matrix) <- info$bacteria_list_Phylogenetic[1:8]

# Fill in the distance values (symmetric matrix)
for (i in 1:28) {
  data.matrix[matD$Species.1[i], matD$Species.2[i]] <- matD$Dist[i]
  data.matrix[matD$Species.2[i], matD$Species.1[i]] <- matD$Dist[i]
}

# Set self distances to zero
for (i in 1:8) {
  data.matrix[info$bacteria_list_Phylogenetic[i], info$bacteria_list_Phylogenetic[i]] <- 0
}

# Add symmetric entries to distance table for plotting
for (i in 1:28) {
  matD <- rbind(
    matD,
    data.frame(
      Species.1 = matD$Species.2[i],
      Species.2 = matD$Species.1[i],
      Dist = matD$Dist[i]
    )
  )
}

# Add diagonal elements (self distance = 0)
for (i in 1:8) {
  matD <- rbind(
    matD,
    data.frame(
      Species.1 = info$bacteria_list_Phylogenetic[i],
      Species.2 = info$bacteria_list_Phylogenetic[i],
      Dist = 0
    )
  )
}

# Factorize species for heatmap ordering
matD <- transform(matD, Species.1 = factor(Species.1, levels = info$bacteria_list_Phylogenetic[8:1]))
matD <- transform(matD, Species.2 = factor(Species.2, levels = info$bacteria_list_Phylogenetic[1:8]))

# Plot heatmap without axis text
g <- ggplot(matD, aes(y = Species.1, x = Species.2, fill = as.numeric(Dist))) +
  geom_tile() +
  scale_fill_gradientn("Phylogenetic Distance", colours = c("white", "grey5"), na.value = "white") +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  theme_pubr() +
  coord_fixed() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20")
  )

ggsave(filename = "FigS17_tile.pdf", plot = g)
plot(g)

# Convert species names to numeric IDs (GFP side)
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP == "AgT"] <- 1
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP == "SpP"] <- 2
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP == "AlF"] <- 3
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP == "DeA"] <- 4
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP == "PaV"] <- 5
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP == "PaA"] <- 6
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP == "PsA"] <- 7

# Convert species names to numeric IDs (mScarlet side)
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet == "PsD"] <- 8
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet == "SpP"] <- 2
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet == "AlF"] <- 3
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet == "DeA"] <- 4
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet == "PaV"] <- 5
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet == "PaA"] <- 6
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet == "PsA"] <- 7

# Assign phylogenetic distances based on numeric IDs
for (i in 1:length(all_sample_df_temp$fcs_file)) {
  if (all_sample_df_temp$bacterial_species_count[i] == 2 &&
      all_sample_df_temp$experiment[i] == "main") {
    all_sample_df$PyloDist[i] <- data.matrix[
      as.numeric(all_sample_df_temp$coculture_species_GFP[i]),
      as.numeric(all_sample_df_temp$coculture_species_mScarlet[i])
    ]
  } else {
    all_sample_df$PyloDist[i] <- "ERROR"
  }
}

# Filter for main experiment with cocultures (2 species)
all_sample_df_temp <- all_sample_df[
  all_sample_df$bacterial_species_count == 2 & 
    all_sample_df$experiment == "main", 
]

# Collect phylogenetic distance and theta value for each coculture pair across environments
Dist_theta <- data.frame()

for (i in 1:28) {
  for (j in 1:16) {
    temp <- all_sample_df_temp[
      all_sample_df_temp$bacteria == info$coculture_bacteria_list[i] &
        all_sample_df_temp$environment == info$environment_list[j], 
    ]
    Dist_theta <- rbind(Dist_theta, data.frame(
      Dist = as.numeric(temp$PyloDist[1]),
      theta = temp$theta_value[1],
      bacteria = info$coculture_bacteria_list[i]
    ))
  }
}

# Compute average phylogenetic distance and theta value for each coculture pair
Dist_theta_ave <- data.frame()

for (i in 1:28) {
  subdata <- Dist_theta[Dist_theta$bacteria == info$coculture_bacteria_list[i], ]
  Dist_theta_ave <- rbind(Dist_theta_ave, data.frame(
    Dist = mean(as.numeric(subdata$Dist), na.rm = TRUE),
    ave = mean(as.numeric(subdata$theta), na.rm = TRUE)
  ))
}

# Plot scatter of individual and average values
g <- ggplot() +
  geom_point(
    data = Dist_theta,
    mapping = aes(x = as.numeric(Dist), y = as.numeric(theta)),
    alpha = 0.3, color = "black", shape = 21
  ) +
  geom_point(
    data = Dist_theta_ave,
    mapping = aes(x = as.numeric(Dist), y = as.numeric(ave)),
    alpha = 1, color = "red", shape = 3, size = 3
  ) +
  theme_bw() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20")
  ) +
  scale_y_continuous(
    limits = c(-90, 90),
    breaks = c(-90, -45, 0, 45, 90),
    expand = c(0, 0)
  ) +
  scale_x_continuous(
    limits = c(0, 0.5),
    breaks = seq(0, 0.5, by = 0.1),
    expand = c(0, 0)
  )

g
ggsave(filename = "FigS17_scatter.pdf", plot = g)

# Spearman correlation between distance and theta (all points)
cor.test(
  as.numeric(Dist_theta$Dist),
  as.numeric(Dist_theta$theta),
  method = "spearman"
)$estimate

cor.test(
  as.numeric(Dist_theta$Dist),
  as.numeric(Dist_theta$theta),
  method = "spearman"
)$p.value

# Spearman correlation between distance and average theta
cor.test(
  as.numeric(Dist_theta_ave$Dist),
  as.numeric(Dist_theta_ave$ave),
  method = "spearman"
)$estimate

cor.test(
  as.numeric(Dist_theta_ave$Dist),
  as.numeric(Dist_theta_ave$ave),
  method = "spearman"
)$p.value
```

## FigS18
```{r}
# Filter dataset: keep only single-carbon-source samples in 'main' experiment
all_sample_df_temp <- all_sample_df[all_sample_df$carbonsource_species_count == 1, ]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$experiment == "main", ]

# Create grow_data table: check growth condition for each species/environment
grow_data <- data.frame()

for (i in 1:16) {
  for (j in 1:8) {
    temp <- all_sample_df_temp[all_sample_df_temp$monoculture_bacteria == info$bacteria_list[j], ]
    temp <- temp[temp$environment == info$environment_list[i], ]
    
    a <- "ERROR"
    if (max(temp$background_processing_target_fluorescent_cells_density) == 457000) { a <- 0 }
    if (max(temp$background_processing_target_fluorescent_cells_density) > 457000)  { a <- 1 }
    
    grow_data <- rbind(
      grow_data,
      data.frame(
        species    = temp$monoculture_bacteria[1],
        env        = temp$environment[1],
        grow_data  = a
      )
    )
  }
}

# Map species short codes to full names
grow_data <- grow_data %>%
  mutate(
    species_full = case_when(
      species == "AgT" ~ "Agrobacterium tumefaciens",
      species == "PaA" ~ "Pantoea agglomerans",
      species == "DeA" ~ "Delftia acidovorans",
      species == "SpP" ~ "Sphingomonas paucimobilis",
      species == "AlF" ~ "Alcaligenes faecalis",
      species == "PaV" ~ "Pandoraea vervacti",
      species == "PsA" ~ "Pseudomonas asiatica",
      species == "PsD" ~ "Pseudomonas delhiensis",
      TRUE ~ species
    )
  )

# Load essential metabolite table
ess <- read.csv(file = "essmtb_count_table.csv")

# Select ess rows where grow_data == 1
ess_grow <- data.frame()
for (i in 1:length(ess$species)) {
  temp_bac       <- ess$species[i]
  temp_env       <- ess$carbon[i]
  grow_data_temp <- grow_data[grow_data$species_full == temp_bac, ]
  grow_data_temp <- grow_data_temp[grow_data_temp$env == temp_env, ]
  
  if (grow_data_temp$grow_data[1] == 1) {
    ess_grow <- rbind(ess_grow, ess[i, ])
  }
}

# Order carbon factor by theta_rank
ess_grow <- ess_grow %>%
  mutate(carbon = factor(carbon, levels = unique(carbon[order(theta_rank)])))

# Species list for plotting
species_list <- c(
  "Agrobacterium tumefaciens",
  "Pantoea agglomerans",
  "Delftia acidovorans",
  "Sphingomonas paucimobilis",
  "Alcaligenes faecalis",
  "Pandoraea vervacti",
  "Pseudomonas asiatica",
  "Pseudomonas delhiensis"
)

# Prepare ordered carbon factor for full ess table
ess <- ess %>%
  mutate(carbon = factor(carbon, levels = unique(carbon[order(theta_rank)])))
all_carbons <- levels(ess$carbon)

# Sync carbon factor levels in ess_grow
ess_grow$carbon <- factor(ess_grow$carbon, levels = all_carbons)

# Set factor for cs_flux
ess_grow$cs_flux <- factor(ess_grow$cs_flux)

# Color settings for cs_flux
flux_levels <- c(2^3)
base_colors <- c("#4B0082", "#00008B", "#CCCC00")
flux_colors <- colorRampPalette(base_colors)(length(flux_levels))
names(flux_colors) <- flux_levels

# Plot for each species
for (sp in species_list) {
  df_sp <- ess_grow %>% filter(species == sp)
  
  dummy <- data.frame(
    species          = sp,
    carbon           = factor(all_carbons, levels = all_carbons),
    number_nzfmtb_ca = NA,
    cs_flux          = NA
  )
  
  df_plot <- bind_rows(df_sp, dummy)
  
  p <- ggplot(df_plot, aes(x = carbon, y = number_nzfmtb_ca, color = cs_flux)) +
    geom_jitter(width = 0, height = 0, size = 3, alpha = 1, shape = 20, na.rm = TRUE) +
    labs(title = sp, x = "Carbon source", y = "number_nzfmtb_ca", color = "cs_flux") +
    theme_bw() +
    scale_color_manual(values = flux_colors, na.translate = FALSE) +
    scale_y_continuous(limits = c(190, 250), breaks = seq(190, 250, 10), expand = c(0, 0)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
  
  print(p)
  ggsave(file = paste("FigS18_", sp, "_FBA.pdf", sep = ""), plot = p)
}

# Filter for cs_flux == 8
ess_grow <- ess_grow[ess_grow$cs_flux == 8, ]

# Spearman correlation results
cor_results <- data.frame(
  species      = character(),
  spearman_rho = numeric(),
  p_value      = numeric()
)

for (sp in species_list) {
  df_sp <- ess_grow %>%
    filter(species == sp) %>%
    filter(!is.na(number_nzfmtb_ca) & !is.na(theta_rank))
  
  if (nrow(df_sp) > 2) {
    cor_test <- cor.test(df_sp$theta_rank, df_sp$number_nzfmtb_ca, method = "spearman")
    cor_results <- rbind(
      cor_results,
      data.frame(
        species      = sp,
        spearman_rho = cor_test$estimate,
        p_value      = cor_test$p.value
      )
    )
  } else {
    cor_results <- rbind(
      cor_results,
      data.frame(
        species      = sp,
        spearman_rho = NA,
        p_value      = NA
      )
    )
  }
}

print(cor_results)
```