---
title: "Ono_interaction_20250317"
author: "HirokiOno"
date: "2025-03-17"
output: html_document
---

# Warning: this code is a temporary version. A revised version will be uploaded shortly.

# Settings
## Library loading
```{r}
library(flowCore)
library(openxlsx)
library(data.table)
library(pbapply)
library(ggplot2)
library(dplyr)
library(plyr)
library(ggpubr)
library(coin)
library(magrittr)
library(stringr)
library(vegan)
library(pairwiseAdonis)
library(tidyverse)
library(clusterProfiler)
library(qvalue)
```

## Color settings
```{r}
# Function to create RGB colors
create_rgb <- function(r, g, b) {
  rgb(red = r, green = g, blue = b, maxColorValue = 255)
}

# Colors for 8 bacterial species
color_bacteria <- c(
  create_rgb(230, 0, 0),
  create_rgb(255, 0, 170),
  create_rgb(153, 0, 230),
  create_rgb(0, 60, 179),
  create_rgb(0, 170, 204),
  create_rgb(0, 179, 89),
  create_rgb(204, 204, 0),
  create_rgb(255, 128, 0)
)

# Colors for 6 types of interactions
color_interaction <- list(
  mutualism = create_rgb(10, 118, 198),
  commensalism = create_rgb(115, 180, 230),
  parasitism = create_rgb(155, 114, 176),
  amensalism = create_rgb(230, 138, 138),
  competition = create_rgb(222, 80, 80),
  neutral = create_rgb(188, 188, 206)
)

# Colors for fluorescent proteins
color_fluorescent <- list(
  GFP = create_rgb(89, 178, 101),
  mScarlet = create_rgb(230, 115, 202)
)

# Colors for 16 carbon sources (using HSV)
color_carbon <- sapply(0:15, function(i) hsv(h = 21 * i / 360, s = 0.5, v = 0.9, alpha = 1))
```

## Load files
```{r}
# Load experimental design file
all_sample_df <- as.data.table(read.xlsx("experimental_design.xlsx", sheet = 1))
info <- as.data.table(read.xlsx("experimental_design.xlsx", sheet = 2))
```


# Preparation of datasets
## Get the count information for each particle from the fcs file
```{r}
# Start time tracking
start_time <- Sys.time()

# Initialize results storage
density_data <- list()

# Process each FCS file with progress bar
density_data <- pblapply(all_sample_df$fcs_file, function(file) {
  sample <- read.FCS(file)
  tempDataframe <- as.data.table(sample@exprs)
  tempDataframe[, Gate.count := 0]
  total_count <- as.integer(sample@description$`$TOT`)

  # Replace values less than 1 with 1
  cols <- c("FITC-A", "PE-A", "PE-Cy5-A")
  for (col in cols) {
    tempDataframe[, (col) := pmax(get(col), 1)]
  }

  # Classify events using conditional logic
  tempDataframe[, Gate.count := fifelse(`FITC-A` > 500 | `PE-A` > 100, 5, Gate.count)]
  tempDataframe[, Gate.count := fifelse((`FITC-A` > 500 & `PE-A` < 100) | 
                                        (`PE-A` > 100 & `PE-A` < 500 & `PE-A` < `FITC-A` / 10), 4, Gate.count)]
  tempDataframe[, Gate.count := fifelse((`FITC-A` < 500 & `PE-A` > 100) | 
                                        (`FITC-A` > 500 & `FITC-A` < 2000 & `PE-A` > (`FITC-A` * 3 - 1000)) | 
                                        (`FITC-A` > 2000 & `FITC-A` < 7000 & `PE-A` > (`FITC-A` * 59 - 113000)), 3, Gate.count)]
  tempDataframe[, Gate.count := fifelse(`SSC-H` > 25000, 2, Gate.count)]
  tempDataframe[, Gate.count := fifelse((`SSC-H` > 240000 & `PE-Cy5-A` > 20000 & `FITC-A` > 20000 & `PE-A` > 800 & 
                                         (`PE-A` > 170000 | `PE-A` < `FITC-A` * 110 / 69 + 60000 - 31000 * 110 / 69)) |
                                        (`SSC-H` > 19000 & `SSC-H` < (15 * `PE-Cy5-A` - 60000) & `SSC-H` > (10 * `PE-Cy5-A` - 360000) & 
                                         `FITC-A` > 20000 & `PE-A` > 800 & (`PE-A` > 170000 | `PE-A` < `FITC-A` * 110 / 69 + 60000 - 31000 * 110 / 69)), 1, Gate.count)]

  # Count event types
  beads <- sum(tempDataframe$Gate.count == 1)
  red <- sum(tempDataframe$Gate.count == 3)
  green <- sum(tempDataframe$Gate.count == 4)
  bicolor <- sum(tempDataframe$Gate.count == 5)

  # Return the result as a list to be merged with all_sample_df
  return(list(green = green, red = red, bicolor = bicolor, beads = beads))
})

# Convert the list of results to a data.table
density_data_dt <- rbindlist(density_data)

# Add new columns to all_sample_df by matching the row order
all_sample_df[, c("green", "red", "bicolor", "beads") := .(density_data_dt$green, density_data_dt$red, density_data_dt$bicolor, density_data_dt$beads)]

all_sample_df <- as.data.frame(all_sample_df)

# End time tracking and print duration
end_time <- Sys.time()
duration <- end_time - start_time
print(paste("Execution time:", duration, "min"))
```

## TEMP
```{r}
all_sample_df_2<-all_sample_df
# all_sample_df<-all_sample_df_2
```

## Convert particle counts to cell density.
```{r}
all_sample_df$target_fluorescent_cells_density <- ifelse(all_sample_df$bacterial_species_count == 1,
  ifelse(all_sample_df$monoculture_fluorescence == "GFP",
    ifelse(all_sample_df$dispensation_protcol == 1, 1.83 * 10000000 * 80 / 4000 * all_sample_df$green / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
      ifelse(all_sample_df$dispensation_protcol %in% c(2, 3, 4), 1.83 * 10000000 * 64 / 4000 * all_sample_df$green / all_sample_df$beads * 10 / all_sample_df$dispensed_volume, "ERROR")),
    ifelse(all_sample_df$monoculture_fluorescence == "mScarlet",
      ifelse(all_sample_df$dispensation_protcol == 1, 1.83 * 10000000 * 80 / 4000 * all_sample_df$red / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
        ifelse(all_sample_df$dispensation_protcol %in% c(2, 3, 4), 1.83 * 10000000 * 64 / 4000 * all_sample_df$red / all_sample_df$beads * 10 / all_sample_df$dispensed_volume, "ERROR")), "ERROR")),
  ifelse(all_sample_df$bacterial_species_count == 2,
    ifelse(all_sample_df$dispensation_protcol == 1, 1.83 * 10000000 * 80 / 4000 * (all_sample_df$green + all_sample_df$red) / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
      ifelse(all_sample_df$dispensation_protcol %in% c(2, 3, 4), 1.83 * 10000000 * 64 / 4000 * (all_sample_df$green + all_sample_df$red) / all_sample_df$beads * 10 / all_sample_df$dispensed_volume, "ERROR")), "ERROR"))

all_sample_df$fluorescent_events_density <- ifelse(all_sample_df$dispensation_protcol == 1,
  1.83 * 10000000 * 80 / 4000 * (all_sample_df$green + all_sample_df$red + all_sample_df$bicolor) / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
  ifelse(all_sample_df$dispensation_protcol %in% c(2, 3, 4), 1.83 * 10000000 * 64 / 4000 * (all_sample_df$green + all_sample_df$red + all_sample_df$bicolor) / all_sample_df$beads * 10 / all_sample_df$dispensed_volume, "ERROR"))

all_sample_df$green_events_density <- ifelse(all_sample_df$dispensation_protcol == 1,
  1.83 * 10000000 * 80 / 4000 * all_sample_df$green / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
  ifelse(all_sample_df$dispensation_protcol %in% c(2, 3, 4), 1.83 * 10000000 * 64 / 4000 * all_sample_df$green / all_sample_df$beads * 10 / all_sample_df$dispensed_volume, "ERROR"))

all_sample_df$red_events_density <- ifelse(all_sample_df$dispensation_protcol == 1,
  1.83 * 10000000 * 80 / 4000 * all_sample_df$red / all_sample_df$beads * 10 / all_sample_df$dispensed_volume,
  ifelse(all_sample_df$dispensation_protcol %in% c(2, 3, 4), 1.83 * 10000000 * 64 / 4000 * all_sample_df$red / all_sample_df$beads * 10 / all_sample_df$dispensed_volume, "ERROR"))

cols_to_check <- c("target_fluorescent_cells_density", "fluorescent_events_density", "green_events_density", "red_events_density")
all_sample_df[cols_to_check] <- lapply(all_sample_df[cols_to_check], function(x) ifelse(is.nan(x), 1, x))

all_sample_df$target_fluorescent_cells_density <- as.numeric(all_sample_df$target_fluorescent_cells_density)
all_sample_df$fluorescent_events_density <- as.numeric(all_sample_df$fluorescent_events_density)
all_sample_df$green_events_density <- as.numeric(all_sample_df$green_events_density)
all_sample_df$red_events_density <- as.numeric(all_sample_df$red_events_density)
all_sample_df$green_red_cells_density <- all_sample_df$green_events_density + all_sample_df$red_events_density

cols_to_check <- c("target_fluorescent_cells_density", "fluorescent_events_density", "green_events_density", "red_events_density", "green_red_cells_density")
all_sample_df[cols_to_check] <- lapply(all_sample_df[cols_to_check], function(x) ifelse(is.nan(x), 1, x))
```

## Determine detection limits
```{r}
water <- all_sample_df[all_sample_df$environment == "water", ]
water_cell_density <- water$green_red_cells_density

proportion <- seq(0,1, by=0.1)
back <- quantile(water_cell_density, proportion, type=1)

# We considered the 90th percentile as the detection limit.
detection_limit <- signif(back[10], 3)
detection_limit
```

## Perform background processing
```{r}
all_sample_df$background_processing_target_fluorescent_cells_density <- pmax(all_sample_df$target_fluorescent_cells_density, detection_limit)
all_sample_df$background_processing_fluorescent_events_density <- pmax(all_sample_df$fluorescent_events_density, detection_limit)
all_sample_df$background_processing_green_events_density <- pmax(all_sample_df$green_events_density, detection_limit)
all_sample_df$background_processing_red_events_density <- pmax(all_sample_df$red_events_density, detection_limit)
```

## Pick up monocultured cell density
```{r}
experiment_vals <- unique(all_sample_df$experiment)
environment_vals <- unique(all_sample_df$environment)

green_min_vec <- numeric(nrow(all_sample_df))
green_med_vec <- numeric(nrow(all_sample_df))
green_max_vec <- numeric(nrow(all_sample_df))
red_min_vec <- numeric(nrow(all_sample_df))
red_med_vec <- numeric(nrow(all_sample_df))
red_max_vec <- numeric(nrow(all_sample_df))
check_vec <- numeric(nrow(all_sample_df))

for(i in 1:nrow(all_sample_df)) {
  if(all_sample_df$bacterial_species_count[i] == 1) {
    temp_experiment <- all_sample_df[all_sample_df$experiment == all_sample_df$experiment[i] &
                                     all_sample_df$environment == all_sample_df$environment[i], ]
    temp_mono <- temp_experiment[temp_experiment$bacteria == all_sample_df$bacteria[i], ]
    
    green_min_vec[i] <- min(as.numeric(temp_mono$background_processing_green_events_density))
    green_med_vec[i] <- median(as.numeric(temp_mono$background_processing_green_events_density))
    green_max_vec[i] <- max(as.numeric(temp_mono$background_processing_green_events_density))
    red_min_vec[i] <- min(as.numeric(temp_mono$background_processing_red_events_density))
    red_med_vec[i] <- median(as.numeric(temp_mono$background_processing_red_events_density))
    red_max_vec[i] <- max(as.numeric(temp_mono$background_processing_red_events_density))
    check_vec[i] <- ifelse(length(temp_mono$fcs_file) == 3, 0, 1)
  }

  if(all_sample_df$bacterial_species_count[i] == 2) {
    temp_experiment <- all_sample_df[all_sample_df$experiment == all_sample_df$experiment[i] &
                                     all_sample_df$environment == all_sample_df$environment[i], ]
    temp_mono_GFP <- temp_experiment[temp_experiment$monoculture_species_GFP == all_sample_df$coculture_species_GFP[i], ]
    temp_mono_mScarlet <- temp_experiment[temp_experiment$monoculture_species_mScarlet == all_sample_df$coculture_species_mScarlet[i], ]
    
    green_min_vec[i] <- min(as.numeric(temp_mono_GFP$background_processing_green_events_density))
    green_med_vec[i] <- median(as.numeric(temp_mono_GFP$background_processing_green_events_density))
    green_max_vec[i] <- max(as.numeric(temp_mono_GFP$background_processing_green_events_density))
    red_min_vec[i] <- min(as.numeric(temp_mono_mScarlet$background_processing_red_events_density))
    red_med_vec[i] <- median(as.numeric(temp_mono_mScarlet$background_processing_red_events_density))
    red_max_vec[i] <- max(as.numeric(temp_mono_mScarlet$background_processing_red_events_density))
    check_vec[i] <- ifelse(length(c(temp_mono_GFP$fcs_file, temp_mono_mScarlet$fcs_file)) == 6, 0, 1)
  }
}

if(all(check_vec == 0)) {
  all_sample_df$green_min <- green_min_vec
  all_sample_df$green_med <- green_med_vec
  all_sample_df$green_max <- green_max_vec
  all_sample_df$red_min <- red_min_vec
  all_sample_df$red_med <- red_med_vec
  all_sample_df$red_max <- red_max_vec
}
```

## Pick up cocultured cell density
```{r}
pick <- data.frame()

for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$experiment[i] == "main" && all_sample_df$bacterial_species_count[i] == 2){
    temp <- all_sample_df[all_sample_df$experiment == "main",]
    temp <- temp[temp$bacterial_species_count == 2,]
    temp <- temp[temp$bacteria == all_sample_df$bacteria[i],]
    temp <- temp[temp$environment == all_sample_df$environment[i],]
    
    pick <- rbind(pick, data.frame(file = all_sample_df$fcs_file[i],
                                   co_mingreen = min(temp$background_processing_green_events_density),
                                   co_medgreen = median(temp$background_processing_green_events_density),
                                   co_maxgreen = max(temp$background_processing_green_events_density),
                                   co_minred = min(temp$background_processing_red_events_density),
                                   co_medred = median(temp$background_processing_red_events_density),
                                   co_maxred = max(temp$background_processing_red_events_density),
                                   check = if(length(temp$fcs_file) == 3) {0} else {1}))
  } else {
    pick <- rbind(pick, data.frame(file = all_sample_df$fcs_file[i],
                                   co_mingreen = "none",
                                   co_medgreen = "none",
                                   co_maxgreen = "none",
                                   co_minred = "none",
                                   co_medred = "none",
                                   co_maxred = "none",
                                   check = 0))
  }
}

if(all(pick$check == 0)) {
  all_sample_df$co_mingreen <- pick$co_mingreen
  all_sample_df$co_medgreen <- pick$co_medgreen
  all_sample_df$co_maxgreen <- pick$co_maxgreen
  all_sample_df$co_minred <- pick$co_minred
  all_sample_df$co_medred <- pick$co_medred
  all_sample_df$co_maxred <- pick$co_maxred
}
```

## Test the significance of the effect
```{r}
temp <- all_sample_df[all_sample_df$experiment == "main", ]
temp <- temp[temp$bacterial_species_count == 2, ]

latestDF <- data.frame()
greenpvalue <- numeric(length(temp$fcs_file))
redpvalue <- numeric(length(temp$fcs_file))
check <- numeric(length(temp$fcs_file))

for (i in 1:length(temp$fcs_file)) {
  cg <- c()
  cr <- c()
  temp_df <- temp[(temp$bacteria == temp$bacteria[i]) & (temp$environment == temp$environment[i]), ]
  
  cg <- c(as.numeric(temp_df$background_processing_green_events_density) / mean(c(as.numeric(temp_df$green_min), as.numeric(temp_df$green_med), as.numeric(temp_df$green_max))))
  cr <- c(as.numeric(temp_df$background_processing_red_events_density) / mean(c(as.numeric(temp_df$red_min), as.numeric(temp_df$red_med), as.numeric(temp_df$red_max))))
  
  if (var(cg) == 0) {
    tgtemp <- ifelse(cg[1] == 1, 1, 0)
  } else {
    tgtemp <- t.test(x = cg, y = NULL, alternative = c("two.sided", "less", "greater"), mu = 1, paired = FALSE, var.equal = FALSE, conf.level = 0.95)$p.value
  }
  
  if (var(cr) == 0) {
    trtemp <- ifelse(cr[1] == 1, 1, 0)
  } else {
    trtemp <- t.test(x = cr, y = NULL, alternative = c("two.sided", "less", "greater"), mu = 1, paired = FALSE, var.equal = FALSE, conf.level = 0.95)$p.value
  }
  
  check[i] <- ifelse(length(cg) == 3 & length(cr) == 3, 0, 1)
  
  # Add the calculated values to the latestDF
  latestDF <- rbind(latestDF, data.frame(filelatest = temp$fcs_file[i], greenpvalue = tgtemp, redpvalue = trtemp, check = check[i]))
}

greenqvalue <- p.adjust(latestDF$greenpvalue, method = "BH")
redqvalue <- p.adjust(latestDF$redpvalue, method = "BH")

if(all(latestDF$check == 0)) {
  # Merge the results back into the original dataframe (all_sample_df)
  all_sample_df$greenpvalue <- "mono-culture"
  all_sample_df$redpvalue <- "mono-culture"
  
  for (i in 1:nrow(latestDF)) {
    idx <- which(all_sample_df$fcs_file == latestDF$filelatest[i])
    
    if (length(idx) > 0) {
      all_sample_df$greenpvalue[idx] <- latestDF$greenpvalue[i]
      all_sample_df$redpvalue[idx] <- latestDF$redpvalue[i]
    }
  }
  
  # Adjust q-values in the main dataframe
  all_sample_df$greenqvalue <- "mono-culture"
  all_sample_df$redqvalue <- "mono-culture"
  all_sample_df$greenqvalue[!all_sample_df$greenpvalue == "mono-culture"] <- greenqvalue
  all_sample_df$redqvalue[!all_sample_df$redpvalue == "mono-culture"] <- redqvalue
}
```

## Calculate interaction classes & interaction types
```{r}
pop_sd <- function(x) {
  if (all(is.na(x))) return(NA)  # すべて NA の場合
  sqrt(mean((x - mean(x, na.rm = TRUE))^2, na.rm = TRUE))
}

safe_numeric <- function(x) {
  vals <- suppressWarnings(as.numeric(x))
  if (any(is.na(vals))) return(NULL) else return(vals)
}

# 各行の必要な列を数値に変換（変換できない場合はNULLを返す）
get_numeric <- function(row, cols) {
  vals <- as.numeric(row[cols])
  if (any(is.na(vals))) return(NULL) else return(vals)
}

# Type 計算の修正
compute_type <- function(red_to_green, green_to_red) {
  if (red_to_green == "+" && green_to_red == "+") {
    return("Mutualism")
  } else if ((red_to_green == "0" && green_to_red == "+") || (red_to_green == "+" && green_to_red == "0")) {
    return("Commensalism")
  } else if ((red_to_green == "-" && green_to_red == "+") || (red_to_green == "+" && green_to_red == "-")) {
    return("Parasitism")
  } else if ((red_to_green == "0" && green_to_red == "-") || (red_to_green == "-" && green_to_red == "0")) {
    return("Amensalism")
  } else if (red_to_green == "-" && green_to_red == "-") {
    return("Competition")
  } else if (red_to_green == "0" && green_to_red == "0") {
    return("Neutral")
  } else {
    return("ERROR")
  }
}

# plot_hierarchy 計算の修正
compute_plot_hierarchy <- function(type) {
  if (type == "Neutral") {
    return(0)
  } else if (type %in% c("Commensalism", "Amensalism")) {
    return(1)
  } else if (type %in% c("Mutualism", "Parasitism", "Competition")) {
    return(2)
  } else {
    return("ERROR")
  }
}

# 1行ずつ計算 (修正部分)
compute_row <- function(row) {
  ## greenaspect_value 計算
  vals_green_num <- safe_numeric(row[c("co_mingreen", "co_medgreen", "co_maxgreen")])
  vals_green_den <- safe_numeric(row[c("green_min", "green_med", "green_max")])
  if (is.null(vals_green_num) || is.null(vals_green_den)) {
    greenaspect_value <- "OTHER"
  } else {
    avg_num <- mean(vals_green_num)
    avg_den <- mean(vals_green_den)
    greenaspect_value <- ifelse(avg_den == 0 || (avg_num/avg_den) <= 0, "OTHER", log(avg_num/avg_den, base = 2))
  }
  
  ## redaspect_value 計算
  vals_red_num <- safe_numeric(row[c("co_minred", "co_medred", "co_maxred")])
  vals_red_den <- safe_numeric(row[c("red_min", "red_med", "red_max")])
  if (is.null(vals_red_num) || is.null(vals_red_den)) {
    redaspect_value <- "OTHER"
  } else {
    avg_num_red <- mean(vals_red_num)
    avg_den_red <- mean(vals_red_den)
    redaspect_value <- ifelse(avg_den_red == 0 || (avg_num_red/avg_den_red) <= 0, "OTHER", log(avg_num_red/avg_den_red, base = 2))
  }
  
  # theta_value（CU=greenaspect_value, CW=redaspect_value）
  if (!is.numeric(greenaspect_value) || !is.numeric(redaspect_value)) {
    theta_value <- "OTHER"
  } else {
    CU <- greenaspect_value
    CW <- redaspect_value
    if (CU == 0 && CW == 0) {
      theta_value <- 0
    } else if (CU == 0) {
      theta_value <- ifelse(CW > 0, 45, -45)
    } else if (CW == 0) {
      theta_value <- ifelse(CU > 0, 45, -45)
    } else if (CU == CW) {
      theta_value <- ifelse(CW > 0, 90, -90)
    } else {
      ratio <- if (CU > CW) CU/CW else CW/CU
      t_val <- atan(ratio)
      adjusted <- if (t_val < (pi * 0.25)) t_val + pi else t_val
      theta_value <- (pi * 3/4 - adjusted) / pi * 180
    }
  }
  
  # x_value = IF(CU > CW, CW, CU)
  if (!is.numeric(greenaspect_value) || !is.numeric(redaspect_value)) {
    x_value <- "OTHER"
  } else {
    x_value <- if (greenaspect_value > redaspect_value) redaspect_value else greenaspect_value
  }
  
  # x_sd の計算
  # 　・CU > CW の場合：赤側グループ（co_minred,co_medred,co_maxred と red_min,red_med,red_max）
  # 　・それ以外の場合：緑側グループ（co_mingreen,co_medgreen,co_maxgreen と green_min,green_med,green_max）
  if (!is.numeric(greenaspect_value) || !is.numeric(redaspect_value)) {
    x_sd <- "OTHER"
  } else {
    if (greenaspect_value > redaspect_value) {
      A_vals <- get_numeric(row, c("co_minred", "co_medred", "co_maxred"))
      B_vals <- get_numeric(row, c("red_min", "red_med", "red_max"))
      if (is.null(A_vals) || is.null(B_vals)) {
        x_sd <- "OTHER"
      } else {
        A <- mean(A_vals)
        B <- mean(B_vals)
        if (A == 0 || B == 0) {
          x_sd <- "OTHER"
        } else {
          sd_A <- pop_sd(A_vals)
          sd_B <- pop_sd(B_vals)
          x_sd <- sqrt((A^2 * sd_B^2) + (B^2 * sd_A^2)) / (log(2) * A * B)
        }
      }
    } else {
      A_vals <- get_numeric(row, c("co_mingreen", "co_medgreen", "co_maxgreen"))
      B_vals <- get_numeric(row, c("green_min", "green_med", "green_max"))
      if (is.null(A_vals) || is.null(B_vals)) {
        x_sd <- "OTHER"
      } else {
        A <- mean(A_vals)
        B <- mean(B_vals)
        if (A == 0 || B == 0) {
          x_sd <- "OTHER"
        } else {
          sd_A <- pop_sd(A_vals)
          sd_B <- pop_sd(B_vals)
          x_sd <- sqrt((A^2 * sd_B^2) + (B^2 * sd_A^2)) / (log(2) * A * B)
        }
      }
    }
  }
  
  # y_value = IF(CU > CW, CU, CW)
  if (!is.numeric(greenaspect_value) || !is.numeric(redaspect_value)) {
    y_value <- "OTHER"
  } else {
    y_value <- if (greenaspect_value > redaspect_value) greenaspect_value else redaspect_value
  }
  
  # y_sd の計算（x_sdとは逆に、CU > CWなら緑側、そうでなければ赤側を用いる）
  if (!is.numeric(greenaspect_value) || !is.numeric(redaspect_value)) {
    y_sd <- "OTHER"
  } else {
    if (greenaspect_value > redaspect_value) {
      A_vals <- get_numeric(row, c("co_mingreen", "co_medgreen", "co_maxgreen"))
      B_vals <- get_numeric(row, c("green_min", "green_med", "green_max"))
      if (is.null(A_vals) || is.null(B_vals)) {
        y_sd <- "OTHER"
      } else {
        A <- mean(A_vals)
        B <- mean(B_vals)
        if (A == 0 || B == 0) {
          y_sd <- "OTHER"
        } else {
          sd_A <- pop_sd(A_vals)
          sd_B <- pop_sd(B_vals)
          y_sd <- sqrt((A^2 * sd_B^2) + (B^2 * sd_A^2)) / (log(2) * A * B)
        }
      }
    } else {
      A_vals <- get_numeric(row, c("co_minred", "co_medred", "co_maxred"))
      B_vals <- get_numeric(row, c("red_min", "red_med", "red_max"))
      if (is.null(A_vals) || is.null(B_vals)) {
        y_sd <- "OTHER"
      } else {
        A <- mean(A_vals)
        B <- mean(B_vals)
        if (A == 0 || B == 0) {
          y_sd <- "OTHER"
        } else {
          sd_A <- pop_sd(A_vals)
          sd_B <- pop_sd(B_vals)
          y_sd <- sqrt((A^2 * sd_B^2) + (B^2 * sd_A^2)) / (log(2) * A * B)
        }
      }
    }
  }
  
  ## red_to_green 計算
  greenq <- safe_numeric(row["greenqvalue"])
  greenaspect <- greenaspect_value
  if (is.null(greenq) || is.null(greenaspect)) {
    red_to_green <- "OTHER"
  } else if (greenq > 0.05 || greenaspect == 0) {
    red_to_green <- "0"
  } else if (greenq <= 0.05 && greenaspect > 0) {
    red_to_green <- "+"
  } else if (greenq <= 0.05 && greenaspect < 0) {
    red_to_green <- "-"
  } else {
    red_to_green <- "ERROR"
  }
  
  ## green_to_red 計算
  redq <- safe_numeric(row["redqvalue"])
  redaspect <- redaspect_value
  if (is.null(redq) || is.null(redaspect)) {
    green_to_red <- "OTHER"
  } else if (redq > 0.05 || redaspect == 0) {
    green_to_red <- "0"
  } else if (redq <= 0.05 && redaspect > 0) {
    green_to_red <- "+"
  } else if (redq <= 0.05 && redaspect < 0) {
    green_to_red <- "-"
  } else {
    green_to_red <- "ERROR"
  }
  
  ## Type 計算 (修正)
  Type <- compute_type(red_to_green, green_to_red)
  
  ## plot_hierarchy 計算 (修正)
  plot_hierarchy <- compute_plot_hierarchy(Type)
  
  return(c(greenaspect_value = greenaspect_value,
           redaspect_value = redaspect_value,
           theta_value = theta_value,
           x_value = x_value,
           x_sd = x_sd,
           y_value = y_value,
           y_sd = y_sd,
           red_to_green = red_to_green,
           green_to_red = green_to_red,
           Type = Type,
           plot_hierarchy = plot_hierarchy))
}

# 計算開始
new_cols <- lapply(1:nrow(all_sample_df), function(i) compute_row(all_sample_df[i, ]))

# 結果をデータフレームに変換
new_cols <- do.call(rbind, new_cols)
new_cols <- as.data.frame(new_cols, stringsAsFactors = FALSE)

# 全データに結合
all_sample_df <- cbind(all_sample_df, new_cols)
```

## Pick up OD data
```{r}
FilterMaxOD96read <- function(plate_basic_name,plate_id,hour,env1,env2,strain,carbon1,carbon2,test,monoculture_fluorescence,monoculture_strain){
  od<-c()
  id<-c()
  plate_name<-paste(plate_basic_name,plate_id,"_",hour,"h.csv",sep="")
  d<-data.frame(read.csv(plate_name))
  for(i in 1:12){
    for(j in 1:8){
      od<-c(od,as.numeric(d[j,i+1]))
    }
  }
  
  h96<-rep(hour,96)
  environment96<-c(rep(env1,48),rep(env2,48))
  carbon96<-c(rep(carbon1,48),rep(carbon2,48))
  index=c(1:96)
  
  ODdf<-data.frame("OD"=as.numeric(od),"hour"=as.numeric(h96),"strain"=strain,"env"=environment96,"well_index"=index,"platehour"=paste(plate_basic_name,plate_id,"-hour",hour,"_",index),"plateindex"=paste(plate_basic_name,plate_id,index),"carbon"=carbon96,"test"=test,"monoculture_fluorescence"=monoculture_fluorescence,"monoculture_strain"=monoculture_strain,stringsAsFactors = F)
  return(ODdf)
}

ODdf<-data.frame()
env_list<-info$environment_list

strain<-info$coculture_platedesign[1:96]
monoculture_fluorescence<-rep("coculture",96)
monoculture_strain<-rep("coculture",96)
for(i in 0:24){
  for(j in 1:32){
    temp_i <- if(i*3<10){paste("0",i*3,sep="")}else{i*3}
    temp_j <- if(j<10){paste("0",j,sep="")}else{j}
    
    env1<-env_list[j]
    env2<-env_list[j]
    carbon1<-env1
    carbon2<-env2
    
    ODdf<-rbind(ODdf,FilterMaxOD96read("Ono_plate",temp_j,temp_i,env1,env2,strain,carbon1,carbon2,"coculture",monoculture_fluorescence,monoculture_strain))    
  }
}

strain<-info$monoculture_platedesign
monoculture_fluorescence<-info$monoculture_fluorescence_list
monoculture_strain<-info$monoculture_platedesign

for(i in 0:24){
  for(j in 33:48){
    temp_i <- if(i*3<10){paste("0",i*3,sep="")}else{i*3}
    temp_j <- if(j<10){paste("0",j,sep="")}else{j}
    
    env1<-env_list[((j-32)*2)]
    env2<-env_list[((j-32)*2-1)]
    carbon1<-env1
    carbon2<-env2
    
    ODdf<-rbind(ODdf,FilterMaxOD96read("Ono_plate",temp_j,temp_i,env1,env2,strain,carbon1,carbon2,"coculture",monoculture_fluorescence,monoculture_strain))
  }
}

env_list<-info$monoculture_test_environment_list
carbon_list<-info$monoculture_test_carbon_list

for(i in 0:24){
  for(j in 49:72){
    temp_i <- if(i*3<10){paste("0",i*3,sep="")}else{i*3}
    temp_j <- if(j<10){paste("0",j,sep="")}else{j}
    
    env1<-env_list[((j-48)*2-1)]
    env2<-env_list[((j-48)*2)]
    
    carbon1<-carbon_list[((j-48)*2-1)]
    carbon2<-carbon_list[((j-48)*2)]
    
    ODdf<-rbind(ODdf,FilterMaxOD96read("Ono_plate",temp_j,temp_i,env1,env2,strain,carbon1,carbon2,"monoculture",monoculture_fluorescence,monoculture_strain))    
  }
}

all_sample_df$final_OD <- "Not Available"

for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$concentration[i]==0.5){
    env_temp <- paste(all_sample_df$environment[i],"0.5 mg/mL")
  }else if(all_sample_df$concentration[i]==1.0){
    env_temp <- all_sample_df$environment[i]
  }
  
  tempOD<-ODdf[ODdf$env==env_temp&ODdf$strain==all_sample_df$bacteria[i]&ODdf$well_index==all_sample_df$well_index[i]&ODdf$hour==72,]
  if(length(tempOD$OD)==1){
    all_sample_df$final_OD[i] <- tempOD$OD[1]
  }
}
```

## temp
```{r}
all_sample_df_3 <- all_sample_df
```

# Analysis
## Fig.1C
```{r}
tempDFG <- data.frame(
  tempx = c("1mono", "1mono", "1mono", "2co", "2co", "2co"),
  tempy = c(4 - 0.6, 4 + 0.2, 4 + 0.4, 4 * sqrt(2) + 0.8, 4 * sqrt(2) - 0.2, 4 * sqrt(2) - 0.6)
)

tempDFR <- data.frame(
  tempx = c("1mono", "1mono", "1mono", "2co", "2co", "2co"),
  tempy = c(8 - 0.9, 8 + 0.2, 8 + 0.7, 2 + 0.4, 2 - 0.3, 2 - 0.1)
)

g <- ggplot(data = tempDFG, mapping = aes(x = tempx, y = tempy)) +
  geom_bar(stat = "summary", fun = "mean", width = 0.6, fill = color_fluorescent$GFP) +
  geom_point(size = 5, color = "grey20") +
  scale_y_continuous(
    limits = c(0, 20),
    expand = c(0, 0),
    breaks = c(0, 4, 8, 12, 16, 20)
  ) +
  theme_linedraw() +
  theme(
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_line(linewidth = 0.5, color = "grey20"),
    plot.margin = margin(t = 10, r = 150, b = 0, l = 150, unit = "pt"),
    legend.position = "none"
  )

ggsave(file = "Fig1C_GFP_cell_density_barplot.pdf", plot = g)
g

g <- ggplot(data = tempDFR, mapping = aes(x = tempx, y = tempy)) +
  geom_bar(stat = "summary", fun = "mean", width = 0.6, fill = color_fluorescent$mScarlet) +
  geom_point(size = 5, color = "grey20") +
  scale_y_continuous(
    limits = c(0, 20),
    expand = c(0, 0),
    breaks = c(0, 4, 8, 12, 16, 20)
  ) +
  theme_linedraw() +
  theme(
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_line(linewidth = 0.5, color = "grey20"),
    plot.margin = margin(t = 10, r = 150, b = 0, l = 150, unit = "pt"),
    legend.position = "none"
  )

ggsave(file = "Fig1C_mScarlet_cell_density_barplot.pdf", plot = g)
g

```

## Fig.1D
```{r}
sample <- data.frame(x1 = -8, y1 = 0.5 * 4, col = "ZZZ", fil = "ZZZZZ")
sample2 <- data.frame(x1 = c(0, -8), y1 = c(0, 0.5 * 4), col = "ZZZZ")

df1_15 <- data.frame(x1 = -15, y1 = -15, x2 = 15, y2 = 15)
df2_15 <- data.frame(x1 = -14, y1 = 14, x2 = 0, y2 = 0)
df3_15 <- data.frame(x1 = -14.5, y1 = 0, x2 = 15, y2 = 0)
df4_15 <- data.frame(x1 = 0, y1 = 14.5, x2 = 0, y2 = -15)

dfMutualism <- data.frame(x1 = 15, y1 = 14.5, x2 = 1, y2 = 14.5, col = "Mutualism")
dfCommensalism <- data.frame(x1 = 1, y1 = 14.5, x2 = -1, y2 = 14.5, col = "Commensalism")
dfParasitism1 <- data.frame(x1 = -1, y1 = 14.5, x2 = -15, y2 = 14.5, col = "Parasitism")
dfParasitism2 <- data.frame(x1 = -14.5, y1 = 15, x2 = -14.5, y2 = 1, col = "Parasitism")
dfAmensalism <- data.frame(x1 = -14.5, y1 = 1, x2 = -14.5, y2 = -1, col = "Amensalism")
dfCompetition <- data.frame(x1 = -14.5, y1 = -1, x2 = -14.5, y2 = -15, col = "Competition")
dfW1 <- data.frame(x1 = -14.5, y1 = -15.5, x2 = -12, y2 = -13, col = "Z")
dfW2 <- data.frame(x1 = 15.5, y1 = 14.5, x2 = 13, y2 = 12, col = "Z")

dfx <- data.frame(x1 = c(4, 8, 12), y1 = c(0, 0, 0), lab = c("1", "2", "3"))
dfy <- data.frame(x1 = c(0, 0, 0), y1 = c(-12, -8, -4), lab = c("-3", "-2", "-1"))

dfxtick <- data.frame(x1 = c(-12, -12, -8, -8, -4, -4, 0, 0, 4, 4, 8, 8, 12, 12),
                      y1 = c(0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2),
                      lab = c("-12", "-12", "-8", "-8", "-4", "-4", "0", "0", "4", "4", "8", "8", "12", "12"),
                      col = "Y")
dfytick <- data.frame(x1 = c(0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2, 0.2, -0.2),
                      y1 = c(-12, -12, -8, -8, -4, -4, 0, 0, 4, 4, 8, 8, 12, 12),
                      lab = c("-12", "-12", "-8", "-8", "-4", "-4", "0", "0", "4", "4", "8", "8", "12", "12"),
                      col = "Y")

circleFun <- function(center = c(0, 0), diameter = 1, npoints = 1000) {
  r <- diameter / 2
  tt <- seq(3/4 * pi, (atan(2/0.5) + 1/2 * pi), length.out = npoints)
  xx <- center[1] + r * cos(tt)
  yy <- center[2] + r * sin(tt)
  data.frame(x = xx, y = yy)
}
dat <- circleFun(c(0, 0), 4, npoints = 1000)

g1 <- ggplot() +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey80", data = df3_15, linewidth = 0.5, linetype = "solid", show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey80", data = df4_15, linewidth = 0.5, linetype = "solid", show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfMutualism, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfCommensalism, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfParasitism1, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfParasitism2, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfAmensalism, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfCompetition, linewidth = 5, show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfW1, linewidth = 5 * sqrt(2), show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2, color = col),
               data = dfW2, linewidth = 5 * sqrt(2), show.legend = NA) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey20", data = df1_15, linewidth = 0.75, show.legend = NA) +
  geom_segment(aes(x = x2, y = y2, xend = x1, yend = y1),
               color = "grey20", data = df2_15, linewidth = 0.5, linetype = "dashed", show.legend = NA) +
  geom_text(data = dfx, aes(x = x1, y = y1 + 1, label = lab), show.legend = NA) +
  geom_line(data = dfxtick, aes(x = x1, y = y1, group = lab, color = col), show.legend = NA) +
  geom_text(data = dfy, aes(x = x1 + 1, y = y1, label = lab), show.legend = NA) +
  geom_line(data = dfytick, aes(x = x1, y = y1, group = lab, color = col), show.legend = NA) +
  geom_line(data = sample2, aes(x = x1, y = y1), color = "grey20", show.legend = NA) +
  geom_point(data = sample, aes(x = as.numeric(x1), y = as.numeric(y1)),
             color = color_interaction$parasitism, fill = "white", shape = 21, stroke = 1, size = 2, alpha = 1,
             stat = "identity", position = "identity", na.rm = FALSE, show.legend = NA, inherit.aes = TRUE)

errorDFx <- data.frame(x1 = (-2 - 0.24417729) * 4, y1 = 0.5 * 4, x2 = (-2 + 0.24417729) * 4, y2 = 0.5 * 4)
errorDFy <- data.frame(x1 = -2 * 4, y1 = (0.5 - 0.216404256) * 4, x2 = -2 * 4, y2 = (0.5 + 0.216404256) * 4)
g1 <- g1 + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "grey20", alpha = 0.4, data = errorDFx, linewidth = 0.4, linetype = "solid")
g1 <- g1 + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "grey20", alpha = 0.4, data = errorDFy, linewidth = 0.4, linetype = "solid")

g1 <- g1 +
  geom_point(data = sample, aes(x = as.numeric(x1), y = as.numeric(y1)),
             color = color_interaction$parasitism, shape = 21, stroke = 1, size = 2, alpha = 1,
             stat = "identity", position = "identity", na.rm = FALSE, show.legend = NA, inherit.aes = TRUE) +
  geom_path(data = dat, aes(x = x, y = y), color = "grey20") +
  scale_x_continuous(limits = c(-15.5, 15.5), expand = c(0, 0)) +
  scale_y_continuous(limits = c(-15.5, 15.5), expand = c(0, 0)) +
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE) +
  scale_color_manual(values=c(color_interaction$amensalism,color_interaction$commensalism,color_interaction$competition,color_interaction$mutualism,color_interaction$parasitism,"grey80","White",color_interaction$mutualism,"grey20"))+
  theme_void() +
  theme(legend.position = "none")

plot(g1)
ggsave(file = "Fig1D_2024_theta_explain.pdf", plot = g1)
```

## Fig.2A
```{r}
thetaplot_df <- data.frame()
for(i in 1:28){
  for(j in 1:32){
    temp <- all_sample_df[all_sample_df$experiment=="main",]
    temp <- temp[temp$bacterial_species_count==2,]
    temp <- temp[temp$bacteria==info$coculture_bacteria_list[i],]
    temp <- temp[temp$environment==info$environment_list[j],]
    thetaplot_df <- rbind(thetaplot_df, data.frame(
      bacteria = info$coculture_bacteria_list[i],
      environment = info$environment_list[j],
      nc = as.numeric(temp$carbonsource_species_count)[1],
      x_value = as.numeric(temp$x_value)[1],
      x_sd = as.numeric(temp$x_sd)[1],
      y_value = as.numeric(temp$y_value)[1],
      y_sd = as.numeric(temp$y_sd)[1],
      theta_value = as.numeric(temp$theta_value)[1],
      Type = temp$Type[1],
      plot_hierarchy = temp$plot_hierarchy[1]
    ))
  }
}

thetaplot_df1 <- thetaplot_df[thetaplot_df$nc == 1,]
all_sample_df0 <- thetaplot_df1[thetaplot_df1$plot_hierarchy==0,]
all_sample_df1 <- thetaplot_df1[thetaplot_df1$plot_hierarchy==1,]
all_sample_df2 <- thetaplot_df1[thetaplot_df1$plot_hierarchy==2,]

df1 <- data.frame(x1=-12, y1=-12, x2=12, y2=12)
df2 <- data.frame(x1=-12, y1=12, x2=0, y2=0)
df3 <- data.frame(x1=-12, y1=0, x2=12, y2=0)
df4 <- data.frame(x1=0, y1=12, x2=0, y2=-12)
dfx <- data.frame(x1=c(-8,-4,0,4,8), y1=rep(0,5), lab=c("-8","-4","0","4","8"))
dfy <- data.frame(x1=rep(0,5), y1=c(-8,-4,0,4,8), lab=c("-8","-4","0","4","8"))
dfxtick <- data.frame(x1=c(-8,-8,-4,-4,0,0,4,4,8,8),
                      y1=c(0.2,-0.2,0.2,-0.2,0.2,-0.2,0.2,-0.2,0.2,-0.2),
                      lab=c("-8","-8","-4","-4","0","0","4","4","8","8"),
                      col="Y")
dfxtick_2 <- data.frame(x1=c(-8,-8,-4,-4),
                        y1=c(0.2,-0.2,0.2,-0.2),
                        lab=c("-8","-8","-4","-4"),
                        col="Y")
dfytick <- data.frame(x1=c(0.2,-0.2,0.2,-0.2,0.2,-0.2,0.2,-0.2,0.2,-0.2),
                      y1=c(-8,-8,-4,-4,0,0,4,4,8,8),
                      lab=c("-8","-8","-4","-4","0","0","4","4","8","8"),
                      col="Y")
dfytick_2 <- data.frame(x1=c(0.2,-0.2,0.2,-0.2,0.2,-0.2,0.2,-0.2),
                        y1=c(-8,-8,-4,-4,4,4,8,8),
                        lab=c("-8","-8","-4","-4","4","4","8","8"),
                        col="Y")

g1 <- ggplot() +
  geom_segment(aes(x=x1, y=y1-12, xend=x2, yend=y2-12),
               color="grey80", data=df3, linewidth=0.5, linetype="solid", show.legend=NA) +
  geom_segment(aes(x=x1-12, y=y1, xend=x2-12, yend=y2),
               color="grey80", data=df4, linewidth=0.5, linetype="solid", show.legend=NA) +
  geom_segment(aes(x=x1, y=y1, xend=x2-12, yend=y2),
               color="grey80", data=df3, linewidth=0.5, linetype="solid", show.legend=NA) +
  geom_segment(aes(x=x1, y=y1, xend=x2, yend=y2),
               color="grey80", data=df4, linewidth=0.5, linetype="solid", show.legend=NA) +
  geom_segment(aes(x=x1, y=y1, xend=x2, yend=y2),
               color="black", data=df1, linewidth=0.75, show.legend=NA) +
  geom_segment(aes(x=x1, y=y1, xend=x2, yend=y2),
               color="black", data=df2, linewidth=0.5, linetype="dashed", show.legend=NA) +
  geom_text(data=dfx, aes(x=x1, y=y1-13.2, label=lab), size=6, show.legend=NA) +
  geom_line(data=dfxtick_2, aes(x=x1, y=y1, group=lab), color="grey80", show.legend=NA) +
  geom_line(data=dfxtick, aes(x=x1, y=y1-12, group=lab), color="grey80", show.legend=NA) +
  geom_text(data=dfy, aes(x=x1-13.5, y=y1, label=lab), size=6, show.legend=NA) +
  geom_line(data=dfytick_2, aes(x=x1, y=y1, group=lab), color="grey80", show.legend=NA) +
  geom_line(data=dfytick, aes(x=x1-12, y=y1, group=lab), color="grey80", show.legend=NA)

for(i in 1:nrow(thetaplot_df1)){
  temp <- thetaplot_df1[i,]
  errorDFx <- data.frame(x1=temp$x_value-temp$x_sd, y1=temp$y_value,
                          x2=temp$x_value+temp$x_sd, y2=temp$y_value)
  errorDFy <- data.frame(x1=temp$x_value, y1=temp$y_value-temp$y_sd,
                          x2=temp$x_value, y2=temp$y_value+temp$y_sd)
  g1 <- g1 +
    geom_segment(aes(x=x1, y=y1, xend=x2, yend=y2),
                 color="black", alpha=0.2, data=errorDFx, linewidth=0.2, linetype="solid") +
    geom_segment(aes(x=x1, y=y1, xend=x2, yend=y2),
                 color="black", alpha=0.2, data=errorDFy, linewidth=0.2, linetype="solid")
}

g1 <- g1 +
  geom_point(data=all_sample_df0,
             aes(x=as.numeric(x_value), y=as.numeric(y_value), color=as.factor(Type)),
             shape=21, stroke=0.5, size=1, alpha=1) +
  geom_point(data=all_sample_df1,
             aes(x=as.numeric(x_value), y=as.numeric(y_value), color=as.factor(Type)),
             shape=21, stroke=0.5, size=1, alpha=1) +
  geom_point(data=all_sample_df2,
             aes(x=as.numeric(x_value), y=as.numeric(y_value), color=as.factor(Type)),
             shape=21, stroke=0.5, size=1, alpha=1) +
  scale_x_continuous(limits=c(-14.5,12), expand=c(0,0)) +
  scale_y_continuous(limits=c(-14.5,12), expand=c(0,0)) +
  coord_fixed(ratio=1) +
  scale_color_manual(values=c(color_interaction$amensalism,
                              color_interaction$commensalism,
                              color_interaction$competition,
                              color_interaction$mutualism,
                              color_interaction$neutral,
                              color_interaction$parasitism)) +
  theme_void() +
  theme(legend.position="none")

ggsave(file="Fig2A_2024_all_theta.pdf", plot=g1)
plot(g1)

all_sample_df <- transform(all_sample_df, Type=factor(Type, levels=info$interaction_types_list))
g1 <- ggplot() +
  geom_segment(aes(x=x1, y=y1, xend=x2, yend=y2),
               color="black", data=df1, linewidth=0.75) +
  geom_segment(aes(x=x1, y=y1, xend=x2, yend=y2),
               color="black", data=df2, linewidth=0.5, linetype="dashed") +
  geom_segment(aes(x=x1, y=y1, xend=x2, yend=y2),
               color="black", data=df3, linewidth=0.5, linetype="dotted") +
  geom_segment(aes(x=x1, y=y1, xend=x2, yend=y2),
               color="black", data=df4, linewidth=0.5, linetype="dotted") +
  geom_point(data=all_sample_df,
             aes(x=as.numeric(x_value), y=as.numeric(y_value), color=as.factor(Type)),
             shape=21, stroke=2, size=3, alpha=1) +
  scale_x_continuous(limits=c(-14,14), breaks=c(-8,-4,0,4,8),
                     guide=guide_axis(angle=90), expand=c(0,0)) +
  scale_y_continuous(limits=c(-14,14), breaks=c(-8,-4,0,4,8), expand=c(0,0)) +
  coord_fixed(ratio=1) +
  scale_color_manual(values=c(color_interaction$mutualism,
                              color_interaction$commensalism,
                              color_interaction$parasitism,
                              color_interaction$amensalism,
                              color_interaction$competition,
                              color_interaction$neutral)) +
  theme_bw() +
  theme(title=element_blank(), axis.text=element_text(size=12),
        axis.title.x=element_blank(), axis.title.y=element_blank(),
        legend.text=element_text(size=15))

ggsave(file="Fig2A_2024_all_for_legend_theta.pdf", plot=g1)
plot(g1)

all_sample_df2 <- transform(thetaplot_df1, Type=factor(Type, levels=info$interaction_types_list))
count <- data.frame()
for(i in 6:1){
  count <- rbind(count, data.frame(x1=1,
                                   count1=length(all_sample_df2[all_sample_df2$Type==info$interaction_types_list[i],]$Type),
                                   Type=info$interaction_types_list[i]))
}
c_vec <- c()
c1_vec <- c()
for(i in 1:6){
  c_vec <- c(c_vec, if(count$count1[i]/sum(count$count1) < 0.1){
    paste(" ", format(round(count$count1[i]/sum(count$count1)*100,1), nsmall=1), "%", sep="")
  } else {
    paste(format(round(count$count1[i]/sum(count$count1)*100,1), nsmall=1), "%", sep="")
  })
  c1_vec <- c(c1_vec, count$count1[i]/sum(count$count1))
}
count <- cbind(count, c=c_vec, c1=c1_vec)
count <- transform(count, Type=factor(Type, levels=info$interaction_types_list))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data=count, aes(x=as.factor(x1), y=c1, fill=Type)) +
  geom_bar(stat="identity", position="fill", width=0.15) +
  geom_text(aes(label=c, y=pos), size=6, hjust=-1) +
  theme_void() +
  scale_fill_manual(values=c(color_interaction$mutualism,
                              color_interaction$commensalism,
                              color_interaction$parasitism,
                              color_interaction$amensalism,
                              color_interaction$competition,
                              color_interaction$neutral))

ggsave(file="Fig2A_2024_all_bar.pdf", plot=g)
plot(g)
```

## Fig.2BC
```{r}
my_strain <- info$bacteria_list_Phylogenetic[8:1]
my_type <- c("Mutualism", "Commensalism", "Parasitism", "Amensalism", "Competition", "Neutral")
my_cmap <- c(color_interaction$mutualism, color_interaction$commensalism, color_interaction$parasitism, 
             color_interaction$amensalism, color_interaction$competition, color_interaction$neutral)

my_color_df <- data.frame(interaction_type = my_type, color = my_cmap)
my_color_df$interaction_type <- factor(my_color_df$interaction_type, levels = my_type)
my_color_df <- my_color_df[order(my_color_df$interaction_type), ]
my_color_df$level = rep(1, nrow(my_color_df))

thetaplot_df <- data.frame()
for (i in 1:28) {
  for (j in 1:32) {
    temp <- all_sample_df[all_sample_df$experiment == "main", ]
    temp <- temp[temp$bacterial_species_count == 2, ]
    temp <- temp[temp$bacteria == info$coculture_bacteria_list[i], ]
    temp <- temp[temp$environment == info$environment_list[j], ]
    thetaplot_df <- rbind(thetaplot_df, data.frame(
      bacteria = info$coculture_bacteria_list[i],
      coculture_species_GFP = temp$coculture_species_GFP[1],
      coculture_species_mScarlet = temp$coculture_species_mScarlet[1],
      environment = info$environment_list[j],
      nc = as.numeric(temp$carbonsource_species_count)[1],
      x_value = as.numeric(temp$x_value)[1],
      x_sd = as.numeric(temp$x_sd)[1],
      y_value = as.numeric(temp$y_value)[1],
      y_sd = as.numeric(temp$y_sd)[1],
      theta_value = as.numeric(temp$theta_value)[1],
      interaction_type = temp$Type[1],
      plot_hierarchy = temp$plot_hierarchy[1]
    ))
  }
}

pairintmap <- function(carbon) {
  fnc_intmap <- thetaplot_df[thetaplot_df$environment == carbon, ]
  fnc_intmap$coculture_species_GFP <- factor(fnc_intmap$coculture_species_GFP, levels = my_strain)
  fnc_intmap$coculture_species_mScarlet <- factor(fnc_intmap$coculture_species_mScarlet, levels = my_strain)
  fnc_intmap$interaction_type <- factor(fnc_intmap$interaction_type, levels = my_type)
  fnc_intmap$ConcatGR <- paste(fnc_intmap$coculture_species_GFP, fnc_intmap$coculture_species_mScarlet, sep = "_")
  fnc_fillcolor <- my_color_df[my_color_df$interaction_type %in% fnc_intmap$interaction_type, ]$color
  fnc_df <- as.data.frame(t(combn(my_strain, m = 2)))
  colnames(fnc_df) <- c("Strain_A", "Strain_B")
  fnc_df$Strain_A <- factor(fnc_df$Strain_A, levels = my_strain)
  fnc_df$Strain_B <- factor(fnc_df$Strain_B, levels = my_strain)
  fnc_df$ConcatAB <- paste(fnc_df$Strain_A, fnc_df$Strain_B, sep = "_")
  fnc_df$ConcatBA <- paste(fnc_df$Strain_B, fnc_df$Strain_A, sep = "_")
  fnc_temp <- fnc_intmap %>% select(ConcatGR, interaction_type)
  colnames(fnc_temp) <- c("ConcatAB", "TypeAB")
  fnc_temp$TypeAB <- as.character(fnc_temp$TypeAB)
  fnc_df <- left_join(fnc_df, fnc_temp)
  fnc_temp <- fnc_intmap %>% select(ConcatGR, interaction_type)
  colnames(fnc_temp) <- c("ConcatBA", "TypeBA")
  fnc_temp$TypeBA <- as.character(fnc_temp$TypeBA)
  fnc_df <- left_join(fnc_df, fnc_temp)
  fnc_df$Type <- NA
  for (i in 1:nrow(fnc_df)) {
    if (!is.na(fnc_df$TypeAB[i])) {
      fnc_df$Type[i] <- fnc_df$TypeAB[i]
    } else {
      fnc_df$Type[i] <- fnc_df$TypeBA[i]
    }
  }
  
  fnc_df <- fnc_df[!is.na(fnc_df$Type), ]
  fnc_df$Type <- factor(fnc_df$Type, levels = my_type)
  
  p <- ggplot(fnc_df, aes(x = Strain_A, y = Strain_B, fill = Type)) +
    geom_tile(colour = "white", size = 0.2) +
    scale_fill_manual(values = fnc_fillcolor) +
    guides(fill = guide_legend(title = "")) +
    coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE) +
    scale_x_discrete(expand = expansion(mult = c(0.1, 0)), guide = guide_axis(angle = 90), position = "top") +
    theme_pubr(legend = "right") +
    theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank(),
          axis.line = element_line(size = 2, lineend = "square", color = "grey20"), axis.ticks.length = unit(3, "mm"),
          axis.ticks = element_line(size = 2, lineend = "square", color = "grey20"))
  return(p)
}

ggsave(file = paste("Fig2B_Raffinose.pdf"), plot = pairintmap("Raffinose"))
ggsave(file = paste("Fig2C_Succinate.pdf"), plot = pairintmap("Succinate"))
pairintmap("Raffinose")
pairintmap("Succinate")
```

## Fig.2DE
```{r}
# Filtering data based on conditions
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 2 &
                                    all_sample_df$carbonsource_species_count == 1 &
                                    all_sample_df$experiment == "main",]

# Bacteria processing
tempB <- data.frame()
for (i in 1:28) {
  tempB <- rbind(tempB, data.frame(bacteria = info$coculture_bacteria_list[i],
                                   mean = mean(as.numeric(all_sample_df_temp[all_sample_df_temp$bacteria == info$coculture_bacteria_list[i],]$theta_value))))
}
tempB <- tempB$bacteria[order(tempB$mean)]

# Clean up bacteria names
tempB <- str_remove_all(tempB, "_GFP|_mScarlet| Tn5")

# Environment processing
tempE <- data.frame()
for (i in 1:16) {
  tempE <- rbind(tempE, data.frame(environment = info$environment_list[i],
                                   mean = mean(as.numeric(all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i],]$theta_value))))
}
tempE <- tempE$environment[order(tempE$mean)]

# Count data
count <- data.frame()
for (i in 6:1) {
  for (j in 1:28) {
    temp <- all_sample_df_temp[all_sample_df_temp$bacteria == info$coculture_bacteria_list[j],]
    count <- rbind(count, data.frame(bac = info$coculture_bacteria_list[j],
                                     count1 = length(temp[temp$Type == info$interaction_types_list[i],]$Type),
                                     Type = info$interaction_types_list[i]))
  }
}

# Prepare count data for ggplot
countDF <- data.frame()
for (j in 1:28) {
  tempcount <- data.frame(dammy = c(1:6))
  c1 <- c()
  for (i in 1:6) {
    temp <- count[count$bac == info$coculture_bacteria_list[j],]
    c1 <- c(c1, temp$count1[i] / sum(temp$count1))
  }
  env1 <- rep(info$coculture_bacteria_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}

# Clean up environment names
countDF$env1 <- str_remove_all(countDF$env1, "_GFP|_mScarlet| Tn5")
countDF <- countDF[countDF$c1 != 0,]

# Final ggplot for bacteria
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = tempB)) 

g <- ggplot(data = countDF, mapping = aes(x = as.factor(env1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.75) +
  theme_pubr(legend = "none") +
  scale_y_continuous(labels = scales::percent, breaks = c(0, 0.5, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_interaction$mutualism, color_interaction$commensalism,
                               color_interaction$parasitism, color_interaction$amensalism,
                               color_interaction$competition, color_interaction$neutral)) +
  theme(title = element_blank(), axis.text.x = element_text(size = 11), axis.text.y = element_text(size = 12),
        axis.title.x = element_blank(), axis.title.y = element_blank(), plot.margin = margin(t = 180, r = 0, b = 0, l = 0, unit = "pt"),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20")) +
  scale_x_discrete(guide = guide_axis(angle = 90))

ggsave(file = paste("Fig2E_", "allbacteriatheta_bar.pdf", sep = ""), plot = g)
plot(g)

# Repeat for environment
count <- data.frame()
for (i in 6:1) {
  for (j in 1:16) {
    temp <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[j],]
    count <- rbind(count, data.frame(env = info$environment_list[j],
                                     count1 = length(temp[temp$Type == info$interaction_types_list[i],]$Type),
                                     Type = info$interaction_types_list[i]))
  }
}

countDF <- data.frame()
for (j in 1:16) {
  tempcount <- data.frame(dammy = c(1:6))
  c1 <- c()
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j],]
    c1 <- c(c1, temp$count1[i] / sum(temp$count1))
  }
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}

countDF <- countDF[countDF$c1 != 0,]
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = tempE)) 

g <- ggplot(data = countDF, mapping = aes(x = as.factor(env1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.75) +
  theme_pubr(legend = "none") +
  scale_y_continuous(labels = scales::percent, breaks = c(0, 0.5, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_interaction$mutualism, color_interaction$commensalism,
                               color_interaction$parasitism, color_interaction$amensalism,
                               color_interaction$competition, color_interaction$neutral)) +
  theme(title = element_blank(), axis.text = element_text(size = 12), axis.title.x = element_blank(),
        axis.title.y = element_blank(), plot.margin = margin(t = 180, r = 209, b = 0, l = 0, unit = "pt"),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20")) +
  scale_x_discrete(guide = guide_axis(angle = 90))

ggsave(file = paste("Fig2D_", "allenvtheta_bar.pdf", sep = ""), plot = g)
plot(g)
```

## Fig.3A
```{r}
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 2 & all_sample_df$experiment == "main", ]

infoc <- transform(all_sample_df_temp, Type = factor(Type, levels = info$interaction_types_list))
count <- data.frame()
for (i in 6:1) {
  for (j in 1:16) {
    temp <- infoc[infoc$environment == info$environment_list[j], ]
    temp <- subset(temp, !is.na(temp$fcs_file))
    count <- rbind(count, data.frame(env = info$environment_list[j],
                                     count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
                                     Type = info$interaction_types_list[i]))
  }
}
countDF <- data.frame()
for (j in 1:16) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    c <- c(c, if (ratio < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    c1 <- c(c1, ratio)
  }
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}
countDF <- subset(countDF, c1 != 0)
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = info$environment_list[16:1]))

g1 <- ggplot() +
  geom_bar(data = countDF,
           mapping = aes(x = as.factor(env1), y = c1, fill = Type),
           stat = "identity", position = "fill", width = 0.75) +
  theme_minimal() +
  scale_y_continuous(position = "right", labels = scales::percent,
                     breaks = c(0, 0.5, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_interaction$mutualism,
                               color_interaction$commensalism,
                               color_interaction$parasitism,
                               color_interaction$amensalism,
                               color_interaction$competition,
                               color_interaction$neutral)) +
  coord_flip()

infoc <- transform(all_sample_df_temp, Type = factor(Type, levels = info$interaction_types_list))
count <- data.frame()
for (i in 6:1) {
  for (j in 17:24) {
    temp <- infoc[infoc$environment == info$environment_list[j], ]
    temp <- subset(temp, !is.na(temp$fcs_file))
    count <- rbind(count, data.frame(env = info$environment_list[j],
                                     count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
                                     Type = info$interaction_types_list[i]))
  }
}
countDF <- data.frame()
for (j in 17:24) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    c <- c(c, if (ratio < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    c1 <- c(c1, ratio)
  }
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}
countDF <- subset(countDF, c1 != 0)
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = info$environment_list[24:17]))

g2 <- ggplot() +
  geom_bar(data = countDF,
           mapping = aes(x = as.factor(env1), y = c1, fill = Type),
           stat = "identity", position = "fill", width = 0.875) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_interaction$mutualism,
                               color_interaction$commensalism,
                               color_interaction$parasitism,
                               color_interaction$amensalism,
                               color_interaction$competition,
                               color_interaction$neutral)) +
  coord_flip()

infoc <- transform(all_sample_df_temp, Type = factor(Type, levels = info$interaction_types_list))
count <- data.frame()
for (i in 6:1) {
  for (j in 25:28) {
    temp <- infoc[infoc$environment == info$environment_list[j], ]
    temp <- subset(temp, !is.na(temp$fcs_file))
    count <- rbind(count, data.frame(env = info$environment_list[j],
                                     count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
                                     Type = info$interaction_types_list[i]))
  }
}
countDF <- data.frame()
for (j in 25:28) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    c <- c(c, if (ratio < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    c1 <- c(c1, ratio)
  }
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}
countDF <- subset(countDF, c1 != 0)
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = info$environment_list[28:25]))

g4 <- ggplot() +
  geom_bar(data = countDF,
           mapping = aes(x = as.factor(env1), y = c1, fill = Type),
           stat = "identity", position = "fill", width = 0.94) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_interaction$mutualism,
                               color_interaction$commensalism,
                               color_interaction$parasitism,
                               color_interaction$amensalism,
                               color_interaction$competition,
                               color_interaction$neutral)) +
  coord_flip()

infoc <- transform(all_sample_df_temp, Type = factor(Type, levels = info$interaction_types_list))
count <- data.frame()
for (i in 6:1) {
  for (j in 29:30) {
    temp <- infoc[infoc$environment == info$environment_list[j], ]
    temp <- subset(temp, !is.na(temp$fcs_file))
    count <- rbind(count, data.frame(env = info$environment_list[j],
                                     count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
                                     Type = info$interaction_types_list[i]))
  }
}
countDF <- data.frame()
for (j in 29:30) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    c <- c(c, if (ratio < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    c1 <- c(c1, ratio)
  }
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}
countDF <- subset(countDF, c1 != 0)
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = info$environment_list[30:29]))

g8 <- ggplot() +
  geom_bar(data = countDF,
           mapping = aes(x = as.factor(env1), y = c1, fill = Type),
           stat = "identity", position = "fill", width = 0.97) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_interaction$parasitism,
                               color_interaction$amensalism,
                               color_interaction$competition,
                               color_interaction$neutral)) +
  coord_flip()

infoc <- transform(all_sample_df_temp, Type = factor(Type, levels = info$interaction_types_list))
count <- data.frame()
for (i in 6:1) {
  for (j in 31:31) {
    temp <- infoc[infoc$environment == info$environment_list[j], ]
    temp <- subset(temp, !is.na(temp$fcs_file))
    count <- rbind(count, data.frame(env = info$environment_list[j],
                                     count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
                                     Type = info$interaction_types_list[i]))
  }
}
countDF <- data.frame()
for (j in 31:31) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  for (i in 1:6) {
    temp <- count[count$env == info$environment_list[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    c <- c(c, if (ratio < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    c1 <- c(c1, ratio)
  }
  env1 <- rep(info$environment_list[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}
countDF <- subset(countDF, c1 != 0)
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = info$environment_list[31:31]))

g16 <- ggplot() +
  geom_bar(data = countDF,
           mapping = aes(x = as.factor(env1), y = c1, fill = Type),
           stat = "identity", position = "fill", width = 1) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0, 0)) +
  scale_fill_manual(values = c(color_interaction$amensalism,
                               color_interaction$competition)) +
  coord_flip()

c1 <- data.frame(env = "1",
                 theta = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 1 & all_sample_df_temp$bacterial_species_count == 2, ]$theta,
                 strain = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 1 & all_sample_df_temp$bacterial_species_count == 2, ]$bacteria,
                 Type = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 1 & all_sample_df_temp$bacterial_species_count == 2, ]$Type)
c2 <- data.frame(env = "2",
                 theta = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 2 & all_sample_df_temp$bacterial_species_count == 2, ]$theta,
                 strain = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 2 & all_sample_df_temp$bacterial_species_count == 2, ]$bacteria,
                 Type = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 2 & all_sample_df_temp$bacterial_species_count == 2, ]$Type)
c4 <- data.frame(env = "4",
                 theta = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 4 & all_sample_df_temp$bacterial_species_count == 2, ]$theta,
                 strain = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 4 & all_sample_df_temp$bacterial_species_count == 2, ]$bacteria,
                 Type = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 4 & all_sample_df_temp$bacterial_species_count == 2, ]$Type)
c8 <- data.frame(env = "8",
                 theta = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 8 & all_sample_df_temp$bacterial_species_count == 2, ]$theta,
                 strain = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 8 & all_sample_df_temp$bacterial_species_count == 2, ]$bacteria,
                 Type = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 8 & all_sample_df_temp$bacterial_species_count == 2, ]$Type)
c16 <- data.frame(env = "16",
                  theta = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 16 & all_sample_df_temp$bacterial_species_count == 2, ]$theta,
                  strain = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 16 & all_sample_df_temp$bacterial_species_count == 2, ]$bacteria,
                  Type = all_sample_df_temp[all_sample_df_temp$carbonsource_species_count == 16 & all_sample_df_temp$bacterial_species_count == 2, ]$Type)

infoc <- rbind(c1, c2, c4, c8, c16)
infoc <- subset(infoc, !is.na(infoc$Type))
infoc <- transform(infoc, env = factor(env, levels = c("1", "2", "4", "8", "16")))

envc <- c("1", "2", "4", "8", "16")
infoc <- transform(infoc, Type = factor(Type, levels = info$interaction_types_list))
count <- data.frame()
for (i in 6:1) {
  for (j in 1:5) {
    temp <- infoc[infoc$env == envc[j], ]
    count <- rbind(count, data.frame(env = envc[j],
                                     count1 = length(temp[temp$Type == info$interaction_types_list[i], ]$Type),
                                     Type = info$interaction_types_list[i]))
  }
}
countDF <- data.frame()
for (j in 1:5) {
  tempcount <- data.frame(fcs_file = 1:6)
  c <- c()
  c1 <- c()
  for (i in 1:6) {
    temp <- count[count$env == envc[j], ]
    ratio <- temp$count1[i] / sum(temp$count1)
    c <- c(c, if (round(ratio) < 0.1) {
      paste(" ", format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    } else {
      paste(format(round(ratio * 100, 1), nsmall = 1), "%", sep = "")
    })
    c1 <- c(c1, ratio)
  }
  env1 <- rep(envc[j], 6)
  Type <- info$interaction_types_list[6:1]
  tempcount <- cbind(tempcount, env1, Type, c, c1)
  tempcount <- ddply(tempcount, .(env1), transform, pos = cumsum(c1) - (0.5 * c1))
  countDF <- rbind(countDF, tempcount)
}
countDF <- subset(countDF, c1 != 0)
countDF <- transform(countDF, Type = factor(Type, levels = info$interaction_types_list))
countDF <- transform(countDF, env1 = factor(env1, levels = c("1", "2", "4", "8", "16")))

gbar <- ggplot(data = countDF, mapping = aes(x = as.factor(env1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.8) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.25, 0.5, 0.75, 1), expand = c(0.05, 0.05)) +
  scale_fill_manual(values = c(color_interaction$mutualism,
                               color_interaction$commensalism,
                               color_interaction$parasitism,
                               color_interaction$amensalism,
                               color_interaction$competition,
                               color_interaction$neutral)) +
  theme(title = element_blank(),
        axis.text = element_text(size = 10),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())

panel.blank <- ggplot() +
  geom_point(aes(1, 1), colour = "white") +
  theme(plot.background = element_rect(colour = "white"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

layout1 <- rbind(c(1, 1, 2, 3, 4, 5, 7),
                 c(8, 6, 6, 6, 6, 6, 7))

g <- gridExtra::grid.arrange(
  g1 + theme_pubr() + theme(axis.title.x = element_blank(),
                            axis.title.y = element_blank(),
                            legend.position = "none",
                            title = element_blank(),
                            axis.text = element_blank(),
                            plot.margin = margin(t = 11.1, r = 9.1, b = 14, l = 42, unit = "pt"),
                            axis.line = element_line(size = 0.5, lineend = "square", color = "grey20"),
                            axis.ticks = element_line(size = 0.5, lineend = "square", color = "grey20"),
                            axis.line.y = element_blank(),
                            axis.ticks.y = element_blank()),
  g2 + theme_void() + theme(axis.title.x = element_blank(),
                             axis.title.y = element_blank(),
                             legend.position = "none",
                             title = element_blank(),
                             plot.margin = margin(t = 13, r = 9, b = 13, l = 0, unit = "pt")),
  g4 + theme_void() + theme(axis.title.x = element_blank(),
                             axis.title.y = element_blank(),
                             legend.position = "none",
                             title = element_blank(),
                             plot.margin = margin(t = 11.03, r = 9, b = 11.03, l = 0, unit = "pt")),
  g8 + theme_void() + theme(axis.title.x = element_blank(),
                             axis.title.y = element_blank(),
                             legend.position = "none",
                             title = element_blank(),
                             plot.margin = margin(t = 6.83, r = 9, b = 6.83, l = 0, unit = "pt")),
  g16 + theme_void() + theme(axis.title.x = element_blank(),
                              axis.title.y = element_blank(),
                              legend.position = "none",
                              title = element_blank(),
                              plot.margin = margin(t = 0, r = 9, b = 0, l = 0, unit = "pt")),
  gbar + theme_pubr() + scale_y_continuous(labels = scales::percent,
                                           breaks = c(0, 0.5, 1), expand = c(0, 0)) +
    theme(axis.text.x = element_text(size = 8),
          axis.title.x = element_blank(),
          axis.text.y = element_text(size = 8),
          axis.title.y = element_blank(),
          legend.position = "none",
          title = element_blank(),
          plot.margin = margin(t = 0, r = 0, b = 50, l = 0, unit = "pt"),
          axis.line = element_line(size = 0.5, lineend = "square", color = "grey20"),
          axis.ticks = element_line(size = 0.5, lineend = "square", color = "grey20")),
  panel.blank, panel.blank,
  layout_matrix = layout1,
  widths = c(0.59, 4.65, 2.6, 2.6, 2.6, 2.6, 15),
  heights = c(3, 2)
)
plot(g)

ggsave("Fig3A_ALLtile.pdf", plot = g)

```

## Fig.3B
```{r}
thetaplot_df <- data.frame()
for (i in 1:28) {
  for (j in 1:32) {
    temp <- all_sample_df[
      all_sample_df$experiment == "main" &
      all_sample_df$bacterial_species_count == 2 &
      all_sample_df$bacteria == info$coculture_bacteria_list[i] &
      all_sample_df$environment == info$environment_list[j], 
    ]
    thetaplot_df <- rbind(
      thetaplot_df,
      data.frame(
        bacteria = info$coculture_bacteria_list[i],
        environment = info$environment_list[j],
        carbonsource_species_count = as.numeric(temp$carbonsource_species_count)[1],
        bacterial_species_count = as.numeric(temp$bacterial_species_count)[1],
        x_value = as.numeric(temp$x_value)[1],
        x_sd = as.numeric(temp$x_sd)[1],
        y_value = as.numeric(temp$y_value)[1],
        y_sd = as.numeric(temp$y_sd)[1],
        theta_value = as.numeric(temp$theta_value)[1],
        Type = temp$Type[1],
        plot_hierarchy = temp$plot_hierarchy[1]
      )
    )
  }
}

all_sample_df_temp <- thetaplot_df

c1 <- data.frame(
  env = "1",
  theta = as.numeric(all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 1 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$theta_value),
  strain = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 1 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$bacteria,
  Type = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 1 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$Type
)

c2 <- data.frame(
  env = "2",
  theta = as.numeric(all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 2 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$theta_value),
  strain = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 2 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$bacteria,
  Type = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 2 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$Type
)

c4 <- data.frame(
  env = "4",
  theta = as.numeric(all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 4 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$theta_value),
  strain = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 4 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$bacteria,
  Type = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 4 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$Type
)

c8 <- data.frame(
  env = "8",
  theta = as.numeric(all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 8 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$theta_value),
  strain = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 8 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$bacteria,
  Type = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 8 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$Type
)

c16 <- data.frame(
  env = "16",
  theta = as.numeric(all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 16 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$theta_value),
  strain = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 16 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$bacteria,
  Type = all_sample_df_temp[
    all_sample_df_temp$carbonsource_species_count == 16 & 
    all_sample_df_temp$bacterial_species_count == 2, 
  ]$Type
)

infoc <- rbind(c1, c2, c4, c8, c16)
infoc <- transform(infoc, env = factor(env, levels = c("1", "2", "4", "8", "16")))

g <- ggplot(data = infoc, aes(x = as.factor(env), y = theta)) +
  scale_y_continuous(limits = c(-90, 90), breaks = c(-90, -45, 0, 45, 90), expand = c(0, 0)) +
  geom_point(shape = 21, size = 0.4, stroke = 0.2, alpha = 0.3, position = position_jitter(0.4)) +
  geom_violin(fill = NA, color = "grey10") +
  stat_summary(fun = mean, geom = "point", shape = 3, size = 1.8, color = "red") +
  theme_minimal() +
  theme(
    plot.margin = margin(t = 230, r = 290, b = 0, l = 0, unit = "pt"),
    axis.text.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    axis.title = element_blank(),
    axis.line = element_line(size = 0.5, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.5, lineend = "square", color = "grey20")
  )
plot(g)
ggsave("Fig3B_envtheta_violin.pdf", g)

infoc2 <- infoc
infoc2$env <- as.numeric(infoc2$env)
n <- data.frame(n = as.numeric(rank(infoc2$env, ties.method = "average")))
infoc2 <- cbind(infoc2, n)
nt <- data.frame(nt = as.numeric(rank(infoc2$theta, ties.method = "average")))
infoc2 <- cbind(infoc2, nt)

coin_corr <- spearman_test(nt ~ n, data = infoc2)
print(pvalue(coin_corr))

log10_p <- log10(pvalue(coin_corr))
cat("log10(p):", log10_p, "\n")
a <- (10^(log10_p + 32))
print(a)
```

## Fig.4A
```{r}
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 1, ]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$experiment == "main", ]

strain_list <- c(info$monoculture_bacteria_list[1],
                 info$monoculture_bacteria_list[3:14],
                 info$monoculture_bacteria_list[16])

logDensityDF <- data.frame()

for (i in 1:32) {
  for (j in 1:14) {
    temp <- all_sample_df_temp[
      all_sample_df_temp$environment == info$environment_list[i] &
      all_sample_df_temp$bacteria == strain_list[j],
    ]
    logDensityDF <- rbind(logDensityDF,
      data.frame(
        env     = temp$environment[1],
        nc      = temp$carbonsource_species_count[1],
        species = temp$monoculture_bacteria[1],
        strain  = temp$bacteria[1],
        med     = log(mean(as.numeric(temp$target_fluorescent_cells_density)), 10)
      )
    )
  }
}

KResult <- data.frame()

for (i in 1:8) {
  c1   <- logDensityDF[logDensityDF$species == info$bacteria_list[i], ]$strain
  c11  <- logDensityDF[logDensityDF$species == info$bacteria_list[i], ]$species
  c2   <- logDensityDF[logDensityDF$species == info$bacteria_list[i], ]$med
  c3   <- logDensityDF[logDensityDF$species == info$bacteria_list[i], ]$env
  nc   <- logDensityDF[logDensityDF$species == info$bacteria_list[i], ]$nc
  part1 <- data.frame(target_fluorescent_cells_density = c2)
  distance <- dist(part1)
  hc <- hclust(distance, method = "ward.D2")
  plot(hc)
  hcresult <- cutree(hc, k = 2)
  result <- data.frame(
    target_fluorescent_cells_density = part1$target_fluorescent_cells_density,
    monoculture_bacteria = c1,
    species = c11,
    hc = hcresult,
    env = c3,
    nc = nc
  )
  KResult <- rbind(KResult, result)
}

KResult[KResult$monoculture_bacteria == "AgT_GFP" & KResult$hc == 1, ]$hc <- 3
KResult[KResult$monoculture_bacteria == "AgT_GFP" & KResult$hc == 2, ]$hc <- 1
KResult[KResult$monoculture_bacteria == "AgT_GFP" & KResult$hc == 3, ]$hc <- 2

KResult[KResult$monoculture_bacteria == "SpP_GFP Tn5" & KResult$hc == 1, ]$hc <- 3
KResult[KResult$monoculture_bacteria == "SpP_GFP Tn5" & KResult$hc == 2, ]$hc <- 1
KResult[KResult$monoculture_bacteria == "SpP_GFP Tn5" & KResult$hc == 3, ]$hc <- 2

KResult[KResult$monoculture_bacteria == "SpP_mScarlet" & KResult$hc == 1, ]$hc <- 3
KResult[KResult$monoculture_bacteria == "SpP_mScarlet" & KResult$hc == 2, ]$hc <- 1
KResult[KResult$monoculture_bacteria == "SpP_mScarlet" & KResult$hc == 3, ]$hc <- 2

EasyHard <- data.frame()

for (i in 1:length(all_sample_df$fcs_file)) {
  if (all_sample_df$coculture_species_GFP[i] != "monoculture") {
    greenHD <- KResult[
      KResult$env == all_sample_df$environment[i] &
      (KResult$monoculture_bacteria == paste(all_sample_df$coculture_species_GFP[i], "_GFP", sep = "") |
       KResult$monoculture_bacteria == paste(all_sample_df$coculture_species_GFP[i], "_GFP Tn5", sep = "")),
    ]$hc[1]
  } else {
    greenHD <- "mono"
  }
  
  if (all_sample_df$coculture_species_mScarlet[i] != "monoculture") {
    redHD <- KResult[
      KResult$env == all_sample_df$environment[i] &
      (KResult$monoculture_bacteria == paste(all_sample_df$coculture_species_mScarlet[i], "_mScarlet", sep = "") |
       KResult$monoculture_bacteria == paste(all_sample_df$coculture_species_mScarlet[i], "_mScarlet Tn5", sep = "")),
    ]$hc[1]
  } else {
    redHD <- "mono"
  }
  
  EasyHard <- rbind(EasyHard, data.frame(greenHD = greenHD, redHD = redHD))
}

all_sample_df$greenHD <- EasyHard$greenHD
all_sample_df$redHD <- EasyHard$redHD


growth_spe1 <- data.frame()

growth_spe <- data.frame()
for (j in 1:16) {
  tempBE <- KResult[KResult$env == info$environment_list[j], ]
  growth_spe <- rbind(growth_spe, tempBE)
  tempBE <- cbind(tempBE, data.frame(c = 1))
  growth_spe1 <- rbind(growth_spe1, tempBE)
}
growth_spe <- transform(growth_spe,
                        monoculture_bacteria = factor(monoculture_bacteria,
                                                      levels = info$strain_list_phylogenetic[1:14]))
growth_spe <- transform(growth_spe,
                        env = factor(env, levels = info$environment_list[16:1]))
g1 <- ggplot() +
  geom_tile(data = growth_spe,
            mapping = aes(x = env, y = monoculture_bacteria, fill = as.factor(hc)),
            width = 0.75) +
  scale_fill_manual(values = c("#c450a0", "#4fc474")) +
  scale_x_discrete(guide = guide_axis(angle = 90), position = "top") +
  coord_flip() +
  theme_minimal()

growth_spe <- data.frame()
for (j in 17:24) {
  tempBE <- KResult[KResult$env == info$environment_list[j], ]
  growth_spe <- rbind(growth_spe, tempBE)
  tempBE <- cbind(tempBE, data.frame(c = 2))
  growth_spe1 <- rbind(growth_spe1, tempBE)
}
growth_spe <- transform(growth_spe,
                        monoculture_bacteria = factor(monoculture_bacteria,
                                                      levels = info$strain_list_phylogenetic[1:14]))
growth_spe <- transform(growth_spe,
                        env = factor(env, levels = info$environment_list[24:17]))
g2 <- ggplot() +
  geom_tile(data = growth_spe,
            mapping = aes(x = env, y = monoculture_bacteria, fill = as.factor(hc)),
            width = 0.75) +
  scale_fill_manual(values = c("#c450a0", "#4fc474")) +
  scale_x_discrete(guide = guide_axis(angle = 90), position = "top") +
  coord_flip() +
  theme_minimal()

growth_spe <- data.frame()
for (j in 25:28) {
  tempBE <- KResult[KResult$env == info$environment_list[j], ]
  growth_spe <- rbind(growth_spe, tempBE)
  tempBE <- cbind(tempBE, data.frame(c = 4))
  growth_spe1 <- rbind(growth_spe1, tempBE)
}
growth_spe <- transform(growth_spe,
                        monoculture_bacteria = factor(monoculture_bacteria,
                                                      levels = info$strain_list_phylogenetic[1:14]))
growth_spe <- transform(growth_spe,
                        env = factor(env, levels = info$environment_list[28:25]))
g4 <- ggplot() +
  geom_tile(data = growth_spe,
            mapping = aes(x = env, y = monoculture_bacteria, fill = as.factor(hc)),
            width = 0.75) +
  scale_fill_manual(values = c("#c450a0", "#4fc474")) +
  scale_x_discrete(guide = guide_axis(angle = 90), position = "top") +
  coord_flip() +
  theme_minimal()

growth_spe <- data.frame()
for (j in 29:30) {
  tempBE <- KResult[KResult$env == info$environment_list[j], ]
  growth_spe <- rbind(growth_spe, tempBE)
  tempBE <- cbind(tempBE, data.frame(c = 8))
  growth_spe1 <- rbind(growth_spe1, tempBE)
}
growth_spe <- transform(growth_spe,
                        monoculture_bacteria = factor(monoculture_bacteria,
                                                      levels = info$strain_list_phylogenetic[1:14]))
growth_spe <- transform(growth_spe,
                        env = factor(env, levels = info$environment_list[30:29]))
g8 <- ggplot() +
  geom_tile(data = growth_spe,
            mapping = aes(x = env, y = monoculture_bacteria, fill = as.factor(hc)),
            width = 0.75) +
  scale_fill_manual(values = c("#c450a0", "#4fc474")) +
  scale_x_discrete(guide = guide_axis(angle = 90), position = "top") +
  coord_flip() +
  theme_minimal()

growth_spe <- data.frame()
for (j in 31:31) {
  tempBE <- KResult[KResult$env == info$environment_list[j], ]
  growth_spe <- rbind(growth_spe, tempBE)
  tempBE <- cbind(tempBE, data.frame(c = 16))
  growth_spe1 <- rbind(growth_spe1, tempBE)
}
growth_spe <- transform(growth_spe,
                        monoculture_bacteria = factor(monoculture_bacteria,
                                                      levels = info$strain_list_phylogenetic[1:14]))
growth_spe <- transform(growth_spe,
                        env = factor(env, levels = info$environment_list[31:31]))
g16 <- ggplot() +
  geom_tile(data = growth_spe,
            mapping = aes(x = env, y = monoculture_bacteria, fill = as.factor(hc)),
            width = 0.75) +
  scale_fill_manual(values = c("#c450a0", "#4fc474")) +
  scale_x_discrete(guide = guide_axis(angle = 90), position = "top") +
  coord_flip() +
  theme_minimal()

par <- data.frame()
for (i in c(1, 2, 4, 8, 16)) {
  temp <- growth_spe1[growth_spe1$c == i, ]
  par <- rbind(par,
               data.frame(num = i,
                          percentage = length(temp[temp$hc == 1, ]$c) / length(temp$c),
                          den = 1))
  par <- rbind(par,
               data.frame(num = i,
                          percentage = length(temp[temp$hc == 2, ]$c) / length(temp$c),
                          den = 2))
}

yaxis1 <- c(0, 1)
yaxis2 <- c(6, 10)

variable_scaler <- function(y2, yaxis1, yaxis2) {
  a <- (yaxis1[2] - yaxis1[1]) / (yaxis2[2] - yaxis2[1])
  b <- (yaxis1[1] * yaxis2[2] - yaxis1[2] * yaxis2[1]) / (yaxis2[2] - yaxis2[1])
  a * y2 + b
}

axis_scaler <- function(y1, yaxis1, yaxis2) {
  c_val <- (yaxis2[2] - yaxis2[1]) / (yaxis1[2] - yaxis1[1])
  d <- (yaxis2[1] * yaxis1[2] - yaxis2[2] * yaxis1[1]) / (yaxis1[2] - yaxis1[1])
  c_val * y1 + d
}

par <- transform(par, den = factor(den, levels = c(2, 1)))
par <- transform(par, num = factor(num, levels = c(1, 2, 4, 8, 16)))
gbar <- ggplot() +
  geom_bar(data = par,
           mapping = aes(x = as.factor(num), y = percentage, fill = as.factor(den)),
           stat = "identity",
           position = "fill",
           width = 0.8) +
  scale_fill_manual(values = c("#F6995C", "#51829B")) +
  scale_y_continuous(labels = scales::percent,
                     breaks = c(0, 0.5, 1),
                     expand = c(0.05, 0.05))

panel.blank <- ggplot() +
  geom_point(aes(1, 1), colour = "white") +
  theme(plot.background = element_rect(colour = "white"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

layout1 <- rbind(c(1, 1, 2, 3, 4, 5, 7),
                 c(8, 6, 6, 6, 6, 6, 7))
g <- gridExtra::grid.arrange(
  g1 + theme_pubr() +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          legend.position = "none",
          title = element_blank(),
          axis.text = element_blank(),
          plot.margin = margin(t = 11.1, r = 9.1, b = 14, l = 42, unit = "pt"),
          axis.line = element_line(size = 0.5, lineend = "square", color = "grey20"),
          axis.ticks = element_line(size = 0.5, lineend = "square", color = "grey20"),
          axis.line.y = element_blank(),
          axis.ticks.y = element_blank()),
  g2 + theme_void() +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          legend.position = "none",
          title = element_blank(),
          plot.margin = margin(t = 13, r = 9, b = 13, l = 0, unit = "pt")),
  g4 + theme_void() +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          legend.position = "none",
          title = element_blank(),
          plot.margin = margin(t = 11.03, r = 9, b = 11.03, l = 0, unit = "pt")),
  g8 + theme_void() +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          legend.position = "none",
          title = element_blank(),
          plot.margin = margin(t = 6.83, r = 9, b = 6.83, l = 0, unit = "pt")),
  g16 + theme_void() +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          legend.position = "none",
          title = element_blank(),
          plot.margin = margin(t = 0, r = 9, b = 0, l = 0, unit = "pt")),
  gbar + theme_pubr() +
    scale_y_continuous(labels = scales::percent,
                       breaks = c(0, 0.5, 1),
                       expand = c(0, 0)) +
    theme(axis.text.x = element_text(size = 8),
          axis.title.x = element_blank(),
          axis.text.y = element_text(size = 8),
          axis.title.y = element_blank(),
          legend.position = "none",
          title = element_blank(),
          plot.margin = margin(t = 0, r = 0, b = 50, l = 0, unit = "pt"),
          axis.line = element_line(size = 0.5, lineend = "square", color = "grey20"),
          axis.ticks = element_line(size = 0.5, lineend = "square", color = "grey20")),
  panel.blank,
  panel.blank,
  layout_matrix = layout1,
  widths = c(0.59, 4.65, 2.6, 2.6, 2.6, 2.6, 15),
  heights = c(3, 2))
plot(g)

ggsave(file = paste("Fig4A_", "EHbar.pdf"), plot = g)
ggsave(file = paste("all_", "cell_density_tile_for_legend.png"), plot = g1)
ggsave(file = paste("Fig4A_", "for_legend.pdf"), plot = gbar)

```

## Fig.4B
```{r}
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 2, ]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$experiment == "main", ]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$environment != "water", ]

EE <- all_sample_df_temp[all_sample_df_temp$greenHD == "2" & all_sample_df_temp$redHD == "2", ]
temp <- data.frame()

for (i in 1:6) {
  tempEH <- EE[EE$Type == info$interaction_types_list[i], ]
  for (j in c(1, 2, 4, 8, 16)) {
    tempEHc <- tempEH[tempEH$carbonsource_species_count == j, ]
    temp <- rbind(
      temp,
      data.frame(
        carbonsource_species_count = j,
        Type = info$interaction_types_list[i],
        count = length(tempEHc$fcs_file)
      )
    )
  }
}

EE <- temp
EE <- transform(EE, Type = factor(Type, levels = info$interaction_types_list))
EE <- transform(EE, carbonsource_species_count = factor(carbonsource_species_count, levels = c("1", "2", "4", "8", "16")))

g <- ggplot(data = EE) +
  geom_histogram(mapping = aes(x = carbonsource_species_count, y = count / 3, fill = Type),
                 position = "stack", stat = "identity", width = 0.8) +
  scale_y_continuous(limits = c(0, 350), breaks = c(0, 100, 200, 300), expand = c(0, 0)) +
  theme_minimal() +
  theme(
    axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_text(size = 15),
    plot.margin = margin(t = 150, r = 330, b = 0, l = 0, unit = "pt")
  ) +
  scale_fill_manual(values = c(
    color_interaction$mutualism,
    color_interaction$commensalism,
    color_interaction$parasitism,
    color_interaction$amensalism,
    color_interaction$competition,
    color_interaction$neutral
  ))
g
ggsave(file = "Fig4B_EE.pdf", plot = g)

EH_HH <- all_sample_df_temp[
  (all_sample_df_temp$greenHD == "1" & all_sample_df_temp$redHD == "1") |
    (all_sample_df_temp$greenHD == "2" & all_sample_df_temp$redHD == "1") |
    (all_sample_df_temp$greenHD == "1" & all_sample_df_temp$redHD == "2"),
]
temp <- data.frame()

for (i in 1:6) {
  tempEH <- EH_HH[EH_HH$Type == info$interaction_types_list[i], ]
  for (j in c(1, 2, 4, 8, 16)) {
    tempEHc <- tempEH[tempEH$carbonsource_species_count == j, ]
    temp <- rbind(
      temp,
      data.frame(
        carbonsource_species_count = j,
        Type = info$interaction_types_list[i],
        count = length(tempEHc$fcs_file)
      )
    )
  }
}

EH_HH <- temp
EH_HH <- transform(EH_HH, Type = factor(Type, levels = info$interaction_types_list))
EH_HH <- transform(EH_HH, carbonsource_species_count = factor(carbonsource_species_count, levels = c("1", "2", "4", "8", "16")))

g <- ggplot(data = EH_HH) +
  geom_histogram(mapping = aes(x = carbonsource_species_count, y = count / 3, fill = Type),
                 position = "stack", stat = "identity", width = 0.8) +
  scale_y_continuous(limits = c(0, 350), breaks = c(0, 100, 200, 300), expand = c(0, 0)) +
  theme_minimal() +
  theme(
    axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
    axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_text(size = 15),
    plot.margin = margin(t = 150, r = 330, b = 0, l = 0, unit = "pt")
  ) +
  scale_fill_manual(values = c(
    color_interaction$mutualism,
    color_interaction$commensalism,
    color_interaction$parasitism,
    color_interaction$amensalism,
    color_interaction$competition,
    color_interaction$neutral
  ))
g
ggsave(file = "Fig4B_H.pdf", plot = g)
```

## Fig.5, FigS12
```{r}
all_sample_df_temp <- all_sample_df[all_sample_df$bacterial_species_count == 1, ]
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$experiment == "main", ]
strain_list <- c(info$monoculture_bacteria_list[1],
                 info$monoculture_bacteria_list[3:14],
                 info$monoculture_bacteria_list[16])

mix2ave2 <- data.frame()
for (i in 17:24) {
  tempE2 <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1  <- all_sample_df_temp[all_sample_df_temp$environment == tempE2$carbonsource_mixed_pair1[1], ]
  temp2  <- all_sample_df_temp[all_sample_df_temp$environment == tempE2$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    temp1B <- temp1[temp1$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2B <- temp2[temp2$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    cmono  <- c(temp1B, temp2B)
    ave12  <- mean(cmono)
    sdmean <- mean(c(var(temp1B), var(temp2B)))^0.5
    tempY  <- c(ave12 - sdmean, ave12, ave12 + sdmean)
    
    tempEBc <- tempE2[tempE2$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2ave2 <- rbind(mix2ave2,
          data.frame(
            envbac  = paste(info$environment_list[i], strain_list[j]),
            env     = info$environment_list[i],
            bacteria= strain_list[j],
            ave12   = ave12,
            sdx     = sdmean,
            sdy     = sd(tempEBc),
            value   = tempEBc[k],
            pvalue  = ptemp
          )
        )
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),
                  paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for (k in 1:length(tempEBc)) {
        mix2ave2 <- rbind(mix2ave2,
          data.frame(
            envbac  = paste(info$environment_list[i], strain_list[j]),
            env     = info$environment_list[i],
            bacteria= strain_list[j],
            ave12   = ave12,
            sdx     = sdmean,
            sdy     = sd(tempEBc),
            value   = tempEBc[k],
            pvalue  = t$p.value
          )
        )
      }
    }
  }
}

qvalue   <- p.adjust(mix2ave2$pvalue, method = "BH")
mix2ave2 <- cbind(mix2ave2, qvalue)

medDF2 <- data.frame()
for (i in 17:24) {
  for (j in 1:14) {
    temp <- mix2ave2[(mix2ave2$env == info$environment_list[i]) &
                     (mix2ave2$bacteria == strain_list[j]), ]
    medDF2 <- rbind(medDF2,
      data.frame(
        envbac = paste(info$environment_list[i], strain_list[j]),
        ave12  = temp$ave12[1],
        med    = mean(temp$value),
        sdx    = temp$sdx[1],
        sdy    = temp$sdy[1],
        p      = if (temp$qvalue[1] < 0.05) 1 else 0,
        pp     = if ((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1])) {
                   "high"
                 } else if ((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1])) {
                   "low"
                 } else {
                   "same"
                 }
      )
    )
  }
}

temphigh <- 0
tempsame <- 0
templow  <- 0
for (i in 1:length(medDF2$envbac)) {
  if (medDF2$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (medDF2$ave12[i] > medDF2$med[i]) {
      templow <- templow + 1
    } else if (medDF2$ave12[i] < medDF2$med[i]) {
      temphigh <- temphigh + 1
    }
  }
}

judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)
c      <- c()
c1     <- c()
for (k in 1:3) {
  c[k]  <- if (count$count1[k] / sum(count$count1) < 0.1) {
             paste(" ", format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
           } else {
             paste(format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
           }
  c1[k] <- count$count1[k] / sum(count$count1)
}
count <- cbind(count, c, c1)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                 "grey70",
                                 rgb(red = 58, green = 184, blue = 153, maxColorValue = 255)))
g
ggsave(file = paste("Fig5A_", "carbonmix_prediction_1to2_bar.pdf"), plot = g)

mix2ave2 <- transform(mix2ave2, bacteria = factor(bacteria, levels = strain_list))
df1 <- data.frame(x1 = 1000000, y1 = 1000000, x2 = 100000000000, y2 = 100000000000)
g <- ggplot(mix2ave2, aes(x = ave12, y = value, color = bacteria)) +
  geom_point(size = 2.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2), color = "black",
               data = df1, linewidth = 0.75, linetype = "dotted") +
  scale_x_continuous(trans = "log10", limits = c(5000000, 200000000000)) +
  scale_y_continuous(trans = "log10", limits = c(5000000, 200000000000)) +
  labs(x = "Mean prediction (cells / mL)",
       y = "Observed (cells / mL)",
       title = paste("1->2 high", temphigh, "same", tempsame, "low", templow)) +
  theme(legend.position = "none")
g

medDF2 <- transform(medDF2, pp = factor(pp, levels = c("high", "same", "low")))
df1 <- data.frame(x1 = 100000, y1 = 100000, x2 = 10000000000, y2 = 10000000000)
g <- ggplot(medDF2, aes(x = ave12, y = med, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2), color = "grey20",
               data = df1, linewidth = 0.75, linetype = "dotted") +
  geom_point(size = 1.5) +
  scale_x_continuous(trans = "log10", limits = c(100000, 10000000000), expand = c(0, 0)) +
  scale_y_continuous(trans = "log10", limits = c(100000, 10000000000), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                  "grey70",
                                  rgb(red = 58, green = 184, blue = 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for (i in 1:length(medDF2$envbac)) {
  temp     <- medDF2[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$med,
                          x2 = temp$ave12 + temp$sdx, y2 = temp$med)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$med - temp$sdy,
                          x2 = temp$ave12, y2 = temp$med + temp$sdy)
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFx,
                        linewidth = 0.2, linetype = "solid")
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFy,
                        linewidth = 0.2, linetype = "solid")
}
g
ggsave(file = paste("Fig5A_carbonmix_prediction_1to2.pdf"), plot = g)

g <- ggplot(medDF2, aes(x = "1", y = med / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 0.75, alpha = 0.5, fill = NA,
               binwidth = 0.15, stackdir = "center", color = "black") +
  scale_y_continuous(trans = "log10", limits = c(0.01, 1000), expand = c(0, 0)) +
  labs(y = "Observed/Prediction") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = paste("FigS13_carbonmix_prediction_1to2.pdf"), plot = g)




















mix2Ave <- data.frame()
for (i in 25:28) {
  tempE   <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]
  temp11  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1], ]
  temp12  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1], ]
  temp21  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1], ]
  temp22  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    temp11B <- temp11[temp11$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp12B <- temp12[temp12$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp21B <- temp21[temp21$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp22B <- temp22[temp22$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    
    cvals  <- c(temp11B, temp12B, temp21B, temp22B)
    ave12  <- mean(cvals)
    sdmean <- mean(c(var(temp11B), var(temp12B), var(temp21B), var(temp22B)))^0.5
    tempY  <- c(ave12 - sdmean, ave12, ave12 + sdmean)
    
    tempEBc <- tempE[tempE$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave,
          data.frame(
            envbac   = paste(info$environment_list[i], strain_list[j]),
            env      = info$environment_list[i],
            bacteria = strain_list[j],
            ave12    = ave12,
            sdx      = sdmean,
            sdy      = sd(tempEBc),
            value    = tempEBc[k],
            pvalue   = ptemp
          )
        )
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),
                  paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave,
          data.frame(
            envbac   = paste(info$environment_list[i], strain_list[j]),
            env      = info$environment_list[i],
            bacteria = strain_list[j],
            ave12    = ave12,
            sdx      = sdmean,
            sdy      = sd(tempEBc),
            value    = tempEBc[k],
            pvalue   = t$p.value
          )
        )
      }
    }
  }
}

qvalue   <- p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave <- cbind(mix2Ave, qvalue)

medDF <- data.frame()
for (i in 25:28) {
  for (j in 1:14) {
    temp <- mix2Ave[(mix2Ave$env == info$environment_list[i]) &
                    (mix2Ave$bacteria == strain_list[j]), ]
    medDF <- rbind(medDF,
      data.frame(
        envbac = paste(info$environment_list[i], strain_list[j]),
        ave12  = temp$ave12[1],
        med    = mean(temp$value),
        sdx    = temp$sdx[1],
        sdy    = temp$sdy[1],
        p      = if (temp$qvalue[1] < 0.05) 1 else 0,
        pp     = if ((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1])) {
                   "high"
                 } else if ((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1])) {
                   "low"
                 } else {
                   "same"
                 }
      )
    )
  }
}

temphigh <- 0
tempsame <- 0
templow  <- 0
for (i in 1:length(medDF$envbac)) {
  if (medDF$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (medDF$ave12[i] > medDF$med[i]) {
      templow <- templow + 1
    } else if (medDF$ave12[i] < medDF$med[i]) {
      temphigh <- temphigh + 1
    }
  }
}

judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)
c      <- c()
c1     <- c()
for (k in 1:3) {
  c[k]  <- if (count$count1[k] / sum(count$count1) < 0.1) {
             paste(" ", format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
           } else {
             paste(format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
           }
  c1[k] <- count$count1[k] / sum(count$count1)
}
count <- cbind(count, c, c1)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                 "grey70",
                                 rgb(red = 58, green = 184, blue = 153, maxColorValue = 255)))
g
ggsave(file = paste("Fig5B__", "carbonmix_prediction_1to4_bar.pdf"), plot = g)

mix2Ave <- transform(mix2Ave, bacteria = factor(bacteria, levels = strain_list))
df1      <- data.frame(x1 = 1000000, y1 = 1000000, x2 = 100000000000, y2 = 100000000000)
g <- ggplot(mix2Ave, aes(x = ave12, y = value, color = bacteria)) +
  geom_point(size = 2.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "black", data = df1, linewidth = 0.75, linetype = "dotted") +
  scale_x_continuous(trans = "log10", limits = c(5000000, 200000000000)) +
  scale_y_continuous(trans = "log10", limits = c(5000000, 200000000000)) +
  labs(x = "Mean prediction (cells / mL)",
       y = "Observed (cells / mL)",
       title = paste("1->2 high", temphigh, "same", tempsame, "low", templow)) +
  theme(legend.position = "none")
g

medDF <- transform(medDF, pp = factor(pp, levels = c("high", "same", "low")))
df1   <- data.frame(x1 = 100000, y1 = 100000, x2 = 10000000000, y2 = 10000000000)
g <- ggplot(medDF, aes(x = ave12, y = med, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey20", data = df1, linewidth = 0.75, linetype = "dotted") +
  geom_point(size = 1.5) +
  scale_x_continuous(trans = "log10", limits = c(100000, 10000000000), expand = c(0, 0)) +
  scale_y_continuous(trans = "log10", limits = c(100000, 10000000000), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                  "grey70",
                                  rgb(red = 58, green = 184, blue = 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for (i in 1:length(medDF$envbac)) {
  temp     <- medDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$med,
                          x2 = temp$ave12 + temp$sdx, y2 = temp$med)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$med - temp$sdy,
                          x2 = temp$ave12, y2 = temp$med + temp$sdy)
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFx,
                        linewidth = 0.2, linetype = "solid")
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFy,
                        linewidth = 0.2, linetype = "solid")
}
g
ggsave(file = paste("Fig5B_carbonmix_prediction_1to4.pdf"), plot = g)

g <- ggplot(medDF, aes(x = "1", y = med / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 0.75, alpha = 0.5, fill = NA,
               binwidth = 0.15, stackdir = "center", color = "black") +
  scale_y_continuous(trans = "log10", limits = c(0.01, 1000), expand = c(0, 0)) +
  labs(y = "Observed/Prediction") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = paste("FigS13_carbonmix_prediction_1to4.pdf"), plot = g)








mix2Ave <- data.frame()
for (i in 29:30) {
  tempE   <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]
  temp11  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1], ]
  temp12  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1], ]
  temp21  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1], ]
  temp22  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1], ]
  temp111 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair1[1], ]
  temp112 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair2[1], ]
  temp121 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair1[1], ]
  temp122 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair2[1], ]
  temp211 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair1[1], ]
  temp212 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair2[1], ]
  temp221 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair1[1], ]
  temp222 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    temp111B <- temp111[temp111$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp112B <- temp112[temp112$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp121B <- temp121[temp121$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp122B <- temp122[temp122$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp211B <- temp211[temp211$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp212B <- temp212[temp212$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp221B <- temp221[temp221$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp222B <- temp222[temp222$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    
    cvals  <- c(temp111B, temp112B, temp121B, temp122B,
                temp211B, temp212B, temp221B, temp222B)
    ave12  <- mean(cvals)
    sdmean <- mean(c(var(temp111B), var(temp112B), var(temp121B), var(temp122B),
                     var(temp211B), var(temp212B), var(temp221B), var(temp222B)))^0.5
    tempY  <- c(ave12 - sdmean, ave12, ave12 + sdmean)
    
    tempEBc <- tempE[tempE$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = ptemp
        ))
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),
                  paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = t$p.value
        ))
      }
    }
  }
}

qvalue  <- p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave <- cbind(mix2Ave, qvalue)

medDF <- data.frame()
for (i in 29:30) {
  for (j in 1:14) {
    temp <- mix2Ave[(mix2Ave$env == info$environment_list[i]) &
                    (mix2Ave$bacteria == strain_list[j]), ]
    medDF <- rbind(medDF, data.frame(
      envbac = paste(info$environment_list[i], strain_list[j]),
      ave12  = temp$ave12[1],
      med    = mean(temp$value),
      sdx    = temp$sdx[1],
      sdy    = temp$sdy[1],
      p      = if (temp$qvalue[1] < 0.05) 1 else 0,
      pp     = if ((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1])) {
                 "high"
               } else if ((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1])) {
                 "low"
               } else {
                 "same"
               }
    ))
  }
}

temphigh <- 0
tempsame <- 0
templow  <- 0
for (i in 1:length(medDF$envbac)) {
  if (medDF$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (medDF$ave12[i] > medDF$med[i]) {
      templow <- templow + 1
    } else if (medDF$ave12[i] < medDF$med[i]) {
      temphigh <- temphigh + 1
    }
  }
}

judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)
c_vals <- c()
c1_vals <- c()
for (k in 1:3) {
  c_vals[k]  <- if (count$count1[k] / sum(count$count1) < 0.1) {
                  paste(" ", format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                } else {
                  paste(format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                }
  c1_vals[k] <- count$count1[k] / sum(count$count1)
}
count <- cbind(count, c = c_vals, c1 = c1_vals)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                 "grey70",
                                 rgb(red = 58, green = 184, blue = 153, maxColorValue = 255)))
g
ggsave(file = paste("Fig5C_", "carbonmix_prediction_1to8_bar.pdf"), plot = g)

mix2Ave <- transform(mix2Ave, bacteria = factor(bacteria, levels = strain_list))
df1      <- data.frame(x1 = 1000000, y1 = 1000000, x2 = 100000000000, y2 = 100000000000)
g <- ggplot(mix2Ave, aes(x = ave12, y = value, color = bacteria)) +
  geom_point(size = 2.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "black", data = df1, linewidth = 0.75, linetype = "dotted") +
  scale_x_continuous(trans = "log10", limits = c(5000000, 200000000000)) +
  scale_y_continuous(trans = "log10", limits = c(5000000, 200000000000)) +
  labs(x = "Mean prediction (cells / mL)",
       y = "Observed (cells / mL)",
       title = paste("1->2 high", temphigh, "same", tempsame, "low", templow)) +
  theme(legend.position = "none")
g

medDF <- transform(medDF, pp = factor(pp, levels = c("high", "same", "low")))
df1   <- data.frame(x1 = 100000, y1 = 100000, x2 = 10000000000, y2 = 10000000000)
g <- ggplot(medDF, aes(x = ave12, y = med, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey20", data = df1, linewidth = 0.75, linetype = "dotted") +
  geom_point(size = 1.5) +
  scale_x_continuous(trans = "log10", limits = c(100000, 10000000000), expand = c(0, 0)) +
  scale_y_continuous(trans = "log10", limits = c(100000, 10000000000), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                  "grey70",
                                  rgb(red = 58, green = 184, blue = 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for (i in 1:length(medDF$envbac)) {
  temp     <- medDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$med,
                         x2 = temp$ave12 + temp$sdx, y2 = temp$med)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$med - temp$sdy,
                         x2 = temp$ave12, y2 = temp$med + temp$sdy)
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFx,
                        linewidth = 0.2, linetype = "solid")
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFy,
                        linewidth = 0.2, linetype = "solid")
}
g
ggsave(file = paste("Fig5C_carbonmix_prediction_1to8.pdf"), plot = g)

g <- ggplot(medDF, aes(x = "1", y = med / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 0.75, alpha = 0.5, fill = NA,
               binwidth = 0.15, stackdir = "center", color = "black") +
  scale_y_continuous(trans = "log10", limits = c(0.01, 1000), expand = c(0, 0)) +
  labs(y = "Observed/Prediction") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = paste("FigS13_carbonmix_prediction_1to8.pdf"), plot = g)










mix2Ave <- data.frame()
for (i in 31:31) {
  tempE   <- all_sample_df_temp[all_sample_df_temp$environment == info$environment_list[i], ]
  temp1   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair1[1], ]
  temp2   <- all_sample_df_temp[all_sample_df_temp$environment == tempE$carbonsource_mixed_pair2[1], ]
  temp11  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair1[1], ]
  temp12  <- all_sample_df_temp[all_sample_df_temp$environment == temp1$carbonsource_mixed_pair2[1], ]
  temp21  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair1[1], ]
  temp22  <- all_sample_df_temp[all_sample_df_temp$environment == temp2$carbonsource_mixed_pair2[1], ]
  temp111 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair1[1], ]
  temp112 <- all_sample_df_temp[all_sample_df_temp$environment == temp11$carbonsource_mixed_pair2[1], ]
  temp121 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair1[1], ]
  temp122 <- all_sample_df_temp[all_sample_df_temp$environment == temp12$carbonsource_mixed_pair2[1], ]
  temp211 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair1[1], ]
  temp212 <- all_sample_df_temp[all_sample_df_temp$environment == temp21$carbonsource_mixed_pair2[1], ]
  temp221 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair1[1], ]
  temp222 <- all_sample_df_temp[all_sample_df_temp$environment == temp22$carbonsource_mixed_pair2[1], ]
  
  temp1111 <- all_sample_df_temp[all_sample_df_temp$environment == temp111$carbonsource_mixed_pair1[1], ]
  temp1112 <- all_sample_df_temp[all_sample_df_temp$environment == temp111$carbonsource_mixed_pair2[1], ]
  temp1121 <- all_sample_df_temp[all_sample_df_temp$environment == temp112$carbonsource_mixed_pair1[1], ]
  temp1122 <- all_sample_df_temp[all_sample_df_temp$environment == temp112$carbonsource_mixed_pair2[1], ]
  temp1211 <- all_sample_df_temp[all_sample_df_temp$environment == temp121$carbonsource_mixed_pair1[1], ]
  temp1212 <- all_sample_df_temp[all_sample_df_temp$environment == temp121$carbonsource_mixed_pair2[1], ]
  temp1221 <- all_sample_df_temp[all_sample_df_temp$environment == temp122$carbonsource_mixed_pair1[1], ]
  temp1222 <- all_sample_df_temp[all_sample_df_temp$environment == temp122$carbonsource_mixed_pair2[1], ]
  temp2111 <- all_sample_df_temp[all_sample_df_temp$environment == temp211$carbonsource_mixed_pair1[1], ]
  temp2112 <- all_sample_df_temp[all_sample_df_temp$environment == temp211$carbonsource_mixed_pair2[1], ]
  temp2121 <- all_sample_df_temp[all_sample_df_temp$environment == temp212$carbonsource_mixed_pair1[1], ]
  temp2122 <- all_sample_df_temp[all_sample_df_temp$environment == temp212$carbonsource_mixed_pair2[1], ]
  temp2211 <- all_sample_df_temp[all_sample_df_temp$environment == temp221$carbonsource_mixed_pair1[1], ]
  temp2212 <- all_sample_df_temp[all_sample_df_temp$environment == temp221$carbonsource_mixed_pair2[1], ]
  temp2221 <- all_sample_df_temp[all_sample_df_temp$environment == temp222$carbonsource_mixed_pair1[1], ]
  temp2222 <- all_sample_df_temp[all_sample_df_temp$environment == temp222$carbonsource_mixed_pair2[1], ]
  
  for (j in 1:14) {
    temp1111B <- temp1111[temp1111$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1112B <- temp1112[temp1112$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1121B <- temp1121[temp1121$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1122B <- temp1122[temp1122$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1211B <- temp1211[temp1211$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1212B <- temp1212[temp1212$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1221B <- temp1221[temp1221$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp1222B <- temp1222[temp1222$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2111B <- temp2111[temp2111$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2112B <- temp2112[temp2112$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2121B <- temp2121[temp2121$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2122B <- temp2122[temp2122$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2211B <- temp2211[temp2211$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2212B <- temp2212[temp2212$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2221B <- temp2221[temp2221$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    temp2222B <- temp2222[temp2222$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    
    cvals  <- c(temp1111B, temp1112B, temp1121B, temp1122B,
                temp1211B, temp1212B, temp1221B, temp1222B,
                temp2111B, temp2112B, temp2121B, temp2122B,
                temp2211B, temp2212B, temp2221B, temp2222B)
    ave12  <- mean(cvals)
    sdmean <- mean(c(var(temp1111B), var(temp1112B), var(temp1121B), var(temp1122B),
                     var(temp1211B), var(temp1212B), var(temp1221B), var(temp1222B),
                     var(temp2111B), var(temp2112B), var(temp2121B), var(temp2122B),
                     var(temp2211B), var(temp2212B), var(temp2221B), var(temp2222B)))^0.5
    tempY  <- c(ave12 - sdmean, ave12, ave12 + sdmean)
    
    tempEBc <- tempE[tempE$bacteria == strain_list[j], ]$background_processing_target_fluorescent_cells_density
    if (var(tempEBc) == 0) {
      ptemp <- if (tempEBc[1] == ave12) 1 else 0
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = ptemp
        ))
      }
    } else {
      t <- t.test(x = tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),
                  paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for (k in 1:length(tempEBc)) {
        mix2Ave <- rbind(mix2Ave, data.frame(
          envbac   = paste(info$environment_list[i], strain_list[j]),
          env      = info$environment_list[i],
          bacteria = strain_list[j],
          ave12    = ave12,
          sdx      = sdmean,
          sdy      = sd(tempEBc),
          value    = tempEBc[k],
          pvalue   = t$p.value
        ))
      }
    }
  }
}

qvalue  <- p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave <- cbind(mix2Ave, qvalue)

medDF <- data.frame()
for (i in 31:31) {
  for (j in 1:14) {
    temp <- mix2Ave[(mix2Ave$env == info$environment_list[i]) &
                    (mix2Ave$bacteria == strain_list[j]), ]
    medDF <- rbind(medDF, data.frame(
      envbac = paste(info$environment_list[i], strain_list[j]),
      ave12  = temp$ave12[1],
      med    = mean(temp$value),
      sdx    = temp$sdx[1],
      sdy    = temp$sdy[1],
      p      = if (temp$qvalue[1] < 0.05) 1 else 0,
      pp     = if ((temp$qvalue[1] < 0.05) & (mean(temp$value) > temp$ave12[1])) {
                 "high"
               } else if ((temp$qvalue[1] < 0.05) & (mean(temp$value) < temp$ave12[1])) {
                 "low"
               } else {
                 "same"
               }
    ))
  }
}

temphigh <- 0
tempsame <- 0
templow  <- 0
for (i in 1:length(medDF$envbac)) {
  if (medDF$p[i] == 0) {
    tempsame <- tempsame + 1
  } else {
    if (medDF$ave12[i] > medDF$med[i]) {
      templow <- templow + 1
    } else if (medDF$ave12[i] < medDF$med[i]) {
      temphigh <- temphigh + 1
    }
  }
}

judge  <- c("Scenario3", "Scenario1", "Scenario2")
judge2 <- c(templow, tempsame, temphigh)
count  <- data.frame(x1 = 1, Type = judge, count1 = judge2)
c_vals <- c()
c1_vals <- c()
for (k in 1:3) {
  c_vals[k]  <- if (count$count1[k] / sum(count$count1) < 0.1) {
                  paste(" ", format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                } else {
                  paste(format(round(count$count1[k] / sum(count$count1) * 100, 1), nsmall = 1), "%", sep = "")
                }
  c1_vals[k] <- count$count1[k] / sum(count$count1)
}
count <- cbind(count, c = c_vals, c1 = c1_vals)
count <- transform(count, Type = factor(Type, levels = c("Scenario2", "Scenario1", "Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))

g <- ggplot(data = count, mapping = aes(x = as.factor(x1), y = c1, fill = Type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.15) +
  geom_text(aes(label = c, y = pos), size = 13, hjust = -0.6) +
  theme_void() +
  scale_fill_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                 "grey70",
                                 rgb(red = 58, green = 184, blue = 153, maxColorValue = 255)))
g
ggsave(file = paste("Fig5D__", "carbonmix_prediction_1to16_bar.pdf"), plot = g)

mix2Ave <- transform(mix2Ave, bacteria = factor(bacteria, levels = strain_list))
df1 <- data.frame(x1 = 1000000, y1 = 1000000, x2 = 100000000000, y2 = 100000000000)
g <- ggplot(mix2Ave, aes(x = ave12, y = value, color = bacteria)) +
  geom_point(size = 2.5) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "black", data = df1, linewidth = 0.75, linetype = "dotted") +
  scale_x_continuous(trans = "log10", limits = c(5000000, 200000000000)) +
  scale_y_continuous(trans = "log10", limits = c(5000000, 200000000000)) +
  labs(x = "Mean prediction (cells / mL)",
       y = "Observed (cells / mL)",
       title = paste("1->2 high", temphigh, "same", tempsame, "low", templow)) +
  theme(legend.position = "none")
g

medDF <- transform(medDF, pp = factor(pp, levels = c("high", "same", "low")))
df1 <- data.frame(x1 = 100000, y1 = 100000, x2 = 10000000000, y2 = 10000000000)
g <- ggplot(medDF, aes(x = ave12, y = med, color = as.factor(pp))) +
  geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
               color = "grey20", data = df1, linewidth = 0.75, linetype = "dotted") +
  geom_point(size = 1.5) +
  scale_x_continuous(trans = "log10", limits = c(100000, 10000000000), expand = c(0, 0)) +
  scale_y_continuous(trans = "log10", limits = c(100000, 10000000000), expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        title = element_blank(),
        axis.line = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.ticks = element_line(size = 0.8, lineend = "square", color = "grey20"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(t = 160, r = 160, b = 0, l = 0, unit = "pt")) +
  scale_color_manual(values = c(rgb(red = 184, green = 153, blue = 58, maxColorValue = 255),
                                  "grey70",
                                  rgb(red = 58, green = 184, blue = 153, maxColorValue = 255))) +
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for (i in 1:length(medDF$envbac)) {
  temp <- medDF[i, ]
  errorDFx <- data.frame(x1 = temp$ave12 - temp$sdx, y1 = temp$med,
                          x2 = temp$ave12 + temp$sdx, y2 = temp$med)
  errorDFy <- data.frame(x1 = temp$ave12, y1 = temp$med - temp$sdy,
                          x2 = temp$ave12, y2 = temp$med + temp$sdy)
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFx,
                        linewidth = 0.2, linetype = "solid")
  g <- g + geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                        color = "black", alpha = 0.3, data = errorDFy,
                        linewidth = 0.2, linetype = "solid")
}
g
ggsave(file = paste("Fig5D_carbonmix_prediction_1to16.pdf"), plot = g)

g <- ggplot(medDF, aes(x = "1", y = med / ave12)) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1.2) +
  geom_boxplot(outlier.shape = NA, width = 0.4, color = "grey5") +
  geom_dotplot(binaxis = "y", dotsize = 0.75, alpha = 0.5, fill = NA,
               binwidth = 0.15, stackdir = "center", color = "black") +
  scale_y_continuous(trans = "log10", limits = c(0.01, 1000), expand = c(0, 0)) +
  labs(y = "Observed/Prediction") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = margin(t = 0, r = 70, b = 0, l = 70, unit = "pt"))
g
ggsave(file = paste("FigS13_carbonmix_prediction_1to16.pdf"), plot = g)
```

## Fig.S1 
```{r}
#metabolic distance の算出
all_sample_df_temp<-all_sample_df[all_sample_df$experiment=="main",]

#growth_spe<-data.frame("dammy"=c(1:32))
growth_spe<-data.frame("dammy"=c(1:16))
bacteria_list<-c(info$monoculture_bacteria_list[1],info$monoculture_bacteria_list[3:14],info$monoculture_bacteria_list[16])

for(i in 1:14){
  temp<-all_sample_df_temp[all_sample_df_temp$bacteria==bacteria_list[i],]
  tempc<-data.frame()
  #for(j in 1:32){
  for(j in 1:16){
    tempBE<-temp[temp$environment==info$environment_list[j],]
    tempc<-rbind(tempc,"a"=log10(mean(as.numeric(tempBE$background_processing_target_fluorescent_cells_density)))-log10(457000))
  }
  growth_spe<-cbind(growth_spe,tempc)
}

normalizedG<-data.frame("dammy"=c(1:32))
for(i in 2:15){
  tempmax<-max(growth_spe[,i])
  tempc<-data.frame()
  for(j in 1:16){
    tempc<-rbind(tempc,"a"=growth_spe[j,i]/tempmax)
  }
  normalizedG<-cbind(normalizedG,tempc)
}
normalizedGt<-t(normalizedG)[2:15,1:16]
a<-set_colnames(normalizedGt, info$environment_list[1:16])
MetabolicMatrix<-(set_rownames(a, bacteria_list))

MetabolicMelt <- melt(MetabolicMatrix)
colnames(MetabolicMelt) <- c("Strain", "Carbon", "Value")

dev.new()
pdf("FigS1_for_dendrogram.pdf")
heatmap(MetabolicMatrix, scale = "none") #, col = original(10000))
dev.off()


dev.new()
clr <- heatmap(MetabolicMatrix, scale = "none")
dev.off()

gene.idx  <- rownames(MetabolicMatrix)[clr$rowInd]
group.idx <- colnames(MetabolicMatrix)[clr$colInd]

MetabolicMelt$Strain  <- factor(MetabolicMelt$Strain, levels = gene.idx)
MetabolicMelt$Carbon <- factor(MetabolicMelt$Carbon, levels = group.idx)

MetabolicMelt

ghm <- ggplot(MetabolicMelt, aes(x = Carbon, y = Strain, fill = Value))
ghm <- ghm + geom_tile()
ghm <- ghm + theme_pubr()
ghm <- ghm + theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),
                   axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),
                   strip.background = element_rect(fill = "white", colour = "white"),
                   axis.text.x = element_text(size=10,angle = 90, vjust = 0.5, hjust = 1),
                   axis.text.y = element_text(size=10),
                   axis.title = element_blank())

ghm <- ghm + scale_fill_gradientn("value", colours = c("grey95","grey5"),na.value = "red")
ghm <- ghm + coord_fixed(ratio = 1.14, xlim = NULL, ylim = NULL, expand = TRUE)
ghm

ggsave(file = "FigS1_species_metabolites_heatmap.pdf", plot = ghm)






```

## Fig.S2 CDE
```{r}
all_sample_df_temp<-all_sample_df[all_sample_df$experiment=="main"|all_sample_df$experiment=="conc",]
all_sample_df_temp<-all_sample_df_temp[all_sample_df_temp$carbonsource_species_count==1,]
ODdfConc<-all_sample_df_temp[all_sample_df_temp$bacterial_species_count==1,]


concDF<-data.frame()
concentration_list<-c(0.5,1)
for(i in 1:16){
  tempE<-ODdfConc[ODdfConc$environment==info$environment_list[i],]
  for(j in 1:8){
    tempB<-tempE[tempE$monoculture_bacteria==info$bacteria_list[j],]
    concDFt<-data.frame()
    for(k in 1:2){
      
      temp<-tempB[tempB$concentration==concentration_list[k],]
      concDFt<-rbind(concDFt,data.frame(
        monoculture_strain=temp$monoculture_bacteria[1],
        carbon=temp$environment[1],
        concentration=as.numeric(temp$concentration[1]),
        mean=mean(temp$background_processing_target_fluorescent_cells_density),
        k=k,
        a=mean(tempB[tempB$concentration==concentration_list[2],]$background_processing_target_fluorescent_cells_density)/mean(tempB[tempB$concentration==concentration_list[1],]$background_processing_target_fluorescent_cells_density),
        b=if(mean(tempB[tempB$concentration==concentration_list[2],]$background_processing_target_fluorescent_cells_density)!=457000&&mean(tempB[tempB$concentration==concentration_list[1],]$background_processing_target_fluorescent_cells_density!=457000)){mean(tempB[tempB$concentration==concentration_list[2],]$background_processing_target_fluorescent_cells_density)/mean(tempB[tempB$concentration==concentration_list[1],]$background_processing_target_fluorescent_cells_density)}else{"ERROR"}))
    }
    if(concDFt[concDFt$concentration==0.5,]$mean[1]<=concDFt[concDFt$concentration==1,]$mean[1]){c<-rep(1,2)}else{c<-rep(0,2)}
    concDFt<-cbind(concDFt,c)
    concDF<-rbind(concDF,concDFt)
  }
}
#concDF<-transform(concDF,monoculture_strain=factor(monoculture_strain,levels=info$bacteria_list))
concDF<-transform(concDF,carbon=factor(carbon,levels=info$environment_list))
concDF<-transform(concDF,monoculture_strain=factor(monoculture_strain,levels=info$bacteria_list_Phylogenetic))


g<-ggplot()+
  geom_violin(data=concDF,mapping=aes(x=as.factor(concentration),y=mean),alpha=0.3,color="grey")+
  geom_line(data=concDF,aes(x=as.factor(concentration),y=mean,color=carbon,group=interaction(carbon,monoculture_strain)),alpha=0.5)+
  geom_point(data=concDF,mapping=aes(x=as.factor(concentration),y=mean,fill=monoculture_strain),alpha=0.5,shape=21,size=2)+
  scale_y_continuous(trans="log10",limits=c(10^5,3*10^9),breaks=c(10^6,10^7,10^8,10^9),expand = c(0,0))+
  scale_fill_manual(values=c(color_bacteria[1],color_bacteria[2],color_bacteria[3],color_bacteria[4],color_bacteria[5],color_bacteria[6],color_bacteria[7],color_bacteria[8]))+
  scale_color_manual(values=c(color_carbon[1],color_carbon[5],color_carbon[9],color_carbon[13],color_carbon[2],color_carbon[6],color_carbon[10],color_carbon[14],color_carbon[3],color_carbon[7],color_carbon[11],color_carbon[15],color_carbon[4],color_carbon[8],color_carbon[12],color_carbon[16]))+
  theme_bw()+
  theme(legend.position="none",
        axis.title = element_blank(),axis.text = element_blank())
g
ggsave(file = "FigS3_conc_cellsml.pdf", plot = g)

g<-ggplot()+
  geom_violin(data=concDF,mapping=aes(x=as.factor(concentration),y=mean),alpha=0.3,color="grey")+
  geom_line(data=concDF,aes(x=as.factor(concentration),y=mean,color=carbon,group=interaction(carbon,monoculture_strain)),alpha=0.5)+
  geom_point(data=concDF,mapping=aes(x=as.factor(concentration),y=mean,fill=monoculture_strain),alpha=0.5,shape=21,size=2)+
  scale_y_continuous(trans="log10",limits=c(10^5,3*10^9),breaks=c(10^6,10^7,10^8,10^9),expand = c(0,0))+
  scale_fill_manual(values=c(color_bacteria[1],color_bacteria[2],color_bacteria[3],color_bacteria[4],color_bacteria[5],color_bacteria[6],color_bacteria[7],color_bacteria[8]))+
  scale_color_manual(values=c(color_carbon[1],color_carbon[5],color_carbon[9],color_carbon[13],color_carbon[2],color_carbon[6],color_carbon[10],color_carbon[14],color_carbon[3],color_carbon[7],color_carbon[11],color_carbon[15],color_carbon[4],color_carbon[8],color_carbon[12],color_carbon[16]))+
  theme_bw()+
  theme(axis.title = element_blank(),legend.text = element_text(size=10))
g
ggsave(file = "FigS3_conc_cellsml_for_legend.pdf", plot = g,height = unit(10,"cm"),width = unit(10,"cm") )


concDF1<-concDF[concDF$c==0,]

g<-ggplot()+
  #geom_violin(data=concDF1,mapping=aes(x=as.factor(concentration),y=mean),alpha=0.3,color="grey")+
  geom_line(data=concDF1,aes(x=as.factor(concentration),y=mean,color=carbon,group=interaction(carbon,monoculture_strain)),alpha=0.5)+
  geom_point(data=concDF1,mapping=aes(x=as.factor(concentration),y=mean,fill=monoculture_strain),alpha=0.5,shape=21,size=2)+
  scale_y_continuous(trans="log10",limits=c(10^5,3*10^9),breaks=c(10^6,10^7,10^8,10^9),expand = c(0,0))+
  scale_fill_manual(values=c(color_bacteria[4],color_bacteria[6],color_bacteria[7],color_bacteria[8]))+
  scale_color_manual(values=c(color_carbon[1],color_carbon[5],color_carbon[13],color_carbon[6],color_carbon[10],color_carbon[14],color_carbon[11],color_carbon[4],color_carbon[12],color_carbon[16]))+
  theme_bw()+
  theme(axis.title = element_blank(),legend.text = element_text(size=10),legend.position = "none",axis.text = element_blank())
g
ggsave(file = "FigS3_conc_cellsml_part.pdf", plot = g)

g<-ggplot()+
  #geom_violin(data=concDF1,mapping=aes(x=as.factor(concentration),y=mean),alpha=0.3,color="grey")+
  geom_line(data=concDF1,aes(x=as.factor(concentration),y=mean,color=carbon,group=interaction(carbon,monoculture_strain)),alpha=0.5)+
  geom_point(data=concDF1,mapping=aes(x=as.factor(concentration),y=mean,fill=monoculture_strain),alpha=0.5,shape=21,size=2)+
  scale_y_continuous(trans="log10",limits=c(10^5,3*10^9),breaks=c(10^6,10^7,10^8,10^9),expand = c(0,0))+
  scale_fill_manual(values=c(color_bacteria[4],color_bacteria[6],color_bacteria[7],color_bacteria[8]))+
  scale_color_manual(values=c(color_carbon[1],color_carbon[5],color_carbon[13],color_carbon[6],color_carbon[10],color_carbon[14],color_carbon[11],color_carbon[4],color_carbon[12],color_carbon[16]))+
  theme_bw()+
  theme(axis.title = element_blank(),legend.text = element_text(size=10))
g
ggsave(file = "FigS3_conc_cellsml_part_for_legend.pdf", plot = g,height = unit(10,"cm"),width = unit(10,"cm") )


concNew<-concDF[concDF$b!="ERROR",]

g<-ggplot()+
  geom_histogram(data=concNew[concNew$k==k,],mapping=aes(x=1/as.numeric(b)),alpha=0.3,color="grey",bins=14)+
  scale_x_continuous(trans="log2",limits=c(2^(-9),2^4),expand=c(0,0),breaks=c(2^(-8:3)))+
  scale_y_continuous(limits=c(0,30),expand=c(0,0))+
  theme_bw()+
  theme(axis.text = element_blank())
g
ggsave(file = "FigS3_hist.pdf", plot = g)

g<-ggplot()+
  geom_histogram(data=concNew[concNew$k==k,],mapping=aes(x=1/as.numeric(b)),alpha=0.3,color="grey",bins=27)+
  scale_x_continuous(trans="log2",limits=c(2^(-9),2^4),expand=c(0,0),breaks=c(2^(-9:4)))+
  scale_y_continuous(limits=c(0,20),expand=c(0,0))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))
g
ggsave(file = "conc_hist.pdf", plot = g)
```

## Fig.S2 AB
```{r}
#炭素源の濃度とFinalODの関係を見る
FilterMaxOD96read <- function(plate_basic_name,plate_id,hour,env1,env2,strain,carbon1,carbon2,test,monoculture_fluorescence,monoculture_strain){
  od<-c()
  id<-c()
  plate_name<-paste(plate_basic_name,plate_id,"_",hour,"h.csv",sep="")
  d<-data.frame(read.csv(plate_name))
  for(i in 1:12){
    for(j in 1:8){
      od<-c(od,as.numeric(d[j,i+1]))
    }
  }
  
  h96<-rep(hour,96)
  environment96<-c(rep(env1,48),rep(env2,48))
  carbon96<-c(rep(carbon1,48),rep(carbon2,48))
  index=c(1:96)
  
  ODdf<-data.frame("OD"=as.numeric(od),"hour"=as.numeric(h96),"strain"=strain,"env"=environment96,"index"=index,"platehour"=paste(plate_basic_name,plate_id,"-hour",hour,"_",index),"plateindex"=paste(plate_basic_name,plate_id,index),"carbon"=carbon96,"test"=test,"monoculture_fluorescence"=monoculture_fluorescence,"monoculture_strain"=monoculture_strain,stringsAsFactors = F)
  return(ODdf)
}



env_list<-info$environment_list

strain<-info$coculture_platedesign
monoculture_fluorescence<-info$monoculture_fluorescence_list
monoculture_strain<-info$monoculture_platedesign

ODdfConc<-data.frame()
env_list<-info$monoculture_test_environment_list
carbon_list<-info$monoculture_test_carbon_list
for(i in 24:24){
  for(j in 49:72){
    temp_i <- if(i*3<10){paste("0",i*3,sep="")}else{i*3}
    temp_j <- if(j<10){paste("0",j,sep="")}else{j}
    
    env1<-env_list[((j-48)*2-1)]
    env2<-env_list[((j-48)*2)]
    
    carbon1<-carbon_list[((j-48)*2-1)]
    carbon2<-carbon_list[((j-48)*2)]
    
    if(mod(j,3)==1){
      conc<-data.frame(concentration=c(rep(0.5,48),rep(1,48)))
    }else{
      if(mod(j,3)==2){
        conc<-data.frame(concentration=c(rep(1.5,48),rep(0.5,48)))
      }else{
        if(mod(j,3)==0){
          conc<-data.frame(concentration=c(rep(1.0,48),rep(1.5,48)))
        }
      }
    }
    ODdfConctemp<-cbind(FilterMaxOD96read("Ono_plate",temp_j,temp_i,env1,env2,strain,carbon1,carbon2,"monoculture",monoculture_fluorescence,monoculture_strain),conc)   
    ODdfConc<-rbind(ODdfConc,ODdfConctemp)
  }
}

concDF<-data.frame()
concentration_list<-c(0.5,1,1.5)
for(i in 1:16){
  tempE<-ODdfConc[ODdfConc$carbon==info$environment_list[i],]
  for(j in 1:8){
    tempB<-tempE[substr(tempE$monoculture_strain, 1, 3)==info$bacteria_list[j],]
    concDFt<-data.frame()
    for(k in 1:3){
      
      temp<-tempB[tempB$concentration==concentration_list[k],]
      concDFt<-rbind(concDFt,data.frame(monoculture_strain=substr(temp$monoculture_strain[1],1,3),carbon=temp$carbon[1],concentration=as.numeric(temp$concentration[1]),mean=mean(temp$OD)))
    }
    if((concDFt[concDFt$concentration==0.5,]$mean[1]<concDFt[concDFt$concentration==1,]$mean[1])&(concDFt[concDFt$concentration==1.0,]$mean[1]<concDFt[concDFt$concentration==1.5,]$mean[1])){c<-rep(1,3)}else{c<-rep(0,3)}
    concDFt<-cbind(concDFt,c)
    concDF<-rbind(concDF,concDFt)
  }
}
concDF<-transform(concDF,monoculture_strain=factor(monoculture_strain,levels=info$bacteria_list_Phylogenetic))
concDF<-transform(concDF,carbon=factor(carbon,levels=info$environment_list))


g<-ggplot()+
  geom_violin(data=concDF,mapping=aes(x=as.factor(concentration),y=mean),alpha=0.3,color="grey")+
  geom_line(data=concDF,aes(x=as.factor(concentration),y=mean,color=carbon,group=interaction(carbon,monoculture_strain)),alpha=0.5)+
  geom_point(data=concDF,mapping=aes(x=as.factor(concentration),y=mean,fill=monoculture_strain),alpha=0.5,shape=21,size=2)+
  scale_y_continuous(limits=c(0,0.75),breaks=c(0,0.25,0.5,0.75),expand = c(0,0))+
  scale_fill_manual(values=c(color_bacteria[1],color_bacteria[2],color_bacteria[3],color_bacteria[4],color_bacteria[5],color_bacteria[6],color_bacteria[7],color_bacteria[8]))+
  scale_color_manual(values=c(color_carbon[1],color_carbon[5],color_carbon[9],color_carbon[13],color_carbon[2],color_carbon[6],color_carbon[10],color_carbon[14],color_carbon[3],color_carbon[7],color_carbon[11],color_carbon[15],color_carbon[4],color_carbon[8],color_carbon[12],color_carbon[16]))+
  theme_bw()+
  theme(legend.position="none",
        axis.title = element_blank(),axis.text = element_blank())
g
ggsave(file = "FigS3_conc_OD.pdf", plot = g)

g<-ggplot()+
  geom_violin(data=concDF,mapping=aes(x=as.factor(concentration),y=mean),alpha=0.3,color="grey")+
  geom_line(data=concDF,aes(x=as.factor(concentration),y=mean,color=carbon,group=interaction(carbon,monoculture_strain)),alpha=0.5)+
  geom_point(data=concDF,mapping=aes(x=as.factor(concentration),y=mean,fill=monoculture_strain),alpha=0.5,shape=21,size=2)+
  scale_y_continuous(limits=c(0,0.75),breaks=c(0,0.25,0.5,0.75),expand = c(0,0))+
  scale_fill_manual(values=c(color_bacteria[1],color_bacteria[2],color_bacteria[3],color_bacteria[4],color_bacteria[5],color_bacteria[6],color_bacteria[7],color_bacteria[8]))+
  scale_color_manual(values=c(color_carbon[1],color_carbon[5],color_carbon[9],color_carbon[13],color_carbon[2],color_carbon[6],color_carbon[10],color_carbon[14],color_carbon[3],color_carbon[7],color_carbon[11],color_carbon[15],color_carbon[4],color_carbon[8],color_carbon[12],color_carbon[16]))+
  theme_bw()+
  theme(axis.title = element_blank(),legend.text = element_text(size=10))
g
ggsave(file = "FigS3_conc_OD_for_legend.pdf", plot = g,height = unit(10,"cm"),width = unit(10,"cm") )











temp<-data.frame()
for(i in 1:16){
  for(j in 1:8){
    temp1<-concDF[concDF$carbon==info$environment_list[i],]
    temp1<-temp1[temp1$monoculture_strain==info$bacteria_list[j],]
    #if((temp1[temp1$concentration==0.5,]$mean>0.04)&(temp1[temp1$concentration==0.5,]$c==0)){
    if(((temp1[temp1$concentration==0.5,]$mean>0.05)|(temp1[temp1$concentration==1.0,]$mean>0.05)|(temp1[temp1$concentration==1.5,]$mean>0.05))&&(temp1[temp1$concentration==0.5,]$c==0)){
      temp<-rbind(temp,temp1)
    }
  }
}

g<-ggplot()+
  #geom_violin(data=temp,mapping=aes(x=as.factor(concentration),y=mean),alpha=0.3,color="grey")+
  geom_line(data=temp,aes(x=as.factor(concentration),y=mean,color=carbon,group=interaction(carbon,monoculture_strain)),alpha=0.5)+
  geom_point(data=temp,mapping=aes(x=as.factor(concentration),y=mean,fill=monoculture_strain),alpha=0.5,shape=21,size=2)+
  scale_y_continuous(limits=c(0,0.75),breaks=c(0,0.25,0.5,0.75),expand = c(0,0))+
  scale_fill_manual(values=c(color_bacteria[1],color_bacteria[3],color_bacteria[4],color_bacteria[5],color_bacteria[6],color_bacteria[7],color_bacteria[8]))+
  scale_color_manual(values=c(color_carbon[1],color_carbon[10],color_carbon[14],color_carbon[3],color_carbon[15],color_carbon[4],color_carbon[12],color_carbon[16]))+
  theme_bw()+
  theme(legend.position="none",
        axis.title = element_blank(),axis.text = element_blank())
g
ggsave(file = "FigS3_conc_OD_part.pdf", plot = g)

g<-ggplot()+
  #geom_violin(data=temp,mapping=aes(x=as.factor(concentration),y=mean),alpha=0.3,color="grey")+
  geom_line(data=temp,aes(x=as.factor(concentration),y=mean,color=carbon,group=interaction(carbon,monoculture_strain)),alpha=0.5)+
  geom_point(data=temp,mapping=aes(x=as.factor(concentration),y=mean,fill=monoculture_strain),alpha=0.5,shape=21,size=2)+
  scale_y_continuous(limits=c(0,1),breaks=c(0,0.5,1),expand = c(0,0))+
  scale_fill_manual(values=c(color_bacteria[1],color_bacteria[3],color_bacteria[4],color_bacteria[5],color_bacteria[6],color_bacteria[7],color_bacteria[8]))+
  scale_color_manual(values=c(color_carbon[1],color_carbon[10],color_carbon[14],color_carbon[3],color_carbon[15],color_carbon[4],color_carbon[12],color_carbon[16]))+
  theme_bw()+
  theme(axis.title = element_blank())
g
ggsave(file = "FigS3_conc_OD_part_for_legend.pdf", plot = g,height = unit(10,"cm"),width = unit(10,"cm"))

```

## Fig.S4
```{r}
#GFP
df1=data.frame(x1=500,y1=100,x2=500,y2=1)
df2=data.frame(x1=500,y1=1,x2=299999,y2=1)
df3=data.frame(x1=299999,y1=1,x2=299999,y2=500)
df4=data.frame(x1=299999,y1=500,x2=5000,y2=500)
df5=data.frame()
  for(i in seq(1000,5000,by=10)){df5<-rbind(df5,data.frame(x=i,y=i/10))}
df6=data.frame(x1=1000,y1=100,x2=500,y2=100)

#mScarlet
df7=data.frame(x1=1,y1=299999,x2=1,y2=100)
df8=data.frame(x1=1,y1=100,x2=500,y2=100)
df9=data.frame(x1=500,y1=100,x2=500,y2=500)
df10=data.frame()
df10=data.frame()
  for(i in seq(500,2000,by=1)){df10<-rbind(df10,data.frame(x=i,y=(i*3-1000)))}
df11=data.frame()
  for(i in seq(2000,7000,by=10)){df11<-rbind(df11,data.frame(x=i,y=(i*59-113000)))}
df12=data.frame(x1=7000,y1=299999,x2=1,y2=299999)

#PCRed
df13=data.frame(x1=20000,y1=299999,x2=20000,y2=240000)
df14=data.frame()
  for(i in seq(79000/15,20000,by=10)){df14<-rbind(df14,data.frame(x=i,y=(i*15-60000)))}
df15=data.frame(x1=79000/15,y1=19000,x2=37900,y2=19000)
df16=data.frame()
  for(i in seq(37900,60000,by=10)){df16<-rbind(df16,data.frame(x=i,y=(i*10-360000)))}
df17=data.frame(x1=60000,y1=240000,x2=299999,y2=240000)
df18=data.frame(x1=299999,y1=240000,x2=299999,y2=299999)
df19=data.frame(x1=299999,y1=299999,x2=20000,y2=299999)
df20=data.frame(x1=1,y1=170000,x2=299999,y2=170000)
df21=data.frame()
  for(i in seq(0,100000,by=10)){df21<-rbind(df21,data.frame(x=i,y=(i*110000/69000+60000-31000*110000/69000)))}



  
sample<-read.FCS("Ono_plate23_19.fcs")
tempDataframe<-data.frame("SSC.H"=data.frame(sample@exprs)$SSC.H,"FITC.A"=data.frame(sample@exprs)$FITC.A,"PE.A"=data.frame(sample@exprs)$PE.A,"PE.Cy5.A"=data.frame(sample@exprs)$PE.Cy5.A,"Gate.count"=0)
total_count=sample@description$`$TOT`
  
      #1未満の値を持つデータを1に置き換え
if(length(tempDataframe[tempDataframe$FITC.A<1,]$Gate.count)>0){tempDataframe[tempDataframe$FITC.A<1,]$FITC.A<-1}
if(length(tempDataframe[tempDataframe$PE.A<1,]$Gate.count)>0){tempDataframe[tempDataframe$PE.A<1,]$PE.A<-1}
if(length(tempDataframe[tempDataframe$PE.Cy5.A<1,]$Gate.count)>0){tempDataframe[tempDataframe$PE.Cy5.A<1,]$PE.Cy5.A<-1}
  
  #Gate.count列の値でイベントを分別
  #bicolor
if(length(tempDataframe[(tempDataframe$FITC.A>500 | tempDataframe$PE.A>100),]$Gate.count)>0){tempDataframe[(tempDataframe$FITC.A>500 | tempDataframe$PE.A>100),]$Gate.count<-5}
  
  #GFP
if(length(tempDataframe[(tempDataframe$FITC.A>500 & tempDataframe$PE.A<100) | (tempDataframe$PE.A>100 & tempDataframe$PE.A<500 & tempDataframe$PE.A<tempDataframe$FITC.A/10),]$Gate.count)>0){tempDataframe[(tempDataframe$FITC.A>500 & tempDataframe$PE.A<100) | (tempDataframe$PE.A>100 & tempDataframe$PE.A<500 & tempDataframe$PE.A<tempDataframe$FITC.A/10),]$Gate.count<-4}
  
  #mScarlet
if(length(tempDataframe[(tempDataframe$FITC.A<500 & tempDataframe$PE.A>100) | (tempDataframe$FITC.A>500 & tempDataframe$FITC.A<2000 & tempDataframe$PE.A>(tempDataframe$FITC.A*3-1000)) | (tempDataframe$FITC.A>2000 & tempDataframe$FITC.A<7000 & tempDataframe$PE.A>(tempDataframe$FITC.A*59-113000)),]$Gate.count)>0){tempDataframe[(tempDataframe$FITC.A<500 & tempDataframe$PE.A>100) | (tempDataframe$FITC.A>500 & tempDataframe$FITC.A<2000 & tempDataframe$PE.A>(tempDataframe$FITC.A*3-1000)) | (tempDataframe$FITC.A>2000 & tempDataframe$FITC.A<7000 & tempDataframe$PE.A>(tempDataframe$FITC.A*59-113000)),]$Gate.count<-3}
  
  #beadsのごみ
if(length(tempDataframe[tempDataframe$SSC.H>25000,]$Gate.count)>0){tempDataframe[tempDataframe$SSC.H>25000,]$Gate.count<-2}   
  
  #beads
if(length(tempDataframe[(tempDataframe$SSC.H>240000 & tempDataframe$PE.Cy5.A>20000 & tempDataframe$FITC.A>20000 & tempDataframe$PE.A>800 & (tempDataframe$PE.A>170000 | tempDataframe$PE.A<tempDataframe$FITC.A*110/69+60000-31000*110/69))|(tempDataframe$SSC.H>19000 & tempDataframe$SSC.H<(15*tempDataframe$PE.Cy5.A-60000) & tempDataframe$SSC.H>(10*tempDataframe$PE.Cy5.A-360000) & tempDataframe$FITC.A>20000 & tempDataframe$PE.A>800 & (tempDataframe$PE.A>170000 | tempDataframe$PE.A<tempDataframe$FITC.A*110/69+60000-31000*110/69)),]$Gate.count)>0){tempDataframe[(tempDataframe$SSC.H>240000 & tempDataframe$PE.Cy5.A>20000 & tempDataframe$FITC.A>20000 & tempDataframe$PE.A>800 & (tempDataframe$PE.A>170000 | tempDataframe$PE.A<tempDataframe$FITC.A*110/69+60000-31000*110/69))|(tempDataframe$SSC.H>19000 & tempDataframe$SSC.H<(15*tempDataframe$PE.Cy5.A-60000) & tempDataframe$SSC.H>(10*tempDataframe$PE.Cy5.A-360000) & tempDataframe$FITC.A>20000 & tempDataframe$PE.A>800 & (tempDataframe$PE.A>170000 | tempDataframe$PE.A<tempDataframe$FITC.A*110/69+60000-31000*110/69)),]$Gate.count<-1}

colorT = rgb(255,255,255,maxColorValue = 255,alpha = 0)
colorG1 = rgb(red=89+(255-89)*2/3,green=178+(255-178)*2/3,blue=101+(255-101)*2/3,maxColorValue=255)
colorG2 = rgb(red=89+(255-89)*1/3,green=178+(255-178)*1/3,blue=101+(255-101)*1/3,maxColorValue=255)
colorG3 = rgb(red=89,green=178,blue=101,maxColorValue=255)
colorR1 = rgb(red=230+(255-230)*2/3,green=115+(255-115)*2/3,blue=202+(255-202)*2/3,maxColorValue=255)
colorR2 = rgb(red=230+(255-230)*1/3,green=115+(255-115)*1/3,blue=202+(255-202)*1/3,maxColorValue=255)
colorR3 = rgb(red=230,green=115,blue=202,maxColorValue=255)

temp <- tempDataframe[(tempDataframe$Gate.count==3)|(tempDataframe$Gate.count==4),]
tempG <- temp[temp$Gate.count == 4,]
tempR <- temp[temp$Gate.count == 3,]

g1<-ggplot()+
  geom_point(data = tempG, mapping = aes( x = FITC.A , y = PE.A),size = 0.1, shape = 20, color = colorG3, alpha=0.2) +
  geom_density_2d_filled(data = tempG, mapping = aes( x = FITC.A , y = PE.A),breaks = c(0,0.01,0.1,1,10,100)) +
  scale_fill_discrete(type = c(colorT,colorG1,colorG2,colorG3,"black")) +
  geom_density_2d(data = tempG, mapping = aes( x = FITC.A , y = PE.A),breaks = c(0,0.01,0.1,1,10,100),color = "black") +
  scale_x_continuous(trans="log10",limits=c(1,300000),breaks=c(10^(0:5)),guide = guide_axis(angle = 90),expand = c(0.004,0.004))+
  scale_y_continuous(trans="log10",limits=c(1,300000),breaks=c(10^(0:5)),expand = c(0.004,0.004))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
  theme_minimal()+
  theme(panel.background = element_rect(fill = colorT),axis.line = element_blank())
plot(g1)
ggsave(file="Fig.S5_GFP.pdf",plot=g1)

g2<-ggplot()+
  geom_point(data = tempR, mapping = aes( x = FITC.A , y = PE.A),size = 0.1, shape = 20, color = colorR3, alpha=0.2) +
  geom_density_2d_filled(data = tempR, mapping = aes( x = FITC.A , y = PE.A),breaks = c(0,0.01,0.1,1,10,100)) +
  scale_fill_discrete(type = c(colorT,colorR1,colorR2,colorR3,"black")) +
  geom_density_2d(data = tempR, mapping = aes( x = FITC.A , y = PE.A),breaks = c(0,0.01,0.1,1,10,100),color = "black") +
  scale_x_continuous(trans="log10",limits=c(1,300000),breaks=c(10^(0:5)),guide = guide_axis(angle = 90),expand = c(0.004,0.004))+
  scale_y_continuous(trans="log10",limits=c(1,300000),breaks=c(10^(0:5)),expand = c(0.004,0.004))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorG3,data=df1)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorG3,data=df2)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorG3,data=df3)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorG3,data=df4)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorG3,data=df6)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorR3,data=df7)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorR3,data=df8)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorR3,data=df9)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorR3,data=df12)+
  geom_line(data=df5,mapping=aes(x=x,y=y),color=colorG3)+
  geom_line(data=df10,mapping=aes(x=x,y=y),color=colorR3)+
  geom_line(data=df11,mapping=aes(x=x,y=y),color=colorR3)+
  theme_minimal()+
  theme(panel.background = element_rect(fill = colorT),panel.grid = element_blank())
plot(g2)
ggsave(file="Fig.S5_RFP.pdf",plot=g2)


g1<-ggplot()+
  #geom_point(data = tempG, mapping = aes( x = FITC.A , y = PE.A),size = 0.1, shape = 20, color = colorG3, alpha=0.2) +
  geom_density_2d_filled(data = tempG, mapping = aes( x = FITC.A , y = PE.A),breaks = c(0,0.01,0.1,1,10,100)) +
  scale_fill_discrete(type = c(colorT,colorG1,colorG2,colorG3,"black")) +
  geom_density_2d(data = tempG, mapping = aes( x = FITC.A , y = PE.A),breaks = c(0,0.01,0.1,1,10,100),color = "black") +
  scale_x_continuous(trans="log10",limits=c(1,300000),breaks=c(10^(0:5)),guide = guide_axis(angle = 90),expand = c(0.004,0.004))+
  scale_y_continuous(trans="log10",limits=c(1,300000),breaks=c(10^(0:5)),expand = c(0.004,0.004))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
  theme_minimal()+
  theme(panel.background = element_rect(fill = colorT),axis.line = element_blank())
plot(g1)
ggsave(file="Fig.S5_GFP_for_legend.pdf",plot=g1)

g2<-ggplot()+
  #geom_point(data = tempR, mapping = aes( x = FITC.A , y = PE.A),size = 0.1, shape = 20, color = colorR3, alpha=0.2) +
  geom_density_2d_filled(data = tempR, mapping = aes( x = FITC.A , y = PE.A),breaks = c(0,0.01,0.1,1,10,100)) +
  scale_fill_discrete(type = c(colorT,colorR1,colorR2,colorR3,"black")) +
  geom_density_2d(data = tempR, mapping = aes( x = FITC.A , y = PE.A),breaks = c(0,0.01,0.1,1,10,100),color = "black") +
  scale_x_continuous(trans="log10",limits=c(1,300000),breaks=c(10^(0:5)),guide = guide_axis(angle = 90),expand = c(0.004,0.004))+
  scale_y_continuous(trans="log10",limits=c(1,300000),breaks=c(10^(0:5)),expand = c(0.004,0.004))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorG3,data=df1)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorG3,data=df2)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorG3,data=df3)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorG3,data=df4)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorG3,data=df6)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorR3,data=df7)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorR3,data=df8)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorR3,data=df9)+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color=colorR3,data=df12)+
  geom_line(data=df5,mapping=aes(x=x,y=y),color=colorG3)+
  geom_line(data=df10,mapping=aes(x=x,y=y),color=colorR3)+
  geom_line(data=df11,mapping=aes(x=x,y=y),color=colorR3)+
  theme_minimal()+
  theme(panel.background = element_rect(fill = colorT),panel.grid = element_blank())
plot(g2)
ggsave(file="Fig.S5_RFP_for_legend.pdf",plot=g2)

```

## chi-square test
```{r}
thetaplot_df<-data.frame()
for(i in 1:28){
  for(j in 1:32){
    temp <- all_sample_df[all_sample_df$experiment=="main",]
    temp <- temp[temp$bacterial_species_count==2,]
    temp <- temp[temp$bacteria==info$coculture_bacteria_list[i],]
    temp <- temp[temp$environment==info$environment_list[j],]
    thetaplot_df <- rbind(thetaplot_df, data.frame(bacteria = info$coculture_bacteria_list[i],
                                           environment = info$environment_list[j],
                                           nc = as.numeric(temp$carbonsource_species_count)[1],
                                           x_value = as.numeric(temp$x_value)[1],
                                           x_sd = as.numeric(temp$x_sd)[1],
                                           y_value = as.numeric(temp$y_value)[1],
                                           y_sd = as.numeric(temp$y_sd)[1],
                                           theta_value = as.numeric(temp$theta_value)[1],
                                           Type = temp$Type[1],
                                           plot_hierarchy = temp$plot_hierarchy[1]))
  }
}

thetaplot_df1 <- thetaplot_df[thetaplot_df$nc == 1,]
thetaplot_df1<-transform(thetaplot_df1, environment= factor(environment, levels = info$environment_list[1:16]))
thetaplot_df1<-transform(thetaplot_df1, bacteria= factor(bacteria, levels = info$coculture_bacteria_list))

set.seed(1)


env <- table(thetaplot_df1$environment, thetaplot_df1$Type)
print(env)
chisq.test(env, simulate.p.value = TRUE, B = 100000)

bac <- table(thetaplot_df1$bacteria, thetaplot_df1$Type)
print(bac)
chisq.test(bac, simulate.p.value = TRUE, B = 100000)
```

## PERMANOVA
```{r}
#本当はエンリッチメント解析やりたいんだろうけど、難しいのでk所の方法をとっている？
#https://www.jstage.jst.go.jp/article/seitai/61/1/61_KJ00007176266/_pdf
#https://note.com/medomedo/n/nf5e10f52defb
#https://github.com/pmartinezarbizu/pairwiseAdonis
#2024

all_sample_df_temp<-all_sample_df[all_sample_df$experiment=="main",]
strain_list<-c(info$monoculture_bacteria_list[1],info$monoculture_bacteria_list[3:14],info$monoculture_bacteria_list[16])

# 例データを testdata に入力
testdata <- matrix(c(100,150,0,10,90,100,0,9,80,50,0,8,20,0,50,2,10,0,100,1,0,0,150,0),nrow=4,ncol=6)
rownames(testdata) <- c("A","B","C","D")
colnames(testdata) <- paste("S",1:6,sep="")
testdata

# NPMANOVA（PERMANOVA）
X1 <- c(1,1,2,2)
X2 <- c(1,2,2,3)
adonis2(testdata~X1,method="chao")
adonis2(testdata~X1+X2,method="chao")
pairwise.adonis(testdata,X1)
pairwise.adonis(testdata,X2)

intDF<-data.frame()
for(i in 1:16){
  temp<-all_sample_df_temp[all_sample_df_temp$environment==info$environment_list[i],]
  intDF<-rbind(intDF,data.frame(Mutualism=length(temp[temp$Type=="Mutualism",]$Type),Commensalism=length(temp[temp$Type=="Commensalism",]$Type),Parasitism=length(temp[temp$Type=="Parasitism",]$Type),Amensalism=length(temp[temp$Type=="Amensalism",]$Type),Competition=length(temp[temp$Type=="Competition",]$Type),Neutral=length(temp[temp$Type=="Neutral",]$Type)))
}
rownames(intDF) <- info$environment_list[1:16]

X1<-info$carbon_source_categories_level1[1:16]
X2<-info$carbon_source_categories_level2[1:16]
pairwise.adonis(as.matrix(intDF),X1)
pairwise.adonis(as.matrix(intDF),X2)

pvalue_c<-c()

i=1
tempDF<-data.frame()
for(j in 1:16){
  if(as.numeric(X2[j])==i){
      tempDF<-rbind(tempDF,intDF[j,])
  }
}
X3<-c(rep(i,length(tempDF$Mutualism)),rep(8,16))
tempDF<-rbind(tempDF,intDF)
pairwise.adonis(as.matrix(tempDF),X3)
pvalue_c<-c(pvalue_c,pairwise.adonis(as.matrix(tempDF),X3)["p.value"])


i=2
tempDF<-data.frame()
for(j in 1:16){
  if(as.numeric(X2[j])==i){
      tempDF<-rbind(tempDF,intDF[j,])
  }
}
X3<-c(rep(i,length(tempDF$Mutualism)),rep(8,16))
tempDF<-rbind(tempDF,intDF)
pairwise.adonis(as.matrix(tempDF),X3)
pvalue_c<-c(pvalue_c,pairwise.adonis(as.matrix(tempDF),X3)["p.value"])


i=3
tempDF<-data.frame()
for(j in 1:16){
  if(as.numeric(X2[j])==i){
      tempDF<-rbind(tempDF,intDF[j,])
  }
}
X3<-c(rep(i,length(tempDF$Mutualism)),rep(8,16))
tempDF<-rbind(tempDF,intDF)
pairwise.adonis(as.matrix(tempDF),X3)
pvalue_c<-c(pvalue_c,pairwise.adonis(as.matrix(tempDF),X3)["p.value"])


i=4
tempDF<-data.frame()
for(j in 1:16){
  if(as.numeric(X2[j])==i){
      tempDF<-rbind(tempDF,intDF[j,])
  }
}
X3<-c(rep(i,length(tempDF$Mutualism)),rep(8,16))
tempDF<-rbind(tempDF,intDF)
pairwise.adonis(as.matrix(tempDF),X3)
pvalue_c<-c(pvalue_c,pairwise.adonis(as.matrix(tempDF),X3)["p.value"])


i=5
tempDF<-data.frame()
for(j in 1:16){
  if(as.numeric(X2[j])==i){
      tempDF<-rbind(tempDF,intDF[j,])
  }
}
X3<-c(rep(i,length(tempDF$Mutualism)),rep(8,16))
tempDF<-rbind(tempDF,intDF)
pairwise.adonis(as.matrix(tempDF),X3)
pvalue_c<-c(pvalue_c,pairwise.adonis(as.matrix(tempDF),X3)["p.value"])


i=6
tempDF<-data.frame()
for(j in 1:16){
  if(as.numeric(X2[j])==i){
      tempDF<-rbind(tempDF,intDF[j,])
  }
}
X3<-c(rep(i,length(tempDF$Mutualism)),rep(8,16))
tempDF<-rbind(tempDF,intDF)
pairwise.adonis(as.matrix(tempDF),X3)
pvalue_c<-c(pvalue_c,pairwise.adonis(as.matrix(tempDF),X3)["p.value"])


i=7
tempDF<-data.frame()
for(j in 1:16){
  if(as.numeric(X2[j])==i){
      tempDF<-rbind(tempDF,intDF[j,])
  }
}
X3<-c(rep(i,length(tempDF$Mutualism)),rep(8,16))
tempDF<-rbind(tempDF,intDF)
pairwise.adonis(as.matrix(tempDF),X3)
pvalue_c<-c(pvalue_c,pairwise.adonis(as.matrix(tempDF),X3)["p.value"])


tempDF<-data.frame()
for(j in 1:16){
  if(as.numeric(X2[j])==1|as.numeric(X2[j])==2|as.numeric(X2[j])==3){
      tempDF<-rbind(tempDF,intDF[j,])
  }
}
X3<-c(rep(9,length(tempDF$Mutualism)),rep(8,16))
tempDF<-rbind(tempDF,intDF)
pairwise.adonis(as.matrix(tempDF),X3)
pvalue_c<-c(pvalue_c,pairwise.adonis(as.matrix(tempDF),X3)["p.value"])

qvalue<-p.adjust(as.numeric(pvalue_c), method = "BH")
print(as.numeric(pvalue_c))
print(qvalue)
```

## FigS6
```{r}

thetaplot_df<-data.frame()
for(i in 1:28){
  for(j in 1:16){
    temp <- all_sample_df[all_sample_df$experiment=="main",]
    temp <- temp[temp$bacterial_species_count==2,]
    temp <- temp[temp$bacteria==info$coculture_bacteria_list[i],]
    temp <- temp[temp$environment==info$environment_list[j],]
    thetaplot_df <- rbind(thetaplot_df, data.frame(bacteria = info$coculture_bacteria_list[i],
                                           environment = info$environment_list[j],
                                           nc = as.numeric(temp$carbonsource_species_count[1]),
                                           x_value = as.numeric(temp$x_value)[1],
                                           x_sd = as.numeric(temp$x_sd)[1],
                                           y_value = as.numeric(temp$y_value)[1],
                                           y_sd = as.numeric(temp$y_sd)[1],
                                           theta_value = as.numeric(temp$theta_value)[1],
                                           Type = temp$Type[1],
                                           plot_hierarchy = temp$plot_hierarchy[1]))
  }
}

thetaplot_df1 <- thetaplot_df[thetaplot_df$nc == 1,]

int_matrix16<-data.frame()
for(i in 1:28){
  temp_row<-data.frame(dammy=c(1))
  for(j in 1:16){
    temp <- all_sample_df[all_sample_df$experiment=="main",]
    temp <- temp[temp$bacterial_species_count==2,]
    temp <- temp[temp$bacteria==info$coculture_bacteria_list[i],]
    temp <- temp[temp$environment==info$environment_list[j],]
    temp_row <- cbind(temp_row, data.frame(environment = temp$Type[1]))
  }
  int_matrix16 <- rbind(int_matrix16,temp_row)
}
int_matrix16 <- int_matrix16[1:28,2:17]
int_matrix16 <- set_colnames(x = int_matrix16, value = info$environment_list[1:16])
int_matrix16 <- set_rownames(x = int_matrix16, value = info$coculture_bacteria_list[1:28])



int_matrix16[] <- lapply(int_matrix16, as.factor) # 各列をfactor型に変換
distance_matrix <- daisy(int_matrix16, metric = "dice")
hc <- hclust(as.dist(distance_matrix),method = "average")
par(mar = c(10, 0, 10, 0), pin = c(4, 1))
plot(hc, main = "", xlab = "", sub = "", cex = 0.8,hang=-1)
bac.idx  <- info$coculture_bacteria_list[hc$order]

dev.new()
pdf("FigS7_for_bacteria_dendrogram.pdf")
par(mar = c(10, 0, 10, 0), pin = c(4, 1))
plot(hc, main = "", xlab = "", sub = "", cex = 0.8,labels = FALSE,hang=-1)
dev.off()

dev.new()
pdf("FigS7_for_bacteria_dendrogram_for_species_ref.pdf")
plot(hc, main = "", xlab = "", sub = "", cex = 0.8)
dev.off()



int_matrix16 <- as.data.frame(t(as.matrix(int_matrix16)))
int_matrix16[] <- lapply(int_matrix16, as.factor) # 各列をfactor型に変換

distance_matrix <- daisy(int_matrix16, metric = "dice")

hc <- hclust(as.dist(distance_matrix),method = "average")
plot(hc, main = "", xlab = "", sub = "", cex = 0.8,hang=-1)

dev.new()
pdf("FigS7_for_env_dendrogram.pdf")
par(mar = c(10, 0, 10, 0), pin = c(4, 1))
plot(hc, main = "", xlab = "", sub = "", cex = 0.8,labels = FALSE,hang=-1)
dev.off()

dev.new()
pdf("FigS7_for_env_dendrogram_for_species_ref.pdf")
plot(hc, main = "", xlab = "", sub = "", cex = 0.8)
dev.off()

env.idx  <- info$environment_list[hc$order]

thetaplot_df1$environment  <- factor(thetaplot_df1$environment, levels = env.idx)
thetaplot_df1$bacteria <- factor(thetaplot_df1$bacteria, levels = bac.idx)

g<-ggplot(thetaplot_df1,aes(x=environment,y=bacteria,fill=Type))+
  geom_tile()+
  scale_fill_manual(values=c(color_interaction$mutualism,color_interaction$commensalism,color_interaction$parasitism,color_interaction$amensalism,color_interaction$competition,color_interaction$neutral))+
  theme_pubr()+
  coord_fixed(ratio=1)+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),
                   axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),
                   strip.background = element_rect(fill = "white", colour = "white"),
                   axis.text.x = element_text(size=10,angle = 90, vjust = 0.5, hjust = 1),
                   axis.text.y = element_text(size=10),
                   axis.title = element_blank())
g
ggsave(file="FigS7_tile.pdf",plot=g)
dev.off()
```

## FigS7
```{r}


all_sample_df_temp<-all_sample_df[all_sample_df$bacterial_species_count==2,]
all_sample_df_temp<-all_sample_df_temp[all_sample_df_temp$experiment=="main",]

theta_df<-data.frame()
for(i in 1:28){
  for(j in 1:16){
    temp<-all_sample_df_temp[(all_sample_df_temp$bacteria==info$coculture_bacteria_list[i])&(all_sample_df_temp$environment==info$environment_list[j]),]
    theta_df<-rbind(theta_df,data.frame(theta=temp$theta_value[1],bacteria=info$coculture_bacteria_list[i]),environment=info$environment_list[j])
  }
}

df<-data.frame()
for(i in 1:28){
  df<-rbind(df,data.frame(bacteria=info$coculture_bacteria_list[i],ave=mean(as.numeric(theta_df[theta_df$bacteria==info$coculture_bacteria_list[i],]$theta))))
}

df <- df %>%
  arrange(ave) %>%
  mutate(Theta = row_number())

df$ID=paste("P_",df$Theta,sep = "")
df$Strain_A <- str_extract(df$bacteria, "^[^_]+")
df$Strain_B <- str_extract(df$bacteria, "(?<= - ).*(?=_mScarlet)")

strain<-data.frame(Strain=info$bacteria_list_Phylogenetic[1:8])

strain$pairs<-NA
for(i in 1:nrow(strain)){
  strain$pairs[i]<-c(df[df$Strain_A==strain$Strain[i],]$ID,df[df$Strain_B==strain$Strain[i],]$ID) %>%
  unique() %>%
  paste(.,collapse=",")
}
for(i in 1:nrow(strain)){
  my_tmp<-strain$pairs[i] %>% str_split(pattern = ",") %>% unlist()
  my_df<-data.frame(Strain=strain$Strain[i],ID=my_tmp)
  if(i==1){
    strain_pair_each<-my_df
  }else{
    strain_pair_each<-bind_rows(strain_pair_each,my_df)
  }
}

my_list<-df$Theta
names(my_list)<-df$ID
my_list<-my_list[order(my_list,decreasing = T)]

res_gsea <- GSEA(geneList     = my_list,
              TERM2GENE = strain_pair_each,
               nPerm        = 1000000,
               minGSSize    = 3, # 5
               maxGSSize    = 1000, # 100
               pvalueCutoff = 1, # 0.05
               pAdjustMethod = "BH") #fdr

res_gsea$p.adjust
res_gsea$ID
res_gsea$pvalue


# データフレームの作成
df1 <- data.frame(rep(0, 8))

for(i in 1:27){
  df1 <- cbind(df1, rep(0, 8))
}

# 列名と行名を設定
colnames(df1) <- df$bacteria
rownames(df1) <- info$bacteria_list_Phylogenetic[1:8]

# 各セルに行名の文字列が列名に含まれていれば1を割り当て
for (i in 1:nrow(df1)) {
  for (j in 1:ncol(df1)) {
    row <- rownames(df1)[i]  # 行名を取り出し
    col <- colnames(df1)[j]  # 列名を取り出し
    # 行名が列名に含まれているかチェック
    if (grepl(row, col, fixed = TRUE)) {
      df1[i, j] <- 1
    } else {
      df1[i, j] <- 0
    }
  }
}

SpeDF<-data.frame()
for(i in 1:8){
  for(j in 1:28){
    SpeDF<-rbind(SpeDF,data.frame(y=info$bacteria_list_Phylogenetic[i],x=j,value=df1[i,j]))
  }
}

SpeDF$y <- factor(SpeDF$y, levels = info$bacteria_list_Phylogenetic[8:1])

g<-ggplot(SpeDF,aes(x=as.factor(x),y=y,fill=as.factor(value)))+
  geom_tile()+
  scale_fill_manual(values=c("grey90","grey20"))+
  theme_pubr()+
  coord_fixed(ratio=1)+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),
                   axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),
                   strip.background = element_rect(fill = "white", colour = "white"),
                   axis.text.x = element_text(size=10,angle = 90, vjust = 0.5, hjust = 1),
                   axis.text.y = element_text(size=10),
                   axis.title = element_blank())
g
ggsave(file="FigS8_tile.pdf",plot=g)

#check
p<-c(0.154,0.192,0.476,0.576,0.705,0.100,0.464,0.691)
q<-p.adjust(p,method = "BH")
q

```

## FigS8
```{r}
dev.new()
thetaplot_df<-data.frame()
for(i in 1:28){
  for(j in 1:32){
    temp <- all_sample_df[all_sample_df$experiment=="main",]
    temp <- temp[temp$bacterial_species_count==2,]
    temp <- temp[temp$bacteria==info$coculture_bacteria_list[i],]
    temp <- temp[temp$environment==info$environment_list[j],]
    thetaplot_df <- rbind(thetaplot_df, data.frame(bacteria = info$coculture_bacteria_list[i],
                                           environment = info$environment_list[j],
                                           nc = as.numeric(temp$carbonsource_species_count[1]),
                                           x_value = as.numeric(temp$x_value)[1],
                                           x_sd = as.numeric(temp$x_sd)[1],
                                           y_value = as.numeric(temp$y_value)[1],
                                           y_sd = as.numeric(temp$y_sd)[1],
                                           theta_value = as.numeric(temp$theta_value)[1],
                                           Type = temp$Type[1],
                                           plot_hierarchy = temp$plot_hierarchy[1]))
  }
}

thetaplot_df$environment  <- factor(thetaplot_df$environment, levels = info$environment_list)
thetaplot_df$bacteria <- factor(thetaplot_df$bacteria, levels = info$coculture_bacteria_list)

thetaplot_dfC1 <- thetaplot_df[thetaplot_df$nc == 1,]



g<-ggplot(thetaplot_dfC1,aes(x=environment,y=bacteria,fill=Type))+
  geom_tile()+
  scale_fill_manual(values=c(color_interaction$mutualism,color_interaction$commensalism,color_interaction$parasitism,color_interaction$amensalism,color_interaction$competition,color_interaction$neutral))+
  theme_pubr()+
  coord_fixed(ratio=1)+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),
                   axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),
                   strip.background = element_rect(fill = "white", colour = "white"),
                   axis.text.x = element_text(size=10,angle = 90, vjust = 0.5, hjust = 1),
                   axis.text.y = element_text(size=10),
                   axis.title = element_blank())
g
ggsave(file="FigS9_tile_for_ref.pdf",plot=g)

g<-ggplot(thetaplot_dfC1,aes(x=environment,y=bacteria,fill=Type))+
  geom_tile()+
  scale_fill_manual(values=c(color_interaction$mutualism,color_interaction$commensalism,color_interaction$parasitism,color_interaction$amensalism,color_interaction$competition,color_interaction$neutral))+
  theme_pubr()+
  coord_fixed(ratio=1)+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),
                   legend.position = "none",
                   axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),
                   strip.background = element_rect(fill = "white", colour = "white"),
                   axis.text.x = element_blank(),
                   axis.text.y = element_blank(),
                   axis.title = element_blank())
g
ggsave(file="FigS9_C1_tile.pdf",plot=g)


thetaplot_dfC2 <- thetaplot_df[thetaplot_df$nc == 2,]

g<-ggplot(thetaplot_dfC2,aes(x=environment,y=bacteria,fill=Type))+
  geom_tile()+
  scale_fill_manual(values=c(color_interaction$mutualism,color_interaction$commensalism,color_interaction$parasitism,color_interaction$amensalism,color_interaction$competition,color_interaction$neutral))+
  theme_pubr()+
  coord_fixed(ratio=1/2)+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),
        legend.position = "none",
                   axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),
                   strip.background = element_rect(fill = "white", colour = "white"),
                   axis.text.x = element_blank(),
                   axis.text.y = element_blank(),
                   axis.title = element_blank())
g
ggsave(file="FigS9_C2_tile.pdf",plot=g)

thetaplot_dfC4 <- thetaplot_df[thetaplot_df$nc == 4,]

g<-ggplot(thetaplot_dfC4,aes(x=environment,y=bacteria,fill=Type))+
  geom_tile()+
  scale_fill_manual(values=c(color_interaction$mutualism,color_interaction$commensalism,color_interaction$parasitism,color_interaction$amensalism,color_interaction$competition,color_interaction$neutral))+
  theme_pubr()+
  coord_fixed(ratio=1/4)+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),
        legend.position = "none",
                   axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),
                   strip.background = element_rect(fill = "white", colour = "white"),
                   axis.text.x = element_blank(),
                   axis.text.y = element_blank(),
                   axis.title = element_blank())
g
ggsave(file="FigS9_C4_tile.pdf",plot=g)


thetaplot_dfC8 <- thetaplot_df[thetaplot_df$nc == 8,]

g<-ggplot(thetaplot_dfC8,aes(x=environment,y=bacteria,fill=Type))+
  geom_tile()+
  scale_fill_manual(values=c(color_interaction$parasitism,color_interaction$amensalism,color_interaction$competition,color_interaction$neutral))+
  theme_pubr()+
  coord_fixed(ratio=1/8)+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),
        legend.position = "none",
                   axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),
                   strip.background = element_rect(fill = "white", colour = "white"),
                   axis.text.x = element_blank(),
                   axis.text.y = element_blank(),
                   axis.title = element_blank())
g
ggsave(file="FigS9_C8_tile.pdf",plot=g)


thetaplot_dfC16 <- thetaplot_df[thetaplot_df$nc == 16,]

g<-ggplot(thetaplot_dfC16,aes(x=environment,y=bacteria,fill=Type))+
  geom_tile()+
  scale_fill_manual(values=c(color_interaction$amensalism,color_interaction$competition))+
  theme_pubr()+
  coord_fixed(ratio=1/16)+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),
        legend.position = "none",
                   axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),
                   strip.background = element_rect(fill = "white", colour = "white"),
                   axis.text.x = element_blank(),
                   axis.text.y = element_blank(),
                   axis.title = element_blank())
g
ggsave(file="FigS9_C16_tile.pdf",plot=g)
dev.off()
```

## TableS8
```{r}
all_sample_df_temp <- all_sample_df
all_sample_df_temp <- all_sample_df_temp[all_sample_df_temp$bacterial_species_count==2,]

analysed_df <- data.frame()
for(j in 1:32){
  for (i in 1:28){
    temp<-all_sample_df_temp[all_sample_df_temp$bacteria==info$coculture_bacteria_list[i],]
    temp<-temp[temp$environment==info$environment_list[j],]
    analysed_df <- rbind(analysed_df, data.frame(bacteria=temp$bacteria[1],coculture_species_GFP=temp$coculture_species_GFP[1],coculture_species_mScarlet=temp$coculture_species_mScarlet[1],environment=temp$environment[1],carbonsource_mixed_pair1=temp$carbonsource_mixed_pair1[1],carbonsource_mixed_pair2=temp$carbonsource_mixed_pair2[1],carbonsource_species_count=temp$carbonsource_species_count[1],green_Log2FoldChange=temp$greenaspect_value[1],green_Log2FoldChange=temp$redaspect_value[1],interaction_type=temp$theta_value[1],interaction_class=temp$Type[1]))
  }
}
write_csv(x=analysed_df,file = "TableS8.csv")
```

## FigS9
```{r}
dev.new()
#所々medianと書いてあるが、meanでやっている
#2024

all_sample_df_temp<-all_sample_df[all_sample_df$bacterial_species_count==1,]
all_sample_df_temp<-all_sample_df_temp[all_sample_df_temp$experiment=="main",]

strain_list<-c(info$monoculture_bacteria_list[1],info$monoculture_bacteria_list[3:14],info$monoculture_bacteria_list[16])

medianDF<-data.frame()
for(i in 1:32){
  for(j in 1:14){
    temp<-all_sample_df_temp[all_sample_df_temp$environment==info$environment_list[i]&all_sample_df_temp$bacteria==strain_list[j],]
    #medianDF<-rbind(medianDF,data.frame(env=temp$environment[1],species=temp$monoculture_bacteria[1],strain=temp$bacteria[1],med=if(temp$monoculture_fluorescence[1]=="GFP"){log(temp$green_med[1],10)}else{if(temp$monoculture_fluorescence[1]=="mScarlet"){log(temp$red_med[1],10)}})) #background processed
    medianDF<-rbind(medianDF,data.frame(env=temp$environment[1],nc=temp$carbonsource_species_count[1],species=temp$monoculture_bacteria[1],strain=temp$bacteria[1],med=log(mean(temp$target_fluorescent_cells_density),10))) #raw data
  }
}


KResult<-data.frame()
for(i in 1:8){
  c1<-medianDF[medianDF$species==info$bacteria_list[i],]$species
  c2<-medianDF[medianDF$species==info$bacteria_list[i],]$med
  part1<-data.frame(target_fluorescent_cells_density=c2)
  distance <- dist(part1)
  hc<-hclust(distance,method="ward.D2")
  dev.new()
  pdf(paste("FigS10_dendrogram_",info$bacteria_list[i],".pdf"))
  par(mar = c(10, 0, 10, 0), pin = c(4, 1))
  plot(hc, main = "", xlab = "", sub = "", cex = 0.8,labels = FALSE,hang=-1)
  dev.off()
  #plot(hc)
  hcresult <- cutree(hc,k=2)
  result<-data.frame(target_fluorescent_cells_density=part1$target_fluorescent_cells_density,monoculture_bacteria=c1,hc=hcresult)
  KResult<-rbind(KResult,result)
}


KResult<-data.frame()
for(i in 1:8){
  c1<-medianDF[medianDF$species==info$bacteria_list[i],]$strain
  c11<-medianDF[medianDF$species==info$bacteria_list[i],]$species
  c2<-medianDF[medianDF$species==info$bacteria_list[i],]$med
  c3<-medianDF[medianDF$species==info$bacteria_list[i],]$env
  nc<-medianDF[medianDF$species==info$bacteria_list[i],]$nc
  part1<-data.frame(target_fluorescent_cells_density=c2)
  distance <- dist(part1)
  hc<-hclust(distance,method="ward.D2")
  plot(hc)
  hcresult <- cutree(hc,k=2)
  result<-data.frame(target_fluorescent_cells_density=part1$target_fluorescent_cells_density,monoculture_bacteria=c1,species=c11,hc=hcresult,env=c3,nc=nc)
  KResult<-rbind(KResult,result)
}

KResult[KResult$monoculture_bacteria=="AgT_GFP"&KResult$hc==1,]$hc<-3
KResult[KResult$monoculture_bacteria=="AgT_GFP"&KResult$hc==2,]$hc<-1
KResult[KResult$monoculture_bacteria=="AgT_GFP"&KResult$hc==3,]$hc<-2

KResult[KResult$monoculture_bacteria=="SpP_GFP Tn5"&KResult$hc==1,]$hc<-3
KResult[KResult$monoculture_bacteria=="SpP_GFP Tn5"&KResult$hc==2,]$hc<-1
KResult[KResult$monoculture_bacteria=="SpP_GFP Tn5"&KResult$hc==3,]$hc<-2

KResult[KResult$monoculture_bacteria=="SpP_mScarlet"&KResult$hc==1,]$hc<-3
KResult[KResult$monoculture_bacteria=="SpP_mScarlet"&KResult$hc==2,]$hc<-1
KResult[KResult$monoculture_bacteria=="SpP_mScarlet"&KResult$hc==3,]$hc<-2

KResult$species <- factor(KResult$species, levels = info$bacteria_list_Phylogenetic[1:8])

g<-ggplot()+
  geom_hline(yintercept=log(457000,10),linetype="solid",alpha=0.5,size=1,color='red')+
  geom_violin(data=KResult,mapping=aes(x=species, y=target_fluorescent_cells_density),fill="white",color="black")+
  geom_jitter(data=KResult,mapping=aes(x=species, y=target_fluorescent_cells_density,color=as.factor(hc)),width = 0.35,height = 0,shape=21,stroke=0.8,size=0.8)+
  geom_violin(data=KResult,mapping=aes(x=species, y=target_fluorescent_cells_density),fill=NA,color="black")+
  scale_y_continuous(limits=c(3,10),expand=c(0,0),breaks = c(3,5,7,9))+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  scale_color_manual(values=c("#51829B","#F6995C"))+
  theme_pubr()+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),
        legend.position = "none",
        axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),
        #axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title = element_blank(),
        plot.margin=margin(t = 150, r = 230, b = 0, l = 0, unit = "pt"))
g
ggsave(file="FigS10_cell_density.pdf",plot=g)

g<-ggplot()+
  geom_hline(yintercept=log(457000,10),linetype="solid",alpha=0.5,size=1,color='red')+
  geom_violin(data=KResult,mapping=aes(x=species, y=target_fluorescent_cells_density),fill="white",color="black")+
  geom_jitter(data=KResult,mapping=aes(x=species, y=target_fluorescent_cells_density,color=as.factor(hc)),width = 0.35,height = 0,shape=21,stroke=0.8,size=0.8)+
  geom_violin(data=KResult,mapping=aes(x=species, y=target_fluorescent_cells_density),fill=NA,color="black")+
  scale_y_continuous(limits=c(3,10),expand=c(0,0),breaks = c(3,5,7,9))+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  scale_color_manual(values=c("#51829B","#F6995C"))+
  theme_pubr()+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),
        axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),
        #axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title = element_blank(),
        plot.margin=margin(t = 150, r = 230, b = 0, l = 0, unit = "pt"))
g
ggsave(file="FigS10_cell_density_for_legend.pdf",plot=g)
dev.off()
```

## FigS10
```{r}
#左側に細胞濃度tile plot,右側に生育binの割合変化
#株を種でまとめて良いか？
#平均のラインプロットも載せれたりするけどやめとくか。
dev.new()
all_sample_df_temp<-all_sample_df[all_sample_df$experiment=="main",]


#1
growth_spe<-data.frame()
for(i in 1:8){
  temp<-all_sample_df_temp[all_sample_df_temp$monoculture_bacteria==info$bacteria_list[i],]
  tempc<-data.frame()
  for(j in 1:16){
    tempBE<-temp[temp$environment==info$environment_list[j],]
    #tempBE[is.na(tempBE)]<-0
    #tempBE<-tempBE[tempBE$fcs_file!=0,]
    tempc<-rbind(tempc,data.frame(bacteria=info$bacteria_list[i],env=info$environment_list[j],med=log10(mean(as.numeric(tempBE$background_processing_target_fluorescent_cells_density)))))
  }
  growth_spe<-rbind(growth_spe,tempc)
}
growth_spe<-transform(growth_spe,bacteria=factor(bacteria,levels=info$bacteria_list_Phylogenetic[1:8]))
growth_spe<-transform(growth_spe,env=factor(env,levels=info$environment_list[16:1]))
g1<-ggplot()+
  geom_tile(data=growth_spe,mapping=aes(x=env,y=bacteria,fill=as.numeric(med)),width=0.75)+
  theme_minimal()+
  scale_fill_gradientn("Median", colours = c("grey95","grey5"), na.value = "blue",limit=c(log10(457000),10))+
  #scale_x_discrete(guide = guide_axis(angle = 90),position="top")+
  coord_flip()
g1


#2
growth_spe<-data.frame()
for(i in 1:8){
  temp<-all_sample_df_temp[all_sample_df_temp$monoculture_bacteria==info$bacteria_list[i],]
  tempc<-data.frame()
  for(j in 17:24){
    tempBE<-temp[temp$environment==info$environment_list[j],]
    #tempBE[is.na(tempBE)]<-0
    #tempBE<-tempBE[tempBE$fcs_file!=0,]
    tempc<-rbind(tempc,data.frame(bacteria=info$bacteria_list[i],env=info$environment_list[j],med=log10(mean(as.numeric(tempBE$background_processing_target_fluorescent_cells_density)))))
  }
  growth_spe<-rbind(growth_spe,tempc)
}
growth_spe<-transform(growth_spe,bacteria=factor(bacteria,levels=info$bacteria_list_Phylogenetic[1:8]))
growth_spe<-transform(growth_spe,env=factor(env,levels=info$environment_list[24:17]))
g2<-ggplot()+
  geom_tile(data=growth_spe,mapping=aes(x=env,y=bacteria,fill=as.numeric(med)),width=0.875)+
  scale_fill_gradientn("Median", colours = c("grey95","grey5"), na.value = "blue",limit=c(log10(457000),10))+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  coord_flip()+
  theme_minimal()
#g2

#4
growth_spe<-data.frame()
for(i in 1:8){
  temp<-all_sample_df_temp[all_sample_df_temp$monoculture_bacteria==info$bacteria_list[i],]
  tempc<-data.frame()
  for(j in 25:28){
    tempBE<-temp[temp$environment==info$environment_list[j],]
    #tempBE[is.na(tempBE)]<-0
    #tempBE<-tempBE[tempBE$fcs_file!=0,]
    tempc<-rbind(tempc,data.frame(bacteria=info$bacteria_list[i],env=info$environment_list[j],med=log10(mean(as.numeric(tempBE$background_processing_target_fluorescent_cells_density)))))
  }
  growth_spe<-rbind(growth_spe,tempc)
}
growth_spe<-transform(growth_spe,bacteria=factor(bacteria,levels=info$bacteria_list_Phylogenetic[1:8]))
growth_spe<-transform(growth_spe,env=factor(env,levels=info$environment_list[28:25]))
g4<-ggplot()+
  geom_tile(data=growth_spe,mapping=aes(x=env,y=bacteria,fill=as.numeric(med)),width=0.94)+
  scale_fill_gradientn("Median", colours = c("grey95","grey5"), na.value = "blue",limit=c(log10(457000),10))+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  coord_flip()+
  theme_minimal()
#g4

#8
growth_spe<-data.frame()
for(i in 1:8){
  temp<-all_sample_df_temp[all_sample_df_temp$monoculture_bacteria==info$bacteria_list[i],]
  tempc<-data.frame()
  for(j in 29:30){
    tempBE<-temp[temp$environment==info$environment_list[j],]
    #tempBE[is.na(tempBE)]<-0
    #tempBE<-tempBE[tempBE$fcs_file!=0,]
    tempc<-rbind(tempc,data.frame(bacteria=info$bacteria_list[i],env=info$environment_list[j],med=log10(mean(as.numeric(tempBE$background_processing_target_fluorescent_cells_density)))))
  }
  growth_spe<-rbind(growth_spe,tempc)
}
growth_spe<-transform(growth_spe,bacteria=factor(bacteria,levels=info$bacteria_list_Phylogenetic[1:8]))
growth_spe<-transform(growth_spe,env=factor(env,levels=info$environment_list[30:29]))
g8<-ggplot()+
  geom_tile(data=growth_spe,mapping=aes(x=env,y=bacteria,fill=as.numeric(med)),width=0.97)+
  scale_fill_gradientn("Median", colours = c("grey95","grey5"), na.value = "blue",limit=c(log10(457000),10))+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  coord_flip()+
  theme_minimal()
#g8

#16
growth_spe<-data.frame()
for(i in 1:8){
  temp<-all_sample_df_temp[all_sample_df_temp$monoculture_bacteria==info$bacteria_list[i],]
  tempc<-data.frame()
  for(j in 31:31){
    tempBE<-temp[temp$environment==info$environment_list[j],]
    #tempBE[is.na(tempBE)]<-0
    #tempBE<-tempBE[tempBE$fcs_file!=0,]
    tempc<-rbind(tempc,data.frame(bacteria=info$bacteria_list[i],env=info$environment_list[j],med=log10(mean(as.numeric(tempBE$background_processing_target_fluorescent_cells_density)))))
  }
  growth_spe<-rbind(growth_spe,tempc)
}
growth_spe<-transform(growth_spe,bacteria=factor(bacteria,levels=info$bacteria_list_Phylogenetic[1:8]))
growth_spe<-transform(growth_spe,env=factor(env,levels=info$environment_list[31]))
g16<-ggplot()+
  geom_tile(data=growth_spe,mapping=aes(x=env,y=bacteria,fill=as.numeric(med)),width=1)+
  scale_fill_gradientn("Median", colours = c("grey95","grey5"), na.value = "blue",limit=c(log10(457000),10))+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  coord_flip()+
  theme_minimal()
#g16

#barplot, ここ不要。info$carbonsource_species_listもいらない。
growth_spe<-data.frame()
for(i in 1:8){
  temp<-all_sample_df_temp[all_sample_df_temp$monoculture_bacteria==info$bacteria_list[i],]
  tempc<-data.frame()
  for(j in 1:31){
    tempBE<-temp[temp$environment==info$environment_list[j],]
    #tempBE[is.na(tempBE)]<-0
    #tempBE<-tempBE[tempBE$fcs_file!=0,]
    tempc<-rbind(tempc,data.frame(bacteria=info$bacteria_list[i],env=info$environment_list[j],med=log10(median(as.numeric(tempBE$background_processing_target_fluorescent_cells_density)))[1],c=info$carbonsource_species_list[j]))
  }
  growth_spe<-rbind(growth_spe,tempc)
}

par<-data.frame()
meanDF<-data.frame()
for(i in c(1,2,4,8,16)){
  temp<-growth_spe[growth_spe$c==i,]
  par<-rbind(par,data.frame(num=i,percentage=length(temp[temp$med<log10(5540001),]$c)/length(temp$c),den=1))
  par<-rbind(par,data.frame(num=i,percentage=length(temp[(temp$med>log10(5540001))&(temp$med<8),]$c)/length(temp$c),den=2))
  par<-rbind(par,data.frame(num=i,percentage=length(temp[(temp$med>8)&(temp$med<9),]$c)/length(temp$c),den=3))
  par<-rbind(par,data.frame(num=i,percentage=length(temp[(temp$med>9)&(temp$med<10),]$c)/length(temp$c),den=4))
  par<-rbind(par,data.frame(num=i,percentage=length(temp[temp$med>10,]$c)/length(temp$c),den=5))
  meanDF<-rbind(meanDF,data.frame(num=i,mean=mean(temp$med),den=1))
}

# 左軸: y1 0-4 が右軸y2 100-300に対応するようなスケーリング
yaxis1 <- c(0, 1)
yaxis2 <- c(6, 10)

#------------------------------------------------------
# variabel_scaler(y2, yaxis1, yaxis2)
#   y2             :  y2軸に示すデータ
#   yaxis1, yaxis2 :　y1軸とy2軸の対応
#   戻り値         :  y2の値をy1軸相当の位置にした値
#-------------------------------------------------------
variable_scaler <- function(y2, yaxis1, yaxis2){
  a <- (yaxis1[2] - yaxis1[1]) / (yaxis2[2] - yaxis2[1])
  b <- (yaxis1[1] * yaxis2[2] - yaxis1[2] * yaxis2[1]) / (yaxis2[2] - yaxis2[1])
  ret <- a * y2 + b
  ret
}

#------------------------------------------------------
# axis_scaler(y1, yaxis1, yaxis2)
#   y1             :  y1軸の値（sec_axis()の"."）
#   yaxis1, yaxis2 :　y1軸とy2軸の対応
#   戻り値         :  y2の値をy1軸相当の位置にした値
#-------------------------------------------------------
axis_scaler <- function(y1, yaxis1, yaxis2){
  c <- (yaxis2[2] - yaxis2[1]) / (yaxis1[2] - yaxis1[1])
  d <- (yaxis2[1] * yaxis1[2] - yaxis2[2] * yaxis1[1]) / (yaxis1[2] - yaxis1[1])
  ret <- c * y1 + d
  ret
}



par<-transform(par,den=factor(den,levels=c(5,4,3,2,1)))
par<-transform(par,num=factor(num,levels=c(1,2,4,8,16)))
meanDF<-transform(meanDF,num=factor(num,levels=c(1,2,4,8,16)))
gbar<-ggplot()+
  #geom_bar(data=par,mapping=aes(x=as.factor(num),y=percentage,fill=as.factor(den)),stat = "identity", position = "fill",width=0.9)+
  geom_bar(data=par,mapping=aes(x=as.factor(num),y=percentage,fill=as.factor(den)),stat = "identity", position = "fill",width=0.8)+
  #geom_point(data=meanDF,mapping=aes(x=as.factor(num),y=variable_scaler(mean, yaxis1, yaxis2)),fill="black",stat = "identity",shape=21,stroke=0)+
  #geom_line(data=meanDF,mapping=aes(x=as.factor(num),y=variable_scaler(mean, yaxis1, yaxis2),group=den),color="black",stat = "identity")+
  #geom_point(data=par[par$den==1,],mapping=aes(x=as.factor(num),y=percentage),fill="darkred",stat = "identity",shape=21,stroke=0)+
  #geom_line(data=par[par$den==1,],mapping=aes(x=as.factor(num),y=percentage,group=den),color="darkred",stat = "identity")+
  scale_fill_manual(values =c("black","grey30","grey50","grey70","darkred"))+
  scale_y_continuous(labels = scales::percent,breaks=c(0,0.25,0.5,0.75,1),expand=c(0.05,0.05))#+
  #scale_y_continuous(labels = scales::percent,breaks=c(0,0.25,0.5,0.75,1),expand=c(0.05,0.05),sec.axis = sec_axis(  ~(axis_scaler(., yaxis1, yaxis2)), name = "mean"))+ 
  #coord_flip()
gbar


panel.blank <- ggplot()
panel.blank <- panel.blank + geom_point(aes(1, 1), colour = "white")
panel.blank <- panel.blank + theme(plot.background = element_rect(colour = "white"),
                panel.grid.major = element_blank(),
                                   panel.grid.minor = element_blank(),
                                   panel.border = element_blank(),
                                   panel.background = element_blank(),
                                   axis.title.x = element_blank(),
                                   axis.title.y = element_blank(),
                                   axis.text.x = element_blank(),
                                   axis.text.y = element_blank(),
                                   axis.ticks = element_blank())
layout1<-rbind(c(8,1,2,3,4,5,9,7),c(6,6,6,6,6,6,6,7))

g<-gridExtra::grid.arrange(
  #g1+theme_void()+theme(axis.text.x = element_text(angle=90,size=8),axis.text.y = element_text(angle=80,size=8),axis.title.x = element_blank(),axis.title.y = element_blank(),legend.position = "none",title = element_blank()),
  g1+theme_void()+theme(axis.title.x = element_blank(),axis.title.y = element_blank(),legend.position = "none",title = element_blank(),plot.margin=margin(t = 14.3, r = 15, b = 14.02, l = 0, unit = "pt")),
  g2+theme_void()+theme(axis.title.x = element_blank(),axis.title.y = element_blank(),legend.position = "none",title = element_blank(),plot.margin=margin(t = 13, r = 15, b = 13, l = 0, unit = "pt")),
  g4+theme_void()+theme(axis.title.x = element_blank(),axis.title.y = element_blank(),legend.position = "none",title = element_blank(),plot.margin=margin(t = 11.03, r = 15, b = 11.03, l = 0, unit = "pt")),
  g8+theme_void()+theme(axis.title.x = element_blank(),axis.title.y = element_blank(),legend.position = "none",title = element_blank(),plot.margin=margin(t = 6.83, r = 15, b = 6.83, l = 0, unit = "pt")),
  g16+theme_void()+theme(axis.title.x = element_blank(),axis.title.y = element_blank(),legend.position = "none",title = element_blank(),plot.margin=margin(t = 0, r = 15, b = 0, l = 0, unit = "pt")),
  gbar+theme_pubr()+scale_y_continuous(labels = scales::percent,breaks=c(0,0.5,1),expand=c(0,0))+theme(axis.text.x = element_text(size=12),axis.title.x = element_blank(),axis.title.y = element_blank(),legend.position = "none",title = element_blank(),plot.margin=margin(t = 0, r = 0, b = 50, l = 0, unit = "pt"),axis.line = element_line(size=0.5,lineend="square",color="grey20"),axis.ticks = element_line(size=0.5,lineend="square",color="grey20")),
  panel.blank,panel.blank,panel.blank,
  layout_matrix=layout1,
  widths = c(0,1,1,1,1,1,0,1.305),
  heights = c(1.90,1))
plot(g)

ggsave(file = paste("FigS11_all_","cell_density_tile.pdf"), plot = g)
ggsave(file = paste("FigS11_all_","cell_density_tile_for_legend.pdf"), plot = g1)
#ggsave(file = paste("all_","cell_density_bar_for_legend.png"), plot = gbar)
dev.off()
```

## Enrichment analysis using all dataset
```{r}
dev.new()
my_type<-c("Mutualism","Commensalism","Parasitism","Amensalism","Competition","Neutral")

all_sample_df_temp<-all_sample_df[all_sample_df$experiment=="main",]
all_sample_df_temp<-all_sample_df_temp[all_sample_df_temp$bacterial_species_count==2,]
intmap<-data.frame()
id<-0

for (i in 1:32){
  tempe<-all_sample_df_temp[all_sample_df_temp$environment==info$environment_list[i],]
  for (j in 1:28){
    id <- id + 1
    tempeb<-tempe[tempe$bacteria==info$coculture_bacteria_list[j],]
    intmap<-rbind(intmap,data.frame(ID=id,interaction_type=tempeb$Type[1],Nb_cs=tempeb$carbonsource_species_count[1],level_G=tempeb$greenHD[1],level_R=tempeb$redHD[1]))
  }
}

my_df<-intmap
my_df$UorL<-"Upper & Lower"
my_df[my_df$level_G==1&my_df$level_R==1,]$UorL<-"Lower & Lower"
my_df[my_df$level_G==2&my_df$level_R==2,]$UorL<-"Upper & Upper"
my_df$UorL<-factor(my_df$UorL,levels=c("Lower & Lower","Upper & Lower", "Upper & Upper"))
my_df$frac<-1
# my_fillcolor<-my_color_df[my_color_df$interaction_type %in% my_df$interaction_type,]$color
my_df$interaction_type<-factor(my_df$interaction_type,levels = my_type)
my_df$Nb_cs<-factor(my_df$Nb_cs,levels = c(0,1,2,4,8,16))
my_nbs<-c(0,1,2,4,8,16)
k<-1

for (i in 1:length(my_nbs)){
  my_univ<-my_df[my_df$Nb_cs==my_nbs[i],] %>% select(interaction_type,ID)
  my_subset<-my_df[(my_df$UorL %in% c("Upper & Lower","Lower & Lower"))&(my_df$Nb_cs==my_nbs[i]),]$ID
  if(length(my_subset)>0){
    my_res<-enricher(gene = my_subset,TERM2GENE =  my_univ,pvalueCutoff = 1,minGSSize = 1)
    my_res<-my_res@result
    my_res$Nb_cs<-my_nbs[i]
    my_res$UorL<-"Upr-Lwr or Lwr-Lwr"
    if(k==1){
      my_res_df<-my_res
      k<-k+1
    }else{
      my_res_df<-bind_rows(my_res_df,my_res)
    }
  }
}

for (i in 1:length(my_nbs)){
  my_univ<-my_df[my_df$Nb_cs==my_nbs[i],] %>% select(interaction_type,ID)
  my_subset<-my_df[(my_df$UorL %in% c("Upper & Upper"))&(my_df$Nb_cs==my_nbs[i]),]$ID
  if(length(my_subset)>0){
    my_res<-enricher(gene = my_subset,TERM2GENE =  my_univ,pvalueCutoff = 1,minGSSize = 1)
    my_res<-my_res@result
    my_res$Nb_cs<-my_nbs[i]
    my_res$UorL<-"Upr-Upr"
    my_res_df<-bind_rows(my_res_df,my_res)
  }
}
print(my_res_df)


rownames(my_res_df)<-seq(1,nrow(my_res_df))
my_q<-qvalue(my_res_df$pvalue)
my_res_df$qvalue_all<-my_q$qvalues
my_res_df<-my_res_df %>% select(Nb_cs,qvalue_all,UorL,everything())
my_res_df<-my_res_df[order(my_res_df$qvalue_all),]
#my_res_df.sig<-my_res_df[my_res_df$qvalue_all<1,] #Show enriched categories with statistical significance (q<0.05)
my_res_df.sig<-my_res_df
my_res_df.sig<-my_res_df.sig %>% select(UorL,Nb_cs,ID,qvalue_all,pvalue)
colnames(my_res_df.sig)<-c("Pair","# of carbon sources","Int. classification", "q-value","p-value")
my_res_df.sig$`Int. classification`<-factor(my_res_df.sig$`Int. classification`,levels=my_type)
my_res_df.sig<-my_res_df.sig[order(my_res_df.sig$`Int. classification`),]
my_res_df.sig<-my_res_df.sig[order(my_res_df.sig$`# of carbon sources`),]
ggtexttable(my_res_df.sig, rows = NULL)
dev.off()
```

## FigS11
```{r}
dev.new()

all_sample_df_temp<-all_sample_df[all_sample_df$bacterial_species_count==2,]
all_sample_df_temp<-all_sample_df_temp[all_sample_df_temp$experiment=="main",]
all_sample_df_temp<-all_sample_df_temp[all_sample_df_temp$environment!="water",]

temp<-data.frame()
for(i in 1:length(all_sample_df_temp$fcs_file)){
  if((mean(as.numeric(all_sample_df_temp$green_max[i]),as.numeric(all_sample_df_temp$green_med[i]),as.numeric(all_sample_df_temp$green_min[i]))!=457000)&&(mean(as.numeric(all_sample_df_temp$red_max[i]),as.numeric(all_sample_df_temp$red_med[i]),as.numeric(all_sample_df_temp$red_min[i]))!=457000)){temp<-rbind(temp,all_sample_df_temp[i,])}
}

all_sample_df_temp<-temp

EE<-all_sample_df_temp[all_sample_df_temp$greenHD=="2"&all_sample_df_temp$redHD=="2",]
temp<-data.frame()
for(i in 1:6){
  tempEH<-EE[EE$Type==info$interaction_types_list[i],]
  for(j in c(1,2,4,8,16)){
    tempEHc<-tempEH[tempEH$carbonsource_species_count==j,]
    temp<-rbind(temp,data.frame(carbonsource_species_count=j,Type=info$interaction_types_list[i],count=length(tempEHc$fcs_file)))
  }
}
EE<-temp
EE<-transform(EE, Type= factor(Type, levels = info$interaction_types_list))
EE<-transform(EE, carbonsource_species_count= factor(carbonsource_species_count, levels = c("1","2","4","8","16")))
  
g<-ggplot(data=EE)+
  geom_histogram(mapping=aes(x=carbonsource_species_count,y=count/3,fill=Type),position = "stack",stat = "identity",width = 0.8)+
  scale_y_continuous(limits=c(0,150),breaks = c(0,50,100,150),expand = c(0,0))+
  theme_minimal()+
  # theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),legend.position = "none",axis.title = element_blank(),axis.text = element_text(size=15),plot.margin=margin(t = 150, r = 230, b = 0, l = 0, unit = "pt"))+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),legend.position = "none",axis.title = element_blank(),axis.text = element_text(size=15),plot.margin=margin(t = 150, r = 330, b = 0, l = 0, unit = "pt"))+
  scale_fill_manual(values=c(color_interaction$mutualism,color_interaction$commensalism,color_interaction$parasitism,color_interaction$amensalism,color_interaction$competition,color_interaction$neutral))
g 
ggsave(file = "Fig4B_EE.pdf", plot = g)

g<-ggplot(data=EE)+
  geom_histogram(mapping=aes(x=carbonsource_species_count,y=count/3,fill=Type),position = "stack",stat = "identity",width = 0.8)+
  scale_y_continuous(limits=c(0,150),breaks = c(0,50,100,150),expand = c(0,0))+
  theme_minimal()+
  # theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),axis.title = element_blank(),axis.text = element_text(size=15),plot.margin=margin(t = 150, r = 230, b = 0, l = 0, unit = "pt"))+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),legend.position = "none",axis.title = element_blank(),axis.text = element_text(size=15),plot.margin=margin(t = 150, r = 330, b = 0, l = 0, unit = "pt"))+
  scale_fill_manual(values=c(color_interaction$mutualism,color_interaction$commensalism,color_interaction$parasitism,color_interaction$amensalism,color_interaction$competition,color_interaction$neutral))
g 
ggsave(file = "Fig4B_EE_for_legend.pdf", plot = g)

  
EH_HH<-all_sample_df_temp[(all_sample_df_temp$greenHD=="1"&all_sample_df_temp$redHD=="1")|(all_sample_df_temp$greenHD=="2"&all_sample_df_temp$redHD=="1")|(all_sample_df_temp$greenHD=="1"&all_sample_df_temp$redHD=="2"),]
temp<-data.frame()
for(i in 1:6){
  tempEH<-EH_HH[EH_HH$Type==info$interaction_types_list[i],]
  for(j in c(1,2,4,8,16)){
    tempEHc<-tempEH[tempEH$carbonsource_species_count==j,]
    temp<-rbind(temp,data.frame(carbonsource_species_count=j,Type=info$interaction_types_list[i],count=length(tempEHc$fcs_file)))
  }
}
EH_HH<-temp
EH_HH<-transform(EH_HH, Type= factor(Type, levels = info$interaction_types_list))
EH_HH<-transform(EH_HH, carbonsource_species_count= factor(carbonsource_species_count, levels = c("1","2","4","8","16")))
  
g<-ggplot(data=EH_HH)+
  geom_histogram(mapping=aes(x=carbonsource_species_count,y=count/3,fill=Type),position = "stack",stat = "identity",width = 0.8)+
  scale_y_continuous(limits=c(0,150),breaks = c(0,50,100,150),expand = c(0,0))+
  theme_minimal()+
  # theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),legend.position = "none",axis.title = element_blank(),axis.text = element_text(size=15),plot.margin=margin(t = 150, r = 230, b = 0, l = 0, unit = "pt"))+
  theme(axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),legend.position = "none",axis.title = element_blank(),axis.text = element_text(size=15),plot.margin=margin(t = 150, r = 330, b = 0, l = 0, unit = "pt"))+
  scale_fill_manual(values=c(color_interaction$mutualism,color_interaction$commensalism,color_interaction$parasitism,color_interaction$amensalism,color_interaction$competition,color_interaction$neutral))
g 
ggsave(file = "Fig4B_H.pdf", plot = g)
dev.off()
```

## FigS13
```{r}
dev.new()
#少数炭素源・単培養の細胞濃度から、それら炭素源を混ぜた時の細胞濃度の予想と比較

#2024
all_sample_df_temp<-all_sample_df[all_sample_df$bacterial_species_count==1,]
all_sample_df_temp<-all_sample_df_temp[all_sample_df_temp$experiment=="main",]
strain_list<-c(info$monoculture_bacteria_list[1],info$monoculture_bacteria_list[3:14],info$monoculture_bacteria_list[16])

#少数炭素源・単培養の細胞濃度から、それら炭素源を混ぜた時の細胞濃度の予想と比較、1->2
mix2Ave<-data.frame()
for(i in 17:24){
  tempE<-all_sample_df_temp[all_sample_df_temp$environment==info$environment_list[i],]
  temp1<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair1[1],]
  temp2<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair2[1],]
  
  for(j in 1:14){
    #tempEB<-median(tempE[tempE$monoculture_bacteria==info$bacteria_list[j],]$background_processing_target_fluorescent_cells_density)
    temp1B<-as.numeric(temp1[temp1$bacteria==strain_list[j],]$final_OD)
    temp2B<-as.numeric(temp2[temp2$bacteria==strain_list[j],]$final_OD)
    cmono<-c(temp1B,temp2B)
    ave12<-mean(cmono)
    sdmean<-mean(c(var(temp1B),var(temp2B)))^0.5

    tempY<-c(ave12-sdmean,ave12,ave12+sdmean)
    
    tempEBc<-as.numeric(tempE[tempE$bacteria==strain_list[j],]$final_OD)
    if(var(tempEBc)==0){
      if(tempEBc[1]==ave12){
        ptemp<-1
      }else{
        ptemp<-0
      }
      for(k in 1:length(tempEBc)){
        mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=ptemp))
      }
    }else{
      
      t<-t.test(x=tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for(k in 1:length(tempEBc)){
          mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=t$p.value))
      }
    }
  }
}

qvalue<-p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave<-cbind(mix2Ave,qvalue)

medDF<-data.frame()
for(i in 17:24){
  for(j in 1:14){
    temp<-mix2Ave[(mix2Ave$env==info$environment_list[i])&(mix2Ave$bacteria==strain_list[j]),]
    medDF<-rbind(medDF,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),ave12=temp$ave12[1],med=mean(temp$value),"sdx"=temp$sdx[1],"sdy"=temp$sdy[1],p=if(temp$qvalue[1]<0.05){1}else{0},pp=if((temp$qvalue[1]<0.05)&(mean(temp$value)>temp$ave12[1])){"high"}else{if((temp$qvalue[1]<0.05)&(mean(temp$value)<temp$ave12[1])){"low"}else{"same"}}))
    
  }
}

temphigh<-0
tempsame<-0
templow<-0
for(i in 1:length(medDF$envbac)){
  if(medDF$p[i]==0){
    tempsame<-tempsame+1
  }else{
    if(medDF$p[i]==1){
      if(medDF$ave12[i]>medDF$med[i]){
        templow<-templow+1
      }else{
        if(medDF$ave12[i]<medDF$med[i]){
          temphigh<-temphigh+1
        }
      }
    }
  }
}
#積み上げ棒グラフ
judge<-c("Scenario3","Scenario1","Scenario2")
judge2<-c(templow,tempsame,temphigh)
count<-data.frame(x1=1,Type=judge,count1=judge2)
c<-c()
c1<-c()
for(k in 1:3){
  #c<-c(c,paste(round(count$count1[i]/sum(count$count1)*100,1),"%\n",info$interaction_types_list[(7-i)],sep=""))
  c<-c(c,if(count$count1[k]/sum(count$count1)<0.1){paste(" ",format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")}else{paste(format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")})
  c1<-c(c1,count$count1[k]/sum(count$count1))
}
count<-cbind(count,c,c1)
      
count<-transform(count, Type= factor(Type, levels = c("Scenario2","Scenario1","Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))
      
g<-ggplot(data=count,mapping=aes(x=as.factor(x1),y=c1,fill=Type))+geom_bar(stat = "identity", position = "fill",width=0.15)+
        geom_text(aes(label = c, y = pos), size = 13,hjust=-0.6)+
        #geom_text(aes(label = Type, y = pos), size = 8)+
        #theme_minimal()+
        theme_void()+
        #scale_y_continuous(labels = scales::percent,breaks=c(0,0.25,0.5,0.75,1),expand=c(0,0))+
        #coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
        scale_fill_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))#+
        #theme(title = element_blank(),axis.text = element_text(size=12),axis.title.x = element_blank(),axis.title.y = element_blank())
g
ggsave(file = paste("FigS14A_","carbonmix_prediction_1to2_bar.pdf"), plot = g)

mix2Ave<-transform(mix2Ave,bacteria=factor(bacteria,levels=strain_list))
df1=data.frame(x1=0,y1=0,x2=0.8,y2=0.8)
g<-ggplot(mix2Ave,aes(x=ave12,y=value,color=bacteria))+geom_point(size=2.5)+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",data=df1,linewidth=0.75,linetype="dotted")+scale_x_continuous(limits=c(0,0.8))+scale_y_continuous(limits=c(0,0.8))+labs(x="Mean prediction (cells / mL)",y="Observed (cells / mL)",title=paste("1->2 high",temphigh,"same",tempsame,"low",templow))+theme(legend.position = "none")
g
medDF<-transform(medDF,pp=factor(pp,levels=c("high","same","low")))
df1=data.frame(x1=0,y1=0,x2=0.8,y2=0.8)

g<-ggplot(medDF,aes(x=ave12,y=med,color=as.factor(pp)))+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="grey20",data=df1,linewidth=0.75,linetype="dotted")+
  geom_point(size=1.5)+scale_x_continuous(limits=c(0,0.8),expand=c(0,0))+
  scale_y_continuous(limits=c(0,0.8),expand=c(0,0))+
  theme_minimal()+
  theme(legend.position = "none",title = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),axis.title = element_blank(),axis.text = element_blank(),plot.margin=margin(t = 160, r = 160, b = 0, l = 0, unit = "pt"))+
  scale_color_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for(i in 1:length(medDF$envbac)){
  temp<-medDF[i,]
  errorDFx<-data.frame(x1=(temp$ave12-temp$sdx),y1=temp$med,x2=(temp$ave12+temp$sdx),y2=temp$med)
  errorDFy<-data.frame(x1=temp$ave12,y1=(temp$med-temp$sdy),x2=temp$ave12,y2=(temp$med+temp$sdy))
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFx,linewidth=0.2,linetype="solid")
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFy,linewidth=0.2,linetype="solid")
}
g
ggsave(file = paste("FigS14A_carbonmix_prediction_1to2.pdf"), plot = g)

g<-ggplot(medDF,aes(x="1",y=med/ave12))+geom_hline(yintercept = 1, linetype="dotted", linewidth=1.2)+geom_boxplot(outlier.shape=NA,width=0.4,color="grey5")+geom_dotplot(binaxis="y",dotsize=0.65,alpha=0.5,fill=NA, binwidth=0.15, stackdir="center",color="black")+scale_y_continuous(trans="log10",limits=c(0.01,100),expand=c(0,0))+labs(y="Observed/Prediction")+theme_minimal()+theme(legend.position = "none",plot.margin=margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"))
g
ggsave(file = paste("FigS14_carbonmix_prediction_1to2_box.pdf"), plot = g)




















#少数炭素源・単培養の細胞濃度から、それら炭素源を混ぜた時の細胞濃度の予想と比較、1->4
mix2Ave<-data.frame()
for(i in 25:28){
  tempE<-all_sample_df_temp[all_sample_df_temp$environment==info$environment_list[i],]
  temp1<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair1[1],]
  temp2<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair2[1],]
  temp11<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair1[1],]
  temp12<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair2[1],]
  temp21<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair1[1],]
  temp22<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair2[1],]
  
  for(j in 1:14){
    #tempEB<-median(tempE[tempE$monoculture_bacteria==info$bacteria_list[j],]$final_OD)
    temp11B<-as.numeric(temp11[temp11$bacteria==strain_list[j],]$final_OD)
    temp12B<-as.numeric(temp12[temp12$bacteria==strain_list[j],]$final_OD)
    temp21B<-as.numeric(temp21[temp21$bacteria==strain_list[j],]$final_OD)
    temp22B<-as.numeric(temp22[temp22$bacteria==strain_list[j],]$final_OD)
    
    c<-c(temp11B,temp12B,temp21B,temp22B)
    ave12<-mean(c)
    sdmean<-mean(c(var(temp11B),var(temp12B),var(temp21B),var(temp22B)))^0.5

    tempY<-c(ave12-sdmean,ave12,ave12+sdmean)
    
    tempEBc<-as.numeric(tempE[tempE$bacteria==strain_list[j],]$final_OD)
    if(var(tempEBc)==0){
      if(tempEBc[1]==ave12){
        ptemp<-1
      }else{
        ptemp<-0
      }
      for(k in 1:length(tempEBc)){
        mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=ptemp))
      }
    }else{
      
      t<-t.test(x=tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for(k in 1:length(tempEBc)){
          mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=t$p.value))
      }
    }
  }
}

qvalue<-p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave<-cbind(mix2Ave,qvalue)

medDF<-data.frame()
for(i in 25:28){
  for(j in 1:14){
    temp<-mix2Ave[(mix2Ave$env==info$environment_list[i])&(mix2Ave$bacteria==strain_list[j]),]
    medDF<-rbind(medDF,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),ave12=temp$ave12[1],med=mean(temp$value),"sdx"=temp$sdx[1],"sdy"=temp$sdy[1],p=if(temp$qvalue[1]<0.05){1}else{0},pp=if((temp$qvalue[1]<0.05)&(mean(temp$value)>temp$ave12[1])){"high"}else{if((temp$qvalue[1]<0.05)&(mean(temp$value)<temp$ave12[1])){"low"}else{"same"}}))
  }
}



temphigh<-0
tempsame<-0
templow<-0
for(i in 1:length(medDF$envbac)){
  if(medDF$p[i]==0){
    tempsame<-tempsame+1
  }else{
    if(medDF$p[i]==1){
      if(medDF$ave12[i]>medDF$med[i]){
        templow<-templow+1
      }else{
        if(medDF$ave12[i]<medDF$med[i]){
          temphigh<-temphigh+1
        }
      }
    }
  }
}
#積み上げ棒グラフ
judge<-c("Scenario3","Scenario1","Scenario2")
judge2<-c(templow,tempsame,temphigh)
count<-data.frame(x1=1,Type=judge,count1=judge2)
c<-c()
c1<-c()
for(k in 1:3){
  #c<-c(c,paste(round(count$count1[i]/sum(count$count1)*100,1),"%\n",info$interaction_types_list[(7-i)],sep=""))
  c<-c(c,if(count$count1[k]/sum(count$count1)<0.1){paste(" ",format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")}else{paste(format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")})
  c1<-c(c1,count$count1[k]/sum(count$count1))
}
count<-cbind(count,c,c1)
      
count<-transform(count, Type= factor(Type, levels = c("Scenario2","Scenario1","Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))
      
g<-ggplot(data=count,mapping=aes(x=as.factor(x1),y=c1,fill=Type))+geom_bar(stat = "identity", position = "fill",width=0.15)+
        geom_text(aes(label = c, y = pos), size = 13,hjust=-0.6)+
        #geom_text(aes(label = Type, y = pos), size = 8)+
        #theme_minimal()+
        theme_void()+
        #scale_y_continuous(labels = scales::percent,breaks=c(0,0.25,0.5,0.75,1),expand=c(0,0))+
        #coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
        scale_fill_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))#+
        #theme(title = element_blank(),axis.text = element_text(size=12),axis.title.x = element_blank(),axis.title.y = element_blank())
g
ggsave(file = paste("FigS14B__","carbonmix_prediction_1to4_bar.pdf"), plot = g)

mix2Ave<-transform(mix2Ave,bacteria=factor(bacteria,levels=strain_list))
df1=data.frame(x1=0,y1=0,x2=0.8,y2=0.8)
g<-ggplot(mix2Ave,aes(x=ave12,y=value,color=bacteria))+geom_point(size=2.5)+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",data=df1,linewidth=0.75,linetype="dotted")+scale_x_continuous(limits=c(0,0.8))+scale_y_continuous(limits=c(0,0.8))+labs(x="Mean prediction (cells / mL)",y="Observed (cells / mL)",title=paste("1->2 high",temphigh,"same",tempsame,"low",templow))+theme(legend.position = "none")
g
medDF<-transform(medDF,pp=factor(pp,levels=c("high","same","low")))
df1=data.frame(x1=0,y1=0,x2=0.8,y2=0.8)
g<-ggplot(medDF,aes(x=ave12,y=med,color=as.factor(pp)))+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="grey20",data=df1,linewidth=0.75,linetype="dotted")+
  geom_point(size=1.5)+scale_x_continuous(limits=c(0,0.8),expand=c(0,0))+
  scale_y_continuous(limits=c(0,0.8),expand=c(0,0))+
  theme_minimal()+
  theme(legend.position = "none",title = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),axis.title = element_blank(),axis.text = element_blank(),plot.margin=margin(t = 160, r = 160, b = 0, l = 0, unit = "pt"))+
  scale_color_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for(i in 1:length(medDF$envbac)){
  temp<-medDF[i,]
  errorDFx<-data.frame(x1=(temp$ave12-temp$sdx),y1=temp$med,x2=(temp$ave12+temp$sdx),y2=temp$med)
  errorDFy<-data.frame(x1=temp$ave12,y1=(temp$med-temp$sdy),x2=temp$ave12,y2=(temp$med+temp$sdy))
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFx,linewidth=0.2,linetype="solid")
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFy,linewidth=0.2,linetype="solid")
}
g
ggsave(file = paste("FigS14B_carbonmix_prediction_1to4.pdf"), plot = g)

g<-ggplot(medDF,aes(x="1",y=med/ave12))+geom_hline(yintercept = 1, linetype="dotted", linewidth=1.2)+geom_boxplot(outlier.shape=NA,width=0.4,color="grey5")+geom_dotplot(binaxis="y",dotsize=0.65,alpha=0.5,fill=NA, binwidth=0.15, stackdir="center",color="black")+scale_y_continuous(trans="log10",limits=c(0.01,100),expand=c(0,0))+labs(y="Observed/Prediction")+theme_minimal()+theme(legend.position = "none",plot.margin=margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"))
g
ggsave(file = paste("FigS14_carbonmix_prediction_1to4_box.pdf"), plot = g)












#少数炭素源・単培養の細胞濃度から、それら炭素源を混ぜた時の細胞濃度の予想と比較、1->8
mix2Ave<-data.frame()
for(i in 29:30){
  tempE<-all_sample_df_temp[all_sample_df_temp$environment==info$environment_list[i],]
  temp1<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair1[1],]
  temp2<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair2[1],]
  temp11<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair1[1],]
  temp12<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair2[1],]
  temp21<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair1[1],]
  temp22<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair2[1],]
  temp111<-all_sample_df_temp[all_sample_df_temp$environment==temp11$carbonsource_mixed_pair1[1],]
  temp112<-all_sample_df_temp[all_sample_df_temp$environment==temp11$carbonsource_mixed_pair2[1],]
  temp121<-all_sample_df_temp[all_sample_df_temp$environment==temp12$carbonsource_mixed_pair1[1],]
  temp122<-all_sample_df_temp[all_sample_df_temp$environment==temp12$carbonsource_mixed_pair2[1],]
  temp211<-all_sample_df_temp[all_sample_df_temp$environment==temp21$carbonsource_mixed_pair1[1],]
  temp212<-all_sample_df_temp[all_sample_df_temp$environment==temp21$carbonsource_mixed_pair2[1],]
  temp221<-all_sample_df_temp[all_sample_df_temp$environment==temp22$carbonsource_mixed_pair1[1],]
  temp222<-all_sample_df_temp[all_sample_df_temp$environment==temp22$carbonsource_mixed_pair2[1],]
  
  for(j in 1:14){
    #tempEB<-median(tempE[tempE$monoculture_bacteria==info$bacteria_list[j],]$final_OD)
    temp111B<-as.numeric(temp111[temp111$bacteria==strain_list[j],]$final_OD)
    temp112B<-as.numeric(temp112[temp112$bacteria==strain_list[j],]$final_OD)
    temp121B<-as.numeric(temp121[temp121$bacteria==strain_list[j],]$final_OD)
    temp122B<-as.numeric(temp122[temp122$bacteria==strain_list[j],]$final_OD)
    temp211B<-as.numeric(temp211[temp211$bacteria==strain_list[j],]$final_OD)
    temp212B<-as.numeric(temp212[temp212$bacteria==strain_list[j],]$final_OD)
    temp221B<-as.numeric(temp221[temp221$bacteria==strain_list[j],]$final_OD)
    temp222B<-as.numeric(temp222[temp222$bacteria==strain_list[j],]$final_OD)
    
    c<-c(temp111B,temp112B,temp121B,temp122B,temp211B,temp212B,temp221B,temp222B)
    ave12<-mean(c)
    sdmean<-mean(c(var(temp111B),var(temp112B),var(temp121B),var(temp122B),var(temp211B),var(temp212B),var(temp221B),var(temp222B)))^0.5

    tempY<-c(ave12-sdmean,ave12,ave12+sdmean)
    
    tempEBc<-as.numeric(tempE[tempE$bacteria==strain_list[j],]$final_OD)
    if(var(tempEBc)==0){
      if(tempEBc[1]==ave12){
        ptemp<-1
      }else{
        ptemp<-0
      }
      for(k in 1:length(tempEBc)){
        mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=ptemp))
      }
    }else{
      
      t<-t.test(x=tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for(k in 1:length(tempEBc)){
          mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=t$p.value))
      }
    }
  }
}

qvalue<-p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave<-cbind(mix2Ave,qvalue)

medDF<-data.frame()
for(i in 29:30){
  for(j in 1:14){
    temp<-mix2Ave[(mix2Ave$env==info$environment_list[i])&(mix2Ave$bacteria==strain_list[j]),]
    medDF<-rbind(medDF,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),ave12=temp$ave12[1],med=mean(temp$value),"sdx"=temp$sdx[1],"sdy"=temp$sdy[1],p=if(temp$qvalue[1]<0.05){1}else{0},pp=if((temp$qvalue[1]<0.05)&(mean(temp$value)>temp$ave12[1])){"high"}else{if((temp$qvalue[1]<0.05)&(mean(temp$value)<temp$ave12[1])){"low"}else{"same"}}))
  }
}



temphigh<-0
tempsame<-0
templow<-0
for(i in 1:length(medDF$envbac)){
  if(medDF$p[i]==0){
    tempsame<-tempsame+1
  }else{
    if(medDF$p[i]==1){
      if(medDF$ave12[i]>medDF$med[i]){
        templow<-templow+1
      }else{
        if(medDF$ave12[i]<medDF$med[i]){
          temphigh<-temphigh+1
        }
      }
    }
  }
}
#積み上げ棒グラフ
judge<-c("Scenario3","Scenario1","Scenario2")
judge2<-c(templow,tempsame,temphigh)
count<-data.frame(x1=1,Type=judge,count1=judge2)
c<-c()
c1<-c()
for(k in 1:3){
  #c<-c(c,paste(round(count$count1[i]/sum(count$count1)*100,1),"%\n",info$interaction_types_list[(7-i)],sep=""))
  c<-c(c,if(count$count1[k]/sum(count$count1)<0.1){paste(" ",format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")}else{paste(format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")})
  c1<-c(c1,count$count1[k]/sum(count$count1))
}
count<-cbind(count,c,c1)
      
count<-transform(count, Type= factor(Type, levels = c("Scenario2","Scenario1","Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))
      
g<-ggplot(data=count,mapping=aes(x=as.factor(x1),y=c1,fill=Type))+geom_bar(stat = "identity", position = "fill",width=0.15)+
        geom_text(aes(label = c, y = pos), size = 13,hjust=-0.6)+
        #geom_text(aes(label = Type, y = pos), size = 8)+
        #theme_minimal()+
        theme_void()+
        #scale_y_continuous(labels = scales::percent,breaks=c(0,0.25,0.5,0.75,1),expand=c(0,0))+
        #coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
        scale_fill_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))#+
        #theme(title = element_blank(),axis.text = element_text(size=12),axis.title.x = element_blank(),axis.title.y = element_blank())
g
ggsave(file = paste("FigS14C_","carbonmix_prediction_1to8_bar.pdf"), plot = g)

mix2Ave<-transform(mix2Ave,bacteria=factor(bacteria,levels=strain_list))
df1=data.frame(x1=0,y1=0,x2=0.8,y2=0.8)
g<-ggplot(mix2Ave,aes(x=ave12,y=value,color=bacteria))+geom_point(size=2.5)+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",data=df1,linewidth=0.75,linetype="dotted")+scale_x_continuous(limits=c(0,0.8))+scale_y_continuous(limits=c(0,0.8))+labs(x="Mean prediction (cells / mL)",y="Observed (cells / mL)",title=paste("1->2 high",temphigh,"same",tempsame,"low",templow))+theme(legend.position = "none")
g
medDF<-transform(medDF,pp=factor(pp,levels=c("high","same","low")))
df1=data.frame(x1=0,y1=0,x2=0.8,y2=0.8)
g<-ggplot(medDF,aes(x=ave12,y=med,color=as.factor(pp)))+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="grey20",data=df1,linewidth=0.75,linetype="dotted")+
  geom_point(size=1.5)+scale_x_continuous(limits=c(0,0.8),expand=c(0,0))+
  scale_y_continuous(limits=c(0,0.8),expand=c(0,0))+
  theme_minimal()+
  theme(legend.position = "none",title = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),axis.title = element_blank(),axis.text = element_blank(),plot.margin=margin(t = 160, r = 160, b = 0, l = 0, unit = "pt"))+
  scale_color_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for(i in 1:length(medDF$envbac)){
  temp<-medDF[i,]
  errorDFx<-data.frame(x1=(temp$ave12-temp$sdx),y1=temp$med,x2=(temp$ave12+temp$sdx),y2=temp$med)
  errorDFy<-data.frame(x1=temp$ave12,y1=(temp$med-temp$sdy),x2=temp$ave12,y2=(temp$med+temp$sdy))
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFx,linewidth=0.2,linetype="solid")
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFy,linewidth=0.2,linetype="solid")
}
g
ggsave(file = paste("FigS14C_carbonmix_prediction_1to8.pdf"), plot = g)

g<-ggplot(medDF,aes(x="1",y=med/ave12))+geom_hline(yintercept = 1, linetype="dotted", linewidth=1.2)+geom_boxplot(outlier.shape=NA,width=0.4,color="grey5")+geom_dotplot(binaxis="y",dotsize=0.65,alpha=0.5,fill=NA, binwidth=0.15, stackdir="center",color="black")+scale_y_continuous(trans="log10",limits=c(0.01,100),expand=c(0,0))+labs(y="Observed/Prediction")+theme_minimal()+theme(legend.position = "none",plot.margin=margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"))
g
ggsave(file = paste("FigS14_carbonmix_prediction_1to8_box.pdf"), plot = g)







#少数炭素源・単培養の細胞濃度から、それら炭素源を混ぜた時の細胞濃度の予想と比較、1->16
mix2Ave<-data.frame()
for(i in 31:31){
  tempE<-all_sample_df_temp[all_sample_df_temp$environment==info$environment_list[i],]
  temp1<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair1[1],]
  temp2<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair2[1],]
  temp11<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair1[1],]
  temp12<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair2[1],]
  temp21<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair1[1],]
  temp22<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair2[1],]
  temp111<-all_sample_df_temp[all_sample_df_temp$environment==temp11$carbonsource_mixed_pair1[1],]
  temp112<-all_sample_df_temp[all_sample_df_temp$environment==temp11$carbonsource_mixed_pair2[1],]
  temp121<-all_sample_df_temp[all_sample_df_temp$environment==temp12$carbonsource_mixed_pair1[1],]
  temp122<-all_sample_df_temp[all_sample_df_temp$environment==temp12$carbonsource_mixed_pair2[1],]
  temp211<-all_sample_df_temp[all_sample_df_temp$environment==temp21$carbonsource_mixed_pair1[1],]
  temp212<-all_sample_df_temp[all_sample_df_temp$environment==temp21$carbonsource_mixed_pair2[1],]
  temp221<-all_sample_df_temp[all_sample_df_temp$environment==temp22$carbonsource_mixed_pair1[1],]
  temp222<-all_sample_df_temp[all_sample_df_temp$environment==temp22$carbonsource_mixed_pair2[1],]
  
  temp1111<-all_sample_df_temp[all_sample_df_temp$environment==temp111$carbonsource_mixed_pair1[1],]
  temp1112<-all_sample_df_temp[all_sample_df_temp$environment==temp111$carbonsource_mixed_pair2[1],]
  temp1121<-all_sample_df_temp[all_sample_df_temp$environment==temp112$carbonsource_mixed_pair1[1],]
  temp1122<-all_sample_df_temp[all_sample_df_temp$environment==temp112$carbonsource_mixed_pair2[1],]
  temp1211<-all_sample_df_temp[all_sample_df_temp$environment==temp121$carbonsource_mixed_pair1[1],]
  temp1212<-all_sample_df_temp[all_sample_df_temp$environment==temp121$carbonsource_mixed_pair2[1],]
  temp1221<-all_sample_df_temp[all_sample_df_temp$environment==temp122$carbonsource_mixed_pair1[1],]
  temp1222<-all_sample_df_temp[all_sample_df_temp$environment==temp122$carbonsource_mixed_pair2[1],]
  temp2111<-all_sample_df_temp[all_sample_df_temp$environment==temp211$carbonsource_mixed_pair1[1],]
  temp2112<-all_sample_df_temp[all_sample_df_temp$environment==temp211$carbonsource_mixed_pair2[1],]
  temp2121<-all_sample_df_temp[all_sample_df_temp$environment==temp212$carbonsource_mixed_pair1[1],]
  temp2122<-all_sample_df_temp[all_sample_df_temp$environment==temp212$carbonsource_mixed_pair2[1],]
  temp2211<-all_sample_df_temp[all_sample_df_temp$environment==temp221$carbonsource_mixed_pair1[1],]
  temp2212<-all_sample_df_temp[all_sample_df_temp$environment==temp221$carbonsource_mixed_pair2[1],]
  temp2221<-all_sample_df_temp[all_sample_df_temp$environment==temp222$carbonsource_mixed_pair1[1],]
  temp2222<-all_sample_df_temp[all_sample_df_temp$environment==temp222$carbonsource_mixed_pair2[1],]
  
  
  for(j in 1:14){
    #tempEB<-median(tempE[tempE$monoculture_bacteria==info$bacteria_list[j],]$final_OD)
    temp1111B<-as.numeric(temp1111[temp1111$bacteria==strain_list[j],]$final_OD)
    temp1112B<-as.numeric(temp1112[temp1112$bacteria==strain_list[j],]$final_OD)
    temp1121B<-as.numeric(temp1121[temp1121$bacteria==strain_list[j],]$final_OD)
    temp1122B<-as.numeric(temp1122[temp1122$bacteria==strain_list[j],]$final_OD)
    temp1211B<-as.numeric(temp1211[temp1211$bacteria==strain_list[j],]$final_OD)
    temp1212B<-as.numeric(temp1212[temp1212$bacteria==strain_list[j],]$final_OD)
    temp1221B<-as.numeric(temp1221[temp1221$bacteria==strain_list[j],]$final_OD)
    temp1222B<-as.numeric(temp1222[temp1222$bacteria==strain_list[j],]$final_OD)
    temp2111B<-as.numeric(temp2111[temp2111$bacteria==strain_list[j],]$final_OD)
    temp2112B<-as.numeric(temp2112[temp2112$bacteria==strain_list[j],]$final_OD)
    temp2121B<-as.numeric(temp2121[temp2121$bacteria==strain_list[j],]$final_OD)
    temp2122B<-as.numeric(temp2122[temp2122$bacteria==strain_list[j],]$final_OD)
    temp2211B<-as.numeric(temp2211[temp2211$bacteria==strain_list[j],]$final_OD)
    temp2212B<-as.numeric(temp2212[temp2212$bacteria==strain_list[j],]$final_OD)
    temp2221B<-as.numeric(temp2221[temp2221$bacteria==strain_list[j],]$final_OD)
    temp2222B<-as.numeric(temp2222[temp2222$bacteria==strain_list[j],]$final_OD)
    
    
    c<-c(temp1111B,temp1112B,temp1121B,temp1122B,temp1211B,temp1212B,temp1221B,temp1222B,temp2111B,temp2112B,temp2121B,temp2122B,temp2211B,temp2212B,temp2221B,temp2222B)
    ave12<-mean(c)
    sdmean<-mean(c(var(temp1111B),var(temp1112B),var(temp1121B),var(temp1122B),var(temp1211B),var(temp1212B),var(temp1221B),var(temp1222B),var(temp2111B),var(temp2112B),var(temp2121B),var(temp2122B),var(temp2211B),var(temp2212B),var(temp2221B),var(temp2222B)))^0.5

    #tempY<-c(ave12-sdmean,ave12-sdmean,ave12,ave12+sdmean,ave12+sdmean)
    tempY<-c(ave12-sdmean,ave12,ave12+sdmean)
    a<-tempE[tempE$bacteria==strain_list[j],]
    tempEBc<-as.numeric(tempE[tempE$bacteria==strain_list[j],]$final_OD)
    if(var(tempEBc)==0){
      if(tempEBc[1]==ave12){
        ptemp<-1
      }else{
        ptemp<-0
      }
      for(k in 1:length(tempEBc)){
        mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=ptemp))
      }
    }else{
      
      t<-t.test(x=tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),paired = FALSE, var.equal = FALSE, conf.level = 0.95)
      for(k in 1:length(tempEBc)){
          mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=t$p.value))
      }
    }
  }
}

qvalue<-p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave<-cbind(mix2Ave,qvalue)

medDF<-data.frame()
for(i in 31:31){
  for(j in 1:14){
    temp<-mix2Ave[(mix2Ave$env==info$environment_list[i])&(mix2Ave$bacteria==strain_list[j]),]
    medDF<-rbind(medDF,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),ave12=temp$ave12[1],med=mean(temp$value),"sdx"=temp$sdx[1],"sdy"=temp$sdy[1],p=if(temp$qvalue[1]<0.05){1}else{0},pp=if((temp$qvalue[1]<0.05)&(mean(temp$value)>temp$ave12[1])){"high"}else{if((temp$qvalue[1]<0.05)&(mean(temp$value)<temp$ave12[1])){"low"}else{"same"}}))
  }
}

median


temphigh<-0
tempsame<-0
templow<-0
for(i in 1:length(medDF$envbac)){
  if(medDF$p[i]==0){
    tempsame<-tempsame+1
  }else{
    if(medDF$p[i]==1){
      if(medDF$ave12[i]>medDF$med[i]){
        templow<-templow+1
      }else{
        if(medDF$ave12[i]<medDF$med[i]){
          temphigh<-temphigh+1
        }
      }
    }
  }
}
#積み上げ棒グラフ
judge<-c("Scenario3","Scenario1","Scenario2")
judge2<-c(templow,tempsame,temphigh)
count<-data.frame(x1=1,Type=judge,count1=judge2)
c<-c()
c1<-c()
for(k in 1:3){
  #c<-c(c,paste(round(count$count1[i]/sum(count$count1)*100,1),"%\n",info$interaction_types_list[(7-i)],sep=""))
  c<-c(c,if(count$count1[k]/sum(count$count1)<0.1){paste(" ",format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")}else{paste(format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")})
  c1<-c(c1,count$count1[k]/sum(count$count1))
}
count<-cbind(count,c,c1)
      
count<-transform(count, Type= factor(Type, levels = c("Scenario2","Scenario1","Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))
      
g<-ggplot(data=count,mapping=aes(x=as.factor(x1),y=c1,fill=Type))+geom_bar(stat = "identity", position = "fill",width=0.15)+
        geom_text(aes(label = c, y = pos), size = 13,hjust=-0.6)+
        #geom_text(aes(label = Type, y = pos), size = 8)+
        #theme_minimal()+
        theme_void()+
        #scale_y_continuous(labels = scales::percent,breaks=c(0,0.25,0.5,0.75,1),expand=c(0,0))+
        #coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
        scale_fill_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))#+
        #theme(title = element_blank(),axis.text = element_text(size=12),axis.title.x = element_blank(),axis.title.y = element_blank())
g
ggsave(file = paste("FigS14D_","carbonmix_prediction_1to16_bar.pdf"), plot = g)

mix2Ave<-transform(mix2Ave,bacteria=factor(bacteria,levels=strain_list))
df1=data.frame(x1=0,y1=0,x2=0.8,y2=0.8)
g<-ggplot(mix2Ave,aes(x=ave12,y=value,color=bacteria))+geom_point(size=2.5)+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",data=df1,linewidth=0.75,linetype="dotted")+scale_x_continuous(limits=c(0,0.8))+scale_y_continuous(limits=c(0,0.8))+labs(x="Mean prediction (cells / mL)",y="Observed (cells / mL)",title=paste("1->2 high",temphigh,"same",tempsame,"low",templow))+theme(legend.position = "none")
g
medDF<-transform(medDF,pp=factor(pp,levels=c("high","same","low")))
df1=data.frame(x1=0,y1=0,x2=0.8,y2=0.8)
g<-ggplot(medDF,aes(x=ave12,y=med,color=as.factor(pp)))+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="grey20",data=df1,linewidth=0.75,linetype="dotted")+
  geom_point(size=1.5)+scale_x_continuous(limits=c(0,0.8),expand=c(0,0))+
  scale_y_continuous(limits=c(0,0.8),expand=c(0,0))+
  theme_minimal()+
  theme(legend.position = "none",title = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),axis.title = element_blank(),axis.text = element_blank(),plot.margin=margin(t = 160, r = 160, b = 0, l = 0, unit = "pt"))+
  scale_color_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for(i in 1:length(medDF$envbac)){
  temp<-medDF[i,]
  errorDFx<-data.frame(x1=(temp$ave12-temp$sdx),y1=temp$med,x2=(temp$ave12+temp$sdx),y2=temp$med)
  errorDFy<-data.frame(x1=temp$ave12,y1=(temp$med-temp$sdy),x2=temp$ave12,y2=(temp$med+temp$sdy))
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFx,linewidth=0.2,linetype="solid")
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFy,linewidth=0.2,linetype="solid")
}
g
ggsave(file = paste("FigS14D_carbonmix_prediction_1to16.pdf"), plot = g)

g<-ggplot(medDF,aes(x="1",y=med/ave12))+geom_hline(yintercept = 1, linetype="dotted", linewidth=1.2)+geom_boxplot(outlier.shape=NA,width=0.4,color="grey5")+geom_dotplot(binaxis="y",dotsize=0.65,alpha=0.5,fill=NA, binwidth=0.15, stackdir="center",color="black")+scale_y_continuous(trans="log10",limits=c(0.01,100),expand=c(0,0))+labs(y="Observed/Prediction")+theme_minimal()+theme(legend.position = "none",plot.margin=margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"))
g
ggsave(file = paste("FigS14_carbonmix_prediction_1to16_box.pdf"), plot = g)
dev.off()
```

## FigS14
```{r}
all_sample_df$mono_target_med <- 0
all_sample_df$conc_ratio <- 0

for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$bacterial_species_count[i]==1 && all_sample_df$monoculture_fluorescence[i]=="GFP"){
    all_sample_df$mono_target_med[i]<-all_sample_df$green_med[i]
  }else if(all_sample_df$bacterial_species_count[i]==1 && all_sample_df$monoculture_fluorescence[i]=="mScarlet"){
    all_sample_df$mono_target_med[i]<-all_sample_df$red_med[i]
  }
}
all_sample_df$mono_target_med<-as.numeric(all_sample_df$mono_target_med)

for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$bacterial_species_count[i]==1&&all_sample_df$carbonsource_species_count[i]==1&&(all_sample_df$experiment[i]=="main"|all_sample_df$experiment[i]=="conc")){
    temp1<-all_sample_df[all_sample_df$environment==all_sample_df$environment[i],]
    temp1<-temp1[temp1$bacteria==all_sample_df$bacteria[i],]
    
    temp_main<-temp1[temp1$experiment=="main",]
    temp_half<-temp1[temp1$experiment=="conc",]
    
    if(all_sample_df$monoculture_fluorescence[i]=="GFP"){
      main_ave<-mean(as.numeric(temp_main$green_min[1]),as.numeric(temp_main$green_med[1]),as.numeric(temp_main$green_max[1]))
      half_ave<-mean(as.numeric(temp_half$green_min[1]),as.numeric(temp_half$green_med[1]),as.numeric(temp_half$green_max[1]))
    }else if(all_sample_df$monoculture_fluorescence[i]=="mScarlet"){
      main_ave<-mean(as.numeric(temp_main$red_min[1]),as.numeric(temp_main$red_med[1]),as.numeric(temp_main$red_max[1]))
      half_ave<-mean(as.numeric(temp_half$red_min[1]),as.numeric(temp_half$red_med[1]),as.numeric(temp_half$red_max[1]))
    }else{
      main_ave<-"ERROR"
      half_ave<-"ERROR"
    }
    
    if((var(as.numeric(temp_main$mono_target_med))==0) && (var(as.numeric(temp_half$mono_target_med))==0)){
      all_sample_df$conc_ratio[i]<-half_ave/main_ave
    }else{
      all_sample_df$conc_ratio[i]<-"ERROR---------------"
    }
  }
}
```

```{r}
dev.new()
all_sample_df$starve <- "ERROR"
# for coculture
# c1
for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$experiment[i]=="main"&&all_sample_df$bacterial_species_count[i]==2&&all_sample_df$carbonsource_species_count[i]==1){
    tempE<-all_sample_df[all_sample_df$environment==all_sample_df$environment[i],]
    tempEG<-tempE[(tempE$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(tempE$experiment=="main"),]
    tempER<-tempE[(tempE$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(tempE$experiment=="main"),]
    
    if((length(tempEG$conc_ratio)==3)&&(length(tempER$conc_ratio)==3)){
      if((tempEG$conc_ratio[1]<1/2|tempEG$conc_ratio[1]==1)&&(tempER$conc_ratio[1]<1/2|tempER$conc_ratio[1]==1)){
        all_sample_df$starve[i]<-1
      }else{all_sample_df$starve[i]<-0}
    }else{all_sample_df$starve[i]<-"ERROR"}
  }
}



# c2
for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$experiment[i]=="main"&&all_sample_df$bacterial_species_count[i]==2&&all_sample_df$carbonsource_species_count[i]==2){
    tempE<-all_sample_df[all_sample_df$environment==all_sample_df$environment[i],]
    
    temp1<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair1[1],]
    temp2<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair2[1],]
    
    temp1G<-temp1[(temp1$monoculture_species_GFP==all_sample_df$coculture_species_GFP[1])&(temp1$experiment=="main"),]
    temp1R<-temp1[(temp1$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp1$experiment=="main"),]
    temp2G<-temp2[(temp2$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp2$experiment=="main"),]
    temp2R<-temp2[(temp2$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp2$experiment=="main"),]
    
    if((length(temp1G$conc_ratio)==3)&&
       (length(temp1R$conc_ratio)==3)&&
       (length(temp2G$conc_ratio)==3)&&
       (length(temp2R$conc_ratio)==3)){
      if((temp1G$conc_ratio[1]<=1)&&
         (temp1R$conc_ratio[1]<=1)&&
         (temp2G$conc_ratio[1]<=1)&&
         (temp2R$conc_ratio[1]<=1)){
        all_sample_df$starve[i]<-1
      }else{all_sample_df$starve[i]<-0}
    }else{all_sample_df$starve[i]<-"ERROR"}
  }
}


# c4
for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$experiment[i]=="main"&&all_sample_df$bacterial_species_count[i]==2&&all_sample_df$carbonsource_species_count[i]==4){
    tempE<-all_sample_df[all_sample_df$environment==all_sample_df$environment[i],]
    
    temp1<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair1[1],]
    temp2<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair2[1],]
    temp11<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair1[1],]
    temp12<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair2[1],]
    temp21<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair1[1],]
    temp22<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair2[1],]
    
    temp11G<-temp11[(temp11$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp11$experiment=="main"),]
    temp11R<-temp11[(temp11$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp11$experiment=="main"),]
    temp12G<-temp12[(temp12$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp12$experiment=="main"),]
    temp12R<-temp12[(temp12$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp12$experiment=="main"),]
    temp21G<-temp21[(temp21$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp21$experiment=="main"),]
    temp21R<-temp21[(temp21$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp21$experiment=="main"),]
    temp22G<-temp22[(temp22$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp22$experiment=="main"),]
    temp22R<-temp22[(temp22$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp22$experiment=="main"),]
    
    if((length(temp11G$conc_ratio)==3)&&
       (length(temp11R$conc_ratio)==3)&&
       (length(temp12G$conc_ratio)==3)&&
       (length(temp12R$conc_ratio)==3)&&
       (length(temp21G$conc_ratio)==3)&&
       (length(temp21R$conc_ratio)==3)&&
       (length(temp22G$conc_ratio)==3)&&
       (length(temp22R$conc_ratio)==3)){
      if((temp11G$conc_ratio[1]<=1)&&
         (temp11R$conc_ratio[1]<=1)&&
         (temp12G$conc_ratio[1]<=1)&&
         (temp12R$conc_ratio[1]<=1)&&
         (temp21G$conc_ratio[1]<=1)&&
         (temp21R$conc_ratio[1]<=1)&&
         (temp22G$conc_ratio[1]<=1)&&
         (temp22R$conc_ratio[1]<=1)){
        all_sample_df$starve[i]<-1
      }else{all_sample_df$starve[i]<-0}
    }else{all_sample_df$starve[i]<-"ERROR"}
  }
}


# c8
for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$experiment[i]=="main"&&all_sample_df$bacterial_species_count[i]==2&&all_sample_df$carbonsource_species_count[i]==8){
    tempE<-all_sample_df[all_sample_df$environment==all_sample_df$environment[i],]
    
    temp1<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair1[1],]
    temp2<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair2[1],]
   
    temp11<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair1[1],]
    temp12<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair2[1],]
    temp21<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair1[1],]
    temp22<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair2[1],]
    
    temp111<-all_sample_df[all_sample_df$environment==temp11$carbonsource_mixed_pair1[1],]
    temp112<-all_sample_df[all_sample_df$environment==temp11$carbonsource_mixed_pair2[1],]
    temp121<-all_sample_df[all_sample_df$environment==temp12$carbonsource_mixed_pair1[1],]
    temp122<-all_sample_df[all_sample_df$environment==temp12$carbonsource_mixed_pair2[1],]
    temp211<-all_sample_df[all_sample_df$environment==temp21$carbonsource_mixed_pair1[1],]
    temp212<-all_sample_df[all_sample_df$environment==temp21$carbonsource_mixed_pair2[1],]
    temp221<-all_sample_df[all_sample_df$environment==temp22$carbonsource_mixed_pair1[1],]
    temp222<-all_sample_df[all_sample_df$environment==temp22$carbonsource_mixed_pair2[1],]
    
    temp111G<-temp111[(temp111$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp111$experiment=="main"),]
    temp111R<-temp111[(temp111$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp111$experiment=="main"),]
    temp112G<-temp112[(temp112$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp112$experiment=="main"),]
    temp112R<-temp112[(temp112$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp112$experiment=="main"),]
    temp121G<-temp121[(temp121$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp121$experiment=="main"),]
    temp121R<-temp121[(temp121$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp121$experiment=="main"),]
    temp122G<-temp122[(temp122$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp122$experiment=="main"),]
    temp122R<-temp122[(temp122$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp122$experiment=="main"),]
    temp211G<-temp211[(temp211$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp211$experiment=="main"),]
    temp211R<-temp211[(temp211$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp211$experiment=="main"),]
    temp212G<-temp212[(temp212$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp212$experiment=="main"),]
    temp212R<-temp212[(temp212$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp212$experiment=="main"),]
    temp221G<-temp221[(temp221$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp221$experiment=="main"),]
    temp221R<-temp221[(temp221$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp221$experiment=="main"),]
    temp222G<-temp222[(temp222$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp222$experiment=="main"),]
    temp222R<-temp222[(temp222$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp222$experiment=="main"),]
    
    if((length(temp111G$conc_ratio)==3)&&
       (length(temp111R$conc_ratio)==3)&&
       (length(temp112G$conc_ratio)==3)&&
       (length(temp112R$conc_ratio)==3)&&
       (length(temp121G$conc_ratio)==3)&&
       (length(temp121R$conc_ratio)==3)&&
       (length(temp122G$conc_ratio)==3)&&
       (length(temp122R$conc_ratio)==3)&&
       (length(temp211G$conc_ratio)==3)&&
       (length(temp211R$conc_ratio)==3)&&
       (length(temp212G$conc_ratio)==3)&&
       (length(temp212R$conc_ratio)==3)&&
       (length(temp221G$conc_ratio)==3)&&
       (length(temp221R$conc_ratio)==3)&&
       (length(temp222G$conc_ratio)==3)&&
       (length(temp222R$conc_ratio)==3)){
      if((temp111G$conc_ratio[1]<=1)&&
         (temp111R$conc_ratio[1]<=1)&&
         (temp112G$conc_ratio[1]<=1)&&
         (temp112R$conc_ratio[1]<=1)&&
         (temp121G$conc_ratio[1]<=1)&&
         (temp121R$conc_ratio[1]<=1)&&
         (temp122G$conc_ratio[1]<=1)&&
         (temp122R$conc_ratio[1]<=1)&&
         (temp211G$conc_ratio[1]<=1)&&
         (temp211R$conc_ratio[1]<=1)&&
         (temp212G$conc_ratio[1]<=1)&&
         (temp212R$conc_ratio[1]<=1)&&
         (temp221G$conc_ratio[1]<=1)&&
         (temp221R$conc_ratio[1]<=1)&&
         (temp222G$conc_ratio[1]<=1)&&
         (temp222R$conc_ratio[1]<=1)){
        all_sample_df$starve[i]<-1
      }else{all_sample_df$starve[i]<-0}
    }else{all_sample_df$starve[i]<-"ERROR"}
  }
}


# c16
for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$experiment[i]=="main"&&all_sample_df$bacterial_species_count[i]==2&&all_sample_df$carbonsource_species_count[i]==16){
    tempE<-all_sample_df[all_sample_df$environment==all_sample_df$environment[i],]
    
    temp1<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair1[1],]
    temp2<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair2[1],]
   
    temp11<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair1[1],]
    temp12<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair2[1],]
    temp21<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair1[1],]
    temp22<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair2[1],]
    
    temp111<-all_sample_df[all_sample_df$environment==temp11$carbonsource_mixed_pair1[1],]
    temp112<-all_sample_df[all_sample_df$environment==temp11$carbonsource_mixed_pair2[1],]
    temp121<-all_sample_df[all_sample_df$environment==temp12$carbonsource_mixed_pair1[1],]
    temp122<-all_sample_df[all_sample_df$environment==temp12$carbonsource_mixed_pair2[1],]
    temp211<-all_sample_df[all_sample_df$environment==temp21$carbonsource_mixed_pair1[1],]
    temp212<-all_sample_df[all_sample_df$environment==temp21$carbonsource_mixed_pair2[1],]
    temp221<-all_sample_df[all_sample_df$environment==temp22$carbonsource_mixed_pair1[1],]
    temp222<-all_sample_df[all_sample_df$environment==temp22$carbonsource_mixed_pair2[1],]
    
    temp1111<-all_sample_df[all_sample_df$environment==temp111$carbonsource_mixed_pair1[1],]
    temp1112<-all_sample_df[all_sample_df$environment==temp111$carbonsource_mixed_pair2[1],]
    temp1121<-all_sample_df[all_sample_df$environment==temp112$carbonsource_mixed_pair1[1],]
    temp1122<-all_sample_df[all_sample_df$environment==temp112$carbonsource_mixed_pair2[1],]
    temp1211<-all_sample_df[all_sample_df$environment==temp121$carbonsource_mixed_pair1[1],]
    temp1212<-all_sample_df[all_sample_df$environment==temp121$carbonsource_mixed_pair2[1],]
    temp1221<-all_sample_df[all_sample_df$environment==temp122$carbonsource_mixed_pair1[1],]
    temp1222<-all_sample_df[all_sample_df$environment==temp122$carbonsource_mixed_pair2[1],]
    temp2111<-all_sample_df[all_sample_df$environment==temp211$carbonsource_mixed_pair1[1],]
    temp2112<-all_sample_df[all_sample_df$environment==temp211$carbonsource_mixed_pair2[1],]
    temp2121<-all_sample_df[all_sample_df$environment==temp212$carbonsource_mixed_pair1[1],]
    temp2122<-all_sample_df[all_sample_df$environment==temp212$carbonsource_mixed_pair2[1],]
    temp2211<-all_sample_df[all_sample_df$environment==temp221$carbonsource_mixed_pair1[1],]
    temp2212<-all_sample_df[all_sample_df$environment==temp221$carbonsource_mixed_pair2[1],]
    temp2221<-all_sample_df[all_sample_df$environment==temp222$carbonsource_mixed_pair1[1],]
    temp2222<-all_sample_df[all_sample_df$environment==temp222$carbonsource_mixed_pair2[1],]
    
    temp1111G<-temp1111[(temp1111$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp1111$experiment=="main"),]
    temp1111R<-temp1111[(temp1111$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp1111$experiment=="main"),]
    temp1112G<-temp1112[(temp1112$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp1112$experiment=="main"),]
    temp1112R<-temp1112[(temp1112$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp1112$experiment=="main"),]
    temp1121G<-temp1121[(temp1121$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp1121$experiment=="main"),]
    temp1121R<-temp1121[(temp1121$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp1121$experiment=="main"),]
    temp1122G<-temp1122[(temp1122$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp1122$experiment=="main"),]
    temp1122R<-temp1122[(temp1122$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp1122$experiment=="main"),]
    temp1211G<-temp1211[(temp1211$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp1211$experiment=="main"),]
    temp1211R<-temp1211[(temp1211$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp1211$experiment=="main"),]
    temp1212G<-temp1212[(temp1212$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp1212$experiment=="main"),]
    temp1212R<-temp1212[(temp1212$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp1212$experiment=="main"),]
    temp1221G<-temp1221[(temp1221$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp1221$experiment=="main"),]
    temp1221R<-temp1221[(temp1221$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp1221$experiment=="main"),]
    temp1222G<-temp1222[(temp1222$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp1222$experiment=="main"),]
    temp1222R<-temp1222[(temp1222$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp1222$experiment=="main"),]
    temp2111G<-temp2111[(temp2111$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp2111$experiment=="main"),]
    temp2111R<-temp2111[(temp2111$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp2111$experiment=="main"),]
    temp2112G<-temp2112[(temp2112$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp2112$experiment=="main"),]
    temp2112R<-temp2112[(temp2112$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp2112$experiment=="main"),]
    temp2121G<-temp2121[(temp2121$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp2121$experiment=="main"),]
    temp2121R<-temp2121[(temp2121$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp2121$experiment=="main"),]
    temp2122G<-temp2122[(temp2122$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp2122$experiment=="main"),]
    temp2122R<-temp2122[(temp2122$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp2122$experiment=="main"),]
    temp2211G<-temp2211[(temp2211$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp2211$experiment=="main"),]
    temp2211R<-temp2211[(temp2211$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp2211$experiment=="main"),]
    temp2212G<-temp2212[(temp2212$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp2212$experiment=="main"),]
    temp2212R<-temp2212[(temp2212$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp2212$experiment=="main"),]
    temp2221G<-temp2221[(temp2221$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp2221$experiment=="main"),]
    temp2221R<-temp2221[(temp2221$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp2221$experiment=="main"),]
    temp2222G<-temp2222[(temp2222$monoculture_species_GFP==all_sample_df$coculture_species_GFP[i])&(temp2222$experiment=="main"),]
    temp2222R<-temp2222[(temp2222$monoculture_species_mScarlet==all_sample_df$coculture_species_mScarlet[i])&(temp2222$experiment=="main"),]
    
    if((length(temp1111G$conc_ratio)==3)&&
       (length(temp1111R$conc_ratio)==3)&&
       (length(temp1112G$conc_ratio)==3)&&
       (length(temp1112R$conc_ratio)==3)&&
       (length(temp1121G$conc_ratio)==3)&&
       (length(temp1121R$conc_ratio)==3)&&
       (length(temp1122G$conc_ratio)==3)&&
       (length(temp1122R$conc_ratio)==3)&&
       (length(temp1211G$conc_ratio)==3)&&
       (length(temp1211R$conc_ratio)==3)&&
       (length(temp1212G$conc_ratio)==3)&&
       (length(temp1212R$conc_ratio)==3)&&
       (length(temp1221G$conc_ratio)==3)&&
       (length(temp1221R$conc_ratio)==3)&&
       (length(temp1222G$conc_ratio)==3)&&
       (length(temp1222R$conc_ratio)==3)&&
       (length(temp2111G$conc_ratio)==3)&&
       (length(temp2111R$conc_ratio)==3)&&
       (length(temp2112G$conc_ratio)==3)&&
       (length(temp2112R$conc_ratio)==3)&&
       (length(temp2121G$conc_ratio)==3)&&
       (length(temp2121R$conc_ratio)==3)&&
       (length(temp2122G$conc_ratio)==3)&&
       (length(temp2122R$conc_ratio)==3)&&
       (length(temp2211G$conc_ratio)==3)&&
       (length(temp2211R$conc_ratio)==3)&&
       (length(temp2212G$conc_ratio)==3)&&
       (length(temp2212R$conc_ratio)==3)&&
       (length(temp2221G$conc_ratio)==3)&&
       (length(temp2221R$conc_ratio)==3)&&
       (length(temp2222G$conc_ratio)==3)&&
       (length(temp2222R$conc_ratio)==3)){
      if((temp1111G$conc_ratio[1]<=1)&&
         (temp1111R$conc_ratio[1]<=1)&&
         (temp1112G$conc_ratio[1]<=1)&&
         (temp1112R$conc_ratio[1]<=1)&&
         (temp1121G$conc_ratio[1]<=1)&&
         (temp1121R$conc_ratio[1]<=1)&&
         (temp1122G$conc_ratio[1]<=1)&&
         (temp1122R$conc_ratio[1]<=1)&&
         (temp1211G$conc_ratio[1]<=1)&&
         (temp1211R$conc_ratio[1]<=1)&&
         (temp1212G$conc_ratio[1]<=1)&&
         (temp1212R$conc_ratio[1]<=1)&&
         (temp1221G$conc_ratio[1]<=1)&&
         (temp1221R$conc_ratio[1]<=1)&&
         (temp1222G$conc_ratio[1]<=1)&&
         (temp1222R$conc_ratio[1]<=1)&&
         (temp2111G$conc_ratio[1]<=1)&&
         (temp2111R$conc_ratio[1]<=1)&&
         (temp2112G$conc_ratio[1]<=1)&&
         (temp2112R$conc_ratio[1]<=1)&&
         (temp2121G$conc_ratio[1]<=1)&&
         (temp2121R$conc_ratio[1]<=1)&&
         (temp2122G$conc_ratio[1]<=1)&&
         (temp2122R$conc_ratio[1]<=1)&&
         (temp2211G$conc_ratio[1]<=1)&&
         (temp2211R$conc_ratio[1]<=1)&&
         (temp2212G$conc_ratio[1]<=1)&&
         (temp2212R$conc_ratio[1]<=1)&&
         (temp2221G$conc_ratio[1]<=1)&&
         (temp2221R$conc_ratio[1]<=1)&&
         (temp2222G$conc_ratio[1]<=1)&&
         (temp2222R$conc_ratio[1]<=1)){
        all_sample_df$starve[i]<-1
      }else{all_sample_df$starve[i]<-0}
    }else{all_sample_df$starve[i]<-"ERROR"}
  }
}




















# for monoculture
# c1
for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$experiment[i]=="main"&&all_sample_df$bacterial_species_count[i]==1&&all_sample_df$carbonsource_species_count[i]==1){
    tempE<-all_sample_df[all_sample_df$environment==all_sample_df$environment[i],]
    tempEB<-tempE[(tempE$bacteria==all_sample_df$bacteria[i])&(tempE$experiment=="main"),]
    
    if((length(tempEB$conc_ratio)==3)){
      if((tempEB$conc_ratio[1]<1/2|tempEB$conc_ratio[1]==1)){
        all_sample_df$starve[i]<-1
      }else{all_sample_df$starve[i]<-0}
    }else{all_sample_df$starve[i]<-"ERROR"}
  }
}



# c2
for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$experiment[i]=="main"&&all_sample_df$bacterial_species_count[i]==1&&all_sample_df$carbonsource_species_count[i]==2){
    tempE<-all_sample_df[all_sample_df$environment==all_sample_df$environment[i],]
    
    temp1<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair1[1],]
    temp2<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair2[1],]
    
    temp1B<-temp1[(temp1$bacteria==all_sample_df$bacteria[i])&(temp1$experiment=="main"),]
    temp2B<-temp2[(temp2$bacteria==all_sample_df$bacteria[i])&(temp2$experiment=="main"),]
    
    if((length(temp1B$conc_ratio)==3)&&
       (length(temp2B$conc_ratio)==3)){
      if((temp1B$conc_ratio[1]<=1)&&
         (temp2B$conc_ratio[1]<=1)){
        all_sample_df$starve[i]<-1
      }else{all_sample_df$starve[i]<-0}
    }else{all_sample_df$starve[i]<-"ERROR"}
  }
}


# c4
for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$experiment[i]=="main"&&all_sample_df$bacterial_species_count[i]==1&&all_sample_df$carbonsource_species_count[i]==4){
    tempE<-all_sample_df[all_sample_df$environment==all_sample_df$environment[i],]
    
    temp1<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair1[1],]
    temp2<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair2[1],]
    temp11<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair1[1],]
    temp12<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair2[1],]
    temp21<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair1[1],]
    temp22<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair2[1],]
    
    temp11B<-temp11[(temp11$bacteria==all_sample_df$bacteria[i])&(temp11$experiment=="main"),]
    temp12B<-temp12[(temp12$bacteria==all_sample_df$bacteria[i])&(temp12$experiment=="main"),]
    temp21B<-temp21[(temp21$bacteria==all_sample_df$bacteria[i])&(temp21$experiment=="main"),]
    temp22B<-temp22[(temp22$bacteria==all_sample_df$bacteria[i])&(temp22$experiment=="main"),]
    
    if((length(temp11B$conc_ratio)==3)&&
       (length(temp12B$conc_ratio)==3)&&
       (length(temp21B$conc_ratio)==3)&&
       (length(temp22B$conc_ratio)==3)){
      if((temp11B$conc_ratio[1]<=1)&&
         (temp12B$conc_ratio[1]<=1)&&
         (temp21B$conc_ratio[1]<=1)&&
         (temp22B$conc_ratio[1]<=1)){
        all_sample_df$starve[i]<-1
      }else{all_sample_df$starve[i]<-0}
    }else{all_sample_df$starve[i]<-"ERROR"}
  }
}


# c8
for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$experiment[i]=="main"&&all_sample_df$bacterial_species_count[i]==1&&all_sample_df$carbonsource_species_count[i]==8){
    tempE<-all_sample_df[all_sample_df$environment==all_sample_df$environment[i],]
    
    temp1<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair1[1],]
    temp2<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair2[1],]
   
    temp11<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair1[1],]
    temp12<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair2[1],]
    temp21<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair1[1],]
    temp22<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair2[1],]
    
    temp111<-all_sample_df[all_sample_df$environment==temp11$carbonsource_mixed_pair1[1],]
    temp112<-all_sample_df[all_sample_df$environment==temp11$carbonsource_mixed_pair2[1],]
    temp121<-all_sample_df[all_sample_df$environment==temp12$carbonsource_mixed_pair1[1],]
    temp122<-all_sample_df[all_sample_df$environment==temp12$carbonsource_mixed_pair2[1],]
    temp211<-all_sample_df[all_sample_df$environment==temp21$carbonsource_mixed_pair1[1],]
    temp212<-all_sample_df[all_sample_df$environment==temp21$carbonsource_mixed_pair2[1],]
    temp221<-all_sample_df[all_sample_df$environment==temp22$carbonsource_mixed_pair1[1],]
    temp222<-all_sample_df[all_sample_df$environment==temp22$carbonsource_mixed_pair2[1],]
    
    temp111B<-temp111[(temp111$bacteria==all_sample_df$bacteria[i])&(temp111$experiment=="main"),]
    temp112B<-temp112[(temp112$bacteria==all_sample_df$bacteria[i])&(temp112$experiment=="main"),]
    temp121B<-temp121[(temp121$bacteria==all_sample_df$bacteria[i])&(temp121$experiment=="main"),]
    temp122B<-temp122[(temp122$bacteria==all_sample_df$bacteria[i])&(temp122$experiment=="main"),]
    temp211B<-temp211[(temp211$bacteria==all_sample_df$bacteria[i])&(temp211$experiment=="main"),]
    temp212B<-temp212[(temp212$bacteria==all_sample_df$bacteria[i])&(temp212$experiment=="main"),]
    temp221B<-temp221[(temp221$bacteria==all_sample_df$bacteria[i])&(temp221$experiment=="main"),]
    temp222B<-temp222[(temp222$bacteria==all_sample_df$bacteria[i])&(temp222$experiment=="main"),]

    if((length(temp111B$conc_ratio)==3)&&
       (length(temp112B$conc_ratio)==3)&&
       (length(temp121B$conc_ratio)==3)&&
       (length(temp122B$conc_ratio)==3)&&
       (length(temp211B$conc_ratio)==3)&&
       (length(temp212B$conc_ratio)==3)&&
       (length(temp221B$conc_ratio)==3)&&
       (length(temp222B$conc_ratio)==3)){
      if((temp111B$conc_ratio[1]<=1)&&
         (temp112B$conc_ratio[1]<=1)&&
         (temp121B$conc_ratio[1]<=1)&&
         (temp122B$conc_ratio[1]<=1)&&
         (temp211B$conc_ratio[1]<=1)&&
         (temp212B$conc_ratio[1]<=1)&&
         (temp221B$conc_ratio[1]<=1)&&
         (temp222B$conc_ratio[1]<=1)){
        all_sample_df$starve[i]<-1
      }else{all_sample_df$starve[i]<-0}
    }else{all_sample_df$starve[i]<-"ERROR"}
  }
}


# c16
for(i in 1:length(all_sample_df$fcs_file)){
  if(all_sample_df$experiment[i]=="main"&&all_sample_df$bacterial_species_count[i]==1&&all_sample_df$carbonsource_species_count[i]==16){
    tempE<-all_sample_df[all_sample_df$environment==all_sample_df$environment[i],]
    
    temp1<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair1[1],]
    temp2<-all_sample_df[all_sample_df$environment==tempE$carbonsource_mixed_pair2[1],]
   
    temp11<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair1[1],]
    temp12<-all_sample_df[all_sample_df$environment==temp1$carbonsource_mixed_pair2[1],]
    temp21<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair1[1],]
    temp22<-all_sample_df[all_sample_df$environment==temp2$carbonsource_mixed_pair2[1],]
    
    temp111<-all_sample_df[all_sample_df$environment==temp11$carbonsource_mixed_pair1[1],]
    temp112<-all_sample_df[all_sample_df$environment==temp11$carbonsource_mixed_pair2[1],]
    temp121<-all_sample_df[all_sample_df$environment==temp12$carbonsource_mixed_pair1[1],]
    temp122<-all_sample_df[all_sample_df$environment==temp12$carbonsource_mixed_pair2[1],]
    temp211<-all_sample_df[all_sample_df$environment==temp21$carbonsource_mixed_pair1[1],]
    temp212<-all_sample_df[all_sample_df$environment==temp21$carbonsource_mixed_pair2[1],]
    temp221<-all_sample_df[all_sample_df$environment==temp22$carbonsource_mixed_pair1[1],]
    temp222<-all_sample_df[all_sample_df$environment==temp22$carbonsource_mixed_pair2[1],]
    
    temp1111<-all_sample_df[all_sample_df$environment==temp111$carbonsource_mixed_pair1[1],]
    temp1112<-all_sample_df[all_sample_df$environment==temp111$carbonsource_mixed_pair2[1],]
    temp1121<-all_sample_df[all_sample_df$environment==temp112$carbonsource_mixed_pair1[1],]
    temp1122<-all_sample_df[all_sample_df$environment==temp112$carbonsource_mixed_pair2[1],]
    temp1211<-all_sample_df[all_sample_df$environment==temp121$carbonsource_mixed_pair1[1],]
    temp1212<-all_sample_df[all_sample_df$environment==temp121$carbonsource_mixed_pair2[1],]
    temp1221<-all_sample_df[all_sample_df$environment==temp122$carbonsource_mixed_pair1[1],]
    temp1222<-all_sample_df[all_sample_df$environment==temp122$carbonsource_mixed_pair2[1],]
    temp2111<-all_sample_df[all_sample_df$environment==temp211$carbonsource_mixed_pair1[1],]
    temp2112<-all_sample_df[all_sample_df$environment==temp211$carbonsource_mixed_pair2[1],]
    temp2121<-all_sample_df[all_sample_df$environment==temp212$carbonsource_mixed_pair1[1],]
    temp2122<-all_sample_df[all_sample_df$environment==temp212$carbonsource_mixed_pair2[1],]
    temp2211<-all_sample_df[all_sample_df$environment==temp221$carbonsource_mixed_pair1[1],]
    temp2212<-all_sample_df[all_sample_df$environment==temp221$carbonsource_mixed_pair2[1],]
    temp2221<-all_sample_df[all_sample_df$environment==temp222$carbonsource_mixed_pair1[1],]
    temp2222<-all_sample_df[all_sample_df$environment==temp222$carbonsource_mixed_pair2[1],]
    
    temp1111B<-temp1111[(temp1111$bacteria==all_sample_df$bacteria[i])&(temp1111$experiment=="main"),]
    temp1112B<-temp1112[(temp1112$bacteria==all_sample_df$bacteria[i])&(temp1112$experiment=="main"),]
    temp1121B<-temp1121[(temp1121$bacteria==all_sample_df$bacteria[i])&(temp1121$experiment=="main"),]
    temp1122B<-temp1122[(temp1122$bacteria==all_sample_df$bacteria[i])&(temp1122$experiment=="main"),]
    temp1211B<-temp1211[(temp1211$bacteria==all_sample_df$bacteria[i])&(temp1211$experiment=="main"),]
    temp1212B<-temp1212[(temp1212$bacteria==all_sample_df$bacteria[i])&(temp1212$experiment=="main"),]
    temp1221B<-temp1221[(temp1221$bacteria==all_sample_df$bacteria[i])&(temp1221$experiment=="main"),]
    temp1222B<-temp1222[(temp1222$bacteria==all_sample_df$bacteria[i])&(temp1222$experiment=="main"),]
    temp2111B<-temp2111[(temp2111$bacteria==all_sample_df$bacteria[i])&(temp2111$experiment=="main"),]
    temp2112B<-temp2112[(temp2112$bacteria==all_sample_df$bacteria[i])&(temp2112$experiment=="main"),]
    temp2121B<-temp2121[(temp2121$bacteria==all_sample_df$bacteria[i])&(temp2121$experiment=="main"),]
    temp2122B<-temp2122[(temp2122$bacteria==all_sample_df$bacteria[i])&(temp2122$experiment=="main"),]
    temp2211B<-temp2211[(temp2211$bacteria==all_sample_df$bacteria[i])&(temp2211$experiment=="main"),]
    temp2212B<-temp2212[(temp2212$bacteria==all_sample_df$bacteria[i])&(temp2212$experiment=="main"),]
    temp2221B<-temp2221[(temp2221$bacteria==all_sample_df$bacteria[i])&(temp2221$experiment=="main"),]
    temp2222B<-temp2222[(temp2222$bacteria==all_sample_df$bacteria[i])&(temp2222$experiment=="main"),]
    
    if((length(temp1111B$conc_ratio)==3)&&
       (length(temp1112B$conc_ratio)==3)&&
       (length(temp1121B$conc_ratio)==3)&&
       (length(temp1122B$conc_ratio)==3)&&
       (length(temp1211B$conc_ratio)==3)&&
       (length(temp1212B$conc_ratio)==3)&&
       (length(temp1221B$conc_ratio)==3)&&
       (length(temp1222B$conc_ratio)==3)&&
       (length(temp2111B$conc_ratio)==3)&&
       (length(temp2112B$conc_ratio)==3)&&
       (length(temp2121B$conc_ratio)==3)&&
       (length(temp2122B$conc_ratio)==3)&&
       (length(temp2211B$conc_ratio)==3)&&
       (length(temp2212B$conc_ratio)==3)&&
       (length(temp2221B$conc_ratio)==3)&&
       (length(temp2222B$conc_ratio)==3)){
      if((temp1111B$conc_ratio[1]<=1)&&
         (temp1112B$conc_ratio[1]<=1)&&
         (temp1121B$conc_ratio[1]<=1)&&
         (temp1122B$conc_ratio[1]<=1)&&
         (temp1211B$conc_ratio[1]<=1)&&
         (temp1212B$conc_ratio[1]<=1)&&
         (temp1221B$conc_ratio[1]<=1)&&
         (temp1222B$conc_ratio[1]<=1)&&
         (temp2111B$conc_ratio[1]<=1)&&
         (temp2112B$conc_ratio[1]<=1)&&
         (temp2121B$conc_ratio[1]<=1)&&
         (temp2122B$conc_ratio[1]<=1)&&
         (temp2211B$conc_ratio[1]<=1)&&
         (temp2212B$conc_ratio[1]<=1)&&
         (temp2221B$conc_ratio[1]<=1)&&
         (temp2222B$conc_ratio[1]<=1)){
        all_sample_df$starve[i]<-1
      }else{all_sample_df$starve[i]<-0}
    }else{all_sample_df$starve[i]<-"ERROR"}
  }
}
dev.off()
```

```{r}

all_sample_df_temp<-all_sample_df[all_sample_df$bacterial_species_count==1,]
all_sample_df_temp<-all_sample_df_temp[all_sample_df_temp$experiment=="main",]

strain_list<-c(info$monoculture_bacteria_list[1],info$monoculture_bacteria_list[3:14],info$monoculture_bacteria_list[16])

DF<-data.frame(c(1:31))
for(i in 1:14){
  tempr<-data.frame()
  for(j in 1:31){
    temp<-all_sample_df_temp[all_sample_df_temp$bacteria==strain_list[i]&all_sample_df_temp$environment==info$environment_list[j],]
    tempr<-rbind(tempr,data.frame(a=temp$starve[1]))
  }
  DF<-cbind(DF,tempr)
}
rownames(DF) <- info$environment_list[1:31]
colnames(DF) <- c("id",strain_list[1:14])
```

```{r}
dev.new()
#少数炭素源・単培養の細胞濃度から、それら炭素源を混ぜた時の細胞濃度の予想と比較

#2024

all_sample_df_temp<-all_sample_df[all_sample_df$bacterial_species_count==1,]
all_sample_df_temp<-all_sample_df_temp[all_sample_df_temp$experiment=="main",]
all_sample_df_temp2<-all_sample_df_temp[(as.numeric(all_sample_df_temp$carbonsource_species_count)>=2)&(all_sample_df_temp$starve==1),]
all_sample_df_temp1<-all_sample_df_temp[all_sample_df_temp$carbonsource_species_count==1,]
all_sample_df_temp<-rbind(all_sample_df_temp1,all_sample_df_temp2)

strain_list<-c(info$monoculture_bacteria_list[1],info$monoculture_bacteria_list[3:14],info$monoculture_bacteria_list[16])


#少数炭素源・単培養の細胞濃度から、それら炭素源を混ぜた時の細胞濃度の予想と比較、1->2
mix2Ave<-data.frame()
for(i in 17:24){
  tempE<-all_sample_df_temp[all_sample_df_temp$environment==info$environment_list[i],]
  temp1<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair1[1],]
  temp2<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair2[1],]
  
  for(j in 1:14){
    #tempEB<-median(tempE[tempE$monoculture_bacteria==info$bacteria_list[j],]$background_processing_target_fluorescent_cells_density)
    temp1B<-as.numeric(temp1[temp1$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp2B<-as.numeric(temp2[temp2$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    cmono<-c(temp1B,temp2B)
    ave12<-mean(cmono)
    sdmean<-mean(c(var(temp1B),var(temp2B)))^0.5

    tempY<-c(ave12-sdmean,ave12,ave12+sdmean)
    
    tempEBc<-as.numeric(tempE[tempE$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    
    if(is.na(ave12)|is.na(sdmean)|sum(tempEBc)==0){
    }else{
      if(var(tempEBc)==0){
        if(tempEBc[1]==ave12){
          ptemp<-1
        }else{
          ptemp<-0
        }
        for(k in 1:length(tempEBc)){
          mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=ptemp))
        }
      }else{
        
        t<-t.test(x=tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),paired = FALSE, var.equal = FALSE, conf.level = 0.95)
        for(k in 1:length(tempEBc)){
            mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=t$p.value))
        }
      } 
    }
  }
}

qvalue<-p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave<-cbind(mix2Ave,qvalue)

medDF<-data.frame()
for(i in 17:24){
  for(j in 1:14){
    temp<-mix2Ave[(mix2Ave$env==info$environment_list[i])&(mix2Ave$bacteria==strain_list[j]),]
    if(length(temp$envbac)!=0){
      medDF<-rbind(medDF,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),ave12=temp$ave12[1],med=mean(temp$value),"sdx"=temp$sdx[1],"sdy"=temp$sdy[1],p=if(temp$qvalue[1]<0.05){1}else{0},pp=if((temp$qvalue[1]<0.05)&(mean(temp$value)>temp$ave12[1])){"high"}else{if((temp$qvalue[1]<0.05)&(mean(temp$value)<temp$ave12[1])){"low"}else{"same"}}))
    }
  }
}

temphigh<-0
tempsame<-0
templow<-0
for(i in 1:length(medDF$envbac)){
  if(medDF$p[i]==0){
    tempsame<-tempsame+1
  }else{
    if(medDF$p[i]==1){
      if(medDF$ave12[i]>medDF$med[i]){
        templow<-templow+1
      }else{
        if(medDF$ave12[i]<medDF$med[i]){
          temphigh<-temphigh+1
        }
      }
    }
  }
}
#積み上げ棒グラフ
judge<-c("Scenario3","Scenario1","Scenario2")
judge2<-c(templow,tempsame,temphigh)
count<-data.frame(x1=1,Type=judge,count1=judge2)
c<-c()
c1<-c()
for(k in 1:3){
  #c<-c(c,paste(round(count$count1[i]/sum(count$count1)*100,1),"%\n",info$interaction_types_list[(7-i)],sep=""))
  c<-c(c,if(count$count1[k]/sum(count$count1)<0.1){paste(" ",format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")}else{paste(format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")})
  c1<-c(c1,count$count1[k]/sum(count$count1))
}
count<-cbind(count,c,c1)
      
count<-transform(count, Type= factor(Type, levels = c("Scenario2","Scenario1","Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))
      
g<-ggplot(data=count,mapping=aes(x=as.factor(x1),y=c1,fill=Type))+geom_bar(stat = "identity", position = "fill",width=0.15)+
        geom_text(aes(label = c, y = pos), size = 13,hjust=-0.6)+
        #geom_text(aes(label = Type, y = pos), size = 8)+
        #theme_minimal()+
        theme_void()+
        #scale_y_continuous(labels = scales::percent,breaks=c(0,0.25,0.5,0.75,1),expand=c(0,0))+
        #coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
        scale_fill_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))#+
        #theme(title = element_blank(),axis.text = element_text(size=12),axis.title.x = element_blank(),axis.title.y = element_blank())
g
ggsave(file = paste("FigS15A_","carbonmix_prediction_1to2_bar.pdf"), plot = g)

mix2Ave<-transform(mix2Ave,bacteria=factor(bacteria,levels=strain_list))
df1=data.frame(x1=1000000,y1=1000000,x2=100000000000,y2=100000000000)
g<-ggplot(mix2Ave,aes(x=ave12,y=value,color=bacteria))+geom_point(size=2.5)+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",data=df1,linewidth=0.75,linetype="dotted")+scale_x_continuous(trans="log10",limits=c(100000,10000000000))+scale_y_continuous(trans="log10",limits=c(100000,10000000000))+labs(x="Mean prediction (cells / mL)",y="Observed (cells / mL)",title=paste("1->2 high",temphigh,"same",tempsame,"low",templow))+theme(legend.position = "none")
g
medDF<-transform(medDF,pp=factor(pp,levels=c("high","same","low")))
df1=data.frame(x1=100000,y1=100000,x2=10000000000,y2=10000000000)
g<-ggplot(medDF,aes(x=ave12,y=med,color=as.factor(pp)))+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="grey20",data=df1,linewidth=0.75,linetype="dotted")+
  geom_point(size=1.5)+scale_x_continuous(trans="log10",limits=c(100000,10000000000),expand=c(0,0))+
  scale_y_continuous(trans="log10",limits=c(100000,10000000000),expand=c(0,0))+
  theme_minimal()+
  theme(legend.position = "none",title = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),axis.title = element_blank(),axis.text = element_blank(),plot.margin=margin(t = 160, r = 160, b = 0, l = 0, unit = "pt"))+
  scale_color_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for(i in 1:length(medDF$envbac)){
  temp<-medDF[i,]
  errorDFx<-data.frame(x1=(temp$ave12-temp$sdx),y1=temp$med,x2=(temp$ave12+temp$sdx),y2=temp$med)
  errorDFy<-data.frame(x1=temp$ave12,y1=(temp$med-temp$sdy),x2=temp$ave12,y2=(temp$med+temp$sdy))
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFx,linewidth=0.2,linetype="solid")
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFy,linewidth=0.2,linetype="solid")
}
g
ggsave(file = paste("FigS15A_carbonmix_prediction_1to2.pdf"), plot = g)

g<-ggplot(medDF,aes(x="1",y=med/ave12))+geom_hline(yintercept = 1, linetype="dotted", linewidth=1.2)+geom_boxplot(outlier.shape=NA,width=0.4,color="grey5")+geom_dotplot(binaxis="y",dotsize=0.65,alpha=0.5,fill=NA, binwidth=0.15, stackdir="center",color="black")+scale_y_continuous(trans="log10",limits=c(0.01,1000),expand=c(0,0))+labs(y="Observed/Prediction")+theme_minimal()+theme(legend.position = "none",plot.margin=margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"))
g
ggsave(file = paste("FigS15_carbonmix_prediction_1to2_box.pdf"), plot = g)




















#少数炭素源・単培養の細胞濃度から、それら炭素源を混ぜた時の細胞濃度の予想と比較、1->4
mix2Ave<-data.frame()
for(i in 25:28){
  tempE<-all_sample_df_temp[all_sample_df_temp$environment==info$environment_list[i],]
  temp1<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair1[1],]
  temp2<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair2[1],]
  temp11<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair1[1],]
  temp12<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair2[1],]
  temp21<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair1[1],]
  temp22<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair2[1],]
  
  for(j in 1:14){
    #tempEB<-median(tempE[tempE$monoculture_bacteria==info$bacteria_list[j],]$background_processing_target_fluorescent_cells_density)
    temp11B<-as.numeric(temp11[temp11$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp12B<-as.numeric(temp12[temp12$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp21B<-as.numeric(temp21[temp21$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp22B<-as.numeric(temp22[temp22$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    
    c<-c(temp11B,temp12B,temp21B,temp22B)
    ave12<-mean(c)
    sdmean<-mean(c(var(temp11B),var(temp12B),var(temp21B),var(temp22B)))^0.5

    tempY<-c(ave12-sdmean,ave12,ave12+sdmean)
    
    tempEBc<-as.numeric(tempE[tempE$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    
    if(is.na(ave12)|is.na(sdmean)|sum(tempEBc)==0){
    }else{
      if(var(tempEBc)==0){
        if(tempEBc[1]==ave12){
          ptemp<-1
        }else{
          ptemp<-0
        }
        for(k in 1:length(tempEBc)){
          mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=ptemp))
        }
      }else{
        
        t<-t.test(x=tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),paired = FALSE, var.equal = FALSE, conf.level = 0.95)
        for(k in 1:length(tempEBc)){
            mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=t$p.value))
        }
      }
      
    }
  }
}

qvalue<-p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave<-cbind(mix2Ave,qvalue)

medDF<-data.frame()
for(i in 25:28){
  for(j in 1:14){
    temp<-mix2Ave[(mix2Ave$env==info$environment_list[i])&(mix2Ave$bacteria==strain_list[j]),]
    if(length(temp$envbac)!=0){
      medDF<-rbind(medDF,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),ave12=temp$ave12[1],med=mean(temp$value),"sdx"=temp$sdx[1],"sdy"=temp$sdy[1],p=if(temp$qvalue[1]<0.05){1}else{0},pp=if((temp$qvalue[1]<0.05)&(mean(temp$value)>temp$ave12[1])){"high"}else{if((temp$qvalue[1]<0.05)&(mean(temp$value)<temp$ave12[1])){"low"}else{"same"}}))
    }
  }
}



temphigh<-0
tempsame<-0
templow<-0
for(i in 1:length(medDF$envbac)){
  if(medDF$p[i]==0){
    tempsame<-tempsame+1
  }else{
    if(medDF$p[i]==1){
      if(medDF$ave12[i]>medDF$med[i]){
        templow<-templow+1
      }else{
        if(medDF$ave12[i]<medDF$med[i]){
          temphigh<-temphigh+1
        }
      }
    }
  }
}
#積み上げ棒グラフ
judge<-c("Scenario3","Scenario1","Scenario2")
judge2<-c(templow,tempsame,temphigh)
count<-data.frame(x1=1,Type=judge,count1=judge2)
c<-c()
c1<-c()
for(k in 1:3){
  #c<-c(c,paste(round(count$count1[i]/sum(count$count1)*100,1),"%\n",info$interaction_types_list[(7-i)],sep=""))
  c<-c(c,if(count$count1[k]/sum(count$count1)<0.1){paste(" ",format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")}else{paste(format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")})
  c1<-c(c1,count$count1[k]/sum(count$count1))
}
count<-cbind(count,c,c1)
      
count<-transform(count, Type= factor(Type, levels = c("Scenario2","Scenario1","Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))
      
g<-ggplot(data=count,mapping=aes(x=as.factor(x1),y=c1,fill=Type))+geom_bar(stat = "identity", position = "fill",width=0.15)+
        geom_text(aes(label = c, y = pos), size = 13,hjust=-0.6)+
        #geom_text(aes(label = Type, y = pos), size = 8)+
        #theme_minimal()+
        theme_void()+
        #scale_y_continuous(labels = scales::percent,breaks=c(0,0.25,0.5,0.75,1),expand=c(0,0))+
        #coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
        scale_fill_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))#+
        #theme(title = element_blank(),axis.text = element_text(size=12),axis.title.x = element_blank(),axis.title.y = element_blank())
g
ggsave(file = paste("FigS15B__","carbonmix_prediction_1to4_bar.pdf"), plot = g)

mix2Ave<-transform(mix2Ave,bacteria=factor(bacteria,levels=strain_list))
df1=data.frame(x1=1000000,y1=1000000,x2=100000000000,y2=100000000000)
g<-ggplot(mix2Ave,aes(x=ave12,y=value,color=bacteria))+geom_point(size=2.5)+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",data=df1,linewidth=0.75,linetype="dotted")+scale_x_continuous(trans="log10",limits=c(100000,10000000000))+scale_y_continuous(trans="log10",limits=c(100000,10000000000))+labs(x="Mean prediction (cells / mL)",y="Observed (cells / mL)",title=paste("1->2 high",temphigh,"same",tempsame,"low",templow))+theme(legend.position = "none")
g
medDF<-transform(medDF,pp=factor(pp,levels=c("high","same","low")))
df1=data.frame(x1=100000,y1=100000,x2=10000000000,y2=10000000000)
g<-ggplot(medDF,aes(x=ave12,y=med,color=as.factor(pp)))+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="grey20",data=df1,linewidth=0.75,linetype="dotted")+
  geom_point(size=1.5)+scale_x_continuous(trans="log10",limits=c(100000,10000000000),expand=c(0,0))+
  scale_y_continuous(trans="log10",limits=c(100000,10000000000),expand=c(0,0))+
  theme_minimal()+
  theme(legend.position = "none",title = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),axis.title = element_blank(),axis.text = element_blank(),plot.margin=margin(t = 160, r = 160, b = 0, l = 0, unit = "pt"))+
  scale_color_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for(i in 1:length(medDF$envbac)){
  temp<-medDF[i,]
  errorDFx<-data.frame(x1=(temp$ave12-temp$sdx),y1=temp$med,x2=(temp$ave12+temp$sdx),y2=temp$med)
  errorDFy<-data.frame(x1=temp$ave12,y1=(temp$med-temp$sdy),x2=temp$ave12,y2=(temp$med+temp$sdy))
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFx,linewidth=0.2,linetype="solid")
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFy,linewidth=0.2,linetype="solid")
}
g
ggsave(file = paste("FigS15B_carbonmix_prediction_1to4.pdf"), plot = g)

g<-ggplot(medDF,aes(x="1",y=med/ave12))+geom_hline(yintercept = 1, linetype="dotted", linewidth=1.2)+geom_boxplot(outlier.shape=NA,width=0.4,color="grey5")+geom_dotplot(binaxis="y",dotsize=0.65,alpha=0.5,fill=NA, binwidth=0.15, stackdir="center",color="black")+scale_y_continuous(trans="log10",limits=c(0.01,1000),expand=c(0,0))+labs(y="Observed/Prediction")+theme_minimal()+theme(legend.position = "none",plot.margin=margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"))
g
ggsave(file = paste("FigS15_carbonmix_prediction_1to4_box.pdf"), plot = g)












#少数炭素源・単培養の細胞濃度から、それら炭素源を混ぜた時の細胞濃度の予想と比較、1->8
mix2Ave<-data.frame()
for(i in 29:30){
  tempE<-all_sample_df_temp[all_sample_df_temp$environment==info$environment_list[i],]
  temp1<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair1[1],]
  temp2<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair2[1],]
  temp11<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair1[1],]
  temp12<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair2[1],]
  temp21<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair1[1],]
  temp22<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair2[1],]
  temp111<-all_sample_df_temp[all_sample_df_temp$environment==temp11$carbonsource_mixed_pair1[1],]
  temp112<-all_sample_df_temp[all_sample_df_temp$environment==temp11$carbonsource_mixed_pair2[1],]
  temp121<-all_sample_df_temp[all_sample_df_temp$environment==temp12$carbonsource_mixed_pair1[1],]
  temp122<-all_sample_df_temp[all_sample_df_temp$environment==temp12$carbonsource_mixed_pair2[1],]
  temp211<-all_sample_df_temp[all_sample_df_temp$environment==temp21$carbonsource_mixed_pair1[1],]
  temp212<-all_sample_df_temp[all_sample_df_temp$environment==temp21$carbonsource_mixed_pair2[1],]
  temp221<-all_sample_df_temp[all_sample_df_temp$environment==temp22$carbonsource_mixed_pair1[1],]
  temp222<-all_sample_df_temp[all_sample_df_temp$environment==temp22$carbonsource_mixed_pair2[1],]
  
  for(j in 1:14){
    #tempEB<-median(tempE[tempE$monoculture_bacteria==info$bacteria_list[j],]$background_processing_target_fluorescent_cells_density)
    temp111B<-as.numeric(temp111[temp111$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp112B<-as.numeric(temp112[temp112$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp121B<-as.numeric(temp121[temp121$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp122B<-as.numeric(temp122[temp122$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp211B<-as.numeric(temp211[temp211$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp212B<-as.numeric(temp212[temp212$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp221B<-as.numeric(temp221[temp221$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp222B<-as.numeric(temp222[temp222$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    
    c<-c(temp111B,temp112B,temp121B,temp122B,temp211B,temp212B,temp221B,temp222B)
    ave12<-mean(c)
    sdmean<-mean(c(var(temp111B),var(temp112B),var(temp121B),var(temp122B),var(temp211B),var(temp212B),var(temp221B),var(temp222B)))^0.5

    tempY<-c(ave12-sdmean,ave12,ave12+sdmean)
    
    tempEBc<-as.numeric(tempE[tempE$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    
    if(is.na(ave12)|is.na(sdmean)|sum(tempEBc)==0){
    }else{
      if(var(tempEBc)==0){
        if(tempEBc[1]==ave12){
          ptemp<-1
        }else{
          ptemp<-0
        }
        for(k in 1:length(tempEBc)){
          mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=ptemp))
        }
      }else{
        
        t<-t.test(x=tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),paired = FALSE, var.equal = FALSE, conf.level = 0.95)
        for(k in 1:length(tempEBc)){
            mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=t$p.value))
        }
      }
    }
  }
}

qvalue<-p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave<-cbind(mix2Ave,qvalue)

medDF<-data.frame()
for(i in 29:30){
  for(j in 1:14){
    temp<-mix2Ave[(mix2Ave$env==info$environment_list[i])&(mix2Ave$bacteria==strain_list[j]),]
    if(length(temp$envbac)!=0){
      medDF<-rbind(medDF,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),ave12=temp$ave12[1],med=mean(temp$value),"sdx"=temp$sdx[1],"sdy"=temp$sdy[1],p=if(temp$qvalue[1]<0.05){1}else{0},pp=if((temp$qvalue[1]<0.05)&(mean(temp$value)>temp$ave12[1])){"high"}else{if((temp$qvalue[1]<0.05)&(mean(temp$value)<temp$ave12[1])){"low"}else{"same"}}))
    }
  }
}



temphigh<-0
tempsame<-0
templow<-0
for(i in 1:length(medDF$envbac)){
  if(medDF$p[i]==0){
    tempsame<-tempsame+1
  }else{
    if(medDF$p[i]==1){
      if(medDF$ave12[i]>medDF$med[i]){
        templow<-templow+1
      }else{
        if(medDF$ave12[i]<medDF$med[i]){
          temphigh<-temphigh+1
        }
      }
    }
  }
}
#積み上げ棒グラフ
judge<-c("Scenario3","Scenario1","Scenario2")
judge2<-c(templow,tempsame,temphigh)
count<-data.frame(x1=1,Type=judge,count1=judge2)
c<-c()
c1<-c()
for(k in 1:3){
  #c<-c(c,paste(round(count$count1[i]/sum(count$count1)*100,1),"%\n",info$interaction_types_list[(7-i)],sep=""))
  c<-c(c,if(count$count1[k]/sum(count$count1)<0.1){paste(" ",format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")}else{paste(format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")})
  c1<-c(c1,count$count1[k]/sum(count$count1))
}
count<-cbind(count,c,c1)
      
count<-transform(count, Type= factor(Type, levels = c("Scenario2","Scenario1","Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))
      
g<-ggplot(data=count,mapping=aes(x=as.factor(x1),y=c1,fill=Type))+geom_bar(stat = "identity", position = "fill",width=0.15)+
        geom_text(aes(label = c, y = pos), size = 13,hjust=-0.6)+
        #geom_text(aes(label = Type, y = pos), size = 8)+
        #theme_minimal()+
        theme_void()+
        #scale_y_continuous(labels = scales::percent,breaks=c(0,0.25,0.5,0.75,1),expand=c(0,0))+
        #coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
        scale_fill_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))#+
        #theme(title = element_blank(),axis.text = element_text(size=12),axis.title.x = element_blank(),axis.title.y = element_blank())
g
ggsave(file = paste("FigS15C_","carbonmix_prediction_1to8_bar.pdf"), plot = g)

mix2Ave<-transform(mix2Ave,bacteria=factor(bacteria,levels=strain_list))
df1=data.frame(x1=1000000,y1=1000000,x2=100000000000,y2=100000000000)
g<-ggplot(mix2Ave,aes(x=ave12,y=value,color=bacteria))+geom_point(size=2.5)+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",data=df1,linewidth=0.75,linetype="dotted")+scale_x_continuous(trans="log10",limits=c(100000,10000000000))+scale_y_continuous(trans="log10",limits=c(100000,10000000000))+labs(x="Mean prediction (cells / mL)",y="Observed (cells / mL)",title=paste("1->2 high",temphigh,"same",tempsame,"low",templow))+theme(legend.position = "none")
g
medDF<-transform(medDF,pp=factor(pp,levels=c("high","same","low")))
df1=data.frame(x1=100000,y1=100000,x2=10000000000,y2=10000000000)
g<-ggplot(medDF,aes(x=ave12,y=med,color=as.factor(pp)))+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="grey20",data=df1,linewidth=0.75,linetype="dotted")+
  geom_point(size=1.5)+scale_x_continuous(trans="log10",limits=c(100000,10000000000),expand=c(0,0))+
  scale_y_continuous(trans="log10",limits=c(100000,10000000000),expand=c(0,0))+
  theme_minimal()+
  theme(legend.position = "none",title = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),axis.title = element_blank(),axis.text = element_blank(),plot.margin=margin(t = 160, r = 160, b = 0, l = 0, unit = "pt"))+
  scale_color_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for(i in 1:length(medDF$envbac)){
  temp<-medDF[i,]
  errorDFx<-data.frame(x1=(temp$ave12-temp$sdx),y1=temp$med,x2=(temp$ave12+temp$sdx),y2=temp$med)
  errorDFy<-data.frame(x1=temp$ave12,y1=(temp$med-temp$sdy),x2=temp$ave12,y2=(temp$med+temp$sdy))
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFx,linewidth=0.2,linetype="solid")
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFy,linewidth=0.2,linetype="solid")
}
g
ggsave(file = paste("FigS15C_carbonmix_prediction_1to8.pdf"), plot = g)

g<-ggplot(medDF,aes(x="1",y=med/ave12))+geom_hline(yintercept = 1, linetype="dotted", linewidth=1.2)+geom_boxplot(outlier.shape=NA,width=0.4,color="grey5")+geom_dotplot(binaxis="y",dotsize=0.65,alpha=0.5,fill=NA, binwidth=0.15, stackdir="center",color="black")+scale_y_continuous(trans="log10",limits=c(0.01,1000),expand=c(0,0))+labs(y="Observed/Prediction")+theme_minimal()+theme(legend.position = "none",plot.margin=margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"))
g
ggsave(file = paste("FigS15_carbonmix_prediction_1to8_box.pdf"), plot = g)







#少数炭素源・単培養の細胞濃度から、それら炭素源を混ぜた時の細胞濃度の予想と比較、1->16
mix2Ave<-data.frame()
for(i in 31:31){
  tempE<-all_sample_df_temp[all_sample_df_temp$environment==info$environment_list[i],]
  temp1<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair1[1],]
  temp2<-all_sample_df_temp[all_sample_df_temp$environment==tempE$carbonsource_mixed_pair2[1],]
  temp11<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair1[1],]
  temp12<-all_sample_df_temp[all_sample_df_temp$environment==temp1$carbonsource_mixed_pair2[1],]
  temp21<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair1[1],]
  temp22<-all_sample_df_temp[all_sample_df_temp$environment==temp2$carbonsource_mixed_pair2[1],]
  temp111<-all_sample_df_temp[all_sample_df_temp$environment==temp11$carbonsource_mixed_pair1[1],]
  temp112<-all_sample_df_temp[all_sample_df_temp$environment==temp11$carbonsource_mixed_pair2[1],]
  temp121<-all_sample_df_temp[all_sample_df_temp$environment==temp12$carbonsource_mixed_pair1[1],]
  temp122<-all_sample_df_temp[all_sample_df_temp$environment==temp12$carbonsource_mixed_pair2[1],]
  temp211<-all_sample_df_temp[all_sample_df_temp$environment==temp21$carbonsource_mixed_pair1[1],]
  temp212<-all_sample_df_temp[all_sample_df_temp$environment==temp21$carbonsource_mixed_pair2[1],]
  temp221<-all_sample_df_temp[all_sample_df_temp$environment==temp22$carbonsource_mixed_pair1[1],]
  temp222<-all_sample_df_temp[all_sample_df_temp$environment==temp22$carbonsource_mixed_pair2[1],]
  
  temp1111<-all_sample_df_temp[all_sample_df_temp$environment==temp111$carbonsource_mixed_pair1[1],]
  temp1112<-all_sample_df_temp[all_sample_df_temp$environment==temp111$carbonsource_mixed_pair2[1],]
  temp1121<-all_sample_df_temp[all_sample_df_temp$environment==temp112$carbonsource_mixed_pair1[1],]
  temp1122<-all_sample_df_temp[all_sample_df_temp$environment==temp112$carbonsource_mixed_pair2[1],]
  temp1211<-all_sample_df_temp[all_sample_df_temp$environment==temp121$carbonsource_mixed_pair1[1],]
  temp1212<-all_sample_df_temp[all_sample_df_temp$environment==temp121$carbonsource_mixed_pair2[1],]
  temp1221<-all_sample_df_temp[all_sample_df_temp$environment==temp122$carbonsource_mixed_pair1[1],]
  temp1222<-all_sample_df_temp[all_sample_df_temp$environment==temp122$carbonsource_mixed_pair2[1],]
  temp2111<-all_sample_df_temp[all_sample_df_temp$environment==temp211$carbonsource_mixed_pair1[1],]
  temp2112<-all_sample_df_temp[all_sample_df_temp$environment==temp211$carbonsource_mixed_pair2[1],]
  temp2121<-all_sample_df_temp[all_sample_df_temp$environment==temp212$carbonsource_mixed_pair1[1],]
  temp2122<-all_sample_df_temp[all_sample_df_temp$environment==temp212$carbonsource_mixed_pair2[1],]
  temp2211<-all_sample_df_temp[all_sample_df_temp$environment==temp221$carbonsource_mixed_pair1[1],]
  temp2212<-all_sample_df_temp[all_sample_df_temp$environment==temp221$carbonsource_mixed_pair2[1],]
  temp2221<-all_sample_df_temp[all_sample_df_temp$environment==temp222$carbonsource_mixed_pair1[1],]
  temp2222<-all_sample_df_temp[all_sample_df_temp$environment==temp222$carbonsource_mixed_pair2[1],]
  
  
  for(j in 1:14){
    #tempEB<-median(tempE[tempE$monoculture_bacteria==info$bacteria_list[j],]$background_processing_target_fluorescent_cells_density)
    temp1111B<-as.numeric(temp1111[temp1111$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp1112B<-as.numeric(temp1112[temp1112$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp1121B<-as.numeric(temp1121[temp1121$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp1122B<-as.numeric(temp1122[temp1122$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp1211B<-as.numeric(temp1211[temp1211$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp1212B<-as.numeric(temp1212[temp1212$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp1221B<-as.numeric(temp1221[temp1221$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp1222B<-as.numeric(temp1222[temp1222$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp2111B<-as.numeric(temp2111[temp2111$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp2112B<-as.numeric(temp2112[temp2112$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp2121B<-as.numeric(temp2121[temp2121$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp2122B<-as.numeric(temp2122[temp2122$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp2211B<-as.numeric(temp2211[temp2211$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp2212B<-as.numeric(temp2212[temp2212$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp2221B<-as.numeric(temp2221[temp2221$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    temp2222B<-as.numeric(temp2222[temp2222$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    
    
    c<-c(temp1111B,temp1112B,temp1121B,temp1122B,temp1211B,temp1212B,temp1221B,temp1222B,temp2111B,temp2112B,temp2121B,temp2122B,temp2211B,temp2212B,temp2221B,temp2222B)
    ave12<-mean(c)
    sdmean<-mean(c(var(temp1111B),var(temp1112B),var(temp1121B),var(temp1122B),var(temp1211B),var(temp1212B),var(temp1221B),var(temp1222B),var(temp2111B),var(temp2112B),var(temp2121B),var(temp2122B),var(temp2211B),var(temp2212B),var(temp2221B),var(temp2222B)))^0.5

    #tempY<-c(ave12-sdmean,ave12-sdmean,ave12,ave12+sdmean,ave12+sdmean)
    tempY<-c(ave12-sdmean,ave12,ave12+sdmean)
    a<-tempE[tempE$bacteria==strain_list[j],]
    tempEBc<-as.numeric(tempE[tempE$bacteria==strain_list[j],]$background_processing_target_fluorescent_cells_density)
    
    if(is.na(ave12)|is.na(sdmean)|sum(tempEBc)==0){
    }else{
      if(var(tempEBc)==0){
        if(tempEBc[1]==ave12){
          ptemp<-1
        }else{
          ptemp<-0
        }
        for(k in 1:length(tempEBc)){
          mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=ptemp))
        }
      }else{
        
        t<-t.test(x=tempEBc, y = tempY, alternative = c("two.sided", "less", "greater"),paired = FALSE, var.equal = FALSE, conf.level = 0.95)
        for(k in 1:length(tempEBc)){
            mix2Ave<-rbind(mix2Ave,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),env=info$environment_list[i],bacteria=strain_list[j],"ave12"=ave12,"sdx"=sdmean,"sdy"=sd(tempEBc),value=tempEBc[k],pvalue=t$p.value))
        }
      }
    }
  }
}

qvalue<-p.adjust(mix2Ave$pvalue, method = "BH")
mix2Ave<-cbind(mix2Ave,qvalue)


medDF<-data.frame()
for(i in 31:31){
  for(j in 1:14){
    temp<-mix2Ave[(mix2Ave$env==info$environment_list[i])&(mix2Ave$bacteria==strain_list[j]),]
    if(sum(temp$ave12)!=0){
      medDF<-rbind(medDF,data.frame(envbac=paste(info$environment_list[i],strain_list[j]),ave12=temp$ave12[1],med=mean(temp$value),"sdx"=temp$sdx[1],"sdy"=temp$sdy[1],p=if(temp$qvalue[1]<0.05){1}else{0},pp=if((temp$qvalue[1]<0.05)&(mean(temp$value)>temp$ave12[1])){"high"}else{if((temp$qvalue[1]<0.05)&(mean(temp$value)<temp$ave12[1])){"low"}else{"same"}}))
    }
  }
}


temphigh<-0
tempsame<-0
templow<-0
for(i in 1:length(medDF$envbac)){
  if(medDF$p[i]==0){
    tempsame<-tempsame+1
  }else{
    if(medDF$p[i]==1){
      if(medDF$ave12[i]>medDF$med[i]){
        templow<-templow+1
      }else{
        if(medDF$ave12[i]<medDF$med[i]){
          temphigh<-temphigh+1
        }
      }
    }
  }
}
#積み上げ棒グラフ
judge<-c("Scenario3","Scenario1","Scenario2")
judge2<-c(templow,tempsame,temphigh)
count<-data.frame(x1=1,Type=judge,count1=judge2)
c<-c()
c1<-c()
for(k in 1:3){
  #c<-c(c,paste(round(count$count1[i]/sum(count$count1)*100,1),"%\n",info$interaction_types_list[(7-i)],sep=""))
  c<-c(c,if(count$count1[k]/sum(count$count1)<0.1){paste(" ",format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")}else{paste(format(round(count$count1[k]/sum(count$count1)*100,1),nsmall=1),"%",sep="")})
  c1<-c(c1,count$count1[k]/sum(count$count1))
}
count<-cbind(count,c,c1)
      
count<-transform(count, Type= factor(Type, levels = c("Scenario2","Scenario1","Scenario3")))
count <- ddply(count, .(x1), transform, pos = cumsum(c1) - (0.5 * c1))
      
g<-ggplot(data=count,mapping=aes(x=as.factor(x1),y=c1,fill=Type))+geom_bar(stat = "identity", position = "fill",width=0.15)+
        geom_text(aes(label = c, y = pos), size = 13,hjust=-0.6)+
        #geom_text(aes(label = Type, y = pos), size = 8)+
        #theme_minimal()+
        theme_void()+
        #scale_y_continuous(labels = scales::percent,breaks=c(0,0.25,0.5,0.75,1),expand=c(0,0))+
        #coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+
        scale_fill_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))#+
        #theme(title = element_blank(),axis.text = element_text(size=12),axis.title.x = element_blank(),axis.title.y = element_blank())
g
ggsave(file = paste("FigS15D_","carbonmix_prediction_1to16_bar.pdf"), plot = g)

mix2Ave<-transform(mix2Ave,bacteria=factor(bacteria,levels=strain_list))
df1=data.frame(x1=1000000,y1=1000000,x2=100000000000,y2=100000000000)
g<-ggplot(mix2Ave,aes(x=ave12,y=value,color=bacteria))+geom_point(size=2.5)+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",data=df1,linewidth=0.75,linetype="dotted")+scale_x_continuous(trans="log10",limits=c(100000,10000000000))+scale_y_continuous(trans="log10",limits=c(100000,10000000000))+labs(x="Mean prediction (cells / mL)",y="Observed (cells / mL)",title=paste("1->2 high",temphigh,"same",tempsame,"low",templow))+theme(legend.position = "none")
g
medDF<-transform(medDF,pp=factor(pp,levels=c("high","same","low")))
df1=data.frame(x1=100000,y1=100000,x2=10000000000,y2=10000000000)
g<-ggplot(medDF,aes(x=ave12,y=med,color=as.factor(pp)))+
  geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="grey20",data=df1,linewidth=0.75,linetype="dotted")+
  geom_point(size=1.5)+scale_x_continuous(trans="log10",limits=c(100000,10000000000),expand=c(0,0))+
  scale_y_continuous(trans="log10",limits=c(100000,10000000000),expand=c(0,0))+
  theme_minimal()+
  theme(legend.position = "none",title = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"),axis.title = element_blank(),axis.text = element_blank(),plot.margin=margin(t = 160, r = 160, b = 0, l = 0, unit = "pt"))+
  scale_color_manual(values = c(rgb(red=184,green=153,blue=58,maxColorValue=255),"grey70",rgb(red=58,green=184,blue=153,maxColorValue=255)))+
  coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)
for(i in 1:length(medDF$envbac)){
  temp<-medDF[i,]
  errorDFx<-data.frame(x1=(temp$ave12-temp$sdx),y1=temp$med,x2=(temp$ave12+temp$sdx),y2=temp$med)
  errorDFy<-data.frame(x1=temp$ave12,y1=(temp$med-temp$sdy),x2=temp$ave12,y2=(temp$med+temp$sdy))
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFx,linewidth=0.2,linetype="solid")
  g<-g+geom_segment(aes(x=x1,y=y1,xend=x2, yend=y2),color="black",alpha=0.3,data=errorDFy,linewidth=0.2,linetype="solid")
}
g
ggsave(file = paste("FigS15D_carbonmix_prediction_1to16.pdf"), plot = g)

g<-ggplot(medDF,aes(x="1",y=med/ave12))+geom_hline(yintercept = 1, linetype="dotted", linewidth=1.2)+geom_boxplot(outlier.shape=NA,width=0.4,color="grey5")+geom_dotplot(binaxis="y",dotsize=0.65,alpha=0.5,fill=NA, binwidth=0.15, stackdir="center",color="black")+scale_y_continuous(trans="log10",limits=c(0.01,1000),expand=c(0,0))+labs(y="Observed/Prediction")+theme_minimal()+theme(legend.position = "none",plot.margin=margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"))
g
ggsave(file = paste("FigS15_carbonmix_prediction_1to16_box.pdf"), plot = g)
dev.off()
```

## FigS16
```{r}
dev.new()
#metabolic distance の算出

all_sample_df_temp<-all_sample_df[all_sample_df$experiment=="main",]


growth_spe<-data.frame("dammy"=c(1:32))
#growth_spe<-data.frame("dammy"=c(1:16))
bacteria_list<-c(info$monoculture_bacteria_list[1],info$monoculture_bacteria_list[3:14],info$monoculture_bacteria_list[16])

for(i in 1:14){
  temp<-all_sample_df_temp[all_sample_df_temp$bacteria==bacteria_list[i],]
  tempc<-data.frame()
  for(j in 1:32){
  #for(j in 1:16){
    tempBE<-temp[temp$environment==info$environment_list[j],]
    #tempBE[is.na(tempBE)]<-0
    #tempBE<-tempBE[tempBE$fcs_file!=0,]
    tempc<-rbind(tempc,"a"=log10(mean(as.numeric(tempBE$background_processing_target_fluorescent_cells_density)))-log10(457000))#20231207, log10に変更
  
  }
  growth_spe<-cbind(growth_spe,tempc)
}

normalizedG<-data.frame("dammy"=c(1:32))
for(i in 2:15){
  tempmax<-max(growth_spe[,i])
  tempc<-data.frame()
  for(j in 1:32){
    tempc<-rbind(tempc,"a"=growth_spe[j,i]/tempmax)
  }
  normalizedG<-cbind(normalizedG,tempc)
}
normalizedGt<-t(normalizedG)[2:15,1:32]


a<-dist(normalizedGt) #ユークリッド距離
#plot(hclust(a))

data.matrix <- as.matrix(a)
data.matrix2 <- as.data.frame(data.matrix)
data.matrix2 <- cbind(data.frame(a=info$strain_list[1:14]),data.matrix2)
mat <- rbind(c("a",info$strain_list),data.matrix2)

matD<-data.frame()

for(i in 1:14){
  tempc<-c()
  
  for(j in 1:14){
    tempc<-c(tempc,mat[j+1,i+1])
  }
  tempmatD<-data.frame(GFP=mat$a[2:15],mScarlet=rep(mat[1,i+1],14),a=tempc[1:14])
  matD<-rbind(matD,tempmatD)
}

matD<-transform(matD,GFP=factor(GFP,levels=info$strain_list_phylogenetic[14:1]))
matD<-transform(matD,mScarlet=factor(mScarlet,levels=info$strain_list_phylogenetic[1:14]))
g<-ggplot(matD,aes(y=GFP,x=mScarlet,fill=as.numeric(a)))+geom_tile()+ scale_fill_gradientn("MetabolicDistance", colours = c("white","grey5"), na.value = "white")+scale_x_discrete(guide = guide_axis(angle = 90))+theme_pubr()+coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+theme(axis.text = element_blank(),axis.title = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"))
ggsave(filename = "FigS17_tile.pdf",plot=g)
plot(g)

colnames(data.matrix)<-info$strain_list_phylogenetic[1:14]
rownames(data.matrix)<-info$strain_list_phylogenetic[1:14]

data.matrix<-as.data.frame(data.matrix)

all_sample_df_temp <- all_sample_df
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="AgT"]<-1
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="SpP"]<-2
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="AlF"]<-4
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="DeA"]<-6
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="PaV"]<-8
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="PaA"]<-10
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="PsA"]<-12

all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="PsD"]<-14
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="SpP"]<-3
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="AlF"]<-5
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="DeA"]<-7
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="PaV"]<-9
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="PaA"]<-11
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="PsA"]<-13

for(i in 1:length(all_sample_df_temp$fcs_file)){
  if((all_sample_df_temp$bacterial_species_count[i]==2)){
    if(all_sample_df_temp$experiment[i]=="main"){
      all_sample_df$MetaDist[i]<-data.matrix[as.numeric(all_sample_df_temp$coculture_species_GFP[i]),as.numeric(all_sample_df_temp$coculture_species_mScarlet[i])]
    }
  }else{all_sample_df$MetaDist[i]<-"ERROR"}
}
dev.off()
```

```{r}
#barplot

all_sample_df_temp<-all_sample_df[all_sample_df$bacterial_species_count==2,]
all_sample_df_temp<-all_sample_df_temp[all_sample_df_temp$experiment=="main",]


Dist_theta<-data.frame()
for(i in 1:28){
  for(j in 1:16){
    temp<-all_sample_df_temp[(all_sample_df_temp$bacteria==info$coculture_bacteria_list[i])&(all_sample_df_temp$environment==info$environment_list[j]),]
    Dist_theta<-rbind(Dist_theta,data.frame(Dist=as.numeric(temp$MetaDist[1]),theta=temp$theta_value,bacteria=info$coculture_bacteria_list[i]))
  }
}

Dist_theta_ave<-data.frame()
for(i in 1:28){
  Dist_theta_ave<-rbind(Dist_theta_ave,data.frame(Dist=mean(as.numeric(Dist_theta[Dist_theta$bacteria==info$coculture_bacteria_list[i],]$Dist)),ave=mean(as.numeric(Dist_theta[Dist_theta$bacteria==info$coculture_bacteria_list[i],]$theta))))
}

g<-ggplot()+
  geom_point(data=Dist_theta,mapping=aes(x=as.numeric(Dist),y=as.numeric(theta)),alpha=0.3,color="black",shape=21)+
  geom_point(data=Dist_theta_ave,mapping=aes(x=as.numeric(Dist),y=as.numeric(ave)),alpha=1,color="red",shape=3,size=3)+
  theme_bw()+
  theme(axis.title = element_blank(),axis.text = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"))+
  scale_y_continuous(limits=c(-90,90),breaks=c(-90,-45,0,45,90),expand = c(0,0))+
  scale_x_continuous(limits=c(0,4),breaks=c(0,1,2,3,4),expand = c(0,0))
g
ggsave(filename = "FigS17_point.pdf",plot=g)

cor.test(as.numeric(Dist_theta$Dist),as.numeric(Dist_theta$theta),method="spearman")$estimate
cor.test(as.numeric(Dist_theta$Dist),as.numeric(Dist_theta$theta),method="spearman")$p.value

cor.test(as.numeric(Dist_theta_ave$Dist),as.numeric(Dist_theta_ave$ave),method="spearman")$estimate
cor.test(as.numeric(Dist_theta_ave$Dist),as.numeric(Dist_theta_ave$ave),method="spearman")$p.value


```

## FigS17
```{r}
dev.new()
#metabolic distance の算出

all_sample_df_temp<-all_sample_df[all_sample_df$experiment=="main",]


matD<-data.frame(read.csv("phylogenetic_distance.csv"))
data.matrix<-data.frame()
for (i in 1:8){
  data.matrix <- rbind(data.matrix,c(info$bacteria_list_Phylogenetic[1:8]))
}
colnames(data.matrix) <-info$bacteria_list_Phylogenetic[1:8]
rownames(data.matrix) <-info$bacteria_list_Phylogenetic[1:8]
for(i in 1:28){
  data.matrix[matD$Species.1[i],matD$Species.2[i]]<-matD$Dist[i]
  data.matrix[matD$Species.2[i],matD$Species.1[i]]<-matD$Dist[i]
}
for(i in 1:8){
  data.matrix[info$bacteria_list_Phylogenetic[i],info$bacteria_list_Phylogenetic[i]] <- 0
}
  


for(i in 1:28){
  matD<-rbind(matD,data.frame(Species.1=matD$Species.2[i],Species.2=matD$Species.1[i],Dist=matD$Dist[i]))
}
for(i in 1:8){
  matD<-rbind(matD,data.frame(Species.1=info$bacteria_list_Phylogenetic[i],Species.2=info$bacteria_list_Phylogenetic[i],Dist=0))
}

matD<-transform(matD,Species.1=factor(Species.1,levels=info$bacteria_list_Phylogenetic[8:1]))
matD<-transform(matD,Species.2=factor(Species.2,levels=info$bacteria_list_Phylogenetic[1:8]))
g<-ggplot(matD,aes(y=Species.1,x=Species.2,fill=as.numeric(Dist)))+geom_tile()+ scale_fill_gradientn("Phylogenetic Distance", colours = c("white","grey5"), na.value = "white")+scale_x_discrete(guide = guide_axis(angle = 90))+theme_pubr()+coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)#+theme(axis.text = element_blank(),axis.title = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"))
ggsave(filename = "FigS18_tile_legend.pdf",plot=g)

g<-ggplot(matD,aes(y=Species.1,x=Species.2,fill=as.numeric(Dist)))+geom_tile()+ scale_fill_gradientn("Phylogenetic Distance", colours = c("white","grey5"), na.value = "white")+scale_x_discrete(guide = guide_axis(angle = 90))+theme_pubr()+coord_fixed(ratio = 1, xlim = NULL, ylim = NULL, expand = TRUE)+theme(axis.text = element_blank(),axis.title = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"))
ggsave(filename = "FigS18_tile.pdf",plot=g)
plot(g)

all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="AgT"]<-1
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="SpP"]<-2
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="AlF"]<-3
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="DeA"]<-4
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="PaV"]<-5
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="PaA"]<-6
all_sample_df_temp$coculture_species_GFP[all_sample_df_temp$coculture_species_GFP=="PsA"]<-7

all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="PsD"]<-8
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="SpP"]<-2
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="AlF"]<-3
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="DeA"]<-4
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="PaV"]<-5
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="PaA"]<-6
all_sample_df_temp$coculture_species_mScarlet[all_sample_df_temp$coculture_species_mScarlet=="PsA"]<-7

for(i in 1:length(all_sample_df_temp$fcs_file)){
  if((all_sample_df_temp$bacterial_species_count[i]==2)){
    if(all_sample_df_temp$experiment[i]=="main"){
      all_sample_df$PyloDist[i]<-data.matrix[as.numeric(all_sample_df_temp$coculture_species_GFP[i]),as.numeric(all_sample_df_temp$coculture_species_mScarlet[i])]
    }
  }else{all_sample_df$PyloDist[i]<-"ERROR"}
}
dev.off()
```

```{r}
#barplot
dev.new()

all_sample_df_temp<-all_sample_df[all_sample_df$bacterial_species_count==2,]
all_sample_df_temp<-all_sample_df_temp[all_sample_df_temp$experiment=="main",]



Dist_theta<-data.frame()
for(i in 1:28){
  for(j in 1:16){
    temp<-all_sample_df_temp[(all_sample_df_temp$bacteria==info$coculture_bacteria_list[i])&(all_sample_df_temp$environment==info$environment_list[j]),]
    Dist_theta<-rbind(Dist_theta,data.frame(Dist=as.numeric(temp$PyloDist[1]),theta=temp$theta_value[1],bacteria=info$coculture_bacteria_list[i]))
  }
}

Dist_theta_ave<-data.frame()
for(i in 1:28){
  Dist_theta_ave<-rbind(Dist_theta_ave,data.frame(Dist=mean(as.numeric(Dist_theta[Dist_theta$bacteria==info$coculture_bacteria_list[i],]$Dist)),ave=mean(as.numeric(Dist_theta[Dist_theta$bacteria==info$coculture_bacteria_list[i],]$theta))))
}

g<-ggplot()+
  geom_point(data=Dist_theta,mapping=aes(x=as.numeric(Dist),y=as.numeric(theta)),alpha=0.3,color="black",shape=21)+
  geom_point(data=Dist_theta_ave,mapping=aes(x=as.numeric(Dist),y=as.numeric(ave)),alpha=1,color="red",shape=3,size=3)+
  theme_bw()+
  theme(axis.title = element_blank(),axis.text = element_blank(),axis.line = element_line(size=0.8,lineend="square",color="grey20"),axis.ticks = element_line(size=0.8,lineend="square",color="grey20"))+
  scale_y_continuous(limits=c(-90,90),breaks=c(-90,-45,0,45,90),expand = c(0,0))+
  scale_x_continuous(limits=c(0,0.5),breaks=c(0,0.1,0.2,0.3,0.4,0.5),expand = c(0,0))
g
ggsave(filename = "FigS18_point.pdf",plot=g)

cor.test(as.numeric(Dist_theta$Dist),as.numeric(Dist_theta$theta),method="spearman")$estimate
cor.test(as.numeric(Dist_theta$Dist),as.numeric(Dist_theta$theta),method="spearman")$p.value

cor.test(as.numeric(Dist_theta_ave$Dist),as.numeric(Dist_theta_ave$ave),method="spearman")$estimate
cor.test(as.numeric(Dist_theta_ave$Dist),as.numeric(Dist_theta_ave$ave),method="spearman")$p.value
dev.off()

```